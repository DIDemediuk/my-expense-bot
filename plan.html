<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Å–µ–∑–æ–Ω—É</title>
    <style>
      /* –°—Ç–∏–ª—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è —è–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó */
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #333;
        line-height: 1.6;
      }
      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 2.5em;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }
      .subtitle {
        text-align: center;
        color: #7f8c8d;
        margin-bottom: 30px;
        font-style: italic;
      }
      .tabs-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        background: white;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .tab-btn {
        padding: 15px 30px;
        background: #ecf0f1;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        color: #2c3e50;
        transition: all 0.3s ease;
        border-radius: 10px 10px 0 0;
      }
      .tab-btn:hover {
        background: #d5dbdb;
      }
      .tab-btn.active {
        background: #3498db;
        color: white;
      }
      .tab-content {
        display: none;
        background: white;
        padding: 25px;
        border-radius: 0 10px 10px 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .tab-content.active {
        display: block;
      }
      .form-section h2, .table-section h2 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      /* –°—Ç–∏–ª—ñ –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–∏—Ö –±–ª–æ–∫—ñ–≤ */
      .location-block {
          border: 3px solid #f39c12; 
          padding: 20px;
          margin-top: 25px;
          border-radius: 8px;
          background: #fff8eb;
      }
      .shift-details-container {
        border: 2px solid #3498db;
        padding: 20px;
        margin-top: 20px;
        border-radius: 8px;
        background: #ecf0f1;
      }
      .shift-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #bdc3c7;
      }
      .shift-header h3 {
        color: #2c3e50;
        margin: 0;
      }
      .team-member-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 50px;
        gap: 10px;
        margin-bottom: 5px;
        align-items: center;
      }
      .team-member-row button {
        padding: 5px;
        margin: 0;
      }
      .team-members-wrapper {
        border: 1px dashed #7f8c8d;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      .calculated-output {
        font-weight: bold;
        color: #2980b9;
      }
      
      label {
        display: block;
        margin: 12px 0 5px;
        font-weight: 600;
        color: #555;
      }
      input, select, textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #bdc3c7;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      input:focus, select:focus, textarea:focus {
        border-color: #3498db;
        outline: none;
      }
      button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        margin: 5px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .delete-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }
      .delete-btn:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
      }
      .edit-btn {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }
      .edit-btn:hover {
        background: linear-gradient(135deg, #e67e22, #d68910);
      }
      .clear-btn {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      }
      .refresh-btn {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        padding: 8px 16px;
        font-size: 14px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      th, td {
        padding: 8px 6px; /* –ó–º–µ–Ω—à–µ–Ω–æ padding –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—ñ */
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
        white-space: nowrap; 
        font-size: 14px; /* –ó–º–µ–Ω—à–µ–Ω–æ —à—Ä–∏—Ñ—Ç */
      }
      th {
        background: linear-gradient(135deg, #34495e, #2c3e50);
        color: white;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background: #f8f9fa;
      }
      tr:hover {
        background: #e8f4fd;
      }
      .error {
        color: #e74c3c;
        background: #fdf2f2;
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 4px solid #e74c3c;
      }
      .success {
        color: #27ae60;
        background: #f0f9f0;
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 4px solid #27ae60;
      }
      .hidden {
        display: none;
      }
      .loading {
        text-align: center;
        color: #7f8c8d;
        font-style: italic;
      }
      /* –°—Ç–∏–ª—ñ –¥–ª—è –±–ª–æ–∫—É —Å–æ–±—ñ–≤–∞—Ä—Ç–æ—Å—Ç—ñ */
      .summary-block {
          margin-top: 25px;
          padding: 15px;
          border: 1px solid #2980b9;
          border-radius: 6px;
          background: #d4eaf7;
      }
      .summary-block h4 {
          color: #2c3e50;
          margin-top: 0;
          border-bottom: 1px dashed #2980b9;
          padding-bottom: 5px;
      }
      .summary-item {
          display: flex;
          justify-content: space-between;
          padding: 3px 0;
      }
      .summary-item.total {
          font-weight: bold;
          font-size: 1.1em;
          color: #c0392b;
          border-top: 1px solid #c0392b;
          margin-top: 5px;
          padding-top: 5px;
      }
      /* –°—Ç–∏–ª—ñ –¥–ª—è –ü—Ä–æ–≥–Ω–æ–∑–Ω–∏—Ö –û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö –í–∏—Ç—Ä–∞—Ç */
      .op-cost-block {
          border: 1px dashed #27ae60;
          padding: 15px;
          border-radius: 6px;
          background: #e6f7e9;
          margin-bottom: 20px;
      }
      
      /* –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –ü—Ä–æ–≥–Ω–æ–∑ VS –§–∞–∫—Ç */
      .vs-row-plan {
          font-weight: bold;
          background-color: #f0f8ff; /* –°–≤—ñ—Ç–ª–æ-–±–ª–∞–∫–∏—Ç–Ω–∏–π –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É */
      }
      .vs-row-fact {
          color: #16a085; /* –ó–µ–ª–µ–Ω–∏–π –¥–ª—è —Ñ–∞–∫—Ç—É */
          font-weight: 600;
          border-top: 1px solid #bdc3c7;
      }
      .vs-profit {
          color: #c0392b;
      }

      /* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –†–Ü–ó–ù–ò–¶–¨ */
      .positive-diff {
        color: #27ae60;
        font-weight: bold;
      }
      .negative-diff {
        color: #e74c3c;
        font-weight: bold;
      }
      .zero-diff {
        color: #7f8c8d;
        font-style: italic;
      }

      /* –°–¢–ò–õ–Ü –î–õ–Ø –ó–í–ï–î–ï–ù–û–ì–û –ó–í–Ü–¢–£ –ü–û –°–ï–ó–û–ù–£ */
      .season-summary-report {
        border: 2px solid #2c3e50;
        padding: 20px;
        border-radius: 8px;
        background: #f7f9fb;
        margin-top: 30px;
      }
      .season-summary-report h3 {
        color: #2c3e50;
        border-bottom: 2px solid #e74c3c;
        padding-bottom: 10px;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 15px;
      }
      .summary-col-financial .summary-item {
        font-size: 1.1em;
        padding: 8px 0;
        border-bottom: 1px dashed #ccc;
      }
      .summary-col-cost .summary-item {
        font-size: 1em;
        padding: 5px 0;
      }
      .summary-col-financial .summary-item.total {
          color: #e74c3c;
          font-size: 1.3em;
          border-top: 2px solid #e74c3c;
          padding-top: 10px;
          margin-top: 10px;
      }
      .summary-col-cost h4 {
        color: #27ae60;
        margin-top: 0;
        border-bottom: 1px solid #27ae60;
        padding-bottom: 5px;
      }

      /* –ù–û–í–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ì–û –ü–†–û–ö–†–£–¢–ö–ò –¢–ê–ë–õ–ò–¶–Ü */
      .plans-container {
        overflow-x: auto;
        margin-top: 15px;
      }
      .plans-table-wrapper {
        min-width: 1200px; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ */
      }
      /* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –ê–ù–ê–õ–Ü–¢–ò–ß–ù–û–ì–û –î–ê–®–ë–û–†–î–£ */
  .analytics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  .kpi-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-align: center;
  }
  .kpi-title {
    font-size: 14px;
    color: #7f8c8d;
    margin-bottom: 10px;
  }
  .kpi-value {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
  }
  .kpi-diff {
    font-size: 12px;
    margin-top: 5px;
  }
  .season-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  .season-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
  }
  .season-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .season-name {
    font-weight: bold;
    color: #2c3e50;
  }
  .season-actions {
    display: flex;
    gap: 5px;
  }
  .metric-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    padding: 2px 0;
    border-bottom: 1px solid #ecf0f1;
  }
  .metric-label {
    font-size: 12px;
    color: #7f8c8d;
  }
  .metric-value {
    font-size: 12px;
    font-weight: bold;
  }
  .overall-kpi {
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
  }
  .kpi-item {
    text-align: center;
  }
  .kpi-label {
    font-size: 12px;
    color: #7f8c8d;
  }
  .kpi-number {
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
  }
  /* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –†–Ü–ó–ù–ò–¶–¨ */
  .positive-diff {
    color: #27ae60; /* –ó–µ–ª–µ–Ω–∏–π */
    font-weight: bold;
  }
  .negative-diff {
    color: #e74c3c; /* –ß–µ—Ä–≤–æ–Ω–∏–π */
    font-weight: bold;
  }
  .zero-diff {
    color: #7f8c8d;
    font-style: italic;
  }
  /* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê */
  .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); 
  }

  .modal-content {
      background-color: #fefefe;
      margin: 5% auto; /* 5% –≤—ñ–¥ –≤–µ—Ä—Ö—É —Ç–∞ —Ü–µ–Ω—Ç—Ä—É */
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 1200px; 
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
  }

  .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
  }

  .close-button:hover,
  .close-button:focus {
      color: #333;
      text-decoration: none;
      cursor: pointer;
  }

  .details-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
  }

  .details-section h4 {
      color: #3498db;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      margin-top: 0;
      margin-bottom: 15px;
  }

  .details-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
  }

  .details-table th, .details-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 13px;
  }

  .details-table th {
      background-color: #f2f2f2;
      color: #555;
      font-weight: 600;
  }

  .details-table .diff-cell {
      font-weight: bold;
  }

  /* –ù–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω–æ—ó –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó */
  .breakdown-table th {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: white;
  }
  .breakdown-table tr:nth-child(even) {
      background: #f8f9fa;
  }
  .breakdown-table tr:hover {
      background: #e8f4fd;
  }
  .category-group {
      background: #e8f4fd;
      font-weight: bold;
      border-left: 4px solid #3498db;
  }
    </style>
  </head>
  <body>
    <h1>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Å–µ–∑–æ–Ω—É</h1>
    <p class="subtitle">–î–æ–¥–∞–π –∞–±–æ —Ä–µ–¥–∞–≥—É–π –ø–ª–∞–Ω–∏ —Å–µ–∑–æ–Ω—ñ–≤ (–º–Ω–æ–∂–∏–Ω–∞ –ª–æ–∫–∞—Ü—ñ–π/–∑–º—ñ–Ω). –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –∞—Ä–∫—É—à–∞—Ö "Plans" —Ç–∞ "ShiftDetails". –§–∞–∫—Ç–∏—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –æ–±—á–∏—Å–ª—é—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑ –∞—Ä–∫—É—à–∞ "ShiftExpenses".</p>
    
    <div class="tabs-container">
      
      <button class="tab-btn" onclick="switchTab('list')">–Ü—Å–Ω—É—é—á—ñ –°–µ–∑–æ–Ω–∏ (–ü—Ä–æ–≥–Ω–æ–∑ VS –§–∞–∫—Ç)</button>
      <button class="tab-btn active" onclick="switchTab('add')">–î–æ–¥–∞—Ç–∏/–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –°–µ–∑–æ–Ω</button>
      
    </div>

    <div id="add-tab" class="tab-content active">
      <div class="form-section">
        <h2>–ó–∞–≥–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ —Å–µ–∑–æ–Ω—É —Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ üí∞</h2>
        <form id="planForm">
          <input type="hidden" id="planIndex" value="-1">
          <input type="hidden" id="opCostPerChild" value="0">
          <input type="hidden" id="totalChildren" value="0">

          <label for="planName">–ù–∞–∑–≤–∞ –°–µ–∑–æ–Ω—É:</label>
          <input type="text" id="planName" placeholder="e.g., –û—Å—ñ–Ω—å 2025" required>
          
          <div class="op-cost-block">
              <h3 style="margin-top: 0; color: #27ae60;">–ü—Ä–æ–≥–Ω–æ–∑–Ω—ñ –û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏ (–Ω–∞ –≤–µ—Å—å —Å–µ–∑–æ–Ω)</h3>
              <p class="subtitle" style="margin-bottom: 5px;">–¶—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –±—É–¥—É—Ç—å —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω—ñ –Ω–∞ –≤—Å—ñ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ –ø—É—Ç—ñ–≤–∫–∏.</p>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div>
                  <label for="advertisingCost">–†–µ–∫–ª–∞–º–∞ (–≥—Ä–Ω):</label>
                  <input type="number" id="advertisingCost" class="op-cost-input" step="0.01" value="0" required>
                </div>
                <div>
                  <label for="salesManagerCost">–û–ø–ª–∞—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤ (–≥—Ä–Ω):</label>
                  <input type="number" id="salesManagerCost" class="op-cost-input" step="0.01" value="0" required>
                </div>
                <div>
                  <label for="seasonLaunchCost">–ó–∞–ø—É—Å–∫ —Å–µ–∑–æ–Ω—É (–≥—Ä–Ω):</label>
                  <input type="number" id="seasonLaunchCost" class="op-cost-input" step="0.01" value="0" required>
                </div>
              </div>
          </div>
          
          <hr>
          <h2>–î–µ—Ç–∞–ª—ñ –ª–æ–∫–∞—Ü—ñ–π —Ç–∞ –∑–º—ñ–Ω üèïÔ∏è</h2>
          <div id="locationsContainer">
            </div>
          <button type="button" onclick="addLocationBlock()">+ –î–æ–¥–∞—Ç–∏ –õ–æ–∫–∞—Ü—ñ—é</button>

          <hr>
          
          <div class="season-summary-report">
            <h3>üìà –ó–≤–µ–¥–µ–Ω–∏–π –ó–≤—ñ—Ç –ø–æ –°–µ–∑–æ–Ω—É (–ü—Ä–æ–≥–Ω–æ–∑)</h3>
            <div class="summary-grid">
              
              <div class="summary-col-financial">
                <h4>–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –ü–æ–∫–∞–∑–Ω–∏–∫–∏:</h4>
                <div class="summary-item">
                    <span>–ó–∞–≥–∞–ª—å–Ω–∏–π –î–æ—Ö—ñ–¥ (–ü—Ä–æ–≥–Ω–æ–∑):</span>
                    <span id="totalRevenueDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                
                <h4 style="margin-top: 15px; color: #3498db; border-bottom: 1px dashed #3498db; padding-bottom: 5px;">
                    –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ü—Ä—è–º–∏—Ö –í–∏—Ç—Ä–∞—Ç:
                </h4>
                <div style="padding-left: 10px;">
                    <div class="summary-item">
                        <span>–ó–ü –∫–æ–º–∞–Ω–¥–∏ (–°–µ–∑–æ–Ω):</span>
                        <span id="aggSalaryCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                    </div>
                    <div class="summary-item">
                        <span>–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ (–°–µ–∑–æ–Ω):</span>
                        <span id="aggLivingTeamCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                    </div>
                    <div class="summary-item">
                        <span>–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π (–°–µ–∑–æ–Ω):</span>
                        <span id="aggFoodChildCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                    </div>
                    <div class="summary-item">
                        <span>–ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ (–°–µ–∑–æ–Ω):</span>
                        <span id="aggProgramExtraCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                    </div>
                </div>
                <div class="summary-item" style="border-top: 1px solid #ccc; font-weight: bold; margin-top: 5px; padding-top: 5px;">
                    <span>‚úÖ –í–°–¨–û–ì–û –ü—Ä—è–º—ñ –í–∏—Ç—Ä–∞—Ç–∏:</span>
                    <span id="totalDirectCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>

                <div class="summary-item">
                    <span>–ó–∞–≥–∞–ª—å–Ω—ñ –û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏:</span>
                    <span id="totalOpCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item">
                    <span>–í–°–¨–û–ì–û –í–∏—Ç—Ä–∞—Ç (–ü—Ä—è–º—ñ + –û–ø–µ—Ä.):</span>
                    <span id="totalCostDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item total">
                    <span>–ß–∏—Å—Ç–∏–π –ü—Ä–∏–±—É—Ç–æ–∫ (–ü—Ä–æ–≥–Ω–æ–∑):</span>
                    <span id="totalProfitDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item total" style="color: #2980b9; border-color: #2980b9;">
                    <span>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å (–ü—Ä–∏–±—É—Ç–æ–∫/–î–æ—Ö—ñ–¥):</span>
                    <span id="profitMarginDisplay" class="calculated-output">0.00%</span>
                </div>
              </div>
              
              <div class="summary-col-cost">
                <h4>–°–µ—Ä–µ–¥–Ω—è —Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏ –ø–æ –¢–∞–±–æ—Ä—É:</h4>
                <div class="summary-item">
                    <span>–ó–ü –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                    <span id="avgSalaryPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item">
                    <span>–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                    <span id="avgLivingTeamPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item">
                    <span>–•–∞—Ä—á—É–≤–∞–Ω–Ω—è (–¥–∏—Ç–∏–Ω–∞):</span> 
                    <span id="avgFoodChildPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item">
                    <span>–ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                    <span id="avgOtherCostPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item total">
                    <span>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏ (–ë–µ–∑ –û–ø–µ—Ä. –í–∏—Ç—Ä–∞—Ç):</span> 
                    <span id="avgCostPriceNoOpCost" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item total" style="color: #27ae60; border-color: #27ae60;">
                    <span>–ß–∞—Å—Ç–∫–∞ –û–ø–µ—Ä. –í–∏—Ç—Ä–∞—Ç –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                    <span id="opCostPerChildDisplay" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
                <div class="summary-item total" style="color: #f39c12; border-color: #f39c12;">
                    <span>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏ (–ó –û–ø–µ—Ä. –í–∏—Ç—Ä–∞—Ç–∞–º–∏):</span> 
                    <span id="avgCostPriceWithOpCost" class="calculated-output">0.00 –≥—Ä–Ω</span>
                </div>
              </div>

              <div class="summary-col-info">
                  <h4>–î–æ–¥–∞—Ç–∫–æ–≤–∞ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</h4>
                  <div class="summary-item">
                      <span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –¥—ñ—Ç–µ–π:</span>
                      <span id="totalChildrenDisplay" class="calculated-output">0</span>
                  </div>
                  <div class="summary-item">
                      <span>–°–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏:</span>
                      <span id="avgRevenuePerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
                  </div>
              </div>

            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <button type="submit" id="submitBtn">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–ª–∞–Ω —Å–µ–∑–æ–Ω—É</button>
            <button type="button" class="clear-btn" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
          </div>
        </form>
        <div id="formResult"></div>
      </div>
    </div>

    <div id="list-tab" class="tab-content">
        <div class="table-section">
          <h2>–Ü—Å–Ω—É—é—á—ñ –°–µ–∑–æ–Ω–∏ (–ü—Ä–æ–≥–Ω–æ–∑ VS –§–∞–∫—Ç) üìä</h2>
          <p class="subtitle">–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø–ª–∞–Ω—É —Ç–∞ —Ñ–∞–∫—Ç—É. –†—ñ–∑–Ω–∏—Ü—ñ –≤–∏–¥—ñ–ª–µ–Ω—ñ –∫–æ–ª—å–æ—Ä–æ–º: –∑–µ–ª–µ–Ω–∏–π ‚Äî –ø–æ–∑–∏—Ç–∏–≤–Ω–∞ (—Ñ–∞–∫—Ç > –ø–ª–∞–Ω), —á–µ—Ä–≤–æ–Ω–∏–π ‚Äî –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞ (—Ñ–∞–∫—Ç < –ø–ª–∞–Ω).</p>
          <button class="refresh-btn" onclick="loadPlans()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
          <div id="spinnerPlanner" class="loading" style="display:none;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

          <div class="overall-kpi" id="overallKpiDisplay" style="display: none;">
            </div>
          
          <div class="analytics-dashboard" id="analyticsDashboard" style="display: none;">
            </div>
          
          <h3 style="margin-top: 30px; color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px;">–î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ –°–µ–∑–æ–Ω–∞—Ö</h3>
          
          <div class="season-cards" id="seasonCardsContainer">
              </div>

          <div id="tableResult"></div>
        </div>
      </div>

    <script>
      let currentPlanName = '';
      let locationCount = 0;
      let shiftCount = 0; 
      let actualsData = {}; 
      let seasonsData = []; // –ù–æ–≤–∏–π –≥–ª–æ–±–∞–ª—å–Ω–∏–π –º–∞—Å–∏–≤ –¥–ª—è –¥–∞–Ω–∏—Ö —Å–µ–∑–æ–Ω—ñ–≤

      window.onload = function() {
        google.script.run.setupSheets(); 
        loadPlans();
        addLocationBlock();
        
        document.getElementById('planForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('planForm').addEventListener('input', updateOverallCalculatedFields);
        document.querySelectorAll('.op-cost-input').forEach(input => {
            input.addEventListener('input', updateOverallCalculatedFields);
        });
      };

      // ====================================================================
      // UI / TAB MANAGEMENT
      // ====================================================================

      function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabName + '-tab').classList.add('active');
        document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
        
        if (tabName === 'list') {
          loadPlans();
        }
      }

      function clearForm() {
        document.getElementById('planForm').reset();
        document.getElementById('planIndex').value = -1;
        document.getElementById('submitBtn').textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–ª–∞–Ω —Å–µ–∑–æ–Ω—É';
        document.getElementById('formResult').innerHTML = '';
        currentPlanName = '';
        document.getElementById('opCostPerChild').value = 0;
        document.getElementById('totalChildren').value = 0;


        document.getElementById('locationsContainer').innerHTML = '';
        locationCount = 0;
        shiftCount = 0;
        addLocationBlock();
        
        updateOverallCalculatedFields();
      }

      // ====================================================================
      // DYNAMIC LOCATION AND SHIFT MANAGEMENT 
      // ====================================================================
      
      function addLocationBlock(locationName = '', numberOfShifts = 1, shiftDetails = []) {
          locationCount++;
          const container = document.getElementById('locationsContainer');
          const locationId = `location-${Date.now()}-${locationCount}`;
          
          const block = document.createElement('div');
          block.className = 'location-block';
          block.setAttribute('data-location-id', locationId);
          
          block.innerHTML = `
              <div class="shift-header">
                  <h3>–õ–æ–∫–∞—Ü—ñ—è #${locationCount}</h3>
                  <button type="button" class="delete-btn" onclick="removeLocationBlock('${locationId}')">–í–∏–¥–∞–ª–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é</button>
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                  <div>
                      <label for="${locationId}-locationName">–ù–∞–∑–≤–∞ –õ–æ–∫–∞—Ü—ñ—ó:</label>
                      <input type="text" id="${locationId}-locationName" class="location-name" placeholder="e.g., –ü—É—Ç–∏–ª–∞" value="${escapeHtml(locationName)}" oninput="updateShiftHeaders('${locationId}'); updateOverallCalculatedFields();" required>
                  </div>
                  <div>
                      <label for="${locationId}-numberOfShifts">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ó–º—ñ–Ω –Ω–∞ –õ–æ–∫–∞—Ü—ñ—ó:</label>
                      <input type="number" id="${locationId}-numberOfShifts" class="number-of-shifts" min="1" value="${numberOfShifts}" onchange="regenerateShifts('${locationId}', this.value)" required>
                  </div>
              </div>
              
              <h4 style="margin-top: 20px;">–î–µ—Ç–∞–ª—ñ ${numberOfShifts} –∑–º—ñ–Ω:</h4>
              <div class="shifts-container" id="${locationId}-shiftsContainer">
                  </div>
          `;
          container.appendChild(block);
          
          regenerateShifts(locationId, numberOfShifts, shiftDetails);
      }
      
      function removeLocationBlock(locationId) {
          document.querySelector(`.location-block[data-location-id="${locationId}"]`).remove();
          updateOverallCalculatedFields();
      }

      function regenerateShifts(locationId, count, shiftDetails = []) {
          const container = document.getElementById(`${locationId}-shiftsContainer`);
          container.innerHTML = '';
          const locationName = document.getElementById(`${locationId}-locationName`).value.trim();

          const actualCount = parseInt(count) || 0;
          
          for (let i = 0; i < actualCount; i++) {
              const shiftData = shiftDetails[i] || null; 
              const defaultShiftName = `${locationName || '–ó–º—ñ–Ω–∞'} ${i + 1}`; 
              
              addShiftBlockDetail(container, locationName, i + 1, shiftData, defaultShiftName);
          }
          updateOverallCalculatedFields();
      }
      
      function updateShiftHeaders(locationId) {
          const locationName = document.getElementById(`${locationId}-locationName`).value.trim();
          const shifts = document.getElementById(`${locationId}-shiftsContainer`).querySelectorAll('.shift-details-container');
          
          shifts.forEach((shiftBlock, index) => {
              const shiftNumber = index + 1;
              const shiftNameInput = shiftBlock.querySelector('.shift-name');
              // –û–Ω–æ–≤–ª—é—î–º–æ, –ª–∏—à–µ —è–∫—â–æ –ø–æ–ª–µ –Ω–µ —Ä–µ–¥–∞–≥—É–≤–∞–ª–æ—Å—è –≤—Ä—É—á–Ω—É
              if (!shiftNameInput.classList.contains('manually-edited')) {
                  shiftNameInput.value = `${locationName || '–ó–º—ñ–Ω–∞'} ${shiftNumber}`;
              }
              shiftBlock.querySelector('.shift-header h3').textContent = `${locationName || '–õ–æ–∫–∞—Ü—ñ—è'} - –ó–º—ñ–Ω–∞ ${shiftNumber}`;
          });
          updateOverallCalculatedFields();
      }
      
      function addShiftBlockDetail(container, locationName, shiftNumber, shift = null, defaultShiftName) {
        shiftCount++;
        const shiftId = `shift-${shiftCount}`;

        const block = document.createElement('div');
        block.className = 'shift-details-container';
        block.setAttribute('data-shift-id', shiftId);
        block.setAttribute('data-location-name', locationName);

        const isManuallyEdited = shift && shift.shiftName !== defaultShiftName;
        const manualClass = isManuallyEdited ? 'manually-edited' : '';

        // –í–ê–ñ–õ–ò–í–û: ProgramCost —Ç–∞ ExtraCost —Ç–µ–ø–µ—Ä –≤–≤–∞–∂–∞—é—Ç—å—Å—è "–Ω–∞ –¥–∏—Ç–∏–Ω—É"
        const programCostValue = shift ? shift.programCost : 0;
        const extraCostValue = shift ? shift.extraCost : 0;
        
        block.innerHTML = `
          <div class="shift-header">
            <h3>${locationName || '–õ–æ–∫–∞—Ü—ñ—è'} - –ó–º—ñ–Ω–∞ ${shiftNumber}</h3>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div>
              <label for="${shiftId}-shiftName">–ù–∞–∑–≤–∞ –ó–º—ñ–Ω–∏ (–¥–ª—è –∑–≤—ñ—Ç–Ω–æ—Å—Ç—ñ):</label>
              <input type="text" id="${shiftId}-shiftName" class="shift-name ${manualClass}" placeholder="e.g., –ü—É—Ç–∏–ª–∞ 1" value="${shift ? escapeHtml(shift.shiftName) : defaultShiftName}" 
              oninput="this.classList.add('manually-edited'); updateOverallCalculatedFields()" required>
            </div>
            <div>
              <label for="${shiftId}-location">–õ–æ–∫–∞—Ü—ñ—è (–∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞):</label>
              <input type="text" id="${shiftId}-location" class="location" value="${escapeHtml(locationName)}" disabled>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <div>
              <label for="${shiftId}-shiftFee">–ü–ª–∞—Ç–∞ –∑–∞ –∑–º—ñ–Ω—É (–≥—Ä–Ω):</label>
              <input type="number" id="${shiftId}-shiftFee" class="shift-fee" step="0.01" value="${shift ? shift.shiftFee : 0}" required>
            </div>
            <div>
              <label for="${shiftId}-shiftCount">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω (–æ–¥.):</label>
              <input type="number" id="${shiftId}-shiftCount" class="shift-count" value="${shift ? shift.shiftCount : 1}" required>
            </div>
            <div>
              <label for="${shiftId}-avgChildren">–°–µ—Ä–µ–¥–Ω—è –∫-—Å—Ç—å –¥—ñ—Ç–µ–π:</label>
              <input type="number" id="${shiftId}-avgChildren" class="avg-children" value="${shift ? shift.avgChildren : 0}" required>
            </div>
            <div>
              <label for="${shiftId}-livingDays">–ö-—Å—Ç—å –¥–Ω—ñ–≤ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è:</label>
              <input type="number" id="${shiftId}-livingDays" class="living-days" value="${shift ? shift.livingDays : 1}" required>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <div>
              <label for="${shiftId}-foodPricePerDay">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è 1 –¥–µ–Ω—å (–≥—Ä–Ω):</label>
              <input type="number" id="${shiftId}-foodPricePerDay" class="food-price" step="0.01" value="${shift ? shift.foodPricePerDay : 0}" required>
            </div>
            <div>
              <label for="${shiftId}-programCost">–ü—Ä–æ–≥—Ä–∞–º–∞ (–≥—Ä–Ω/–¥–∏—Ç–∏–Ω–∞):</label>
              <input type="number" id="${shiftId}-programCost" class="program-cost" step="0.01" value="${programCostValue}" required>
            </div>
            <div>
              <label for="${shiftId}-extraCost">–î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä–Ω/–¥–∏—Ç–∏–Ω–∞):</label>
              <input type="number" id="${shiftId}-extraCost" class="extra-cost" step="0.01" value="${extraCostValue}" required>
            </div>
            <div>
              <label for="${shiftId}-discountPercent">–ó–Ω–∏–∂–∫–∞ (%):</label>
              <input type="number" id="${shiftId}-discountPercent" class="discount-percent" min="0" max="100" step="0.01" value="${shift ? shift.discountPercent : 0}" required>
            </div>
          </div>
          
          <label for="${shiftId}-discountChildrenCount">–ö-—Å—Ç—å –¥—ñ—Ç–µ–π –∑—ñ –∑–Ω–∏–∂–∫–æ—é (–Ω–∞ –æ–¥–Ω—É –∑–º—ñ–Ω—É):</label>
          <input type="number" id="${shiftId}-discountChildrenCount" class="discount-children-count" min="0" step="1" value="${shift ? shift.discountChildrenCount : 0}" required>

          <h4 style="margin-top: 20px;">–°–∫–ª–∞–¥ –∫–æ–º–∞–Ω–¥–∏ (–ó–ü –∑–∞ –≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥ –∑–º—ñ–Ω–∏)</h4>
          <div class="team-members-wrapper" id="${shiftId}-teamMembersContainer">
            </div>
          <button type="button" onclick="addTeamMemberRow('${shiftId}-teamMembersContainer', null)">–î–æ–¥–∞—Ç–∏ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞</button>
          
          <div class="summary-block">
              <h4>üìä –î–µ—Ç–∞–ª—å–Ω–∏–π –ó–≤—ñ—Ç –Ω–∞ 1 –î–∏—Ç–∏–Ω—É (–∑–∞ 1 –∑–º—ñ–Ω—É)</h4>
              <div class="summary-item">
                  <span>–ó–ü –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                  <span id="${shiftId}-salaryPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
              </div>
              <div class="summary-item">
                  <span>–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                  <span id="${shiftId}-livingTeamPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
              </div>
              <div class="summary-item">
                  <span>–•–∞—Ä—á—É–≤–∞–Ω–Ω—è (–¥–∏—Ç–∏–Ω–∞):</span> 
                  <span id="${shiftId}-foodChildPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
              </div>
              <div class="summary-item">
                  <span>–ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É:</span> 
                  <span id="${shiftId}-otherCostPerChild" class="calculated-output">0.00 –≥—Ä–Ω</span>
              </div>
              <div class="summary-item total">
                  <span>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏ (–ë–µ–∑ –û–ø–µ—Ä. –í–∏—Ç—Ä–∞—Ç):</span> 
                  <span id="${shiftId}-costPriceNoOpCost" class="calculated-output">0.00 –≥—Ä–Ω</span>
              </div>
              <div class="summary-item total" style="color: #27ae60;">
                  <span>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏ (–ó –ü—Ä–æ–≥–Ω–æ–∑–Ω–æ—é –ß–∞—Å—Ç–∫–æ—é –û–ø–µ—Ä. –í–∏—Ç—Ä–∞—Ç):</span> 
                  <span id="${shiftId}-costPriceWithOpCost" class="calculated-output">0.00 –≥—Ä–Ω</span>
              </div>
          </div>
        `;

        container.appendChild(block);

        if (!shift) {
          addDefaultTeamMembers(shiftId + '-teamMembersContainer');
        } else {
          shift.teamMembers.forEach(member => addTeamMemberRow(shiftId + '-teamMembersContainer', member));
        }

        block.querySelectorAll('input').forEach(input => {
            if (input.id !== `${shiftId}-location`) {
                input.addEventListener('input', updateOverallCalculatedFields);
            }
        });
        
        updateOverallCalculatedFields();
      }
      
      function addDefaultTeamMembers(containerId) {
        const defaults = [
          { position: "–î–∏—Ä–µ–∫—Ç–æ—Ä", salary: 20000, count: 1 },
          { position: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä", salary: 17500, count: 1 },
          { position: "–°–∞–ø–æ—Ä—Ç", salary: 10000, count: 1 },
          { position: "–¢—ñ–º–ª—ñ–¥–µ—Ä", salary: 5000, count: 1 },
          { position: "–ú–µ–¥–∏–∫", salary: 10000, count: 1 },
          { position: "–§–æ—Ç–æ–≥—Ä–∞—Ñ", salary: 10000, count: 1 }
        ];
        defaults.forEach(member => addTeamMemberRow(containerId, member));
      }
      
      function addTeamMemberRow(containerId, member = null) {
        const container = document.getElementById(containerId);
        const row = document.createElement('div');
        row.className = 'team-member-row';

        const initialPosition = member && member.position ? member.position : '';
        const initialSalary = member && member.salary ? member.salary : '';
        const initialCount = member && member.count ? member.count : '';

        row.innerHTML = `
          <input type="text" class="position" placeholder="–ü–æ—Å–∞–¥–∞ (e.g., –î–∏—Ä–µ–∫—Ç–æ—Ä)" value="${escapeHtml(initialPosition)}">
          <input type="number" class="salary" placeholder="–ó–ü –∑–∞ –∑–º—ñ–Ω—É (–≥—Ä–Ω)" min="0" step="0.01" value="${initialSalary}">
          <input type="number" class="count" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å" min="1" step="1" value="${initialCount}">
          <button type="button" class="delete-btn" onclick="removeTeamMemberRow(this)">X</button>
        `;
        container.appendChild(row);
        
        row.querySelectorAll('input').forEach(input => input.addEventListener('input', updateOverallCalculatedFields));
        updateOverallCalculatedFields();
      }
      
      function removeTeamMemberRow(button) {
        button.parentElement.remove();
        updateOverallCalculatedFields();
      }

      // ====================================================================
      // CALCULATIONS AND UI UPDATE
      // ====================================================================

      function getShiftData(shiftBlock) {
        const locationName = shiftBlock.closest('.location-block').querySelector('.location-name').value;
        const shiftId = shiftBlock.getAttribute('data-shift-id');
        
        const shiftFee = parseFloat(shiftBlock.querySelector('.shift-fee').value) || 0;
        const shiftCount = parseInt(shiftBlock.querySelector('.shift-count').value) || 1;
        const avgChildren = parseInt(shiftBlock.querySelector('.avg-children').value) || 0;
        const livingDays = parseInt(shiftBlock.querySelector('.living-days').value) || 1;
        
        // –í–ê–ñ–õ–ò–í–û: –¶—ñ –ø–æ–ª—è —Ç–µ–ø–µ—Ä –≤–≤–∞–∂–∞—é—Ç—å—Å—è –í–ò–¢–†–ê–¢–ê–ú–ò –ù–ê –î–ò–¢–ò–ù–£
        const foodPricePerDay = parseFloat(shiftBlock.querySelector('.food-price').value) || 0;
        const programCostPerChild = parseFloat(shiftBlock.querySelector('.program-cost').value) || 0;
        const extraCostPerChild = parseFloat(shiftBlock.querySelector('.extra-cost').value) || 0;
        
        const discountPercent = parseFloat(shiftBlock.querySelector('.discount-percent').value) || 0;
        const discountChildrenCount = parseInt(shiftBlock.querySelector('.discount-children-count').value) || 0;
        
        const totalChildrenInShift = avgChildren;
        const totalChildren = shiftCount * totalChildrenInShift;

        const teamMembers = [];
        const teamMembersContainer = shiftBlock.querySelector('.team-members-wrapper');
        if (teamMembersContainer) {
          teamMembersContainer.querySelectorAll('.team-member-row').forEach(row => {
            const position = row.querySelector('.position').value.trim();
            const salary = parseFloat(row.querySelector('.salary').value) || 0;
            const count = parseInt(row.querySelector('.count').value) || 0;
            if (position && salary > 0 && count > 0) {
              teamMembers.push({ position, salary, count });
            }
          });
        }
        
        const totalTeamCount = teamMembers.reduce((sum, member) => sum + member.count, 0);
        const totalTeamSalaryPerShift = teamMembers.reduce((sum, member) => sum + member.salary * member.count, 0); 

        // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –Ω–∞ –û–î–ù–£ –∑–º—ñ–Ω—É
        const teamLivingCostPerShift = foodPricePerDay * livingDays * totalTeamCount; 
        const childLivingCostPerShift = foodPricePerDay * livingDays; 
        
        // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –≤–∏—Ç—Ä–∞—Ç –Ω–∞ –¥–∏—Ç–∏–Ω—É (–∑–∞ 1 –∑–º—ñ–Ω—É)
        const teamSalaryPerChild = totalChildrenInShift > 0 ? totalTeamSalaryPerShift / totalChildrenInShift : 0;
        const teamLivingCostPerChild = totalChildrenInShift > 0 ? teamLivingCostPerShift / totalChildrenInShift : 0;
        
        // –ù–û–í–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö: –ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É = –≤–≤–µ–¥–µ–Ω—ñ —Å—É–º–∏ (–Ω–∞ –¥–∏—Ç–∏–Ω—É)
        const otherCostPerChild = programCostPerChild + extraCostPerChild; 
        
        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–æ—Ö–æ–¥—É (–∑–∞ –≤—Å—ñ –∑–º—ñ–Ω–∏)
        const fullPriceChildren = Math.max(0, totalChildrenInShift - discountChildrenCount);
        const discountedChildren = Math.min(totalChildrenInShift, discountChildrenCount);
        const effectiveDiscount = (discountPercent / 100) * shiftFee;
        
        const revenuePerShift = (fullPriceChildren * shiftFee) + (discountedChildren * (shiftFee - effectiveDiscount));
        const totalRevenue = revenuePerShift * shiftCount; 
        
        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø—Ä—è–º–∏—Ö –≤–∏—Ç—Ä–∞—Ç (–∑–∞ –≤—Å—ñ –∑–º—ñ–Ω–∏)
        const totalTeamSalaryCost = totalTeamSalaryPerShift * shiftCount; // –í—Å—å–æ–≥–æ –ó–ü –∫–æ–º–∞–Ω–¥–∏ –∑–∞ –≤—Å—ñ –∑–º—ñ–Ω–∏
        const totalTeamLivingCost = teamLivingCostPerShift * shiftCount; // –í—Å—å–æ–≥–æ –ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ –∑–∞ –≤—Å—ñ –∑–º—ñ–Ω–∏
        const totalChildFoodCost = childLivingCostPerShift * totalChildren; // –í—Å—å–æ–≥–æ –•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π –∑–∞ –≤—Å—ñ –∑–º—ñ–Ω–∏

        // –ù–û–í–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö: –ó–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ = (–≤–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞ –¥–∏—Ç–∏–Ω—É) * (–∑–∞–≥–∞–ª—å–Ω–∞ –∫-—Å—Ç—å –¥—ñ—Ç–µ–π)
        const totalProgramCost = programCostPerChild * totalChildren; 
        const totalExtraCost = extraCostPerChild * totalChildren; 
        const totalProgramAndExtraCost = totalProgramCost + totalExtraCost;

        const totalDirectCost = totalTeamSalaryCost + totalTeamLivingCost + totalChildFoodCost + totalProgramAndExtraCost;

        // –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å
        const costPriceNoOpCost = teamSalaryPerChild + teamLivingCostPerChild + childLivingCostPerShift + otherCostPerChild;

        return {
          shiftName: shiftBlock.querySelector('.shift-name').value.trim(),
          location: locationName,
          shiftFee: shiftFee,
          shiftCount: shiftCount,
          avgChildren: totalChildrenInShift,
          livingDays: livingDays,
          foodPricePerDay: foodPricePerDay,
          programCost: programCostPerChild, // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ per child –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
          extraCost: extraCostPerChild,     // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ per child –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
          discountPercent: discountPercent,
          discountChildrenCount: discountChildrenCount,
          teamMembers: teamMembers,
          teamSalaryPerChild: teamSalaryPerChild,
          teamLivingCostPerChild: teamLivingCostPerChild,
          childLivingCostPerShift: childLivingCostPerShift,
          otherCostPerChild: otherCostPerChild,
          costPriceNoOpCost: costPriceNoOpCost,
          shiftId: shiftId,
          totalRevenue: totalRevenue,
          totalDirectCost: totalDirectCost,
          totalChildren: totalChildren,
          // –î–æ–¥–∞—î–º–æ –ø—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ —Å–µ–∑–æ–Ω (–¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó –∑–∞–≥–∞–ª—å–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç)
          totalTeamSalaryCost: totalTeamSalaryCost,
          totalTeamLivingCost: totalTeamLivingCost,
          totalChildFoodCost: totalChildFoodCost,
          totalProgramAndExtraCost: totalProgramAndExtraCost,
        };
      }

      function updateOverallCalculatedFields() {
        const shiftBlocks = document.querySelectorAll('.shift-details-container');
        let aggregatedRevenue = 0;
        let aggregatedDirectCost = 0;
        let aggregatedTotalChildren = 0;
        
        // –î–ª—è —Å–µ—Ä–µ–¥–Ω—å–æ—ó —Å–æ–±—ñ–≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø–æ —Ç–∞–±–æ—Ä—É —Ç–∞ –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—Ä—è–º–∏—Ö –≤–∏—Ç—Ä–∞—Ç
        let aggregatedSalaryCost = 0;
        let aggregatedLivingTeamCost = 0;
        let aggregatedFoodChildCost = 0;
        let aggregatedProgramExtraCost = 0;
        

        shiftBlocks.forEach(shiftBlock => {
          const data = getShiftData(shiftBlock);
          aggregatedRevenue += data.totalRevenue;
          aggregatedDirectCost += data.totalDirectCost;
          aggregatedTotalChildren += data.totalChildren;
          
          // –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –¥–ª—è –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—Ä—è–º–∏—Ö –≤–∏—Ç—Ä–∞—Ç
          aggregatedSalaryCost += data.totalTeamSalaryCost;
          aggregatedLivingTeamCost += data.totalTeamLivingCost;
          aggregatedFoodChildCost += data.totalChildFoodCost;
          aggregatedProgramExtraCost += data.totalProgramAndExtraCost;
        });

        const advertisingCost = parseFloat(document.getElementById('advertisingCost').value) || 0;
        const salesManagerCost = parseFloat(document.getElementById('salesManagerCost').value) || 0;
        const seasonLaunchCost = parseFloat(document.getElementById('seasonLaunchCost').value) || 0;
        
        const totalSeasonOpCost = advertisingCost + salesManagerCost + seasonLaunchCost;
        const totalSeasonCost = aggregatedDirectCost + totalSeasonOpCost;
        const totalProfit = aggregatedRevenue - totalSeasonCost;
        const profitMargin = aggregatedRevenue > 0 ? (totalProfit / aggregatedRevenue) * 100 : 0;
        
        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —á–∞—Å—Ç–∫–∏ –û–ø–µ—Ä. –í–∏—Ç—Ä–∞—Ç –Ω–∞ –æ–¥–Ω—É –¥–∏—Ç–∏–Ω—É
        const opCostPerChild = aggregatedTotalChildren > 0 ? totalSeasonOpCost / aggregatedTotalChildren : 0;
        document.getElementById('opCostPerChild').value = opCostPerChild; 
        document.getElementById('totalChildren').value = aggregatedTotalChildren;
        
        // –†–û–ó–†–ê–•–£–ù–û–ö –°–ï–†–ï–î–ù–¨–û–á –°–û–ë–Ü–í–ê–†–¢–û–°–¢–Ü –ü–û –¢–ê–ë–û–†–£
        const avgSalaryPerChild = aggregatedTotalChildren > 0 ? aggregatedSalaryCost / aggregatedTotalChildren : 0;
        const avgLivingTeamPerChild = aggregatedTotalChildren > 0 ? aggregatedLivingTeamCost / aggregatedTotalChildren : 0;
        const avgFoodChildPerChild = aggregatedTotalChildren > 0 ? aggregatedFoodChildCost / aggregatedTotalChildren : 0;
        const avgOtherCostPerChild = aggregatedTotalChildren > 0 ? aggregatedProgramExtraCost / aggregatedTotalChildren : 0;
        const avgCostPriceNoOpCost = avgSalaryPerChild + avgLivingTeamPerChild + avgFoodChildPerChild + avgOtherCostPerChild;
        const avgCostPriceWithOpCost = avgCostPriceNoOpCost + opCostPerChild;
        const avgRevenuePerChild = aggregatedTotalChildren > 0 ? aggregatedRevenue / aggregatedTotalChildren : 0;


        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–∏—Ö –∑–≤—ñ—Ç—ñ–≤ –ø–æ –∑–º—ñ–Ω–∞—Ö
        shiftBlocks.forEach(shiftBlock => {
            const data = getShiftData(shiftBlock);
            const costPriceWithOpCost = data.costPriceNoOpCost + opCostPerChild;

            if (document.getElementById(`${data.shiftId}-salaryPerChild`)) {
                document.getElementById(`${data.shiftId}-salaryPerChild`).textContent = `${formatCurrency(data.teamSalaryPerChild)} –≥—Ä–Ω`;
                document.getElementById(`${data.shiftId}-livingTeamPerChild`).textContent = `${formatCurrency(data.teamLivingCostPerChild)} –≥—Ä–Ω`;
                document.getElementById(`${data.shiftId}-foodChildPerChild`).textContent = `${formatCurrency(data.childLivingCostPerShift)} –≥—Ä–Ω`;
                document.getElementById(`${data.shiftId}-otherCostPerChild`).textContent = `${formatCurrency(data.otherCostPerChild)} –≥—Ä–Ω`;
                document.getElementById(`${data.shiftId}-costPriceNoOpCost`).textContent = `${formatCurrency(data.costPriceNoOpCost)} –≥—Ä–Ω`;
                document.getElementById(`${data.shiftId}-costPriceWithOpCost`).textContent = `${formatCurrency(costPriceWithOpCost)} –≥—Ä–Ω`;
            }
        });

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ (–ù–û–í–ò–ô –î–ï–¢–ê–õ–¨–ù–ò–ô –ë–õ–û–ö)
        document.getElementById('totalRevenueDisplay').textContent = `${formatCurrency(aggregatedRevenue)} –≥—Ä–Ω`;
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—Ä—è–º–∏—Ö –≤–∏—Ç—Ä–∞—Ç
        document.getElementById('aggSalaryCostDisplay').textContent = `${formatCurrency(aggregatedSalaryCost)} –≥—Ä–Ω`;
        document.getElementById('aggLivingTeamCostDisplay').textContent = `${formatCurrency(aggregatedLivingTeamCost)} –≥—Ä–Ω`;
        document.getElementById('aggFoodChildCostDisplay').textContent = `${formatCurrency(aggregatedFoodChildCost)} –≥—Ä–Ω`;
        document.getElementById('aggProgramExtraCostDisplay').textContent = `${formatCurrency(aggregatedProgramExtraCost)} –≥—Ä–Ω`;
        
        // –û—Å–Ω–æ–≤–Ω—ñ –ø—ñ–¥—Å—É–º–∫–∏
        document.getElementById('totalDirectCostDisplay').textContent = `${formatCurrency(aggregatedDirectCost)} –≥—Ä–Ω`;
        document.getElementById('totalOpCostDisplay').textContent = `${formatCurrency(totalSeasonOpCost)} –≥—Ä–Ω`;
        document.getElementById('totalCostDisplay').textContent = `${formatCurrency(totalSeasonCost)} –≥—Ä–Ω`;
        document.getElementById('totalProfitDisplay').textContent = `${formatCurrency(totalProfit)} –≥—Ä–Ω`;
        document.getElementById('profitMarginDisplay').textContent = `${profitMargin.toFixed(2)}%`;
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–Ω—ñ—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤
        document.getElementById('avgSalaryPerChild').textContent = `${formatCurrency(avgSalaryPerChild)} –≥—Ä–Ω`;
        document.getElementById('avgLivingTeamPerChild').textContent = `${formatCurrency(avgLivingTeamPerChild)} –≥—Ä–Ω`;
        document.getElementById('avgFoodChildPerChild').textContent = `${formatCurrency(avgFoodChildPerChild)} –≥—Ä–Ω`;
        document.getElementById('avgOtherCostPerChild').textContent = `${formatCurrency(avgOtherCostPerChild)} –≥—Ä–Ω`;
        document.getElementById('avgCostPriceNoOpCost').textContent = `${formatCurrency(avgCostPriceNoOpCost)} –≥—Ä–Ω`;
        document.getElementById('opCostPerChildDisplay').textContent = `${formatCurrency(opCostPerChild)} –≥—Ä–Ω`;
        document.getElementById('avgCostPriceWithOpCost').textContent = `${formatCurrency(avgCostPriceWithOpCost)} –≥—Ä–Ω`;
        document.getElementById('totalChildrenDisplay').textContent = `${aggregatedTotalChildren}`;
        document.getElementById('avgRevenuePerChild').textContent = `${formatCurrency(avgRevenuePerChild)} –≥—Ä–Ω`;
      }
      
      // ====================================================================
      // SERVER COMMUNICATION
      // ====================================================================

      function handleFormSubmit(event) {
        event.preventDefault();
        
        // 1. –ó–±—ñ—Ä –∑–∞–≥–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö —Å–µ–∑–æ–Ω—É
        // –í–∞–∂–ª–∏–≤–æ: opCostPerChild –±—É–¥–µ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ, –∞–ª–µ –º–∏ –Ω–∞–¥—Å–∏–ª–∞—î–º–æ –π–æ–≥–æ —Ç—É—Ç.
        const opCostPerChild = parseFloat(document.getElementById('opCostPerChild').value) || 0;

        const planData = {
          name: document.getElementById('planName').value.trim(),
          advertisingCost: parseFloat(document.getElementById('advertisingCost').value) || 0,
          salesManagerCost: parseFloat(document.getElementById('salesManagerCost').value) || 0,
          seasonLaunchCost: parseFloat(document.getElementById('seasonLaunchCost').value) || 0,
          opCostPerChild: opCostPerChild 
        };
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞–∑–≤–∏ —Å–µ–∑–æ–Ω—É
        if (!planData.name) {
            document.getElementById('formResult').innerHTML = '<p class="error">‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Å–µ–∑–æ–Ω—É.</p>';
            return;
        }

        // 2. –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö —É—Å—ñ—Ö –∑–º—ñ–Ω
        const shiftDetails = [];
        let validationError = false;
        document.querySelectorAll('.shift-details-container').forEach(shiftBlock => {
            const data = getShiftData(shiftBlock);
            if (data.location && data.shiftName) {
                shiftDetails.push(data);
            } else {
                validationError = true;
            }
        });
        
        if (shiftDetails.length === 0 || validationError) {
          document.getElementById('formResult').innerHTML = '<p class="error">‚ùå –ù–µ–æ–±—Ö—ñ–¥–Ω–æ –¥–æ–¥–∞—Ç–∏ —Ç–∞ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–Ω—É –∑–º—ñ–Ω—É/–ª–æ–∫–∞—Ü—ñ—é –∫–æ—Ä–µ–∫—Ç–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏.</p>';
          return;
        }
        
        const rowIndex = parseInt(document.getElementById('planIndex').value);

        document.getElementById('formResult').innerHTML = '<p class="loading">‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–ª–∞–Ω—É...</p>';
        document.getElementById('submitBtn').disabled = true;

        google.script.run
          .withSuccessHandler(onSaveSuccess)
          .withFailureHandler(onError)
          .saveFullPlan(planData, shiftDetails, rowIndex);
      }

      function loadPlans() {
      
        document.getElementById('spinnerPlanner').style.display = 'block';
        document.getElementById('tableResult').innerHTML = '';

        // –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ
        google.script.run
            .withSuccessHandler(function(actuals) {
                actualsData = actuals; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ
                // –ü–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø—Ä–æ–≥–Ω–æ–∑–Ω—ñ –ø–ª–∞–Ω–∏
                google.script.run
                    .withSuccessHandler(renderPlans)
                    .withFailureHandler(onErrorInList)
                    .getPlans();
            })
            .withFailureHandler(onErrorInList)
            .getActualsBySeason();
      }

      // –ù–û–í–ò–ô –§–£–ù–ö–¶–Ü–û–ù–ê–õ: –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø –†–Ü–ó–ù–ò–¶–¨ –ó –ö–û–õ–¨–û–†–û–ú
      function formatDifference(value) {
        const formatted = formatCurrency(value);
        if (value > 0) {
          return `<span class="positive-diff">+${formatted}</span>`;
        } else if (value < 0) {
          return `<span class="negative-diff">${formatted}</span>`;
        } else {
          return `<span class="zero-diff">${formatted}</span>`;
        }
      }

      function renderPlans(plans) {
          const dashboardContainer = document.getElementById('analyticsDashboard');
          const cardsContainer = document.getElementById('seasonCardsContainer');
          const overallKpiDisplay = document.getElementById('overallKpiDisplay');

          dashboardContainer.innerHTML = '';
          cardsContainer.innerHTML = '';
          overallKpiDisplay.innerHTML = '';
          seasonsData = []; // –û—á–∏—â—É—î–º–æ –¥–∞–Ω—ñ —Å–µ–∑–æ–Ω—ñ–≤

          if (plans.length === 0) {
              cardsContainer.innerHTML = '<div>–ù–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ –ø–ª–∞–Ω—É —Å–µ–∑–æ–Ω—É.</div>';
          } else {
              
              // ====================================================================
              // 1. –ê–≥—Ä–µ–≥–∞—Ü—ñ—è —Ç–∞ –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –¥–ª—è –î–∞—à–±–æ—Ä–¥—É
              // ====================================================================
              let totalPlanRevenue = 0, totalActualRevenue = 0;
              let totalPlanCost = 0, totalActualCost = 0;
              let totalPlanChildren = 0, totalActualChildren = 0;
              
              seasonsData = plans.map((plan) => {
                  const actuals = actualsData[plan.Name] || { revenue: 0, expense: 0, children: 0 };
                  
                  // –ó–∞–≥–∞–ª—å–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü—ñ—è
                  totalPlanRevenue += plan.TotalRevenue;
                  totalActualRevenue += actuals.revenue;
                  totalPlanCost += plan.TotalSeasonCost;
                  totalActualCost += actuals.expense;
                  totalPlanChildren += plan.TotalChildren || 0;
                  totalActualChildren += actuals.children || 0;
                  
                  return { plan, actuals };
              });

              // ====================================================================
              // 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ö–∞—Ä—Ç–æ–∫ KPI
              // ====================================================================
              
              const overallPlanProfit = totalPlanRevenue - totalPlanCost;
              const overallActualProfit = totalActualRevenue - totalActualCost;
              const overallProfitDiff = overallActualProfit - overallPlanProfit;
              const overallPlanMargin = totalPlanRevenue > 0 ? (overallPlanProfit / totalPlanRevenue) * 100 : 0;
              const overallActualMargin = totalActualRevenue > 0 ? (overallActualProfit / totalActualRevenue) * 100 : 0;

              const kpiMetrics = [
                  { title: '–ó–∞–≥–∞–ª—å–Ω–∏–π –î–æ—Ö—ñ–¥', plan: totalPlanRevenue, fact: totalActualRevenue, format: (v) => formatCurrency(v) + ' –≥—Ä–Ω', isRevenue: true },
                  { title: '–ó–∞–≥–∞–ª—å–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏', plan: totalPlanCost, fact: totalActualCost, format: (v) => formatCurrency(v) + ' –≥—Ä–Ω', isCost: true },
                  { title: '–ß–∏—Å—Ç–∏–π –ü—Ä–∏–±—É—Ç–æ–∫', plan: overallPlanProfit, fact: overallActualProfit, format: (v) => formatCurrency(v) + ' –≥—Ä–Ω', isProfit: true },
                  { title: '–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å', plan: overallPlanMargin, fact: overallActualMargin, format: (v) => v.toFixed(2) + '%', isMargin: true },
                  { title: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ—Ç–µ–π', plan: totalPlanChildren, fact: totalActualChildren, format: (v) => v, isChildren: true },
              ];
              
              kpiMetrics.forEach(metric => {
                  const diff = metric.fact - metric.plan;
                  let diffClass = 'zero-diff';
                  if (metric.isCost) { // –í–∏—Ç—Ä–∞—Ç–∏: —Ñ–∞–∫—Ç < –ø–ª–∞–Ω = –ø–æ–∑–∏—Ç–∏–≤–Ω–æ (–∑–µ–ª–µ–Ω–∏–π)
                      diffClass = diff < 0 ? 'positive-diff' : (diff > 0 ? 'negative-diff' : 'zero-diff');
                  } else if (metric.isChildren) {
                      diffClass = diff > 0 ? 'positive-diff' : (diff < 0 ? 'negative-diff' : 'zero-diff');
                  } else { // –î–æ—Ö—ñ–¥, –ü—Ä–∏–±—É—Ç–æ–∫, –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å: —Ñ–∞–∫—Ç > –ø–ª–∞–Ω = –ø–æ–∑–∏—Ç–∏–≤–Ω–æ (–∑–µ–ª–µ–Ω–∏–π)
                      diffClass = diff > 0 ? 'positive-diff' : (diff < 0 ? 'negative-diff' : 'zero-diff');
                  }

                  // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–ª—ñ—Ä –±–µ–∑ –≤–∫–ª–∞–¥–µ–Ω–æ–≥–æ —Ç–µ—Ä–Ω–∞—Ä–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                  let colorValue;
                  if (diffClass === 'positive-diff') {
                    colorValue = '#27ae60';
                  } else if (diffClass === 'negative-diff') {
                    colorValue = '#e74c3c';
                  } else {
                    colorValue = '#2c3e50';
                  }

                  const card = document.createElement('div');
                  card.className = 'kpi-card';
                  card.innerHTML = `
                      <div class="kpi-title">${metric.title} (–ü–ª–∞–Ω)</div>
                      <div class="kpi-value">${metric.format(metric.plan)}</div>
                      <div class="kpi-title" style="margin-top: 10px;">–§–∞–∫—Ç</div>
                      <div class="kpi-value" style="color: ${colorValue};">${metric.format(metric.fact)}</div>
                      <div class="kpi-diff ${diffClass}">–†—ñ–∑–Ω–∏—Ü—è: ${metric.format(diff)}</div>
                  `;
                  dashboardContainer.appendChild(card);
              });

              // –ó–∞–≥–∞–ª—å–Ω—ñ KPI (–º–∞–ª–µ–Ω—å–∫–∏–π –±–ª–æ–∫)
              const overallColor = overallActualProfit >= 0 ? '#27ae60' : '#e74c3c';
              const overallMarginColor = overallActualMargin >= overallPlanMargin ? '#27ae60' : '#e74c3c';
              overallKpiDisplay.innerHTML = `
                  <div class="kpi-item">
                      <div class="kpi-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –ü—Ä–∏–±—É—Ç–æ–∫ (–§–∞–∫—Ç)</div>
                      <div class="kpi-number" style="color: ${overallColor};">${formatCurrency(overallActualProfit)} –≥—Ä–Ω</div>
                  </div>
                  <div class="kpi-item">
                      <div class="kpi-label">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å (–§–∞–∫—Ç)</div>
                      <div class="kpi-number" style="color: ${overallMarginColor};">${overallActualMargin.toFixed(2)}%</div>
                  </div>
                  <div class="kpi-item">
                      <div class="kpi-label">–í—Å—å–æ–≥–æ –î—ñ—Ç–µ–π (–§–∞–∫—Ç)</div>
                      <div class="kpi-number">${totalActualChildren}</div>
                  </div>
              `;

              // ====================================================================
              // 3. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ö–∞—Ä—Ç–æ–∫ –°–µ–∑–æ–Ω—ñ–≤
              // ====================================================================
              seasonsData.forEach(({plan, actuals}, index) => {
                  const actualProfit = actuals.revenue - actuals.expense;
                  const revenueDiff = actuals.revenue - plan.TotalRevenue;
                  const costDiff = actuals.expense - plan.TotalSeasonCost;
                  const profitDiff = actualProfit - plan.TotalProfit;
                  const childrenDiff = actuals.children - (plan.TotalChildren || 0);
                  
                  const profitColor = actualProfit > 0 ? '#27ae60' : '#e74c3c';

                  const card = document.createElement('div');
                  card.className = 'season-card';
                  
                  card.innerHTML = `
                      <div class="season-header">
                          <span class="season-name">üèïÔ∏è ${escapeHtml(plan.Name)}</span>
                          <div class="season-actions">
                              <button class="edit-btn" style="padding: 5px 10px; font-size: 12px;" onclick="editPlan(${plan.RowIndex}, '${escapeHtml(plan.Name)}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                              <button class="delete-btn" style="padding: 5px 10px; font-size: 12px;" onclick="confirmDelete(${plan.RowIndex}, '${escapeHtml(plan.Name)}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                              <button class="details-btn" style="padding: 5px 10px; font-size: 12px; background: #3498db; color: white;" onclick="showPlanDetails(${index})">–î–µ—Ç–∞–ª—ñ</button>
                          </div>
                      </div>
                      
                      <div class="metric-row">
                          <span class="metric-label">**–î–æ—Ö—ñ–¥ (–ü–ª–∞–Ω/–§–∞–∫—Ç):**</span>
                          <span class="metric-value">${formatCurrency(plan.TotalRevenue)} / ${formatCurrency(actuals.revenue)} –≥—Ä–Ω (${formatDifference(revenueDiff)})</span>
                      </div>
                      <div class="metric-row">
                          <span class="metric-label">**–í–∏—Ç—Ä–∞—Ç–∏ (–ü–ª–∞–Ω/–§–∞–∫—Ç):**</span>
                          <span class="metric-value">${formatCurrency(plan.TotalSeasonCost)} / ${formatCurrency(actuals.expense)} –≥—Ä–Ω (${formatDifference(-costDiff)})</span>
                      </div>
                      <div class="metric-row" style="border-top: 1px solid #ddd; margin-top: 5px; padding-top: 5px;">
                          <span class="metric-label" style="font-weight: bold;">**–ß–∏—Å—Ç–∏–π –ü—Ä–∏–±—É—Ç–æ–∫ (–ü–ª–∞–Ω/–§–∞–∫—Ç):**</span>
                          <span class="metric-value" style="font-weight: bold; color: ${profitColor};">${formatCurrency(plan.TotalProfit)} / ${formatCurrency(actualProfit)} –≥—Ä–Ω (${formatDifference(profitDiff)})</span>
                      </div>
                      <div class="metric-row">
                          <span class="metric-label">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å (–ü–ª–∞–Ω/–§–∞–∫—Ç):</span>
                          <span class="metric-value">${parseFloat(plan.ProfitMargin).toFixed(2)}% / ${actuals.revenue > 0 ? ((actualProfit / actuals.revenue) * 100).toFixed(2) : 0.00}%</span>
                      </div>
                      <div class="metric-row">
                          <span class="metric-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ—Ç–µ–π (–ü–ª–∞–Ω/–§–∞–∫—Ç):</span>
                          <span class="metric-value">${plan.TotalChildren || 0} / ${actuals.children || 0} (${formatDifferenceChildren(childrenDiff)})</span>
                      </div>
                  `;
                  cardsContainer.appendChild(card);
              });

              document.getElementById('analyticsDashboard').style.display = 'grid';
              document.getElementById('overallKpiDisplay').style.display = 'flex';
          }

          document.getElementById('spinnerPlanner').style.display = 'none';
      }

      // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ü—ñ –¥–ª—è –¥—ñ—Ç–µ–π (–±–µ–∑ '–≥—Ä–Ω')
      function formatDifferenceChildren(value) {
          const formatted = Math.abs(value);
          if (value > 0) {
              return `<span class="positive-diff">+${formatted}</span>`;
          } else if (value < 0) {
              return `<span class="negative-diff">-${formatted}</span>`;
          } else {
              return `<span class="zero-diff">${formatted}</span>`;
          }
      }

      function editPlan(index, planName) {
        document.getElementById('planIndex').value = index;
        document.getElementById('planName').value = planName;
        
        google.script.run
          .withSuccessHandler(function(plans) {
            const plan = plans.find(p => p.Name === planName);
            if (plan) {
              document.getElementById('advertisingCost').value = plan.AdvertisingCost;
              document.getElementById('salesManagerCost').value = plan.SalesManagerCost;
              document.getElementById('seasonLaunchCost').value = plan.SeasonLaunchCost;
              
              document.getElementById('submitBtn').textContent = `–û–Ω–æ–≤–∏—Ç–∏ –ø–ª–∞–Ω: ${planName}`;
              document.getElementById('formResult').innerHTML = '<p class="success">‚úÖ –ó–∞–≥–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–º—ñ–Ω...</p>';
              
              google.script.run
                .withSuccessHandler(function(shiftDetails) {
                  document.getElementById('locationsContainer').innerHTML = '';
                  locationCount = 0;
                  shiftCount = 0;
                  
                  if (shiftDetails.length === 0) {
                    addLocationBlock();
                  } else {
                    const groupedByLocation = shiftDetails.reduce((acc, shift) => {
                        const loc = shift.location;
                        if (!acc[loc]) {
                            acc[loc] = [];
                        }
                        acc[loc].push(shift);
                        return acc;
                    }, {});

                    for (const loc in groupedByLocation) {
                        const shifts = groupedByLocation[loc];
                        addLocationBlock(loc, shifts.length, shifts);
                    }
                  }
                  
                  updateOverallCalculatedFields();
                  document.getElementById('formResult').innerHTML = '<p class="success">‚úÖ –ü–ª–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –≤–∫–ª–∞–¥–∫–∏ "–î–æ–¥–∞—Ç–∏/–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –°–µ–∑–æ–Ω".</p>';
                  switchTab('add');
                })
                .withFailureHandler(onError)
                .getShiftDetails(planName);
            } else {
              onError({ message: '–ü–ª–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.' });
            }
          })
          .withFailureHandler(onError)
          .getPlans();
      }

      // –†–û–ó–®–ò–†–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø: –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –ø–ª–∞–Ω—É –∑ –ø–æ–≤–Ω–æ—é –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—î—é (–∑–∞ —ñ–Ω–¥–µ–∫—Å–æ–º)
      function showPlanDetails(index) {
        const data = seasonsData[index];
        if (!data) {
          console.error('–î–∞–Ω—ñ —Å–µ–∑–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è —ñ–Ω–¥–µ–∫—Å—É:', index);
          return;
        }
        const { plan, actuals: basicActuals } = data;

        const modal = document.getElementById('detailsModal');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');

        title.innerText = `–î–µ—Ç–∞–ª—ñ —Å–µ–∑–æ–Ω—É: ${escapeHtml(plan.Name)}`;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª –∑ –ª–æ–∞–¥–µ—Ä–æ–º
        body.innerHTML = '<p class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó...</p>';
        modal.style.display = 'block';

        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–µ—Ç–∞–ª—ñ: shift details —Ç–∞ actual details
        google.script.run
          .withSuccessHandler(function(shiftDetails) {
            // –î–∞–ª—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ actual details
            google.script.run
              .withSuccessHandler(function(actualDetails) {
                // –¢–µ–ø–µ—Ä –≥–µ–Ω–µ—Ä—É—î–º–æ –ø–æ–≤–Ω–∏–π HTML
                const htmlContent = generateDetailedModalContent(plan, basicActuals, shiftDetails, actualDetails);
                body.innerHTML = htmlContent;
              })
              .withFailureHandler(function(error) {
                body.innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–∫—Ç–∏—á–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π: ${escapeHtml(error.message)}</p>`;
              })
              .getActualDetailsBySeason(plan.Name);
          })
          .withFailureHandler(function(error) {
            body.innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –ø–ª–∞–Ω—É: ${escapeHtml(error.message)}</p>`;
          })
          .getPlanShiftDetails(plan.Name);  // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ü–æ–≤–µ—Ä—Ç–∞—î shift details –∑ –æ–±—á–∏—Å–ª–µ–Ω–∏–º–∏ –ø–æ–ª—è–º–∏
      }

      // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ì–µ–Ω–µ—Ä—É—î HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–æ—é –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—î—é
      function generateDetailedModalContent(plan, basicActuals, shiftDetails, actualDetails) {
        let htmlContent = '';

        // 1. –ó–∞–≥–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ (—è–∫ —Ä–∞–Ω—ñ—à–µ, –∞–ª–µ –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º –¥–ª—è –≤–∏—Ç—Ä–∞—Ç)
        const actualProfit = basicActuals.revenue - basicActuals.expense;
        htmlContent += `
            <div class="details-section">
                <h4>üìà –ó–∞–≥–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</h4>
                <table class="details-table">
                    <tr><th>–ü–æ–∫–∞–∑–Ω–∏–∫</th><th>–ü–ª–∞–Ω</th><th>–§–∞–∫—Ç</th><th>–†—ñ–∑–Ω–∏—Ü—è (–§–∞–∫—Ç - –ü–ª–∞–Ω)</th></tr>
                    <tr>
                        <td><strong>–î–æ—Ö—ñ–¥</strong></td>
                        <td>${formatCurrency(plan.TotalRevenue)} –≥—Ä–Ω</td>
                        <td>${formatCurrency(basicActuals.revenue)} –≥—Ä–Ω</td>
                        <td class="diff-cell">${formatDifference(basicActuals.revenue - plan.TotalRevenue)}</td>
                    </tr>
                    <tr>
                        <td><strong>–í–∏—Ç—Ä–∞—Ç–∏</strong></td>
                        <td>${formatCurrency(plan.TotalSeasonCost)} –≥—Ä–Ω</td>
                        <td>${formatCurrency(basicActuals.expense)} –≥—Ä–Ω</td>
                        <td class="diff-cell">${formatDifference(basicActuals.expense - plan.TotalSeasonCost, true)}</td>  <!-- true –¥–ª—è –≤–∏—Ç—Ä–∞—Ç (—ñ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞) -->
                    </tr>
                    <tr class="category-group">
                        <td><strong>–ü—Ä–∏–±—É—Ç–æ–∫</strong></td>
                        <td>${formatCurrency(plan.TotalProfit)} –≥—Ä–Ω</td>
                        <td>${formatCurrency(actualProfit)} –≥—Ä–Ω</td>
                        <td class="diff-cell">${formatDifference(actualProfit - plan.TotalProfit)}</td>
                    </tr>
                    <tr>
                        <td><strong>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å</strong></td>
                        <td>${parseFloat(plan.ProfitMargin).toFixed(2)}%</td>
                        <td>${basicActuals.revenue > 0 ? ((actualProfit / basicActuals.revenue) * 100).toFixed(2) : '0.00'}%</td>
                        <td class="diff-cell">${formatDifferenceMargin((basicActuals.revenue > 0 ? ((actualProfit / basicActuals.revenue) * 100) : 0) - parseFloat(plan.ProfitMargin))}</td>
                    </tr>
                    <tr>
                        <td><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ—Ç–µ–π</strong></td>
                        <td>${plan.TotalChildren || 0}</td>
                        <td>${basicActuals.children || 0}</td>
                        <td class="diff-cell">${formatDifferenceChildren((basicActuals.children || 0) - (plan.TotalChildren || 0))}</td>
                    </tr>
                </table>
            </div>
        `;

        // 2. –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –î–æ—Ö–æ–¥—ñ–≤ (–ü–ª–∞–Ω–æ–≤—ñ –ø–æ –∑–º—ñ–Ω–∞—Ö)
        if (shiftDetails && shiftDetails.length > 0) {
          htmlContent += `
              <div class="details-section">
                  <h4>üíµ –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –î–æ—Ö–æ–¥—ñ–≤ (–ü–ª–∞–Ω–æ–≤—ñ –ø–æ –∑–º—ñ–Ω–∞—Ö)</h4>
                  <table class="details-table breakdown-table">
                      <tr><th>–ù–∞–∑–≤–∞ –ó–º—ñ–Ω–∏</th><th>–õ–æ–∫–∞—Ü—ñ—è</th><th>–ö-—Å—Ç—å –∑–º—ñ–Ω</th><th>–°–µ—Ä–µ–¥–Ω—è –∫-—Å—Ç—å –¥—ñ—Ç–µ–π –Ω–∞ –∑–º—ñ–Ω—É</th><th>–¶—ñ–Ω–∞ –∑–∞ –¥–∏—Ç–∏–Ω—É (–≥—Ä–Ω)</th><th>–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥ –ø–æ –∑–º—ñ–Ω–∞—Ö (–≥—Ä–Ω)</th></tr>
          `;
          shiftDetails.forEach(shift => {
            // –°–ø—Ä–æ—â–µ–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–æ—Ö–æ–¥—É –ø–æ –∑–º—ñ–Ω—ñ (–≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –∑–Ω–∏–∂–∫–∏)
            const fullPriceChildren = Math.max(0, shift.avgChildren - shift.discountChildrenCount);
            const discountedChildren = Math.min(shift.avgChildren, shift.discountChildrenCount);
            const effectiveDiscount = (shift.discountPercent / 100) * shift.shiftFee;
            const revenuePerShift = (fullPriceChildren * shift.shiftFee) + (discountedChildren * (shift.shiftFee - effectiveDiscount));
            htmlContent += `
                  <tr>
                      <td>${escapeHtml(shift.shiftName)}</td>
                      <td>${escapeHtml(shift.location)}</td>
                      <td>${shift.shiftCount}</td>
                      <td>${shift.avgChildren}</td>
                      <td>${formatCurrency(shift.shiftFee)}</td>
                      <td>${formatCurrency(revenuePerShift * shift.shiftCount)}</td>
                  </tr>
              `;
          });
          htmlContent += `</table></div>`;
        }

        // 3. –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –í–∏—Ç—Ä–∞—Ç (–ü–ª–∞–Ω–æ–≤—ñ)
        if (shiftDetails && shiftDetails.length > 0) {
          let totalSalary = 0, totalLivingTeam = 0, totalFoodChild = 0, totalProgramExtra = 0;
          shiftDetails.forEach(shift => {
            totalSalary += shift.totalTeamSalaryCost || 0;
            totalLivingTeam += shift.totalTeamLivingCost || 0;
            totalFoodChild += shift.totalChildFoodCost || 0;
            totalProgramExtra += shift.totalProgramAndExtraCost || 0;
          });
          const opCosts = {
            advertising: plan.AdvertisingCost || 0,
            salesManager: plan.SalesManagerCost || 0,
            launch: plan.SeasonLaunchCost || 0,
            total: (plan.AdvertisingCost || 0) + (plan.SalesManagerCost || 0) + (plan.SeasonLaunchCost || 0)
          };
          const totalSeasonCost = plan.TotalSeasonCost || 0;

          htmlContent += `
              <div class="details-section">
                  <h4>üí∏ –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –í–∏—Ç—Ä–∞—Ç (–ü–ª–∞–Ω–æ–≤—ñ)</h4>
                  <table class="details-table breakdown-table">
                      <tr><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–°—É–º–∞ (–≥—Ä–Ω)</th><th>–ß–∞—Å—Ç–∫–∞ –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç (%)</th></tr>
                      <tr class="category-group"><td colspan="3"><strong>–ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</strong></td></tr>
                      <tr><td>–ó–ü –∫–æ–º–∞–Ω–¥–∏ (—Å–µ–∑–æ–Ω)</td><td>${formatCurrency(totalSalary)}</td><td>${totalSeasonCost > 0 ? ((totalSalary / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr><td>–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ (—Å–µ–∑–æ–Ω)</td><td>${formatCurrency(totalLivingTeam)}</td><td>${totalSeasonCost > 0 ? ((totalLivingTeam / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr><td>–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π (—Å–µ–∑–æ–Ω)</td><td>${formatCurrency(totalFoodChild)}</td><td>${totalSeasonCost > 0 ? ((totalFoodChild / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr><td>–ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ (—Å–µ–∑–æ–Ω)</td><td>${formatCurrency(totalProgramExtra)}</td><td>${totalSeasonCost > 0 ? ((totalProgramExtra / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr class="category-group"><td colspan="3"><strong>–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</strong></td></tr>
                      <tr><td>–†–µ–∫–ª–∞–º–∞</td><td>${formatCurrency(opCosts.advertising)}</td><td>${totalSeasonCost > 0 ? ((opCosts.advertising / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr><td>–û–ø–ª–∞—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤</td><td>${formatCurrency(opCosts.salesManager)}</td><td>${totalSeasonCost > 0 ? ((opCosts.salesManager / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr><td>–ó–∞–ø—É—Å–∫ —Å–µ–∑–æ–Ω—É</td><td>${formatCurrency(opCosts.launch)}</td><td>${totalSeasonCost > 0 ? ((opCosts.launch / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</td></tr>
                      <tr><td><strong>–í—Å—å–æ–≥–æ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö</strong></td><td><strong>${formatCurrency(opCosts.total)}</strong></td><td><strong>${totalSeasonCost > 0 ? ((opCosts.total / totalSeasonCost) * 100).toFixed(1) : '0.0'}%</strong></td></tr>
                  </table>
              </div>
          `;
        }

        // 4. –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –§–∞–∫—Ç–∏—á–Ω–∏—Ö –î–æ—Ö–æ–¥—ñ–≤
        if (actualDetails && actualDetails.revenues && actualDetails.revenues.length > 0) {
          htmlContent += `
              <div class="details-section">
                  <h4>üí∞ –§–∞–∫—Ç–∏—á–Ω—ñ –î–æ—Ö–æ–¥–∏ (–∑ ShiftExpenses)</h4>
                  <table class="details-table breakdown-table">
                      <tr><th>–î–∞—Ç–∞</th><th>–†–∞—Ö—É–Ω–æ–∫</th><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–î–æ–¥. —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</th><th>–°—É–º–∞ (–≥—Ä–Ω)</th><th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th></tr>
          `;
          actualDetails.revenues.forEach(row => {
            htmlContent += `
                  <tr>
                      <td>${escapeHtml(row[0])}</td>
                      <td>${escapeHtml(row[2])}</td>
                      <td>${escapeHtml(row[5])}</td>
                      <td>${escapeHtml(row[9])}</td>
                      <td>${formatCurrency(row[10])}</td>
                      <td>${escapeHtml(row[11])}</td>
                  </tr>
              `;
          });
          htmlContent += `</table></div>`;
        } else {
          htmlContent += `<div class="details-section"><h4>üí∞ –§–∞–∫—Ç–∏—á–Ω—ñ –î–æ—Ö–æ–¥–∏</h4><p>–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –¥–æ—Ö–æ–¥—ñ–≤ –¥–ª—è —Ü—å–æ–≥–æ —Å–µ–∑–æ–Ω—É.</p></div>`;
        }

        // 5. –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –§–∞–∫—Ç–∏—á–Ω–∏—Ö –í–∏—Ç—Ä–∞—Ç (–≥—Ä—É–ø–æ–≤–∞–Ω—ñ)
        if (actualDetails && actualDetails.expenses && Object.keys(actualDetails.expenses).length > 0) {
          htmlContent += `
              <div class="details-section">
                  <h4>üìâ –§–∞–∫—Ç–∏—á–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä—É–ø–æ–≤–∞–Ω—ñ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö –∑ ShiftExpenses)</h4>
                  <table class="details-table breakdown-table">
                      <tr><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ (–≥—Ä–Ω)</th><th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤</th></tr>
          `;
          Object.keys(actualDetails.expenses).forEach(category => {
            actualDetails.expenses[category].forEach(subCat => {
              htmlContent += `
                  <tr>
                      <td>${escapeHtml(category)}</td>
                      <td>${escapeHtml(subCat.name)}</td>
                      <td>${formatCurrency(subCat.total)}</td>
                      <td>${subCat.count}</td>
                  </tr>
              `;
            });
          });
          htmlContent += `</table></div>`;
        } else {
          htmlContent += `<div class="details-section"><h4>üìâ –§–∞–∫—Ç–∏—á–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏</h4><p>–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –≤–∏—Ç—Ä–∞—Ç –¥–ª—è —Ü—å–æ–≥–æ —Å–µ–∑–æ–Ω—É.</p></div>`;
        }

        // 6. –î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö —Ñ–∞–∫—Ç–∏—á–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
        if (actualDetails && actualDetails.allRecords && actualDetails.allRecords.length > 0) {
          htmlContent += `
              <div class="details-section">
                  <h4>üìã –í—Å—ñ –§–∞–∫—Ç–∏—á–Ω—ñ –ó–∞–ø–∏—Å–∏ (–î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫)</h4>
                  <table class="details-table breakdown-table">
                      <tr><th>–î–∞—Ç–∞</th><th>–ì—Ä—É–ø–∞</th><th>–†–∞—Ö—É–Ω–æ–∫</th><th>–õ–æ–∫–∞—Ü—ñ—è</th><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–°—É–º–∞ (–≥—Ä–Ω)</th><th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th></tr>
          `;
          actualDetails.allRecords.forEach(row => {
            htmlContent += `
                  <tr>
                      <td>${escapeHtml(row[0])}</td>
                      <td>${escapeHtml(row[1])}</td>
                      <td>${escapeHtml(row[2])}</td>
                      <td>${escapeHtml(row[4])}</td>
                      <td>${escapeHtml(row[5])}</td>
                      <td>${formatCurrency(row[10])}</td>
                      <td>${escapeHtml(row[11])}</td>
                  </tr>
              `;
          });
          htmlContent += `</table></div>`;
        }

        return htmlContent;
      }

      // –î–û–î–ê–¢–ö–û–í–Ü –§–£–ù–ö–¶–Ü–á –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø –î–õ–Ø –ú–û–î–ê–õ–Ü
      function formatDifference(value, isCost = false) {
        const absValue = Math.abs(value);
        const formatted = formatCurrency(absValue);
        let prefix = '';
        let className = 'zero-diff';
        if (value > 0) {
          prefix = '+';
          className = isCost ? 'negative-diff' : 'positive-diff';  // –î–ª—è –≤–∏—Ç—Ä–∞—Ç: + —Ü–µ –ø–æ–≥–∞–Ω–æ
        } else if (value < 0) {
          prefix = '';
          className = isCost ? 'positive-diff' : 'negative-diff';  // –î–ª—è –≤–∏—Ç—Ä–∞—Ç: - —Ü–µ –¥–æ–±—Ä–µ
        }
        return `<span class="${className}">${prefix}${formatted} –≥—Ä–Ω</span>`;
      }

      function formatDifferenceMargin(value) {
        const formatted = value.toFixed(2) + '%';
        if (value > 0) {
          return `<span class="positive-diff">+${formatted}</span>`;
        } else if (value < 0) {
          return `<span class="negative-diff">${formatted}</span>`;
        } else {
          return `<span class="zero-diff">${formatted}</span>`;
        }
      }

      function closeModal(id) {
        document.getElementById(id).style.display = 'none';
      }

      function confirmDelete(index, planName) {
        if (confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–ª–∞–Ω "${planName}" —Ç–∞ –≤—Å—ñ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ –Ω–∏–º –¥–µ—Ç–∞–ª—ñ –∑–º—ñ–Ω?`)) {
          document.getElementById('tableResult').innerHTML = '<p class="loading">‚è≥ –í–∏–¥–∞–ª–µ–Ω–Ω—è...</p>';
          
          google.script.run
            .withSuccessHandler(onDeleteSuccess)
            .withFailureHandler(onErrorInList)
            .deletePlan(index, planName);
        }
      }

      function onSaveSuccess() {
        document.getElementById('formResult').innerHTML = '<p class="success">‚úÖ –ü–ª–∞–Ω —Å–µ–∑–æ–Ω—É —Ç–∞ –¥–µ—Ç–∞–ª—ñ –∑–º—ñ–Ω —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ/–æ–Ω–æ–≤–ª–µ–Ω–æ!</p>';
        document.getElementById('submitBtn').disabled = false;
        clearForm();
      }

      function onDeleteSuccess() {
        document.getElementById('tableResult').innerHTML = '<p class="success">‚úÖ –ü–ª–∞–Ω —Å–µ–∑–æ–Ω—É —Ç–∞ –¥–µ—Ç–∞–ª—ñ –∑–º—ñ–Ω —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ.</p>';
        loadPlans();
      }

      function onError(error) {
        document.getElementById('formResult').innerHTML = '<p class="error">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + escapeHtml(error.message) + '</p>';
        document.getElementById('submitBtn').disabled = false;
      }
      
      function onErrorInList(error) {
        document.getElementById('tableResult').innerHTML = '<p class="error">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + escapeHtml(error.message) + '</p>';
        document.getElementById('spinnerPlanner').style.display = 'none';
      }

      // ====================================================================
      // UTILS
      // ====================================================================

      function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        if (typeof text !== 'string') return text;
        return text.replace(/[&<>"']/g, m => map[m]);
      }
      
      function formatCurrency(value) {
        return parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
      }
    </script>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
          <span class="close-button" onclick="closeModal('detailsModal')">&times;</span>
          <h3 id="modalTitle">–î–µ—Ç–∞–ª—ñ –°–µ–∑–æ–Ω—É</h3>
          
          <div id="modalBody">
            </div>
          
        </div>
    </div>

  </body>
</html>

