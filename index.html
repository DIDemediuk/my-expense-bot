                    <!doctype html>
                    <!-- Updated: 2025-11-14 14:45 - Enhanced amount sign handling and added debugging -->
                    <html lang="uk">
                    <head>
                    <meta charset="utf-8" />
                    <meta name="viewport" content="width=device-width,initial-scale=1" />
                    <title>CampManager Pro - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∏—Ç—è—á–∏–º–∏ —Ç–∞–±–æ—Ä–∞–º–∏</title>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0"></script>
                    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
                    <style>
                        :root{
                        --bg-gradient-start: #f0f4f8;
                        --bg-gradient-end: #e2e8f0;
                        --card: #ffffff;
                        --accent: #3b82f6;
                        --accent-hover: #2563eb;
                        --accent-light: #dbeafe;
                        --muted: #64748b;
                        --success: #10b981;
                        --warning: #f59e0b;
                        --error: #ef4444;
                        --section-gap: 32px;
                        --row-even: #f8fafc;
                        --row-odd: #ffffff;
                        --hover-row: #eff6ff;
                        --border: #e2e8f0;
                        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                        --group-disc: #fef3c7;
                        --group-price: #dcfce7;
                        --group-cost: #fed7aa;
                        --group-profit: #d9f99d;
                        }
                        
                        * {
                        box-sizing: border-box;
                        }
                        
                        body{
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
                        color: #1e293b;
                        margin: 0;
                        padding: 24px;
                        min-height: 100vh;
                        }
                        
                        .wrap{
                        max-width: 1600px;
                        margin: 0 auto;
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 24px;
                        }
                        /* Tabs */
                        .tabs{display:flex;gap:8px;align-items:center}
                        .tab-btn{background:#f8fafc;color:#475569;border:none;padding:12px 20px;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:hidden}
                        .tab-btn:hover{background:#e2e8f0;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
                        .tab-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:white;box-shadow:0 4px 16px rgba(102,126,234,0.4);transform:translateY(-2px)}
                        .tab-btn.active::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,rgba(255,255,255,0.1),transparent);pointer-events:none}
                        .tab-pane{display:none}
                        .tab-pane.active{display:block}
                        
                        /* CRM Sub-tabs */
                        .crm-tab-btn:hover{color:#3b82f6!important;border-bottom-color:#3b82f6!important}
                        .crm-tab-btn.active{color:#3b82f6!important;border-bottom-color:#3b82f6!important}
                        
                        /* Calculator Sub-tabs */
                        .calc-tab-btn:hover{color:#3b82f6!important;border-bottom-color:#3b82f6!important}
                        .calc-tab-btn.active{color:#3b82f6!important;border-bottom-color:#3b82f6!important}
                        
                        .main-grid{
                        display: grid;
                        grid-template-columns: 500px 1fr;
                        gap: 24px;
                        align-items: start;
                        }
                        
                        .params-column{
                        position: sticky;
                        top: 24px;
                        max-height: calc(100vh - 48px);
                        overflow-y: auto;
                        overflow-x: hidden;
                        }
                        
                        .params-column::-webkit-scrollbar {
                        width: 8px;
                        }
                        
                        .params-column::-webkit-scrollbar-track {
                        background: var(--row-even);
                        border-radius: 4px;
                        }
                        
                        .params-column::-webkit-scrollbar-thumb {
                        background: var(--accent);
                        border-radius: 4px;
                        }
                        
                        .params-column::-webkit-scrollbar-thumb:hover {
                        background: var(--accent-hover);
                        }
                        
                        .results-column{
                        min-height: 100vh;
                        }
                        /* Cost tab layout */
                    .cost-grid{display:grid;grid-template-columns:1fr 380px;gap:24px;align-items:start}
                        .cost-left{position:sticky;top:24px;max-height:calc(100vh - 48px);overflow:auto}
                        .shift-card{background:var(--row-even);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
                        .shift-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
                        .shift-planning-header{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);padding:12px;border-radius:8px;margin-bottom:12px;border-left:4px solid #f59e0b}
                        .team-row{display:grid;grid-template-columns:2fr 1fr 1fr 36px;gap:8px;align-items:center;margin-bottom:6px}
                        .tiny-btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:#e2e8f0;color:#0f172a;font-size:13px}
                        .tiny-btn:hover{background:#cbd5e1}
                        .tiny-btn.danger{background:#fee2e2;color:#991b1b}
                        .tiny-btn.danger:hover{background:#fecaca}
                    .plan-card{transition:all 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
                    .plan-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
                    .plan-card.active{box-shadow:0 4px 12px rgba(59,130,246,0.3)}
                    .metrics-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
                    .metric-row{display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px}
                    .metric-row .label{color:var(--muted);font-size:12px}
                    .metric-row .value{font-weight:700;color:#0f172a}
                    .divider{height:1px;background:var(--border);margin:12px 0}
                        
                        header{
                        background: linear-gradient(135deg, var(--accent) 0%, #1e40af 100%);
                        border-radius: 16px;
                        padding: 32px;
                        margin-bottom: 32px;
                        box-shadow: var(--shadow-lg);
                        color: white;
                        }
                        
                        header h1{
                        font-size: 28px;
                        margin: 0 0 12px 0;
                        font-weight: 700;
                        letter-spacing: -0.5px;
                        }
                        
                        header .small{
                        color: rgba(255, 255, 255, 0.9);
                        line-height: 1.6;
                        font-size: 14px;
                        }
                        
                        .card{
                        background: var(--card);
                        border-radius: 16px;
                        padding: 32px;
                        box-shadow: var(--shadow-lg);
                        margin-bottom: 24px;
                        }
                        
                        .section{
                        margin-bottom: var(--section-gap);
                        }
                        
                        .section:last-child{
                        margin-bottom: 0;
                        }
                        
                        .section h2{
                        margin: 0 0 20px 0;
                        font-size: 20px;
                        font-weight: 700;
                        color: #0f172a;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        }
                        
                        .section h2::before{
                        content: '';
                        width: 4px;
                        height: 24px;
                        background: var(--accent);
                        border-radius: 2px;
                        }
                        
                        .grid{
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        }
                        
                        .category-grid{
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 16px;
                        margin-bottom: 20px;
                        }
                        
                        .category{
                        background: var(--row-even);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        border: 1px solid var(--border);
                        transition: all 0.3s ease;
                        }
                        
                        .category:hover{
                        box-shadow: var(--shadow);
                        transform: translateY(-2px);
                        }
                        
                        .category h3{
                        font-size: 16px;
                        color: var(--accent);
                        margin: 0 0 16px 0;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        }
                        
                        .category h3::before{
                        content: 'üìä';
                        font-size: 18px;
                        }
                        
                        label{
                        font-size: 13px;
                        font-weight: 500;
                        color: var(--muted);
                        display: block;
                        margin-bottom: 8px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        }
                        
                        input[type="number"], 
                        input[type="text"]{
                        width: 100%;
                        padding: 10px 14px;
                        border-radius: 8px;
                        border: 2px solid var(--border);
                        font-size: 14px;
                        transition: all 0.2s ease;
                        background: white;
                        }
                        
                        input[type="number"]:focus, 
                        input[type="text"]:focus{
                        outline: none;
                        border-color: var(--accent);
                        box-shadow: 0 0 0 3px var(--accent-light);
                        }
                        
                        input[type="checkbox"]{
                        width: 18px;
                        height: 18px;
                        cursor: pointer;
                        accent-color: var(--accent);
                        }
                        
                        table{
                        width: 100%;
                        border-collapse: separate;
                        border-spacing: 0;
                        margin-top: 20px;
                        border-radius: 12px;
                        overflow: hidden;
                        box-shadow: var(--shadow);
                        border: 1px solid var(--border);
                        }
                        
                        th, td{
                        padding: 14px 12px;
                        border-bottom: 1px solid var(--border);
                        vertical-align: middle;
                        font-size: 13px;
                        text-align: right;
                        }
                        
                        th{
                        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                        font-weight: 600;
                        color: #0f172a;
                        text-transform: uppercase;
                        font-size: 11px;
                        letter-spacing: 0.5px;
                        }
                        
                        th:first-child, td:first-child{
                        text-align: left;
                        }
                        
                        th:nth-child(2), td:nth-child(2){
                        text-align: center;
                        }
                        
                        tr:nth-child(odd){
                        background: var(--row-odd);
                        }
                        
                        tr:nth-child(even){
                        background: var(--row-even);
                        }
                        
                        tbody tr:hover{
                        background: var(--hover-row) !important;
                        transform: scale(1.01);
                        transition: all 0.2s ease;
                        }
                        
                        tbody tr:last-child td{
                        border-bottom: none;
                        }
                        
                        .positive{
                        color: var(--success);
                        font-weight: 700;
                        }
                        
                        .negative{
                        color: var(--error);
                        font-weight: 700;
                        }
                        
                        .custom-row{
                        background: linear-gradient(135deg, var(--accent-light) 0%, #bfdbfe 100%) !important;
                        font-weight: 600;
                        border-top: 3px solid var(--accent);
                        border-bottom: 3px solid var(--accent);
                        }
                        
                        .custom-row td{
                        font-size: 14px;
                        }
                        
                        /* –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫ –∑ –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞–º–∏ */
                        th.group-disc, td:nth-child(2){
                        background: linear-gradient(135deg, var(--group-disc) 0%, #fef3c7 100%);
                        }
                        
                        th.group-price, td:nth-child(3), td:nth-child(4){
                        background: linear-gradient(135deg, var(--group-price) 0%, #bbf7d0 100%);
                        }
                        
                        th.group-cost, td:nth-child(5){
                        background: linear-gradient(135deg, var(--group-cost) 0%, #fed7aa 100%);
                        }
                        
                        th.group-profit, td:nth-child(6), td:nth-child(7), td:nth-child(8){
                        background: linear-gradient(135deg, var(--group-profit) 0%, #d9f99d 100%);
                        }
                        
                        .controls{
                        display: flex;
                        gap: 12px;
                        flex-wrap: wrap;
                        }
                        
                        .btn{
                        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
                        color: white;
                        padding: 12px 24px;
                        border-radius: 10px;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 14px;
                        transition: all 0.3s ease;
                        box-shadow: var(--shadow);
                        }
                        
                        .btn:hover{
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-lg);
                        }
                        
                        .analytics-tab-btn.active {
                        color: #3b82f6 !important;
                        border-bottom-color: #3b82f6 !important;
                        }
                        .analytics-tab-btn:hover {
                        background: #f8fafc;
                        color: #1e40af;
                        }
                        
                        .btn:active{
                        transform: translateY(0);
                        }
                        
                        .mutebtn{
                        background: white;
                        color: var(--accent);
                        border: 2px solid var(--accent);
                        padding: 12px 24px;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 14px;
                        transition: all 0.3s ease;
                        }
                        
                        .mutebtn:hover{
                        background: var(--accent-light);
                        transform: translateY(-2px);
                        }
                        
                        .footer{
                        margin-top: 24px;
                        padding: 20px;
                        color: var(--muted);
                        font-size: 13px;
                        line-height: 1.6;
                        background: var(--row-even);
                        border-radius: 12px;
                        border-left: 4px solid var(--accent);
                        }
                        
                        .alert{
                        padding: 16px 20px;
                        border-radius: 12px;
                        margin-top: 20px;
                        font-size: 14px;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        box-shadow: var(--shadow);
                        }
                        
                        .alert::before{
                        font-size: 24px;
                        }
                        
                        .alert.success{
                        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                        color: #065f46;
                        border-left: 4px solid var(--success);
                        }
                        
                        .alert.success::before{
                        content: '‚úÖ';
                        }
                        
                        .alert.warning{
                        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
                        color: #92400e;
                        border-left: 4px solid var(--warning);
                        }
                        
                        .alert.warning::before{
                        content: '‚ö†Ô∏è';
                        }
                        
                        .alert.error{
                        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                        color: #991b1b;
                        border-left: 4px solid var(--error);
                        }
                        
                        .alert.error::before{
                        content: '‚ùå';
                        }
                        
                        .suggestion{
                        margin-top: 12px;
                        padding: 12px;
                        font-size: 13px;
                        color: var(--muted);
                        font-style: italic;
                        background: var(--accent-light);
                        border-radius: 8px;
                        border-left: 3px solid var(--accent);
                        }
                        
                        .chart-container{
                        margin-top: 24px;
                        height: 400px;
                        background: white;
                        padding: 20px;
                        border-radius: 12px;
                        box-shadow: var(--shadow);
                        }
                        
                        .breakeven-info{
                        margin-top: 16px;
                        padding: 16px;
                        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                        border-radius: 12px;
                        border-left: 4px solid var(--accent);
                        font-size: 14px;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        }
                        
                        .breakeven-info::before{
                        content: '‚ÑπÔ∏è';
                        font-size: 24px;
                        }
                        
                        .edit-link{
                        color: var(--accent);
                        text-decoration: none;
                        font-size: 12px;
                        font-weight: 600;
                        transition: all 0.2s ease;
                        }
                        
                        .edit-link:hover{
                        text-decoration: underline;
                        color: var(--accent-hover);
                        }
                        
                        @media(max-width: 768px){
                        body{
                            padding: 16px;
                        }
                        
                        .main-grid{
                            grid-template-columns: 1fr;
                        }
                        .cost-grid{grid-template-columns:1fr}
                        .cost-left{position:relative;top:0;max-height:none}
                        
                        .params-column{
                            position: relative;
                            top: 0;
                            max-height: none;
                        }
                        
                        .card{
                            padding: 20px;
                        }
                        
                        header{
                            padding: 24px;
                        }
                        
                        header h1{
                            font-size: 22px;
                        }
                        
                        .grid, .category-grid{
                            grid-template-columns: 1fr;
                        }
                        
                        .controls{
                            flex-direction: column;
                        }
                        
                        .btn, .mutebtn{
                            width: 100%;
                        }
                        
                        th, td{
                            padding: 10px 8px;
                            font-size: 12px;
                        }
                        
                        .chart-container{
                            height: 300px;
                            padding: 12px;
                        }
                        }
                    
                    /* Notification animations */
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }

                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                    
                    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è */
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }

                    /* Mobile / Responsive overrides */
                    @media (max-width: 900px) {
                        body{ padding: 12px; }
                        .wrap{ padding: 0 8px; }
                        header{ padding: 18px; }
                        header h1{ font-size:20px; }
                        .tabs{ flex-wrap:wrap; gap:6px }
                        .tab-btn{ padding:10px 14px; font-size:15px; min-height:44px }
                        /* show header mobile toggle */
                        #mobileMenuToggle{ display:block }
                        .main-grid{ grid-template-columns: 1fr; }
                        .grid, .category-grid, .cost-grid{ grid-template-columns: 1fr; }
                        .card{ padding:14px }
                        .controls{ flex-direction:column; gap:10px }
                        .btn, .mutebtn{ width:100%; min-height:44px; padding:12px 16px }
                        .chart-container{ height:220px }
                        canvas{ max-width:100% !important; height:auto !important }
                        .table-responsive{ overflow-x:auto; -webkit-overflow-scrolling:touch }
                        table{ width:100%; }
                        th, td{ padding:10px 6px; font-size:13px }
                        .metric-row{ display:flex; flex-direction:column; gap:6px }
                        .expenseDetailsTable{ width:100%; overflow-x:auto }
                        /* allow collapsing left column */
                        .params-column.collapsed{ display:none !important }
                        .main-grid.collapsed-columns{ grid-template-columns: 1fr !important }
                    }

                    @media (max-width: 480px) {
                        body{ padding:8px }
                        header{ padding:14px }
                        header h1{ font-size:18px }
                        .tab-btn{ padding:10px 10px; font-size:14px }
                        .chart-container{ height:180px }
                        .card{ padding:12px }
                        .tabs{ gap:4px }
                    }

                    </style>
                    </head>
                    <body>
                    <div class="wrap">
                        <header style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:32px 24px;border-radius:20px;margin-bottom:24px;box-shadow:0 20px 40px rgba(102,126,234,0.15)">
                        <div style="display:flex;align-items:center;gap:20px;margin-bottom:16px">
                            <!-- Mobile menu toggle (visible on small screens) -->
                            <button id="mobileMenuToggle" onclick="toggleMobileMenu()" style="display:none;margin-left:auto;padding:8px 12px;border-radius:10px;border:none;background:rgba(255,255,255,0.12);color:white;cursor:pointer">‚ò∞ –ú–µ–Ω—é</button>
                            <div style="background:rgba(255,255,255,0.2);padding:16px;border-radius:16px;backdrop-filter:blur(10px)">
                                <div style="font-size:32px">ÔøΩÔ∏è</div>
                            </div>
                            <div>
                                <h1 style="margin:0;font-size:28px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.1)">CampManager Pro</h1>
                                <div style="font-size:14px;opacity:0.9;margin-top:4px">–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–∞–±–æ—Ä–æ–º</div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;font-size:13px;opacity:0.95">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="background:rgba(255,255,255,0.2);padding:6px;border-radius:8px">üìä</span>
                                <span>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è —ñ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü—ñ–Ω</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="background:rgba(255,255,255,0.2);padding:6px;border-radius:8px">üë•</span>
                                <span>CRM –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è–º</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="background:rgba(255,255,255,0.2);padding:6px;border-radius:8px">üí∞</span>
                                <span>–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –æ–±–ª—ñ–∫ –∑–∞ –ø–µ—Ä—ñ–æ–¥–∞–º–∏</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="background:rgba(255,255,255,0.2);padding:6px;border-radius:8px">üìà</span>
                                <span>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —ñ –∑–≤—ñ—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</span>
                            </div>
                        </div>
                        </header>
                        
                        <div class="tabs" style="background:white;border-radius:16px;padding:8px;box-shadow:0 8px 32px rgba(0,0,0,0.08);margin-bottom:24px">
                        <button class="tab-btn active" data-tab="homeTab" style="background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;padding:12px 20px;border-radius:12px;font-weight:600;box-shadow:0 4px 12px rgba(16,185,129,0.3)">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
                        <button class="tab-btn" data-tab="salesTab">üìä –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫</button>
                        <button class="tab-btn" data-tab="clientsTab">üë• CRM</button>
                        <button class="tab-btn" data-tab="financeTab">üí∞ –§—ñ–Ω–∞–Ω—Å–∏</button>
                        <button class="tab-btn" data-tab="analyticsTab">üìà –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
                        <button class="tab-btn" data-tab="settingsTab" id="settingsTabBtn" style="display:none">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                        <div id="authStatus" style="margin-left:auto;display:flex;align-items:center;gap:8px;font-size:12px;color:#475569">
                            <span id="currentUserLabel" style="display:none"></span>
                            <button id="loginBtn" onclick="showLoginModal()" style="padding:6px 12px;border-radius:8px;border:1px solid #3b82f6;background:#ffffff;color:#1e40af;font-weight:600;cursor:pointer;font-size:12px">–£–≤—ñ–π—Ç–∏</button>
                            <button id="logoutBtn" onclick="logoutUser()" style="display:none;padding:6px 12px;border-radius:8px;border:1px solid #ef4444;background:#fff;color:#991b1b;font-weight:600;cursor:pointer;font-size:12px">–í–∏–π—Ç–∏</button>
                        </div>
                        </div>

                        <!-- –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ (Dashboard) -->
                        <div id="homeTab" class="tab-pane active">
                            
                            <!-- –®–≤–∏–¥–∫–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:32px">
                                
                                <!-- –ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å -->
                                <div class="card" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;text-align:center">
                                    <div style="font-size:14px;opacity:0.9;margin-bottom:8px">üí∞ –ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å</div>
                                    <div id="dashboardTotalBalance" style="font-size:32px;font-weight:700;margin-bottom:4px">0 ‚Ç¥</div>
                                    <div style="font-size:12px;opacity:0.8">–≤—Å—ñ —Ä–∞—Ö—É–Ω–∫–∏</div>
                                </div>
                                
                                <!-- –ê–∫—Ç–∏–≤–Ω—ñ –ø–ª–∞–Ω–∏ -->
                                <div class="card" style="background:linear-gradient(135deg,#10b981,#059669);color:white;text-align:center">
                                    <div style="font-size:14px;opacity:0.9;margin-bottom:8px">üìÖ –ê–∫—Ç–∏–≤–Ω—ñ –ø–ª–∞–Ω–∏</div>
                                    <div id="dashboardActivePlans" style="font-size:32px;font-weight:700;margin-bottom:4px">0</div>
                                    <div style="font-size:12px;opacity:0.8">–∑–∞—Ä–∞–∑ –ø—Ä–∞—Ü—é—î</div>
                                </div>
                                
                                <!-- –ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ—Ç–µ–π -->
                                <div class="card" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;text-align:center">
                                    <div style="font-size:14px;opacity:0.9;margin-bottom:8px">üë• –î—ñ—Ç–∏ –≤ –∑–º—ñ–Ω–∞—Ö</div>
                                    <div id="dashboardChildrenCount" style="font-size:32px;font-weight:700;margin-bottom:4px">0</div>
                                    <div style="font-size:12px;opacity:0.8">–≤ –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–º—ñ–Ω–∞—Ö</div>
                                </div>
                                
                                <!-- –ú—ñ—Å—è—á–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ -->
                                <div class="card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;text-align:center">
                                    <div style="font-size:14px;opacity:0.9;margin-bottom:8px">üìä –ü—Ä–∏–±—É—Ç–æ–∫ –º—ñ—Å—è—Ü—è</div>
                                    <div id="dashboardMonthlyProfit" style="font-size:32px;font-weight:700;margin-bottom:4px">0 ‚Ç¥</div>
                                    <div style="font-size:12px;opacity:0.8">–ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å</div>
                                </div>
                                
                            </div>

                            <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
                                
                                <!-- –ê–∫—Ç–∏–≤–Ω—ñ –∑–º—ñ–Ω–∏ -->
                                <div class="card">
                                    <h3 style="margin:0 0 20px 0;display:flex;align-items:center;justify-content:space-between">
                                        <span>üèïÔ∏è –ê–∫—Ç–∏–≤–Ω—ñ –∑–º—ñ–Ω–∏</span>
                                        <button onclick="showTab('salesTab')" style="padding:6px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞–Ω</button>
                                    </h3>
                                    <div id="dashboardActiveShifts">
                                        <div style="text-align:center;padding:40px;color:#64748b">
                                            <div style="font-size:48px;margin-bottom:16px;opacity:0.5">üèïÔ∏è</div>
                                            <div>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–º—ñ–Ω</div>
                                            <div style="font-size:13px;margin-top:8px">–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à–∏–π –ø–ª–∞–Ω, —â–æ–± –ø–æ—á–∞—Ç–∏</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –®–≤–∏–¥–∫—ñ –¥—ñ—ó -->
                                <div class="card">
                                    <h3 style="margin:0 0 20px 0">‚ö° –®–≤–∏–¥–∫—ñ –¥—ñ—ó</h3>
                                    <div style="display:flex;flex-direction:column;gap:12px">
                                        
                                        <button onclick="showTab('salesTab')" style="display:flex;align-items:center;padding:12px;background:#f0f9ff;border:1px solid #bfdbfe;border-radius:8px;cursor:pointer;transition:all 0.2s ease" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='#f0f9ff'">
                                            <span style="font-size:20px;margin-right:12px">üìä</span>
                                            <div>
                                                <div style="font-weight:600;color:#1e40af">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞–Ω</div>
                                                <div style="font-size:12px;color:#64748b">–ù–æ–≤–∏–π —Ç–∞–±—ñ—Ä –∞–±–æ –∑–º—ñ–Ω–∞</div>
                                            </div>
                                        </button>
                                        
                                        <button onclick="showAccountsSettingsModal()" style="display:flex;align-items:center;padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;cursor:pointer;transition:all 0.2s ease" onmouseover="this.style.background='#dcfce7'" onmouseout="this.style.background='#f0fdf4'">
                                            <span style="font-size:20px;margin-right:12px">üí≥</span>
                                            <div>
                                                <div style="font-weight:600;color:#166534">–î–æ–¥–∞—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</div>
                                                <div style="font-size:12px;color:#64748b">–ë–∞–Ω–∫ –∞–±–æ –§–û–ü</div>
                                            </div>
                                        </button>
                                        
                                        <button onclick="showFopAssignmentModal()" style="display:flex;align-items:center;padding:12px;background:#fffbeb;border:1px solid #fed7aa;border-radius:8px;cursor:pointer;transition:all 0.2s ease" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='#fffbeb'">
                                            <span style="font-size:20px;margin-right:12px">üë§</span>
                                            <div>
                                                <div style="font-weight:600;color:#92400e">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –§–û–ü</div>
                                                <div style="font-size:12px;color:#64748b">–î–æ –∑–º—ñ–Ω</div>
                                            </div>
                                        </button>
                                        
                                        <button onclick="showTab('clientsTab')" style="display:flex;align-items:center;padding:12px;background:#fdf4ff;border:1px solid #e9d5ff;border-radius:8px;cursor:pointer;transition:all 0.2s ease" onmouseover="this.style.background='#f3e8ff'" onmouseout="this.style.background='#fdf4ff'">
                                            <span style="font-size:20px;margin-right:12px">üë•</span>
                                            <div>
                                                <div style="font-weight:600;color:#7c2d12">–í—ñ–¥–∫—Ä–∏—Ç–∏ CRM</div>
                                                <div style="font-size:12px;color:#64748b">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏</div>
                                            </div>
                                        </button>
                                        
                                        <button onclick="showPlansManagementModal()" style="display:flex;align-items:center;padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;cursor:pointer;transition:all 0.2s ease" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">
                                            <span style="font-size:20px;margin-right:12px">üìã</span>
                                            <div>
                                                <div style="font-weight:600;color:#dc2626">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–ª–∞–Ω–∞–º–∏</div>
                                                <div style="font-size:12px;color:#64748b">–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ñ</div>
                                            </div>
                                        </button>
                                        
                                    </div>
                                </div>
                                
                            </div>
                            
                        </div>

                        <div id="salesTab" class="tab-pane">
                        <!-- Calculator Sub-tabs -->
                        <div style="display:flex;gap:2px;margin-bottom:24px;border-bottom:2px solid #e5e7eb">
                            <button onclick="switchCalculatorTab('sales')" id="calcSalesTabBtn" class="calc-tab-btn active" 
                                    style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid #3b82f6;color:#3b82f6;font-size:14px">
                                üíº –ü—Ä–æ–¥–∞–∂—ñ (—Ü—ñ–Ω–∞/–∑–Ω–∏–∂–∫–∏)
                            </button>
                            <button onclick="switchCalculatorTab('cost')" id="calcCostTabBtn" class="calc-tab-btn" 
                                    style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid transparent;color:#6b7280;font-size:14px">
                                üèïÔ∏è –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å (–ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è)
                            </button>
                        </div>

                        <!-- Sales Section (default visible) -->
                        <div id="calcSalesSection">
                        <div class="main-grid">
                        <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ -->
                        <div class="params-column">
                            <section class="card">
                            <div class="section">
                                <h2>‚öôÔ∏è –ë–∞–∑–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</h2>
                                <div class="grid" style="grid-template-columns: 1fr">
                                <div>
                                    <label>–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞ (‚Ç¥)</label>
                                    <input id="basePrice" type="number" value="26900" min="0" step="100" />
                                </div>
                                <div>
                                    <label>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏ (‚Ç¥)</label>
                                    <input id="costAmount" type="number" value="17000" min="0" step="50" />
                                </div>
                                <div>
                                    <label>–§—ñ–∫—Å–æ–≤–∞–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (‚Ç¥)</label>
                                    <input id="fixedCosts" type="number" value="0" min="0" step="1000" />
                                </div>
                                <div>
                                    <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ—Ç–µ–π –Ω–∞ –∑–º—ñ–Ω—ñ</label>
                                    <input id="totalChildren" type="number" value="35" min="1" step="1" />
                                </div>
                                <div>
                                    <label>–ú—ñ–Ω. –º–∞—Ä–∂–∞ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É (‚Ç¥)</label>
                                    <input id="minProfitMaxDisc" type="number" value="5000" min="0" step="100" />
                                </div>
                                </div>
                            </div>

                            <div class="section">
                                <h2>üí∞ –ó–Ω–∏–∂–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö</h2>
                                <div class="category">
                                <h3>15‚Äì20 –¥—ñ—Ç–µ–π</h3>
                                <div class="category-grid" style="grid-template-columns: 1fr 1fr">
                                    <div>
                                    <label><input type="checkbox" id="enableDisc1" checked> –ó–Ω–∏–∂–∫–∞ (%)</label>
                                    <input id="disc1" type="number" value="5" min="0" max="100" step="0.1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableCoach1" checked> –ö-—Ç—å –≤–æ–∂–∞—Ç–∏—Ö</label>
                                    <input id="coachQty1" type="number" value="1" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label>–û–ø–ª–∞—Ç–∞ –∑–∞ –≤–æ–∂–∞—Ç–æ–≥–æ (‚Ç¥)</label>
                                    <input id="coachPay1" type="number" value="5000" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableTransfer1" checked> –¢—Ä–∞–Ω—Å—Ñ–µ—Ä (‚Ç¥)</label>
                                    <input id="transferAmount1" type="number" value="0" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableTax1" checked> –ü–æ–¥–∞—Ç–æ–∫ (%)</label>
                                    <input id="taxPct1" type="number" value="6" min="0" max="100" step="0.1" />
                                    </div>
                                </div>
                                </div>
                                
                                <div class="category">
                                <h3>21‚Äì30 –¥—ñ—Ç–µ–π</h3>
                                <div class="category-grid" style="grid-template-columns: 1fr 1fr">
                                    <div>
                                    <label><input type="checkbox" id="enableDisc2" checked> –ó–Ω–∏–∂–∫–∞ (%)</label>
                                    <input id="disc2" type="number" value="7" min="0" max="100" step="0.1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableCoach2" checked> –ö-—Ç—å –≤–æ–∂–∞—Ç–∏—Ö</label>
                                    <input id="coachQty2" type="number" value="2" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label>–û–ø–ª–∞—Ç–∞ –∑–∞ –≤–æ–∂–∞—Ç–æ–≥–æ (‚Ç¥)</label>
                                    <input id="coachPay2" type="number" value="5000" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableTransfer2" checked> –¢—Ä–∞–Ω—Å—Ñ–µ—Ä (‚Ç¥)</label>
                                    <input id="transferAmount2" type="number" value="0" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableTax2" checked> –ü–æ–¥–∞—Ç–æ–∫ (%)</label>
                                    <input id="taxPct2" type="number" value="6" min="0" max="100" step="0.1" />
                                    </div>
                                </div>
                                </div>
                                
                                <div class="category">
                                <h3>31+ –¥—ñ—Ç–µ–π</h3>
                                <div class="category-grid" style="grid-template-columns: 1fr 1fr">
                                    <div>
                                    <label><input type="checkbox" id="enableDisc3" checked> –ó–Ω–∏–∂–∫–∞ (%)</label>
                                    <input id="disc3" type="number" value="10" min="0" max="100" step="0.1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableCoach3" checked> –ö-—Ç—å –≤–æ–∂–∞—Ç–∏—Ö</label>
                                    <input id="coachQty3" type="number" value="3" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label>–û–ø–ª–∞—Ç–∞ –∑–∞ –≤–æ–∂–∞—Ç–æ–≥–æ (‚Ç¥)</label>
                                    <input id="coachPay3" type="number" value="5000" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableTransfer3" checked> –¢—Ä–∞–Ω—Å—Ñ–µ—Ä (‚Ç¥)</label>
                                    <input id="transferAmount3" type="number" value="0" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="enableTax3" checked> –ü–æ–¥–∞—Ç–æ–∫ (%)</label>
                                    <input id="taxPct3" type="number" value="6" min="0" max="100" step="0.1" />
                                    </div>
                                </div>
                                </div>
                                
                                <div class="card" style="margin-top:16px;background:#f8fafc">
                                <h3 style="margin:0 0 10px 0;font-size:16px;color:#0f172a">üí∞ –ó–Ω–∏–∂–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö</h3>
                                <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
                                    <div>
                                    <label>–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è (—Å—É–º–∞, –≥—Ä–Ω)</label>
                                    <input id="catEarlyAmount" type="number" value="1000" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label>–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å (—Å—É–º–∞, –≥—Ä–Ω)</label>
                                    <input id="catRepeatAmount" type="number" value="1000" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label>–î—Ä—É–∑—ñ (—Å—É–º–∞, –≥—Ä–Ω)</label>
                                    <input id="catFriendsAmount" type="number" value="1000" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label>–£–ë–î —ñ –í–ü–û (–≤—ñ–¥—Å–æ—Ç–æ–∫, %)</label>
                                    <input id="catSocPct" type="number" value="10" min="0" max="100" step="0.1" />
                                    </div>
                                    <div>
                                    <label>2 –∑–º—ñ–Ω–∏ (–≤—ñ–¥—Å–æ—Ç–æ–∫, %)</label>
                                    <input id="catDoublePct" type="number" value="5" min="0" max="100" step="0.1" />
                                    </div>
                                    <div>
                                    <label>–†–∞–Ω–Ω—î + —Å–æ—Ü (—Å—É–º–∞, –≥—Ä–Ω + %)</label>
                                    <input id="catEarlySocAmount" type="number" value="1000" min="0" step="100" />
                                    <input id="catEarlySocPct" type="number" value="10" min="0" max="100" step="0.1" />
                                    </div>
                                </div>
                                </div>
                                <div class="card" style="margin-top:16px;background:#f8fafc">
                                <h3 style="margin:0 0 10px 0;font-size:16px;color:#0f172a">üí∏ –ó–Ω–∏–∂–∫–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ—ó –≥—Ä—É–ø–∏</h3>
                                <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
                                    <div>
                                    <label><input type="checkbox" id="customEarlyCheck" /> –†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customEarlyCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="customRepeatCheck" /> –í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customRepeatCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="customFriendsCheck" /> –î—Ä—É–∑—ñ</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customFriendsCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="customSocCheck" /> –£–ë–î —ñ –í–ü–û</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customSocCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="customDoubleCheck" /> 2 –∑–º—ñ–Ω–∏</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customDoubleCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="customEarlySocCheck" /> –†–∞–Ω–Ω—î + —Å–æ—Ü</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customEarlySocCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                    <div>
                                    <label><input type="checkbox" id="customCategoryCheck" /> –ö–∞—Å—Ç–æ–º–Ω–∞ –∑–Ω–∏–∂–∫–∞ (–∞–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó)</label>
                                    <label>–ö-—Å—Ç—å –¥—ñ—Ç–µ–π</label>
                                    <input id="customCategoryCount" type="number" value="0" min="0" step="1" />
                                    </div>
                                </div>
                                </div>
                            </div>

                            <div class="section">
                                <h2>üéÆ –ö–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
                                <div class="controls" style="flex-direction: column">
                                <button id="calcBtn" class="btn" style="width: 100%">–ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
                                <button id="downloadCsv" class="mutebtn" style="width: 100%">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV</button>
                                <button id="resetBtn" class="mutebtn" style="width: 100%">–°–∫–∏–Ω—É—Ç–∏</button>
                                </div>
                            </div>
                            </section>
                        </div>

                        <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ -->
                        <div class="results-column">
                            <section class="card">
                            <div class="section">
                                <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤</h2>
                                <div id="result" style="margin-top:16px"></div>
                                <div id="marginCheck" style="margin-top:16px"></div>
                                <div id="breakevenInfo" style="margin-top:16px"></div>
                                <div class="chart-container">
                                <canvas id="profitChart"></canvas>
                                </div>
                            </div>

                            <div class="footer">–ü–æ—è—Å–Ω–µ–Ω–Ω—è: –ö–æ–∂–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó. –ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Ü—ñ–Ω–∞ = –±–∞–∑–æ–≤–∞ √ó (1 ‚àí % –∑–Ω–∏–∂–∫–∞) ‚àí —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä. –¶—ñ–Ω–∞ –ø—ñ—Å–ª—è –ø–æ–¥–∞—Ç–∫—É = –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ √ó (1 ‚àí –ø–æ–¥–∞—Ç–æ–∫%). –ù–µ—Ç—Ç–æ = —Ü—ñ–Ω–∞ –ø—ñ—Å–ª—è –ø–æ–¥–∞—Ç–∫—É ‚àí (–≤–æ–∂–∞—Ç—ñ / –≥—Ä—É–ø–∞). –ü—Ä–∏–±—É—Ç–æ–∫ = (–Ω–µ—Ç—Ç–æ √ó –≥—Ä—É–ø–∞) ‚àí (—Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å √ó –≥—Ä—É–ø–∞ + —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ). –¢–æ—á–∫–∞ –±–µ–∑–∑–±–∏—Ç–∫–æ–≤–æ—Å—Ç—ñ ‚Äî –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ—Ç–µ–π.</div>
                            </section>
                        </div>
                        </div>
                        </div>

                        <!-- Cost Section (hidden by default) -->
                        <div id="calcCostSection" style="display:none">
                        <div class="cost-grid">
                            <div class="cost-left">
                            <section class="card">
                                <div class="section">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                                    <h2 style="margin:0">üìã –ü–ª–∞–Ω–∏ –Ω–∞ —Å–µ–∑–æ–Ω–∏</h2>
                                    <button type="button" class="btn" id="addPlanBtn" style="background:#10b981;color:white;font-weight:700">+ –î–æ–¥–∞—Ç–∏ –ø–ª–∞–Ω</button>
                                </div>
                                <div id="plansListContainer" style="margin-bottom:16px">
                                    <!-- Plans will be rendered here -->
                                </div>
                                </div>
                                
                                <div class="section" id="activePlanEditor" style="display:none">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <h2 style="margin:0">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–ª–∞–Ω—É</h2>
                                    <div style="display:flex;gap:8px">
                                    <button type="button" class="btn" id="savePlanBtn" style="background:#10b981;color:white;font-weight:600;font-size:13px;padding:8px 16px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                    <button type="button" class="mutebtn" id="cancelPlanBtn" style="font-size:13px;padding:8px 16px">‚úï –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom:16px;padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:8px">
                                    <label style="font-weight:700;display:block;margin-bottom:8px">–ù–∞–∑–≤–∞ –ø–ª–∞–Ω—É</label>
                                    <input type="text" id="planName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ó–∏–º–∞ 2026" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                
                                <h3 style="margin:0 0 12px 0">üßÆ –û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –ø–ª–∞–Ω—É</h3>
                                <div class="grid">
                                    <div>
                                    <label>–†–µ–∫–ª–∞–º–∞ (–≥—Ä–Ω)</label>
                                    <input type="number" id="planOpAdvertising" value="0" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label>–û–ø–ª–∞—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤ (–≥—Ä–Ω)</label>
                                    <input type="number" id="planOpManagers" value="0" min="0" step="100" />
                                    </div>
                                    <div>
                                    <label>–ó–∞–ø—É—Å–∫ —Å–µ–∑–æ–Ω—É (–≥—Ä–Ω)</label>
                                    <input type="number" id="planOpLaunch" value="0" min="0" step="100" />
                                    </div>
                                </div>
                                
                                <div class="divider"></div>
                                
                                <h3 style="margin:0 0 12px 0">üèïÔ∏è –ü–µ—Ä—ñ–æ–¥–∏ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—ó</h3>
                                <div id="periodsContainer"></div>
                                <button type="button" class="btn" id="addPeriodBtn" style="width:100%;margin-top:8px">+ –î–æ–¥–∞—Ç–∏ –ø–µ—Ä—ñ–æ–¥</button>
                                </div>
                            </section>
                            </div>
                            <div>
                            <section class="card">
                                <div class="section">
                                <h2>üìò –ü—ñ–¥—Å—É–º–æ–∫ —Å–æ–±—ñ–≤–∞—Ä—Ç–æ—Å—Ç—ñ</h2>
                                <div class="grid" style="grid-template-columns:1fr">
                                    <div>
                                    <label>–í—Å—å–æ–≥–æ –¥—ñ—Ç–µ–π (–ø—Ä–æ–≥–Ω–æ–∑)</label>
                                    <input type="text" id="sumTotalChildren" readonly value="0" />
                                    </div>
                                    <div>
                                    <label>–û–ø–µ—Ä. –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É</label>
                                    <input type="text" id="sumOpPerChild" readonly value="0 –≥—Ä–Ω" />
                                    </div>
                                    <div>
                                    <label>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –±–µ–∑ –æ–ø–µ—Ä.</label>
                                    <input type="text" id="sumCostNoOp" readonly value="0 –≥—Ä–Ω" />
                                    </div>
                                    <div>
                                    <label>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –∑ –æ–ø–µ—Ä.</label>
                                    <input type="text" id="sumCostWithOp" readonly value="0 –≥—Ä–Ω" />
                                    </div>
                                    <div>
                                    <label>üí∞ –°–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞ (–∑ –ª–æ–∫–∞—Ü—ñ–π)</label>
                                    <input type="text" id="sumAvgPrice" readonly value="0 –≥—Ä–Ω" style="background:#fef3c7;border-color:#f59e0b" />
                                    </div>
                                </div>
                                <div class="divider"></div>
                                <h3 style="margin:0 0 8px 0;font-size:16px;color:#0f172a">üìà –ú–µ—Ç—Ä–∏–∫–∏ —Å–µ–∑–æ–Ω—É</h3>
                                <div class="metrics-list">
                                    <div class="metric-row"><span class="label">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥ (–ø—Ä–æ–≥–Ω–æ–∑)</span><span class="value" id="sumRevenueSeason">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–ó–ü –∫–æ–º–∞–Ω–¥–∏ (—Å–µ–∑–æ–Ω)</span><span class="value" id="sumDirectSalary">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ (—Å–µ–∑–æ–Ω)</span><span class="value" id="sumDirectLivingTeam">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π (—Å–µ–∑–æ–Ω)</span><span class="value" id="sumDirectFoodChild">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥. (—Å–µ–∑–æ–Ω)</span><span class="value" id="sumDirectProgramExtra">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">‚úÖ –í—Å—å–æ–≥–æ –ø—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</span><span class="value" id="sumDirectTotal">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (—Å–µ–∑–æ–Ω)</span><span class="value" id="sumOpSeason">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–í–°–¨–û–ì–û –≤–∏—Ç—Ä–∞—Ç–∏</span><span class="value" id="sumTotalCostSeason">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</span><span class="value" id="sumProfitSeason">0 –≥—Ä–Ω</span></div>
                                    <div class="metric-row"><span class="label">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å</span><span class="value" id="sumProfitMargin">0%</span></div>
                                    <div class="metric-row"><span class="label">–°–µ—Ä–µ–¥–Ω—ñ–π –¥–æ—Ö—ñ–¥ –Ω–∞ –¥–∏—Ç–∏–Ω—É</span><span class="value" id="sumAvgRevenuePerChild">0 –≥—Ä–Ω</span></div>
                                </div>
                                <div style="display:flex;align-items:center;gap:10px;margin-top:10px">
                                    <input type="checkbox" id="syncCostToSales" checked />
                                    <label for="syncCostToSales">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ –≤–∫–ª–∞–¥–∫–æ—é –ü—Ä–æ–¥–∞–∂—ñ</label>
                                </div>
                                <div class="small" style="margin-top:8px;color:var(--muted)">–ü—Ä–∏ –≤–≤—ñ–º–∫–Ω–µ–Ω—ñ–π –æ–ø—Ü—ñ—ó –ø–æ–ª—è "–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—É—Ç—ñ–≤–∫–∏" —Ç–∞ "–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞" —É –≤–∫–ª–∞–¥—Ü—ñ –ü—Ä–æ–¥–∞–∂—ñ –∑–∞–ø–æ–≤–Ω—é–≤–∞—Ç–∏–º—É—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑—ñ —Å–µ—Ä–µ–¥–Ω—ñ—Ö –∑–Ω–∞—á–µ–Ω—å –≤—Å—ñ—Ö –ª–æ–∫–∞—Ü—ñ–π, —ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏–º—É—Ç—å—Å—è.</div>
                                </div>
                            </section>
                            </div>
                        </div>
                        </div>
                        </div>

                        <!-- CRM Tab -->
                        <div id="clientsTab" class="tab-pane">
                        <div class="card" style="max-width:100%">
                            <h2 style="margin:0 0 20px 0">üë• –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏</h2>
                            
                            <!-- Periods Mini Analytics -->
                            <div style="margin-bottom:24px">
                                <h3 style="margin:0 0 12px 0;font-size:16px;color:#374151">üìä –û–≥–ª—è–¥ –ø–µ—Ä—ñ–æ–¥—ñ–≤</h3>
                                <div id="activeSeasonsStats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>

            <!-- CRM Sub-tabs -->
            <div style="display:flex;gap:2px;margin-bottom:24px;border-bottom:2px solid #e5e7eb">
                <button onclick="switchCrmTab('clients')" id="crmClientsTabBtn" class="crm-tab-btn active" 
                        style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid #3b82f6;color:#3b82f6;font-size:14px">
                    üë• –ö–ª—ñ—î–Ω—Ç–∏
                </button>
                <button onclick="switchCrmTab('refunds')" id="crmRefundsTabBtn" class="crm-tab-btn" 
                        style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid transparent;color:#6b7280;font-size:14px;position:relative">
                    üí∏ –í—ñ–¥–º–æ–≤–∏
                    <span id="refundsCountBadge" style="position:absolute;top:-8px;right:8px;background:#ef4444;color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;line-height:1;display:none">0</span>
                </button>
            </div>

            <!-- Clients Section (hidden by default when refunds is active) -->
            <div id="crmClientsSection">
            <!-- Location & Shift Selection -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px">
                            <div>
                                <label style="font-weight:700">–ü–µ—Ä—ñ–æ–¥</label>
                                <select id="crmPeriod" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–í–∏–±—Ä–∞—Ç–∏ –ø–µ—Ä—ñ–æ–¥...</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight:700">–õ–æ–∫–∞—Ü—ñ—è</label>
                                <select id="crmLocation" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–í–∏–±—Ä–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é...</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight:700">–ó–º—ñ–Ω–∞</label>
                                <select id="crmShift" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–í–∏–±—Ä–∞—Ç–∏ –∑–º—ñ–Ω—É...</option>
                                </select>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:8px;justify-content:flex-end">
                                <button id="addClient" class="btn" style="width:100%">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
                                <button onclick="document.getElementById('settingsTabBtn').click()" class="mutebtn" style="width:100%">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                                <button id="importClients" class="mutebtn" style="width:100%">üì§ –Ü–º–ø–æ—Ä—Ç –∑ Google Sheets/CSV</button>
                                <button id="exportClients" class="mutebtn" style="width:100%">üì• –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                            </div>
                            </div>

                            <!-- Summary Stats -->
                            <div id="crmStats" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;padding:16px;background:#f8fafc;border-radius:12px">
                            <div>
                                <div style="font-size:12px;color:#64748b">–í—Å—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤</div>
                                <div style="font-size:24px;font-weight:700;color:#0f172a" id="statTotalClients">0</div>
                            </div>
                            <div>
                                <div style="font-size:12px;color:#64748b">–ü–æ–≤–Ω—ñ –æ–ø–ª–∞—Ç–∏</div>
                                <div style="font-size:24px;font-weight:700;color:#10b981" id="statFullPaid">0</div>
                            </div>
                            <div>
                                <div style="font-size:12px;color:#64748b">–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</div>
                                <div style="font-size:24px;font-weight:700;color:#f59e0b" id="statPrepaid">0</div>
                            </div>
                            <div>
                                <div style="font-size:12px;color:#64748b">–°—É–º–∞ –≤–Ω–µ—Å–µ–Ω–∞</div>
                                <div style="font-size:24px;font-weight:700;color:#3b82f6" id="statTotalPaid">0 –≥—Ä–Ω</div>
                            </div>
                            <div>
                                <div style="font-size:12px;color:#64748b">–û—á—ñ–∫—É—î—Ç—å—Å—è</div>
                                <div style="font-size:24px;font-weight:700;color:#f59e0b" id="statExpected">0 –≥—Ä–Ω</div>
                            </div>
                            </div>

                            <!-- FOP Assignment Info -->
                            <div id="fopAssignmentInfo" style="margin-bottom:20px;padding:16px;background:#fefce8;border-radius:12px;border-left:4px solid #facc15;display:none">
                                <div style="display:flex;align-items:center;justify-content:space-between">
                                    <div>
                                        <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:4px">üë§ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –§–û–ü –¥–ª—è —Ü—ñ—î—ó –∑–º—ñ–Ω–∏</div>
                                        <div id="assignedFopName" style="font-size:16px;font-weight:700;color:#854d0e">–§–û–ü –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π</div>
                                    </div>
                                    <button id="showFopDetailsBtn" onclick="showCurrentFopDetails()" class="btn" style="padding:8px 16px;background:#facc15;color:#92400e;font-size:13px;display:none">üìã –†–µ–∫–≤—ñ–∑–∏—Ç–∏</button>
                                </div>
                            </div>

                            <!-- Search Bar -->
                            <div style="margin-bottom:20px">
                            <input type="text" id="clientSearch" placeholder="üîç –ü–æ—à—É–∫ –ø–æ –ü–Ü–ë, —Ç–µ–ª–µ—Ñ–æ–Ω—É, –º—ñ—Å—Ç—É, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ–π –æ—Å–æ–±—ñ, –∫–æ–º–µ–Ω—Ç–∞—Ä—é..." 
                                style="width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px">
                            </div>

                            <!-- Filters -->
                            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;padding:16px;background:#f8fafc;border-radius:12px">
                            <div>
                                <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:6px">–°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏</label>
                                <select id="filterPaymentStatus" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
                                <option value="">–í—Å—ñ</option>
                                <option value="–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</option>
                                <option value="–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞">–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                                <option value="–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ">–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ</option>
                                <option value="–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞">–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:6px">–¢–∏–ø –∫–ª—ñ—î–Ω—Ç–∞</label>
                                <select id="filterClientType" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
                                <option value="">–í—Å—ñ</option>
                                <option value="–Ω–æ–≤–∏–π">–ù–æ–≤–∏–π</option>
                                <option value="–ø–æ—Å—Ç—ñ–π–Ω–∏–π">–ü–æ—Å—Ç—ñ–π–Ω–∏–π</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:6px">–ó–Ω–∏–∂–∫–∞</label>
                                <select id="filterDiscount" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
                                <option value="">–í—Å—ñ</option>
                                <option value="–ù–µ–º–∞—î –∑–Ω–∏–∂–∫–∏">–ù–µ–º–∞—î –∑–Ω–∏–∂–∫–∏</option>
                                <option value="–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω–∞ —Å—ñ–º'—è">–ë–∞–≥–∞—Ç–æ–¥—ñ—Ç–Ω–∞ —Å—ñ–º'—è</option>
                                <option value="–î—Ä—É–∑—ñ">–î—Ä—É–∑—ñ</option>
                                <option value="–£–ë–î —ñ –í–ü–û">–£–ë–î —ñ –í–ü–û</option>
                                <option value="2 –∑–º—ñ–Ω–∏">2 –∑–º—ñ–Ω–∏</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:6px">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                                <select id="filterManager" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
                                <option value="">–í—Å—ñ</option>
                                </select>
                            </div>
                            <div style="display:flex;align-items:flex-end">
                                <button id="clearFilters" class="mutebtn" style="width:100%;padding:8px;font-size:13px">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
                            </div>
                            </div>

                            <!-- Clients Table -->
                            <div style="overflow-x:auto">
                            <table id="clientsTable" style="width:100%;border-collapse:collapse;font-size:13px">
                                <thead>
                                <tr style="background:#f1f5f9;text-align:left">
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">‚Ññ</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü–Ü–ë</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–°—É–º–∞ –≤–Ω–µ—Å–µ–Ω–∞</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ó–Ω–∏–∂–∫–∞</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–í–∞—Ä—Ç—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—É</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ú—ñ—Å—Ç–æ</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–¢–∏–ø</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–î—ñ—ó</th>
                                </tr>
                                </thead>
                                <tbody id="clientsTableBody">
                                <tr>
                                    <td colspan="13" style="padding:40px;text-align:center;color:#94a3b8">
                                    –û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                        </div>

                        <!-- Refunds Section (copied from original refunds tab) -->
                        <div id="crmRefundsSection" style="display:none">
                            <h3 style="margin:20px 0 16px 0;font-size:18px;color:#374151">‚ö†Ô∏è –í—ñ–¥–º–æ–≤–∏ –≤—ñ–¥ —Ç–∞–±–æ—Ä—É</h3>
                            
                            <!-- Stats by Period -->
                            <div id="crmRefundsStatsByPeriod" style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px"></div>
                            <!-- Pending refunds banner -->
                            <div id="crmRefundsPendingBanner" style="margin-bottom:12px"></div>

                            <!-- Hierarchical Navigator -->
                            <div id="crmRefundsBreadcrumb" style="margin-bottom:12px;color:#64748b;font-size:13px"></div>
                            <div id="crmRefundsNavigator" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px"></div>

                            <!-- Refunds Table -->
                            <div id="crmRefundsTableContainer" style="overflow-x:auto;display:none">
                            <table style="width:100%;border-collapse:collapse;font-size:13px">
                                <thead>
                                <tr style="background:#fef2f2;text-align:left">
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">‚Ññ</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–î–∞—Ç–∞ –≤—ñ–¥–º–æ–≤–∏</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–ü–Ü–ë</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–ü–µ—Ä—ñ–æ–¥/–õ–æ–∫–∞—Ü—ñ—è/–ó–º—ñ–Ω–∞</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–¢–∏–ø –≤—ñ–¥–º–æ–≤–∏</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–ü—Ä–∏—á–∏–Ω–∞</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–°—É–º–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–†–µ–∫–≤—ñ–∑–∏—Ç–∏</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–°—Ç–∞—Ç—É—Å</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #fecaca">–î—ñ—ó</th>
                                </tr>
                                </thead>
                                <tbody id="crmRefundsTableBody">
                                <tr>
                                    <td colspan="11" style="padding:40px;text-align:center;color:#94a3b8">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ ‚Üí –ª–æ–∫–∞—Ü—ñ—é ‚Üí –∑–º—ñ–Ω—É, —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—ñ–¥–º–æ–≤–∏</td>
                                </tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                        </div>

                        <!-- Finance Tab -->
                        <div id="financeTab" class="tab-pane">
                            <!-- Settings Buttons (Top) -->
                            <div style="margin-bottom:16px;display:flex;gap:12px">
                                <button onclick="showAccountsSettingsModal()" class="btn" style="padding:8px 16px;font-size:13px;background:#6366f1;color:white">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–∞—Ö—É–Ω–∫—ñ–≤</button>
                                <button onclick="showFopAssignmentModal()" class="btn" style="padding:8px 16px;font-size:13px;background:#f59e0b;color:white">üë§ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤ –¥–æ –∑–º—ñ–Ω</button>
                            </div>

                            <!-- Two columns below -->
                            <div style="display:flex;gap:24px">
                                <!-- LEFT: –û–ø–µ—Ä–∞—Ü—ñ—ó (–±–æ–ª—å—à–æ–π) -->
                                <div style="flex:2">
                                    <div class="card">
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                                            <h2 style="margin:0">üìã –û–ø–µ—Ä–∞—Ü—ñ—ó</h2>
                                            <button onclick="showAddOperationModal()" class="btn">‚ûï –î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é</button>
                                        </div>
                                        <div style="overflow-x:auto">
                                            <table style="width:100%;border-collapse:collapse;font-size:12px">
                                                <thead>
                                                    <tr style="background:#f1f5f9;font-weight:600">
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–î–∞—Ç–∞</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–ü–ª–∞–Ω</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–ü–µ—Ä—ñ–æ–¥</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–õ–æ–∫–∞—Ü—ñ—è</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–ó–º—ñ–Ω–∞</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–û–ø–∏—Å</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–°—É–º–∞ (+/-)</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:left">–†–∞—Ö—É–Ω–æ–∫</th>
                                                        <th style="padding:10px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–î—ñ—è</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="operationsTable">
                                                    <tr><td colspan="9" style="padding:32px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –æ–ø–µ—Ä–∞—Ü—ñ–π</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT: –ë–∞–ª–∞–Ω—Å–∏ (–º–∞–ª–µ–Ω—å–∫–∏–π) -->
                                <div style="flex:0 0 280px">
                                    <div class="card">
                                        <h3 style="margin:0 0 16px 0">üí≥ –ë–∞–ª–∞–Ω—Å–∏</h3>
                                        <div id="accountsBalances"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Tab -->
                        <div id="analyticsTab" class="tab-pane">
                        <div class="card" style="max-width:100%">
                            <h2 style="margin:0 0 20px 0">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤ —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤</h2>
                            
                            <!-- Financial Analytics Toggle -->
                            <div style="margin-bottom:20px">
                            <div style="display:flex;gap:12px;border-bottom:2px solid #e5e7eb">
                                <button onclick="switchAnalyticsTab('sales')" id="salesAnalyticsBtn" class="analytics-tab-btn active" style="padding:8px 16px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:2px solid transparent">
                                üõí –ü—Ä–æ–¥–∞–∂—ñ
                                </button>
                                <button onclick="switchAnalyticsTab('financial')" id="financialAnalyticsBtn" class="analytics-tab-btn" style="padding:8px 16px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:2px solid transparent">
                                üí∞ –§—ñ–Ω–∞–Ω—Å–∏
                                </button>
                                <button onclick="switchAnalyticsTab('profitability')" id="profitabilityAnalyticsBtn" class="analytics-tab-btn" style="padding:8px 16px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:2px solid transparent">
                                üìà –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å
                                </button>
                                <button onclick="switchAnalyticsTab('pnl')" id="pnlAnalyticsBtn" class="analytics-tab-btn" style="padding:8px 16px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:2px solid transparent">
                                üìã P&L
                                </button>
                                <button onclick="switchAnalyticsTab('kpi')" id="kpiAnalyticsBtn" class="analytics-tab-btn" style="padding:8px 16px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:2px solid transparent">
                                üéØ KPI Dashboard
                                </button>
                                <button onclick="switchAnalyticsTab('planVsFact')" id="planVsFactAnalyticsBtn" class="analytics-tab-btn" style="padding:8px 16px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:2px solid transparent">
                                üìä –ü–ª–∞–Ω vs –§–∞–∫—Ç
                                </button>
                            </div>
                            </div>

                            <!-- Sales Analytics Section -->
                            <div id="salesAnalyticsSection">
                            <!-- Overall KPI Cards -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                            <div style="padding:20px;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-radius:12px;border-left:4px solid #3b82f6;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#1e40af;margin-bottom:6px;font-weight:600">–í—Å—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤</div>
                                <div style="font-size:32px;font-weight:700;color:#1e40af" id="analyticsAllClients">0</div>
                            </div>
                            <div style="padding:20px;background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);border-radius:12px;border-left:4px solid #10b981;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#065f46;margin-bottom:6px;font-weight:600">–û—Ç—Ä–∏–º–∞–Ω–æ –∫–æ—à—Ç—ñ–≤</div>
                                <div style="font-size:32px;font-weight:700;color:#065f46" id="analyticsRevenue">0 –≥—Ä–Ω</div>
                            </div>
                            <div style="padding:20px;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border-radius:12px;border-left:4px solid #f59e0b;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#92400e;margin-bottom:6px;font-weight:600">–û—á—ñ–∫—É—î—Ç—å—Å—è</div>
                                <div style="font-size:32px;font-weight:700;color:#92400e" id="analyticsExpected">0 –≥—Ä–Ω</div>
                            </div>
                            <div style="padding:20px;background:linear-gradient(135deg,#fee2e2 0%,#fecaca 100%);border-radius:12px;border-left:4px solid #ef4444;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#991b1b;margin-bottom:6px;font-weight:600">–í—ñ–¥–º–æ–≤–∏</div>
                                <div style="font-size:32px;font-weight:700;color:#991b1b" id="analyticsRefunds">0</div>
                            </div>
                            <div style="padding:20px;background:linear-gradient(135deg,#e0e7ff 0%,#c7d2fe 100%);border-radius:12px;border-left:4px solid #6366f1;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#4338ca;margin-bottom:6px;font-weight:600">–ö–æ–Ω–≤–µ—Ä—Å—ñ—è</div>
                                <div style="font-size:32px;font-weight:700;color:#4338ca" id="analyticsConversion">0%</div>
                            </div>
                            <div style="padding:20px;background:linear-gradient(135deg,#fce7f3 0%,#fbcfe8 100%);border-radius:12px;border-left:4px solid #ec4899;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#831843;margin-bottom:6px;font-weight:600">–ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω</div>
                                <div style="font-size:32px;font-weight:700;color:#831843" id="analyticsFillRate">‚Äî</div>
                            </div>
                            </div>

                            <!-- Period Selection for Detailed View -->
                            <div style="display:flex;gap:12px;align-items:center;margin-bottom:20px;padding:16px;background:#f8fafc;border-radius:12px">
                            <div style="flex:1">
                                <label style="font-weight:700;display:block;margin-bottom:8px">–§—ñ–ª—å—Ç—Ä –ø–æ –ø–µ—Ä—ñ–æ–¥—É</label>
                                <select id="analyticsPeriodFilter" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–í—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏</option>
                                </select>
                            </div>
                            <div style="flex:1">
                                <label style="font-weight:700;display:block;margin-bottom:8px">–§—ñ–ª—å—Ç—Ä –ø–æ –ª–æ–∫–∞—Ü—ñ—ó</label>
                                <select id="analyticsLocationFilter" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–í—Å—ñ –ª–æ–∫–∞—Ü—ñ—ó</option>
                                </select>
                            </div>
                            <button onclick="updateAnalytics()" class="btn" style="align-self:flex-end;padding:10px 24px">–û–Ω–æ–≤–∏—Ç–∏</button>
                            </div>

                            <!-- Period Breakdown Table -->
                            <div style="margin-bottom:32px">
                            <h3 style="margin:0 0 16px 0;font-size:18px;font-weight:700;color:#0f172a">üìÖ –†–æ–∑–±–∏–≤–∫–∞ –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö —Ç–∞ –∑–º—ñ–Ω–∞—Ö</h3>
                            <div style="overflow-x:auto">
                                <table style="width:100%;border-collapse:collapse;font-size:13px">
                                <thead>
                                    <tr style="background:#f1f5f9;text-align:left">
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü–µ—Ä—ñ–æ–¥</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–õ–æ–∫–∞—Ü—ñ—è</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ó–º—ñ–Ω–∞</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–ü–ª–∞–Ω</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–§–∞–∫—Ç</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–û—Ç—Ä–∏–º–∞–Ω–æ</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–û—á—ñ–∫—É—î—Ç—å—Å—è</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">% –æ–ø–ª–∞—Ç–∏</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–í—ñ–¥–º–æ–≤–∏</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsBreakdownBody">
                                    <tr>
                                    <td colspan="10" style="padding:40px;text-align:center;color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td>
                                    </tr>
                                </tbody>
                                </table>
                            </div>
                            </div>

                            <!-- Charts Section -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
                            <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìà –î–∏–Ω–∞–º—ñ–∫–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤</h3>
                                <canvas id="analyticsSalesChart" style="max-height:300px"></canvas>
                            </div>
                            <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üí∞ –†–æ–∑–ø–æ–¥—ñ–ª –¥–æ—Ö–æ–¥—É</h3>
                                <canvas id="analyticsRevenueChart" style="max-height:300px"></canvas>
                            </div>
                            </div>

                            <!-- Managers Performance -->
                            <div style="margin-bottom:32px">
                            <h3 style="margin:0 0 16px 0;font-size:18px;font-weight:700;color:#0f172a">üë• –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤</h3>
                            <div style="overflow-x:auto">
                                <table style="width:100%;border-collapse:collapse;font-size:13px">
                                <thead>
                                    <tr style="background:#f1f5f9;text-align:left">
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–ö–ª—ñ—î–Ω—Ç—ñ–≤</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ü—Ä–æ–¥–∞–∂—ñ (–≥—Ä–Ω)</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫</th>
                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–ö–æ–Ω–≤–µ—Ä—Å—ñ—è</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsManagersBody">
                                    <tr>
                                    <td colspan="5" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td>
                                    </tr>
                                </tbody>
                                </table>
                            </div>
                            </div>
                            </div>

                            <!-- Financial Analytics Section -->
                            <div id="financialAnalyticsSection" style="display:none">
                            
                            <!-- Financial KPI Cards -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                                <div style="padding:20px;background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);border-radius:12px;border-left:4px solid #10b981;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#065f46;margin-bottom:6px;font-weight:600">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥</div>
                                <div style="font-size:32px;font-weight:700;color:#065f46" id="financialTotalIncome">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg,#fee2e2 0%,#fecaca 100%);border-radius:12px;border-left:4px solid #ef4444;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#991b1b;margin-bottom:6px;font-weight:600">–ó–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
                                <div style="font-size:32px;font-weight:700;color:#991b1b" id="financialTotalExpenses">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-radius:12px;border-left:4px solid #3b82f6;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#1e40af;margin-bottom:6px;font-weight:600">–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div>
                                <div style="font-size:32px;font-weight:700;color:#1e40af" id="financialNetProfit">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg,#f3e8ff 0%,#e9d5ff 100%);border-radius:12px;border-left:4px solid #8b5cf6;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#6b21a8;margin-bottom:6px;font-weight:600">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å</div>
                                <div style="font-size:32px;font-weight:700;color:#6b21a8" id="financialProfitMargin">0%</div>
                                </div>
                            </div>

                            <!-- Financial Categories Breakdown -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìä –†–æ–∑–ø–æ–¥—ñ–ª –¥–æ—Ö–æ–¥—ñ–≤</h3>
                                <canvas id="financialIncomeChart" style="max-height:300px"></canvas>
                                </div>
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üí∏ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç</h3>
                                <canvas id="financialExpensesChart" style="max-height:300px"></canvas>
                                </div>
                            </div>

                            <!-- Financial Operations Table -->
                            <div style="margin-bottom:32px">
                                <h3 style="margin:0 0 16px 0;font-size:18px;font-weight:700;color:#0f172a">üìã –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</h3>
                                <div style="overflow-x:auto">
                                <table style="width:100%;border-collapse:collapse;font-size:13px">
                                    <thead>
                                    <tr style="background:#f1f5f9;text-align:left">
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–î–∞—Ç–∞</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü–µ—Ä—ñ–æ–¥</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–õ–æ–∫–∞—Ü—ñ—è</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–°—É–º–∞</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                                    </tr>
                                    </thead>
                                    <tbody id="financialOperationsBody">
                                    <tr>
                                        <td colspan="7" style="padding:40px;text-align:center;color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td>
                                    </tr>
                                    </tbody>
                                </table>
                                </div>
                            </div>

                            <!-- Monthly Financial Trend -->
                            <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìà –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Ç—Ä–µ–Ω–¥–∏ –ø–æ –º—ñ—Å—è—Ü—è—Ö</h3>
                                <canvas id="financialTrendChart" style="max-height:300px"></canvas>
                            </div>
                            </div>

                            <!-- Profitability Analytics Section -->
                            <div id="profitabilityAnalyticsSection" style="display:none">
                            
                            <!-- Profitability KPIs -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                                <div style="padding:20px;background:linear-gradient(135deg,#ecfdf5 0%,#d1fae5 100%);border-radius:12px;border-left:4px solid #22c55e;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#15803d;margin-bottom:6px;font-weight:600">–í–∞–ª–æ–≤–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å</div>
                                <div style="font-size:32px;font-weight:700;color:#15803d" id="profitabilityGrossMargin">0%</div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg,#fef7ff 0%,#f3e8ff 100%);border-radius:12px;border-left:4px solid #a855f7;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#7c2d92;margin-bottom:6px;font-weight:600">–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å</div>
                                <div style="font-size:32px;font-weight:700;color:#7c2d92" id="profitabilityOperatingMargin">0%</div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg,#fefce8 0%,#fef3c7 100%);border-radius:12px;border-left:4px solid #eab308;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#a16207;margin-bottom:6px;font-weight:600">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –∑–∞ –ø–µ—Ä—ñ–æ–¥</div>
                                <div style="font-size:32px;font-weight:700;color:#a16207" id="profitabilityPeriodMargin">0%</div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg,#f0fdfa 0%,#ccfbf1 100%);border-radius:12px;border-left:4px solid #14b8a6;box-shadow:var(--shadow)">
                                <div style="font-size:13px;color:#0f766e;margin-bottom:6px;font-weight:600">–í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É</div>
                                <div style="font-size:32px;font-weight:700;color:#0f766e" id="profitabilityCostPerChild">0 –≥—Ä–Ω</div>
                                </div>
                            </div>

                            <!-- Profitability by Period -->
                            <div style="margin-bottom:32px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                                    <h3 style="margin:0;font-size:18px;font-weight:700;color:#0f172a">üìä –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –ø–æ per√≠–æ–¥–∞—Ö</h3>
                                    <div style="display:flex;gap:12px;align-items:center">
                                        <div style="display:flex;flex-direction:column;gap:4px">
                                            <label style="font-size:12px;color:#64748b;font-weight:600">–ü–µ—Ä—ñ–æ–¥:</label>
                                            <select id="profitabilityPeriodFilter" onchange="updateProfitabilityAnalytics()" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;color:#374151;min-width:150px">
                                                <option value="">–í—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏</option>
                                            </select>
                                        </div>
                                        <!-- –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≤–∏–¥–∞–ª–µ–Ω–∞ –∑–∞ –∑–∞–ø–∏—Ç–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
                                    </div>
                                </div>
                                <div style="overflow-x:auto">
                                <table style="width:100%;border-collapse:collapse;font-size:13px">
                                    <thead>
                                    <tr style="background:#f1f5f9;text-align:left">
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü–µ—Ä—ñ–æ–¥</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–î–æ—Ö–æ–¥–∏</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ü—Ä–∏–±—É—Ç–æ–∫</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å</th>
                                    </tr>
                                    </thead>
                                    <tbody id="profitabilityPeriodBody">
                                    <tr>
                                        <td colspan="7" style="padding:40px;text-align:center;color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td>
                                    </tr>
                                    </tbody>
                                </table>
                                </div>
                            </div>

                            <!-- Detailed Expense Analysis -->
                            <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                                    <h3 style="margin:0;font-size:18px;font-weight:700;color:#0f172a">üí° –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –≤–∏—Ç—Ä–∞—Ç</h3>
                                    <button onclick="toggleExpenseDetails()" id="expenseDetailsToggle" style="padding:8px 16px;font-size:13px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer">üìä –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—é</button>
                                </div>
                                
                                <!-- Expense Summary Cards -->
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                                    <div style="background:linear-gradient(135deg,#fef3c7 0%,#fbbf24 100%);padding:16px;border-radius:10px;text-align:center">
                                        <div style="font-size:14px;color:#92400e;margin-bottom:4px">–ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
                                        <div style="font-size:20px;font-weight:700;color:#92400e" id="detailedDirectTotal">45.0%</div>
                                        <div style="font-size:12px;color:#a16207" id="detailedDirectAmount">0 –≥—Ä–Ω</div>
                                    </div>
                                    <div style="background:linear-gradient(135deg,#ddd6fe 0%,#8b5cf6 100%);padding:16px;border-radius:10px;text-align:center">
                                        <div style="font-size:14px;color:#5b21b6;margin-bottom:4px">–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
                                        <div style="font-size:20px;font-weight:700;color:#5b21b6" id="detailedOperationalTotal">20.0%</div>
                                        <div style="font-size:12px;color:#6d28d9" id="detailedOperationalAmount">0 –≥—Ä–Ω</div>
                                    </div>
                                    <div style="background:linear-gradient(135deg,#fecaca 0%,#f87171 100%);padding:16px;border-radius:10px;text-align:center">
                                        <div style="font-size:14px;color:#991b1b;margin-bottom:4px">–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ</div>
                                        <div style="font-size:20px;font-weight:700;color:#991b1b" id="detailedUnexpectedTotal">3.0%</div>
                                        <div style="font-size:12px;color:#dc2626" id="detailedUnexpectedAmount">0 –≥—Ä–Ω</div>
                                    </div>
                                    <div style="background:linear-gradient(135deg,#d1fae5 0%,#34d399 100%);padding:16px;border-radius:10px;text-align:center">
                                        <div style="font-size:14px;color:#065f46;margin-bottom:4px">–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div>
                                        <div style="font-size:20px;font-weight:700;color:#065f46" id="detailedProfitTotal">32.0%</div>
                                        <div style="font-size:12px;color:#059669" id="detailedProfitAmount">0 –≥—Ä–Ω</div>
                                    </div>
                                </div>
                                
                                <!-- Detailed Breakdown Table -->
                                <div id="expenseDetailsTable" style="display:none">
                                    <div style="overflow-x:auto">
                                        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-top:20px">
                                            <thead>
                                                <tr style="background:#f8fafc;text-align:left">
                                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–°—É–º–∞</th>
                                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">% –≤—ñ–¥ –¥–æ—Ö–æ–¥—É</th>
                                                    <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center">–°—Ç–∞—Ç—É—Å</th>
                                                </tr>
                                            </thead>
                                            <tbody id="expenseDetailsBody">
                                                <tr><td colspan="5" style="padding:40px;text-align:center;color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Cost Structure Analysis -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç</h3>
                                <canvas id="profitabilityCostStructureChart" style="max-height:300px"></canvas>
                                </div>
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìà –î–∏–Ω–∞–º—ñ–∫–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ</h3>
                                <canvas id="profitabilityTrendChart" style="max-height:300px"></canvas>
                                </div>
                            </div>
                            </div>
                            </div>

                            <!-- P&L Analytics Section -->
                            <div id="pnlAnalyticsSection" style="display:none">
                            
                            <!-- P&L Header -->
                            <div style="background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);padding:20px;border-radius:12px;margin-bottom:24px;border-left:4px solid #6366f1">
                                <h3 style="margin:0 0 8px 0;color:#1e293b;font-size:18px">üìã –ó–≤—ñ—Ç –ø—Ä–æ –ø—Ä–∏–±—É—Ç–∫–∏ —Ç–∞ –∑–±–∏—Ç–∫–∏ (P&L)</h3>
                                <p style="margin:0;color:#64748b;font-size:14px">–î–æ—Ö–æ–¥–∏ –∑ –ø—Ä–æ–¥–∞–∂—ñ–≤ + —Ñ–∞–∫—Ç–∏—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ = –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</p>
                            </div>

                            <!-- P&L Statement -->
                            <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                                <h3 style="margin:0 0 20px 0;color:#0f172a;font-size:16px;font-weight:700">üí∞ –ó–≤—ñ—Ç P&L</h3>
                                
                                <!-- Revenue Section -->
                                <div style="border-bottom:2px solid #e5e7eb;padding-bottom:16px;margin-bottom:16px">
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
                                    <div style="font-weight:600;color:#059669">üìà –î–û–•–û–î–ò</div>
                                    <div style="font-weight:700;color:#059669;font-size:16px" id="pnlTotalRevenue">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:4px 0 4px 20px;color:#6b7280;font-size:14px">
                                    <span>–ü—Ä–æ–¥–∞–∂—ñ –ø—É—Ç—ñ–≤–æ–∫</span>
                                    <span id="pnlSalesRevenue">0 –≥—Ä–Ω</span>
                                </div>
                                </div>

                                <!-- Cost of Goods Sold -->
                                <div style="border-bottom:1px solid #e5e7eb;padding-bottom:12px;margin-bottom:12px">
                                <div style="display:flex;justify-content:space-between;padding:4px 0 4px 20px;color:#dc2626">
                                    <span>–ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</span>
                                    <span id="pnlDirectCosts">0 –≥—Ä–Ω</span>
                                </div>
                                </div>

                                <!-- Gross Profit -->
                                <div style="border-bottom:2px solid #e5e7eb;padding-bottom:16px;margin-bottom:16px">
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
                                    <div style="font-weight:600;color:#0369a1">üíé –í–ê–õ–û–í–ò–ô –ü–†–ò–ë–£–¢–û–ö</div>
                                    <div style="font-weight:700;color:#0369a1;font-size:16px" id="pnlGrossProfit">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:4px 0 4px 20px;color:#6b7280;font-size:14px">
                                    <span>–í–∞–ª–æ–≤–∞ –º–∞—Ä–∂–∞</span>
                                    <span id="pnlGrossMargin">0%</span>
                                </div>
                                </div>

                                <!-- Operating Expenses -->
                                <div style="border-bottom:1px solid #e5e7eb;padding-bottom:12px;margin-bottom:12px">
                                <div style="display:flex;justify-content:space-between;padding:4px 0 4px 20px;color:#dc2626">
                                    <span>–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</span>
                                    <span id="pnlOperatingExpenses">0 –≥—Ä–Ω</span>
                                </div>
                                </div>

                                <!-- EBITDA -->
                                <div style="border-bottom:2px solid #e5e7eb;padding-bottom:16px;margin-bottom:16px">
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
                                    <div style="font-weight:600;color:#7c3aed">üöÄ EBITDA</div>
                                    <div style="font-weight:700;color:#7c3aed;font-size:16px" id="pnlEbitda">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:4px 0 4px 20px;color:#6b7280;font-size:14px">
                                    <span>EBITDA –º–∞—Ä–∂–∞</span>
                                    <span id="pnlEbitdaMargin">0%</span>
                                </div>
                                </div>

                                <!-- Other Expenses -->
                                <div style="border-bottom:1px solid #e5e7eb;padding-bottom:12px;margin-bottom:12px">
                                <div style="display:flex;justify-content:space-between;padding:4px 0 4px 20px;color:#dc2626">
                                    <span>–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</span>
                                    <span id="pnlOtherExpenses">0 –≥—Ä–Ω</span>
                                </div>
                                </div>

                                <!-- Net Profit -->
                                <div style="background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);padding:16px;border-radius:8px;border-left:4px solid #22c55e">
                                <div style="display:flex;justify-content:space-between;align-items:center">
                                    <div style="font-weight:700;color:#15803d;font-size:18px">üéØ –ß–ò–°–¢–ò–ô –ü–†–ò–ë–£–¢–û–ö</div>
                                    <div style="font-weight:700;color:#15803d;font-size:20px" id="pnlNetProfit">0 –≥—Ä–Ω</div>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-top:8px">
                                    <span style="color:#16a34a;font-weight:600">–ß–∏—Å—Ç–∞ –º–∞—Ä–∂–∞</span>
                                    <span style="color:#16a34a;font-weight:600" id="pnlNetMargin">0%</span>
                                </div>
                                </div>
                            </div>

                            <!-- P&L Charts -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ—Ö–æ–¥—ñ–≤</h3>
                                <canvas id="pnlRevenueChart" style="max-height:300px"></canvas>
                                </div>
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üí∏ –í–æ–¥–æ—Å–ø–∞–¥ –≤–∏—Ç—Ä–∞—Ç</h3>
                                <canvas id="pnlWaterfallChart" style="max-height:300px"></canvas>
                                </div>
                            </div>

                            <!-- P&L Trend -->
                            <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                                <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìà –î–∏–Ω–∞–º—ñ–∫–∞ P&L –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö</h3>
                                <canvas id="pnlTrendChart" style="max-height:300px"></canvas>
                            </div>
                            </div>

                        </div>
                        
                        <!-- KPI Dashboard Section -->
                        <div id="kpiAnalyticsSection" style="display:none">
                            <!-- KPI Header -->
                            <div style="background:linear-gradient(135deg,#f0f9ff 0%,#dbeafe 100%);padding:20px;border-radius:12px;margin-bottom:24px;border-left:4px solid #3b82f6">
                                <h3 style="margin:0 0 8px 0;color:#1e293b;font-size:18px">üéØ KPI Dashboard - –ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</h3>
                                <p style="margin:0;color:#64748b;font-size:14px">–Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ —Ç–∞ –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–∏—Ö —Ä—ñ—à–µ–Ω—å</p>
                            </div>

                            <!-- Performance Overview -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:32px">
                                <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;text-align:center">
                                    <div style="font-size:32px;font-weight:bold;margin-bottom:8px" id="kpiOverallRevenue">0 ‚Ç¥</div>
                                    <div style="font-size:14px;opacity:0.9">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥</div>
                                    <div style="font-size:12px;opacity:0.7;margin-top:4px" id="kpiRevenueGrowth">+0% –¥–æ –º–∏–Ω—É–ª–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:20px;border-radius:12px;text-align:center">
                                    <div style="font-size:32px;font-weight:bold;margin-bottom:8px" id="kpiAvgMargin">0%</div>
                                    <div style="font-size:14px;opacity:0.9">–°–µ—Ä–µ–¥–Ω—è –º–∞—Ä–∂–∞</div>
                                    <div style="font-size:12px;opacity:0.7;margin-top:4px" id="kpiMarginTrend">–¢—Ä–µ–Ω–¥: —Å—Ç–∞–±—ñ–ª—å–Ω–æ</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:12px;text-align:center">
                                    <div style="font-size:32px;font-weight:bold;margin-bottom:8px" id="kpiAvgOccupancy">0%</div>
                                    <div style="font-size:14px;opacity:0.9">–°–µ—Ä–µ–¥–Ω—è –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å</div>
                                    <div style="font-size:12px;opacity:0.7;margin-top:4px" id="kpiOccupancyTrend">–¶—ñ–ª—å–æ–≤–∞: 85%</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:12px;text-align:center">
                                    <div style="font-size:32px;font-weight:bold;margin-bottom:8px" id="kpiAvgCheck">0 ‚Ç¥</div>
                                    <div style="font-size:14px;opacity:0.9">–°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫</div>
                                    <div style="font-size:12px;opacity:0.7;margin-top:4px" id="kpiCheckGrowth">+0% –¥–æ –º–∏–Ω—É–ª–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É</div>
                                </div>
                            </div>

                            <!-- Performance Analysis by Location -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
                                <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <h4 style="margin:0 0 16px 0;color:#1e293b">üìç –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ª–æ–∫–∞—Ü—ñ–π</h4>
                                    <div id="kpiLocationAnalysis"></div>
                                </div>
                                <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <h4 style="margin:0 0 16px 0;color:#1e293b">‚è∞ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω</h4>
                                    <div id="kpiShiftAnalysis"></div>
                                </div>
                            </div>

                            <!-- Strategic Recommendations -->
                            <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                                <h4 style="margin:0 0 16px 0;color:#1e293b">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó</h4>
                                <div id="kpiRecommendations"></div>
                            </div>

                            <!-- Financial Health Score -->
                            <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h4 style="margin:0 0 16px 0;color:#1e293b">üè• –§—ñ–Ω–∞–Ω—Å–æ–≤–µ –∑–¥–æ—Ä–æ–≤'—è –±—ñ–∑–Ω–µ—Å—É</h4>
                                <div style="display:flex;align-items:center;gap:24px">
                                    <div style="flex:1">
                                        <canvas id="healthScoreChart" width="200" height="200"></canvas>
                                    </div>
                                    <div style="flex:2">
                                        <div id="healthScoreDetails"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Plan vs Fact Analytics Section -->
                        <div id="planVsFactAnalyticsSection" style="display:none">
                            <!-- Header with Plan Selector -->
                            <div style="background:linear-gradient(135deg,#fef3c7 0%,#fbbf24 100%);padding:20px;border-radius:12px;margin-bottom:24px;border-left:4px solid #f59e0b">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                    <h3 style="margin:0;color:#78350f;font-size:18px">üìä –ü–ª–∞–Ω vs –§–∞–∫—Ç - –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</h3>
                                    <div style="display:flex;align-items:center;gap:12px;font-weight:600;color:#78350f">
                                        <label for="pvfPlanSelector" style="font-size:14px;font-weight:600">–í–∏–±–µ—Ä—ñ—Ç—å –ø–ª–∞–Ω:</label>
                                        <select id="pvfPlanSelector" onchange="changePlanVsFactPlan()" style="padding:8px 12px;border-radius:8px;border:1px solid #f59e0b;background:white;color:#78350f;font-weight:600;cursor:pointer;font-size:14px">
                                            <option value="">-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è --</option>
                                        </select>
                                    </div>
                                </div>
                                <p style="margin:0;color:#92400e;font-size:14px">–í—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–ª–∞–Ω–æ–≤–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ —Ç–∞ –∞–Ω–∞–ª—ñ–∑—É–π—Ç–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</p>
                            </div>

                            <!-- Summary KPI Cards -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:32px">
                                <!-- Total Children Plan vs Fact -->
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                        <div style="font-size:13px;color:#64748b;font-weight:600">üë• –î—ñ—Ç–∏ (–≤—Å—å–æ–≥–æ)</div>
                                        <div style="font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600" id="pvfChildrenStatus">‚Äî</div>
                                    </div>
                                    <div style="display:flex;gap:16px;margin-bottom:12px">
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–ü–ª–∞–Ω</div>
                                            <div style="font-size:24px;font-weight:700;color:#3b82f6" id="pvfChildrenPlan">0</div>
                                        </div>
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–§–∞–∫—Ç</div>
                                            <div style="font-size:24px;font-weight:700;color:#10b981" id="pvfChildrenFact">0</div>
                                        </div>
                                    </div>
                                    <div style="background:#f8fafc;border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px">
                                        <div id="pvfChildrenProgress" style="background:linear-gradient(90deg,#3b82f6,#10b981);height:100%;width:0%;transition:width 0.5s ease"></div>
                                    </div>
                                    <div style="font-size:13px;color:#475569;font-weight:600" id="pvfChildrenPercent">0%</div>
                                </div>

                                <!-- Revenue Plan vs Fact -->
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                        <div style="font-size:13px;color:#64748b;font-weight:600">üí∞ –î–æ—Ö–æ–¥–∏</div>
                                        <div style="font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600" id="pvfRevenueStatus">‚Äî</div>
                                    </div>
                                    <div style="display:flex;gap:16px;margin-bottom:12px">
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–ü–ª–∞–Ω</div>
                                            <div style="font-size:20px;font-weight:700;color:#3b82f6" id="pvfRevenuePlan">0 –≥—Ä–Ω</div>
                                        </div>
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–§–∞–∫—Ç</div>
                                            <div style="font-size:20px;font-weight:700;color:#10b981" id="pvfRevenueFact">0 –≥—Ä–Ω</div>
                                        </div>
                                    </div>
                                    <div style="background:#f8fafc;border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px">
                                        <div id="pvfRevenueProgress" style="background:linear-gradient(90deg,#f59e0b,#10b981);height:100%;width:0%;transition:width 0.5s ease"></div>
                                    </div>
                                    <div style="font-size:13px;color:#475569;font-weight:600" id="pvfRevenuePercent">0%</div>
                                </div>

                                <!-- Expenses Plan vs Fact -->
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                        <div style="font-size:13px;color:#64748b;font-weight:600">üìâ –í–∏—Ç—Ä–∞—Ç–∏</div>
                                        <div style="font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600" id="pvfExpensesStatus">‚Äî</div>
                                    </div>
                                    <div style="display:flex;gap:16px;margin-bottom:12px">
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–ü–ª–∞–Ω</div>
                                            <div style="font-size:20px;font-weight:700;color:#3b82f6" id="pvfExpensesPlan">0 –≥—Ä–Ω</div>
                                        </div>
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–§–∞–∫—Ç</div>
                                            <div style="font-size:20px;font-weight:700;color:#ef4444" id="pvfExpensesFact">0 –≥—Ä–Ω</div>
                                        </div>
                                    </div>
                                    <div style="background:#f8fafc;border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px">
                                        <div id="pvfExpensesProgress" style="background:linear-gradient(90deg,#ef4444,#fbbf24);height:100%;width:0%;transition:width 0.5s ease"></div>
                                    </div>
                                    <div style="font-size:13px;color:#475569;font-weight:600" id="pvfExpensesPercent">0%</div>
                                </div>

                                <!-- Occupancy Plan vs Fact -->
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                        <div style="font-size:13px;color:#64748b;font-weight:600">üìä –ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å</div>
                                        <div style="font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600" id="pvfOccupancyStatus">‚Äî</div>
                                    </div>
                                    <div style="display:flex;gap:16px;margin-bottom:12px">
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–ü–ª–∞–Ω</div>
                                            <div style="font-size:24px;font-weight:700;color:#3b82f6" id="pvfOccupancyPlan">0%</div>
                                        </div>
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–§–∞–∫—Ç</div>
                                            <div style="font-size:24px;font-weight:700;color:#10b981" id="pvfOccupancyFact">0%</div>
                                        </div>
                                    </div>
                                    <div style="background:#f8fafc;border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px">
                                        <div id="pvfOccupancyProgress" style="background:linear-gradient(90deg,#8b5cf6,#10b981);height:100%;width:0%;transition:width 0.5s ease"></div>
                                    </div>
                                    <div style="font-size:13px;color:#475569;font-weight:600" id="pvfOccupancyPercent">0%</div>
                                </div>

                                <!-- Average Check Plan vs Fact -->
                                <div style="background:white;padding:20px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                        <div style="font-size:13px;color:#64748b;font-weight:600">üí≥ –°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫</div>
                                        <div style="font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600" id="pvfAvgCheckStatus">‚Äî</div>
                                    </div>
                                    <div style="display:flex;gap:16px;margin-bottom:12px">
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–ü–ª–∞–Ω</div>
                                            <div style="font-size:20px;font-weight:700;color:#3b82f6" id="pvfAvgCheckPlan">0 –≥—Ä–Ω</div>
                                        </div>
                                        <div>
                                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">–§–∞–∫—Ç</div>
                                            <div style="font-size:20px;font-weight:700;color:#10b981" id="pvfAvgCheckFact">0 –≥—Ä–Ω</div>
                                        </div>
                                    </div>
                                    <div style="background:#f8fafc;border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px">
                                        <div id="pvfAvgCheckProgress" style="background:linear-gradient(90deg,#ec4899,#10b981);height:100%;width:0%;transition:width 0.5s ease"></div>
                                    </div>
                                    <div style="font-size:13px;color:#475569;font-weight:600" id="pvfAvgCheckPercent">0%</div>
                                </div>
                            </div>

                    <!-- Cost Breakdown Section -->
                    <div id="pvfCostBreakdownSection" style="display:none;background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                            <h3 style="margin:0;font-size:18px;font-weight:700;color:#0f172a">üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç (–ø–ª–∞–Ω / —Ñ–∞–∫—Ç)</h3>
                            <span id="pvfCostBreakdownTotal" style="font-weight:700;color:#334155">0 –≥—Ä–Ω</span>
                        </div>
                        <div id="pvfCostCategoryChips" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px"></div>
                        <div style="overflow-x:auto">
                            <table style="width:100%;border-collapse:collapse;font-size:13px">
                                <thead>
                                    <tr style="background:#f8fafc;text-align:left">
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–ü–µ—Ä—ñ–æ–¥</th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ó–ü –∫–æ–º–∞–Ω–¥–∏<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–ü—Ä–æ–≥—Ä–∞–º–∞ + –¥–æ–¥.<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right">–í—Å—å–æ–≥–æ<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                        <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0">–¢–æ–ø –ª–æ–∫–∞—Ü—ñ—è<br><span style="font-size:11px;font-weight:400;color:#94a3b8">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pvfCostBreakdownBody">
                                    <tr>
                                        <td colspan="8" style="padding:32px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ –ø–ª–∞–Ω–æ–≤–∏–º –≤–∏—Ç—Ä–∞—Ç–∞–º</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                            <!-- Period Comparison Table -->
                            <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb;margin-bottom:32px">
                                <h3 style="margin:0 0 20px 0;font-size:18px;font-weight:700;color:#0f172a">üìã –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö</h3>
                                <div style="overflow-x:auto">
                                    <table style="width:100%;border-collapse:collapse;font-size:13px">
                                        <thead>
                                            <tr style="background:#f8fafc;text-align:left">
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;font-weight:600">–ü–µ—Ä—ñ–æ–¥</th>
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center;font-weight:600">–î—ñ—Ç–∏<br><span style="font-size:11px;font-weight:400;color:#64748b">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center;font-weight:600">–ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å<br><span style="font-size:11px;font-weight:400;color:#64748b">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right;font-weight:600">–î–æ—Ö–æ–¥–∏<br><span style="font-size:11px;font-weight:400;color:#64748b">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:right;font-weight:600">–í–∏—Ç—Ä–∞—Ç–∏<br><span style="font-size:11px;font-weight:400;color:#64748b">–ü–ª–∞–Ω / –§–∞–∫—Ç</span></th>
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center;font-weight:600">–í–∏–∫–æ–Ω–∞–Ω–Ω—è</th>
                                                <th style="padding:12px 8px;border-bottom:2px solid #e2e8f0;text-align:center;font-weight:600">–°—Ç–∞—Ç—É—Å</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pvfPeriodComparisonBody">
                                            <tr>
                                                <td colspan="6" style="padding:40px;text-align:center;color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Charts Section -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
                                <!-- Plan vs Fact Bar Chart -->
                                <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <h4 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìä –ü–ª–∞–Ω vs –§–∞–∫—Ç (–¥—ñ—Ç–∏)</h4>
                                    <canvas id="pvfChildrenChart" style="max-height:300px"></canvas>
                                </div>

                                <!-- Revenue Comparison Chart -->
                                <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <h4 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üí∞ –î–æ—Ö–æ–¥–∏: –ü–ª–∞–Ω vs –§–∞–∫—Ç</h4>
                                    <canvas id="pvfRevenueChart" style="max-height:300px"></canvas>
                                </div>

                                <!-- Expenses Comparison Chart -->
                                <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                    <h4 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:#0f172a">üìâ –í–∏—Ç—Ä–∞—Ç–∏: –ü–ª–∞–Ω vs –§–∞–∫—Ç</h4>
                                    <canvas id="pvfExpensesChart" style="max-height:300px"></canvas>
                                </div>
                            </div>

                            <!-- Deviations Analysis -->
                            <div style="background:white;padding:24px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e5e7eb">
                                <h3 style="margin:0 0 20px 0;font-size:18px;font-weight:700;color:#0f172a">üîç –ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥—Ö–∏–ª–µ–Ω—å</h3>
                                <div id="pvfDeviationsAnalysis">
                                    <div style="padding:40px;text-align:center;color:#94a3b8">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –≤—ñ–¥—Ö–∏–ª–µ–Ω—å</div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- Settings Tab -->
                        <div id="settingsTab" class="tab-pane">
                        <div class="card" style="max-width:1200px;margin:0 auto">
                            <h2 style="margin:0 0 20px 0">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏</h2>
                            
                            <!-- Periods Management -->
                            <div style="margin-bottom:32px">
                            <h3 style="margin:0 0 16px 0;padding-bottom:12px;border-bottom:2px solid #e5e7eb">üìÖ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥–∞–º–∏, –ª–æ–∫–∞—Ü—ñ—è–º–∏ —Ç–∞ –∑–º—ñ–Ω–∞–º–∏</h3>
                            <div id="periodsManagement"></div>
                            </div>

                            <!-- Discount Settings -->
                            <div style="margin-bottom:32px">
                            <h3 style="margin:0 0 16px 0;padding-bottom:12px;border-bottom:2px solid #e5e7eb">üí∞ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–Ω–∏–∂–æ–∫</h3>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px">
                                <div>
                                <label style="font-weight:600;display:block;margin-bottom:8px">–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è (–≥—Ä–Ω)</label>
                                <input id="settingEarlyDiscount" type="number" value="1000" min="0" step="100" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                <div>
                                <label style="font-weight:600;display:block;margin-bottom:8px">–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å (–≥—Ä–Ω)</label>
                                <input id="settingRepeatDiscount" type="number" value="1000" min="0" step="100" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                <div>
                                <label style="font-weight:600;display:block;margin-bottom:8px">–î—Ä—É–∑—ñ (–≥—Ä–Ω)</label>
                                <input id="settingFriendsDiscount" type="number" value="1000" min="0" step="100" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                <div>
                                <label style="font-weight:600;display:block;margin-bottom:8px">–£–ë–î —ñ –í–ü–û (%)</label>
                                <input id="settingSocialDiscount" type="number" value="10" min="0" max="100" step="0.1" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                <div>
                                <label style="font-weight:600;display:block;margin-bottom:8px">2 –∑–º—ñ–Ω–∏ (%)</label>
                                <input id="settingDoubleDiscount" type="number" value="5" min="0" max="100" step="0.1" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                <div>
                                <label style="font-weight:600;display:block;margin-bottom:8px">–†–∞–Ω–Ω—î + —Å–æ—Ü (–≥—Ä–Ω)</label>
                                <input id="settingEarlySocialDiscount" type="number" value="1000" min="0" step="100" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                            </div>
                            <button id="saveDiscountSettings" class="btn" style="margin-top:16px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–Ω–∏–∂–∫–∏</button>
                            </div>

                            <!-- FOP Settings -->
                            <div style="margin-bottom:32px">
                            <h3 style="margin:0 0 16px 0;padding-bottom:12px;border-bottom:2px solid #e5e7eb">üè¶ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –§–û–ü</h3>
                            <div id="fopList" style="margin-bottom:12px"></div>
                            <div style="display:flex;gap:8px">
                                <input id="newFopName" placeholder="–ù–∞–∑–≤–∞ –§–û–ü (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –§–û–ü –Ü–≤–∞–Ω–æ–≤)" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                <button id="addFop" class="btn" style="padding:10px 20px">‚ûï –î–æ–¥–∞—Ç–∏ –§–û–ü</button>
                            </div>
                            </div>

                            <!-- Transfer Settings -->
                            <div style="margin-bottom:32px">
                            <h3 style="margin:0 0 16px 0;padding-bottom:12px;border-bottom:2px solid #e5e7eb">üöå –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—É</h3>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
                                <!-- To Camp -->
                                <div>
                                <h4 style="margin:0 0 12px 0;color:#0f172a">‚û°Ô∏è –î–æ —Ç–∞–±–æ—Ä—É</h4>
                                <div id="transferToList" style="margin-bottom:12px"></div>
                                <div style="display:flex;gap:8px">
                                    <input id="newTransferToLocation" placeholder="–õ–æ–∫–∞—Ü—ñ—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤)" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                                    <input id="newTransferToPrice" type="number" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" min="0" step="100" style="width:120px;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                                    <button id="addTransferTo" class="btn" style="padding:8px 16px">‚ûï</button>
                                </div>
                                </div>
                                
                                <!-- From Camp -->
                                <div>
                                <h4 style="margin:0 0 12px 0;color:#0f172a">‚¨ÖÔ∏è –ó —Ç–∞–±–æ—Ä—É</h4>
                                <div id="transferFromList" style="margin-bottom:12px"></div>
                                <div style="display:flex;gap:8px">
                                    <input id="newTransferFromLocation" placeholder="–õ–æ–∫–∞—Ü—ñ—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤)" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                                    <input id="newTransferFromPrice" type="number" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" min="0" step="100" style="width:120px;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                                    <button id="addTransferFrom" class="btn" style="padding:8px 16px">‚ûï</button>
                                </div>
                                </div>
                            </div>
                            </div>

                            <!-- Payment Instructions -->
                            <div>
                            <h3 style="margin:0 0 16px 0;padding-bottom:12px;border-bottom:2px solid #e5e7eb">üìÑ –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏</h3>
                            <textarea id="settingPaymentInstructions" style="width:100%;min-height:200px;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:14px" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏...">–î–ª—è —É—Å–ø—ñ—à–Ω–æ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ –±—Ä–æ–Ω—ñ –º—ñ—Å—Ü—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∞–≤–∞–Ω—Å —Å—É–º–æ—é 1000 –≥—Ä–Ω –∑–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏:

                    –û–¥–µ—Ä–∂—É–≤–∞—á: –§–û–ü –†–∞–¥—É–ª –Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤–∏—á
                    IBAN: UA043220010000026004350069974
                    –Ñ–î–†–ü–û–£: 3230916436
                    –ú–§–û: 322001
                    –ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –±–∞–Ω–∫—É: –ê–¢ ¬´–£–ù–Ü–í–ï–†–°–ê–õ –ë–ê–ù–ö¬ª
                    –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—É: –û–ø–ª–∞—Ç–∞ –∑–∞ –Ω–∞–¥–∞–Ω–Ω—è –ø–æ—Å–ª—É–≥

                    –Ø–∫—â–æ –≤–∏–Ω–∏–∫–∞—é—Ç—å –ø–∏—Ç–∞–Ω–Ω—è - –∑ —Ä–∞–¥—ñ—Å—Ç—é –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç—É—î–º–æ –í–∞—Å. –¢–∞–∫–æ–∂ –ø—ñ—Å–ª—è –≤–Ω–µ—Å–µ–Ω–Ω—è –∞–≤–∞–Ω—Å—É –Ω–∞–¥—ñ—à–ª—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, —Å–∫—Ä—ñ–Ω-—à–æ—Ç –æ–ø–ª–∞—Ç–∏.</textarea>
                            <button id="savePaymentInstructions" class="btn" style="margin-top:12px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏</button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Modal for Account -->
                    <!-- Accounts Settings Modal -->
                    <div id="accountsSettingsModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:10000">
                    <div class="modal-content" style="background:#fff;max-width:600px;margin:auto;padding:32px;border-radius:16px;box-shadow:var(--shadow-lg);position:relative;max-height:85vh;overflow-y:auto">
                        <span class="close" onclick="closeAccountsSettingsModal()" style="position:absolute;top:12px;right:16px;font-size:28px;cursor:pointer;color:#64748b">&times;</span>
                        <h3 style="margin:0 0 24px 0">‚öôÔ∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–∞—Ö—É–Ω–∫–∞–º–∏</h3>
                        
                        <!-- Add New Account Form -->
                        <div style="padding:16px;background:#f0f9ff;border-radius:12px;border-left:4px solid #3b82f6;margin-bottom:24px">
                        <h4 style="margin:0 0 16px 0;font-size:14px;font-weight:600">‚ûï –ù–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫/–§–û–ü</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                            <input id="newAccountName" placeholder="–ù–∞–∑–≤–∞ —Ä–∞—Ö—É–Ω–∫—É/–§–û–ü" style="padding:10px;border:1px solid #bfdbfe;border-radius:8px;font-size:13px" />
                            <input id="newAccountBalance" type="number" placeholder="–ë–∞–ª–∞–Ω—Å (–≥—Ä–Ω)" style="padding:10px;border:1px solid #bfdbfe;border-radius:8px;font-size:13px" />
                        </div>
                        <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px">
                            <select id="newAccountType" style="padding:10px;border:1px solid #bfdbfe;border-radius:8px;font-size:13px">
                                <option value="account">üí≥ –ó–≤–∏—á–∞–π–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫</option>
                                <option value="fop">üë§ –§–û–ü (–∑ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏)</option>
                            </select>
                        </div>
                        <!-- –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –§–û–ü–∞ (–ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –≤–∏–±—Ä–∞–Ω–æ –§–û–ü) -->
                        <div id="fopDetailsContainer" style="display:none;background:#fefce8;padding:12px;border-radius:8px;border:1px solid #facc15;margin-bottom:12px">
                            <h5 style="margin:0 0 8px 0;font-size:12px;font-weight:600;color:#854d0e">üìã –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –§–û–ü–∞</h5>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
                                <input id="newAccountIban" placeholder="IBAN —Ä–∞—Ö—É–Ω–æ–∫" style="padding:8px;border:1px solid #facc15;border-radius:6px;font-size:12px" />
                                <input id="newAccountEdrpou" placeholder="–Ñ–î–†–ü–û–£/–Ü–ü–ù" style="padding:8px;border:1px solid #facc15;border-radius:6px;font-size:12px" />
                            </div>
                            <input id="newAccountBank" placeholder="–ù–∞–∑–≤–∞ –±–∞–Ω–∫—É" style="width:100%;padding:8px;border:1px solid #facc15;border-radius:6px;font-size:12px;margin-bottom:8px" />
                            <textarea id="newAccountDetails" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ (–ú–§–û, –∞–¥—Ä–µ—Å–∞ —Ç–æ—â–æ)" style="width:100%;height:60px;padding:8px;border:1px solid #facc15;border-radius:6px;font-size:12px;resize:vertical"></textarea>
                        </div>
                        <button onclick="addNewAccount()" class="btn" style="width:100%;margin-top:12px;background:#3b82f6;color:white">‚ûï –î–æ–¥–∞—Ç–∏</button>
                        </div>

                        <!-- Accounts List -->
                        <h4 style="margin:0 0 12px 0;font-size:14px;font-weight:600">üìã –°–ø–∏—Å–æ–∫ —Ä–∞—Ö—É–Ω–∫—ñ–≤</h4>
                        <div id="accountsSettingsListContainer">
                        <div style="padding:16px;text-align:center;color:#94a3b8;font-size:13px">–ù–µ–º–∞—î —Ä–∞—Ö—É–Ω–∫—ñ–≤</div>
                        </div>
                    </div>
                    </div>

                    <!-- Old Account Modal (deprecated, kept for backward compatibility) -->
                    <div id="accountModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:10000">
                    <div class="modal-content" style="background:#fff;max-width:400px;margin:auto;padding:32px;border-radius:16px;box-shadow:var(--shadow-lg);position:relative">
                        <span class="close" onclick="closeAccountModal()" style="position:absolute;top:12px;right:16px;font-size:28px;cursor:pointer">&times;</span>
                        <h3 id="accountModalTitle">–î–æ–¥–∞—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</h3>
                        <input id="accountNameInput" class="input" placeholder="–ù–∞–∑–≤–∞ —Ä–∞—Ö—É–Ω–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –§–û–ü, –¢–û–í, –ì–æ—Ç—ñ–≤–∫–∞)" style="margin-bottom:12px;width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                        <input id="accountBalanceInput" class="input" type="number" placeholder="–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å, –≥—Ä–Ω" style="margin-bottom:12px;width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                        <button class="btn" onclick="saveAccount()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                    </div>

                    <!-- Operation Modal -->
                    <div id="operationModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:10000">
                    <div class="modal-content" style="background:#fff;max-width:550px;margin:auto;padding:32px;border-radius:16px;box-shadow:var(--shadow-lg);position:relative;max-height:90vh;overflow-y:auto">
                        <span class="close" onclick="closeOperationModal()" style="position:absolute;top:12px;right:16px;font-size:28px;cursor:pointer;color:#64748b">&times;</span>
                        <h3 style="margin:0 0 20px 0">üìù –î–æ–¥–∞—Ç–∏ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—É –æ–ø–µ—Ä–∞—Ü—ñ—é</h3>
                        <div style="display:grid;grid-template-columns:1fr;gap:12px">
                        <!-- Date -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üìÖ –î–∞—Ç–∞ *</label>
                            <input id="opModalDate" type="date" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required />
                        </div>
                        <!-- Account -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üí≥ –†–∞—Ö—É–Ω–æ–∫ *</label>
                            <select id="opModalAccount" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Ä–∞—Ö—É–Ω–æ–∫</option>
                            </select>
                        </div>
                        <!-- Period (from saved plans) -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üóìÔ∏è –ü–µ—Ä—ñ–æ–¥ (–∑ –ø–ª–∞–Ω—É) *</label>
                            <select id="opModalPeriod" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required onchange="updateFinanceModalLocation()">
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –∑ –ø–ª–∞–Ω—ñ–≤</option>
                            </select>
                        </div>
                        <!-- Location -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üìç –õ–æ–∫–∞—Ü—ñ—è *</label>
                            <select id="opModalLocation" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required onchange="updateOperationModalChanges()">
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>
                            </select>
                        </div>
                        <!-- Shift -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">‚è∞ –ó–º—ñ–Ω–∞ *</label>
                            <select id="opModalChange" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –∑–º—ñ–Ω—É</option>
                            </select>
                        </div>

                        <!-- Main Category -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">ÔøΩ –¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó *</label>
                            <select id="opModalMainCategory" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required onchange="updateSubCategories()">
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó</option>
                            <option value="–î–æ—Ö–æ–¥–∏">üí∞ –î–æ—Ö–æ–¥–∏</option>
                            <option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ">üè¢ –û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</option>
                            <option value="–ü—Ä—è–º—ñ">üèïÔ∏è –ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</option>
                            <option value="–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ">‚ö†Ô∏è –ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</option>
                            </select>
                        </div>
                        <!-- Sub Category -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üí∞ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
                            <select id="opModalCategory" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required onchange="updateAmountSign()">
                            <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <!-- Amount -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üíµ –°—É–º–∞ (–≥—Ä–Ω) *</label>
                            <input id="opModalAmount" type="number" step="0.01" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required oninput="updateAmountSign()" />
                            <div style="font-size:11px;color:#64748b;margin-top:4px">
                                üí° –ó–Ω–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:<br>
                                ‚úÖ –î–æ—Ö–æ–¥–∏ = –¥–æ–¥–∞—Ç–Ω–µ (+), –í–∏—Ç—Ä–∞—Ç–∏ = –≤—ñ–¥'—î–º–Ω–µ (-)
                            </div>
                        </div>
                        <!-- Comment (for person details) -->
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üìù –ü—Ä–∏–º—ñ—Ç–∫–∞ (–ø–µ—Ä—Å–æ–Ω–∞, –æ–ø–∏—Å) *</label>
                            <input id="opModalComment" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –¢—ñ–º–ª—ñ–¥ –í–∞—Å—è, –¢—ñ–º–ª—ñ–¥ –ú–∞—à–∞" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px" required />
                        </div>
                        <!-- Buttons -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px">
                            <button type="button" onclick="closeOperationModal()" class="btn" style="background:#e2e8f0;color:#334155">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                            <button type="button" onclick="saveOperation()" class="btn" style="background:#10b981;color:white">‚úÖ –î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é</button>
                        </div>
                        </div>
                    </div>
                    </div>

                    <!-- FOP Assignment Modal -->
                    <div id="fopAssignmentModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:10000">
                    <div class="modal-content" style="background:#fff;max-width:700px;margin:auto;padding:32px;border-radius:16px;box-shadow:var(--shadow-lg);position:relative;max-height:85vh;overflow-y:auto">
                        <span class="close" onclick="closeFopAssignmentModal()" style="position:absolute;top:12px;right:16px;font-size:28px;cursor:pointer;color:#64748b">&times;</span>
                        <h3 style="margin:0 0 24px 0">üë§ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤ –¥–æ –∑–º—ñ–Ω</h3>
                        
                        <!-- Period and Location Filter -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;padding:16px;background:#f0f9ff;border-radius:12px">
                            <div>
                                <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üìÖ –ü–µ—Ä—ñ–æ–¥</label>
                                <select id="fopAssignPeriod" onchange="updateFopAssignmentData()" style="width:100%;padding:10px;border:1px solid #bfdbfe;border-radius:8px;font-size:13px">
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight:600;display:block;margin-bottom:6px;font-size:13px">üìç –õ–æ–∫–∞—Ü—ñ—è</label>
                                <select id="fopAssignLocation" onchange="updateFopAssignmentData()" style="width:100%;padding:10px;border:1px solid #bfdbfe;border-radius:8px;font-size:13px">
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>
                                </select>
                            </div>
                        </div>

                        <!-- Shifts Assignment Table -->
                        <div id="shiftsAssignmentContainer">
                            <div style="padding:40px;text-align:center;color:#94a3b8">
                                –û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—é –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Modal –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∫–≤—ñ–∑–∏—Ç—ñ–≤ –§–û–ü–∞ -->
                    <div id="fopDetailsModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:10000">
                        <div class="modal-content" style="background:#fff;max-width:500px;margin:auto;padding:32px;border-radius:16px;box-shadow:var(--shadow-lg);position:relative">
                            <span class="close" onclick="closeFopDetailsModal()" style="position:absolute;top:12px;right:16px;font-size:28px;cursor:pointer;color:#64748b">&times;</span>
                            <h3 style="margin:0 0 24px 0">üìã –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –§–û–ü–∞</h3>
                            
                            <div id="fopDetailsContent">
                                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ –¥–æ–¥–∞–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                            </div>
                            
                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
                                <button onclick="copyAllFopDetails()" class="btn" style="padding:10px 20px;background:#10b981;color:white;font-size:14px;font-weight:600">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏</button>
                                <button onclick="closeFopDetailsModal()" class="btn" style="padding:10px 20px;background:#6b7280;color:white;font-size:14px">–ó–∞–∫—Ä–∏—Ç–∏</button>
                            </div>
                        </div>
                    </div>

                        <script>
                    // ==== –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ====
                    function getCurrentDate() {
                        return new Date().toISOString().split('T')[0];
                    }
                    
                    // ==== –†–∞—Ö—É–Ω–∫–∏: –ª–æ–≥—ñ–∫–∞ ====
                    let accounts = [];
                    function saveAccounts() {
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                    }
                    function loadAccounts() {
                    const data = localStorage.getItem('accounts');
                    accounts = data ? JSON.parse(data) : [];
                    }
                    // ====== –°–¢–ê–†–ê –õ–û–ì–Ü–ö–ê (DEPRECATED - –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è) ======
                    // –¶—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞–ª–∏—à–µ–Ω—ñ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –≤—Å–µ —â–µ –º–æ–∂–µ —ó—Ö –≤–∏–∫–ª–∏–∫–∞—Ç–∏
                    // –ó–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ showAccountsSettingsModal() —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó —Ä–æ–±–æ—Ç–∏ –∑ —Ä–∞—Ö—É–Ω–∫–∞–º–∏ —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
                    function renderAccountsList() {
                    // Deprecated - use renderAccountsSettingsList() instead
                    return;
                    }
                    function showAddAccountModal() {
                    // Deprecated - use showAccountsSettingsModal() instead
                    document.getElementById('accountModal').style.display = 'flex';
                    }
                    function closeAccountModal() {
                    document.getElementById('accountModal').style.display = 'none';
                    }
                    function saveAccount() {
                    const name = document.getElementById('accountNameInput').value.trim();
                    const balance = parseFloat(document.getElementById('accountBalanceInput').value) || 0;
                    if (!name) { alert('–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É —Ä–∞—Ö—É–Ω–∫—É'); return; }
                    if (window.editingAccountId) {
                        const acc = accounts.find(a => a.id === window.editingAccountId);
                        if (acc) { acc.name = name; acc.balance = balance; }
                    } else {
                        accounts.push({ id: Date.now(), name, balance });
                    }
                    saveAccounts();
                    renderAccountsList();
                    renderAccountsBalances();
                    closeAccountModal();
                    }
                    function deleteAccount(id) {
                    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫?')) return;
                    const idx = accounts.findIndex(a => a.id == id || String(a.id) === String(id));
                    if (idx !== -1) accounts.splice(idx, 1);
                    saveAccounts();
                    renderAccountsList();
                    renderAccountsBalances();
                    }
                    
                    // ==== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö –¥–ª—è –§–û–ü—ñ–≤ ====
                    var fopAssignments = {}; // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: {planId: {period: {location: {shift: fopId}}}}
                    
                    loadAccounts();
                    loadFopAssignments();

                    // ==== –ù–æ–≤–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–∞—Ö—É–Ω–∫–∞–º–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ ====
                    function showAccountsSettingsModal() {
                    document.getElementById('accountsSettingsModal').style.display = 'flex';
                    document.getElementById('newAccountName').value = '';
                    document.getElementById('newAccountBalance').value = '';
                    document.getElementById('newAccountType').value = 'account';
                    toggleFopDetails();
                    renderAccountsSettingsList();
                    }
                    
                    function toggleFopDetails() {
                    const type = document.getElementById('newAccountType').value;
                    const container = document.getElementById('fopDetailsContainer');
                    if (container) {
                        container.style.display = type === 'fop' ? 'block' : 'none';
                    }
                    }
                    function closeAccountsSettingsModal() {
                    document.getElementById('accountsSettingsModal').style.display = 'none';
                    }
                    function addNewAccount() {
                    const name = document.getElementById('newAccountName').value.trim();
                    const balance = parseFloat(document.getElementById('newAccountBalance').value) || 0;
                    const type = document.getElementById('newAccountType').value;
                    
                    if (!name) { 
                        alert('‚ö†Ô∏è –í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É —Ä–∞—Ö—É–Ω–∫—É/–§–û–ü'); 
                        return; 
                    }
                    
                    const newAccount = { 
                        id: Date.now(), 
                        name, 
                        balance,
                        type: type // 'account' –∞–±–æ 'fop'
                    };
                    
                    // –Ø–∫—â–æ —Ü–µ –§–û–ü, –¥–æ–¥–∞—î–º–æ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏
                    if (type === 'fop') {
                        newAccount.iban = document.getElementById('newAccountIban').value.trim();
                        newAccount.edrpou = document.getElementById('newAccountEdrpou').value.trim();
                        newAccount.bank = document.getElementById('newAccountBank').value.trim();
                        newAccount.details = document.getElementById('newAccountDetails').value.trim();
                    }
                    
                    accounts.push(newAccount);
                    saveAccounts();
                    renderAccountsBalances();
                    updateOperationModalAccounts();
                    
                    // –û—á–∏—â—É—î–º–æ —Ñ–æ—Ä–º—É
                    document.getElementById('newAccountName').value = '';
                    document.getElementById('newAccountBalance').value = '';
                    document.getElementById('newAccountType').value = 'account';
                    if (type === 'fop') {
                        document.getElementById('newAccountIban').value = '';
                        document.getElementById('newAccountEdrpou').value = '';
                        document.getElementById('newAccountBank').value = '';
                        document.getElementById('newAccountDetails').value = '';
                    }
                    toggleFopDetails();
                    renderAccountsSettingsList();
                    alert('‚úÖ –†–∞—Ö—É–Ω–æ–∫/–§–û–ü –¥–æ–¥–∞–Ω–æ!');
                    }
                    function editAccountFromSettings(id) {
                    const acc = accounts.find(a => a.id == id || String(a.id) === String(id));
                    if (!acc) return;
                    const newName = prompt('–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É:', acc.name);
                    if (!newName || !newName.trim()) return;
                    const newBalance = prompt('–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±–∞–ª–∞–Ω—Å (–≥—Ä–Ω):', acc.balance);
                    if (newBalance === null) return;
                    acc.name = newName.trim();
                    acc.balance = parseFloat(newBalance) || 0;
                    saveAccounts();
                    renderAccountsBalances();
                    updateOperationModalAccounts();
                    renderAccountsSettingsList();
                    alert('‚úÖ –†–∞—Ö—É–Ω–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                    }
                    function deleteAccountFromSettings(id) {
                    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä–∞—Ö—É–Ω–æ–∫?')) return;
                    const idx = accounts.findIndex(a => a.id == id || String(a.id) === String(id));
                    if (idx !== -1) accounts.splice(idx, 1);
                    saveAccounts();
                    renderAccountsBalances();
                    updateOperationModalAccounts();
                    renderAccountsSettingsList();
                    alert('‚úÖ –†–∞—Ö—É–Ω–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–æ!');
                    }
                    function renderAccountsSettingsList() {
                    const container = document.getElementById('accountsSettingsListContainer');
                    if (accounts.length === 0) {
                        container.innerHTML = '<div style="padding:16px;text-align:center;color:#94a3b8;font-size:13px">–ù–µ–º–∞—î —Ä–∞—Ö—É–Ω–∫—ñ–≤</div>';
                        return;
                    }
                    container.innerHTML = accounts.map(acc => {
                        const isFop = acc.type === 'fop';
                        const typeIcon = isFop ? 'üë§' : 'üí≥';
                        const typeText = isFop ? '–§–û–ü' : '–†–∞—Ö—É–Ω–æ–∫';
                        const borderColor = isFop ? '#facc15' : '#3b82f6';
                        
                        let detailsHtml = '';
                        if (isFop && (acc.iban || acc.bank || acc.edrpou)) {
                            detailsHtml = `
                            <div style="font-size:11px;color:#64748b;margin-top:4px;padding-top:4px;border-top:1px solid #e5e7eb">
                                ${acc.iban ? `<div>üìã ${acc.iban}</div>` : ''}
                                ${acc.bank ? `<div>üèõÔ∏è ${acc.bank}</div>` : ''}
                                ${acc.edrpou ? `<div>üÜî ${acc.edrpou}</div>` : ''}
                            </div>`;
                        }
                        
                        return `
                        <div style="display:flex;justify-content:space-between;align-items:start;padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:8px;border-left:4px solid ${borderColor}">
                            <div style="flex:1">
                                <div style="font-weight:600;font-size:14px">${typeIcon} ${acc.name}</div>
                                <div style="font-size:12px;color:#64748b">
                                    ${typeText} ‚Ä¢ –ë–∞–ª–∞–Ω—Å: <span style="font-weight:700;color:#10b981">${(acc.balance||0).toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                                </div>
                                ${detailsHtml}
                            </div>
                            <div style="display:flex;gap:8px">
                                ${isFop ? `<button onclick="showFopDetails('${acc.id}')" class="btn" style="padding:6px 12px;font-size:12px;background:#fef3c7;color:#92400e">üìã –†–µ–∫–≤—ñ–∑–∏—Ç–∏</button>` : ''}
                                <button onclick="editAccountFromSettings('${acc.id}')" class="btn" style="padding:6px 12px;font-size:12px;background:#e0e7ff;color:#4338ca">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                <button onclick="deleteAccountFromSettings('${acc.id}')" class="btn" style="padding:6px 12px;font-size:12px;background:#fee2e2;color:#991b1b">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </div>
                        </div>`;
                    }).join('');
                    }

                    function showFopDetails(fopId) {
                        const fop = accounts.find(acc => acc.id == fopId || String(acc.id) === String(fopId));
                        if (!fop || fop.type !== 'fop') return;
                        
                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –§–û–ü –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
                        window.currentFopForCopy = fop;
                        
                        // –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –∑ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏
                        const detailsText = `üìã –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –§–û–ü: ${fop.name}

    üèõÔ∏è –ë–∞–Ω–∫: ${fop.bank || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}
    üí≥ IBAN: ${fop.iban || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}  
    üÜî –Ñ–î–†–ü–û–£/–Ü–ü–ù: ${fop.edrpou || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}${fop.details ? `

    üìù –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤—ñ–¥–æ–º–æ—Å—Ç—ñ:
    ${fop.details}` : ''}`;
                        
                        const content = document.getElementById('fopDetailsContent');
                        content.innerHTML = `
                            <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0">
                                <div style="display:flex;align-items:center;margin-bottom:16px">
                                    <div style="background:#10b981;color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px">üë§</div>
                                    <div>
                                        <h4 style="margin:0;color:#1e293b;font-size:18px">${fop.name}</h4>
                                        <div style="color:#64748b;font-size:13px">–§—ñ–∑–∏—á–Ω–∞ –æ—Å–æ–±–∞-–ø—ñ–¥–ø—Ä–∏—î–º–µ—Ü—å</div>
                                    </div>
                                </div>
                                
                                <div id="allFopDetails" style="background:#ffffff;padding:16px;border-radius:8px;font-family:monospace;font-size:14px;line-height:1.6;color:#374151;white-space:pre-line;border:1px solid #d1d5db">${detailsText}</div>
                            </div>
                        `;
                        
                        document.getElementById('fopDetailsModal').style.display = 'flex';
                    }

                    function closeFopDetailsModal() {
                        document.getElementById('fopDetailsModal').style.display = 'none';
                    }

                    function copyToClipboard(elementId) {
                        const element = document.getElementById(elementId);
                        if (!element) return;
                        
                        const text = element.textContent || element.innerText;
                        
                        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—É—á–∞—Å–Ω–∏–π API clipboard
                        if (navigator.clipboard && window.isSecureContext) {
                            navigator.clipboard.writeText(text).then(() => {
                                showCopyNotification();
                            }).catch(() => {
                                fallbackCopyTextToClipboard(text);
                            });
                        } else {
                            // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                            fallbackCopyTextToClipboard(text);
                        }
                    }

                    function fallbackCopyTextToClipboard(text) {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-999999px";
                        textArea.style.top = "-999999px";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            showCopyNotification();
                        } catch (err) {
                            console.error('Fallback: Could not copy text: ', err);
                            alert('–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É –≤–∏–¥—ñ–ª–∏—Ç–∏ —Ç–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç.');
                        }
                        
                        document.body.removeChild(textArea);
                    }

                    function copyAllFopDetails() {
                        const element = document.getElementById('allFopDetails');
                        if (!element) return;
                        
                        const text = element.textContent || element.innerText;
                        
                        if (navigator.clipboard && window.isSecureContext) {
                            navigator.clipboard.writeText(text).then(() => {
                                showCopyNotification('–†–µ–∫–≤—ñ–∑–∏—Ç–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
                            }).catch(() => {
                                fallbackCopyTextToClipboard(text);
                            });
                        } else {
                            fallbackCopyTextToClipboard(text);
                        }
                    }

                    function showCopyNotification(message = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!') {
                        // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —è–∫—â–æ —î
                        const existingNotification = document.getElementById('copyNotification');
                        if (existingNotification) {
                            existingNotification.remove();
                        }
                        
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                        const notification = document.createElement('div');
                        notification.id = 'copyNotification';
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #10b981;
                            color: white;
                            padding: 12px 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            z-index: 10001;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                            animation: slideInRight 0.3s ease-out;
                        `;
                        notification.textContent = message;
                        
                        document.body.appendChild(notification);
                        
                        // –í–∏–¥–∞–ª—è—î–º–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.style.animation = 'slideOutRight 0.3s ease-out';
                                setTimeout(() => notification.remove(), 300);
                            }
                        }, 2000);
                    }

                    // ==== –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤ –¥–æ –∑–º—ñ–Ω ====
                    
                    function saveFopAssignments() {
                        localStorage.setItem('fopAssignments', JSON.stringify(fopAssignments));
                    }
                    
                    function loadFopAssignments() {
                        const data = localStorage.getItem('fopAssignments');
                        fopAssignments = data ? JSON.parse(data) : {};
                    }
                    
                    function showFopAssignmentModal() {
                        document.getElementById('fopAssignmentModal').style.display = 'flex';
                        loadFopAssignments();
                        populateFopAssignmentPeriods();
                    }
                    
                    function closeFopAssignmentModal() {
                        document.getElementById('fopAssignmentModal').style.display = 'none';
                    }
                    
                    function populateFopAssignmentPeriods() {
                        const select = document.getElementById('fopAssignPeriod');
                        select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥</option>';
                        
                        const allPeriods = new Set();
                        allPlans.forEach(plan => {
                            if (plan.periods && plan.periods.length > 0) {
                                plan.periods.forEach(period => {
                                    const periodName = typeof period === 'string' ? period : period.periodName;
                                    if (periodName) {
                                        allPeriods.add(periodName);
                                    }
                                });
                            }
                        });
                        
                        Array.from(allPeriods).sort().forEach(periodName => {
                            const option = document.createElement('option');
                            option.value = periodName;
                            option.textContent = periodName;
                            select.appendChild(option);
                        });
                    }
                    
                    function updateFopAssignmentData() {
                        const period = document.getElementById('fopAssignPeriod').value;
                        const location = document.getElementById('fopAssignLocation').value;
                        
                        if (!period) {
                            // –û—á–∏—â—É—î–º–æ –ª–æ–∫–∞—Ü—ñ—ó —Ç–∞ –∑–º—ñ–Ω–∏
                            document.getElementById('fopAssignLocation').innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>';
                            document.getElementById('shiftsAssignmentContainer').innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—é –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤</div>';
                            return;
                        }
                        
                        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ª–æ–∫–∞—Ü—ñ—ó –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                        const locationSelect = document.getElementById('fopAssignLocation');
                        locationSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>';
                        
                        const planWithPeriod = allPlans.find(plan => 
                            plan.periods?.some(p => {
                                const periodName = typeof p === 'string' ? p : p.periodName;
                                return periodName === period;
                            })
                        );
                        
                        if (planWithPeriod) {
                            const foundPeriod = planWithPeriod.periods.find(p => {
                                const periodName = typeof p === 'string' ? p : p.periodName;
                                return periodName === period;
                            });
                            
                            if (foundPeriod && typeof foundPeriod !== 'string' && foundPeriod.locations) {
                                foundPeriod.locations.forEach(loc => {
                                    const option = document.createElement('option');
                                    option.value = loc.locationName;
                                    option.textContent = loc.locationName;
                                    locationSelect.appendChild(option);
                                });
                            }
                        }
                        
                        // –Ø–∫—â–æ –ª–æ–∫–∞—Ü—ñ—é –≤–∏–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—É—î–º–æ –∑–º—ñ–Ω–∏
                        if (location && planWithPeriod) {
                            renderShiftsAssignment(planWithPeriod, period, location);
                        } else {
                            document.getElementById('shiftsAssignmentContainer').innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤</div>';
                        }
                    }
                    
                    function renderShiftsAssignment(plan, period, location) {
                        const container = document.getElementById('shiftsAssignmentContainer');
                        
                        const foundPeriod = plan.periods.find(p => {
                            const periodName = typeof p === 'string' ? p : p.periodName;
                            return periodName === period;
                        });
                        
                        if (!foundPeriod || typeof foundPeriod === 'string') {
                            container.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">–ü–æ–º–∏–ª–∫–∞: –ø–µ—Ä—ñ–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                            return;
                        }
                        
                        const locationData = foundPeriod.locations?.find(loc => loc.locationName === location);
                        if (!locationData) {
                            container.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">–ü–æ–º–∏–ª–∫–∞: –ª–æ–∫–∞—Ü—ñ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                            return;
                        }
                        
                        // –û—Ç—Ä–∏–º—É—î–º–æ –§–û–ü–∏
                        const fops = accounts.filter(acc => acc.type === 'fop');
                        if (fops.length === 0) {
                            container.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –§–û–ü–∏ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö —Ä–∞—Ö—É–Ω–∫—ñ–≤</div>';
                            return;
                        }
                        
                        // –ì–µ–Ω–µ—Ä—É—î–º–æ –∑–º—ñ–Ω–∏ (—è–∫—â–æ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ, —Å—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ)
                        let shifts = ['–ó–º—ñ–Ω–∞ 1', '–ó–º—ñ–Ω–∞ 2'];
                        if (locationData.shifts && Array.isArray(locationData.shifts)) {
                            shifts = locationData.shifts;
                        }
                        
                        const fopOptions = fops.map(fop => `<option value="${fop.id}">${fop.name}</option>`).join('');
                        
                        const assignmentKey = `${plan.id}|${period}|${location}`;
                        
                        container.innerHTML = `
                        <h4 style="margin:0 0 16px 0;font-size:14px;font-weight:600">üìã –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –§–û–ü—ñ–≤ –¥–ª—è: ${period} ‚Üí ${location}</h4>
                        <div style="display:grid;gap:12px">
                            ${shifts.map(shift => {
                                const currentFopId = getFopAssignment(plan.id, period, location, shift);
                                return `
                                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:#f8fafc;border-radius:8px;border-left:4px solid #3b82f6">
                                    <div style="font-weight:600;font-size:14px">üîÑ ${shift}</div>
                                    <div style="display:flex;align-items:center;gap:12px">
                                        <select onchange="assignFopToShift('${plan.id}', '${period}', '${location}', '${shift}', this.value)" style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
                                            <option value="">–§–û–ü –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π</option>
                                            ${fopOptions}
                                        </select>
                                        <button onclick="showAssignedFopDetails('${currentFopId || ''}')" ${!currentFopId ? 'disabled' : ''} class="btn" style="padding:6px 12px;font-size:12px;background:#fef3c7;color:#92400e;${!currentFopId ? 'opacity:0.5;' : ''}">üìã –†–µ–∫–≤—ñ–∑–∏—Ç–∏</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                        `;
                        
                        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
                        setTimeout(() => {
                            shifts.forEach(shift => {
                                const currentFopId = getFopAssignment(plan.id, period, location, shift);
                                if (currentFopId) {
                                    const select = document.querySelector(`select[onchange*="${shift}"]`);
                                    if (select) {
                                        select.value = currentFopId;
                                    }
                                }
                            });
                        }, 10);
                    }
                    
                    function getFopAssignment(planId, period, location, shift) {
                        return fopAssignments[planId]?.[period]?.[location]?.[shift] || null;
                    }
                    
                    function assignFopToShift(planId, period, location, shift, fopId) {
                        if (!fopAssignments[planId]) fopAssignments[planId] = {};
                        if (!fopAssignments[planId][period]) fopAssignments[planId][period] = {};
                        if (!fopAssignments[planId][period][location]) fopAssignments[planId][period][location] = {};
                        
                        if (fopId) {
                            fopAssignments[planId][period][location][shift] = fopId;
                        } else {
                            delete fopAssignments[planId][period][location][shift];
                        }
                        
                        saveFopAssignments();
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É —Ä–µ–∫–≤—ñ–∑–∏—Ç—ñ–≤
                        const button = document.querySelector(`button[onclick*="showAssignedFopDetails"]`);
                        if (button) {
                            button.disabled = !fopId;
                            button.style.opacity = fopId ? '1' : '0.5';
                            button.setAttribute('onclick', `showAssignedFopDetails('${fopId || ''}')`);
                        }
                    }
                    
                    function showAssignedFopDetails(fopId) {
                        if (!fopId) return;
                        showFopDetails(parseInt(fopId));
                    }

                    // ==== –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏—Ö –§–û–ü—ñ–≤ —É CRM ====
                    let currentAssignedFopId = null;
                    
                    function updateFopAssignmentDisplay() {
                        const period = document.getElementById('crmPeriod')?.value;
                        const location = document.getElementById('crmLocation')?.value;
                        const shift = document.getElementById('crmShift')?.value;
                        
                        const infoContainer = document.getElementById('fopAssignmentInfo');
                        const fopNameEl = document.getElementById('assignedFopName');
                        const detailsBtn = document.getElementById('showFopDetailsBtn');
                        
                        if (!period || !location || !shift) {
                            if (infoContainer) infoContainer.style.display = 'none';
                            currentAssignedFopId = null;
                            return;
                        }
                        
                        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω
                        const activePlan = getActivePlan();
                        if (!activePlan) {
                            if (infoContainer) infoContainer.style.display = 'none';
                            currentAssignedFopId = null;
                            return;
                        }
                        
                        // –®—É–∫–∞—î–º–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ –§–û–ü–∞
                        const assignedFopId = getFopAssignment(activePlan.id, period, location, shift);
                        currentAssignedFopId = assignedFopId;
                        
                        if (assignedFopId) {
                            const fop = accounts.find(acc => acc.id === parseInt(assignedFopId));
                            if (fop) {
                                if (infoContainer) infoContainer.style.display = 'block';
                                if (fopNameEl) fopNameEl.textContent = `üë§ ${fop.name}`;
                                if (detailsBtn) detailsBtn.style.display = 'block';
                            } else {
                                // –§–û–ü –≤–∏–¥–∞–ª–µ–Ω–æ, –∞–ª–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞–ª–∏—à–∏–ª–æ—Å—å
                                if (infoContainer) infoContainer.style.display = 'block';
                                if (fopNameEl) fopNameEl.textContent = '‚ö†Ô∏è –§–û–ü –≤–∏–¥–∞–ª–µ–Ω–æ (–ø–æ—Ç—Ä—ñ–±–Ω–µ –ø–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è)';
                                if (detailsBtn) detailsBtn.style.display = 'none';
                            }
                        } else {
                            // –§–û–ü –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π
                            if (infoContainer) infoContainer.style.display = 'block';
                            if (fopNameEl) fopNameEl.textContent = '‚ùå –§–û–ü –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π';
                            if (detailsBtn) detailsBtn.style.display = 'none';
                        }
                    }
                    
                    function showCurrentFopDetails() {
                        if (currentAssignedFopId) {
                            showFopDetails(parseInt(currentAssignedFopId));
                        }
                    }

                    // –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ç–∏–ø—É —Ä–∞—Ö—É–Ω–∫—É
                    document.addEventListener('DOMContentLoaded', function() {
                        const typeSelector = document.getElementById('newAccountType');
                        if (typeSelector) {
                            typeSelector.addEventListener('change', toggleFopDetails);
                        }
                    });

                    // ==== –û–ø–µ—Ä–∞—Ü—ñ—ó: –ª–æ–≥—ñ–∫–∞ ====
                    let operations = [];
                    function saveOperations() {
                    localStorage.setItem('operations', JSON.stringify(operations));
                    }
                    function loadOperations() {
                    const data = localStorage.getItem('operations');
                    operations = data ? JSON.parse(data) : [];
                    }
                    function showAddOperationModal() {
                    document.getElementById('opModalDate').value = getCurrentDate();
                    document.getElementById('opModalAccount').value = '';
                    document.getElementById('opModalPeriod').value = '';
                    document.getElementById('opModalLocation').value = '';
                    document.getElementById('opModalChange').value = '';
                    document.getElementById('opModalMainCategory').value = '';
                    document.getElementById('opModalCategory').value = '';
                    document.getElementById('opModalAmount').value = '';
                    document.getElementById('opModalComment').value = '';
                    document.getElementById('operationModal').style.display = 'flex';
                    updateOperationModalAccounts();
                    updateOperationModalPeriod();
                    // –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –ø–æ–ª—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                    toggleLocationFields('');
                    }
                    function closeOperationModal() {
                    document.getElementById('operationModal').style.display = 'none';
                    }
                    function updateOperationModalAccounts() {
                    const sel = document.getElementById('opModalAccount');
                    if (!sel) return; // Safety check
                    sel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ä–∞—Ö—É–Ω–æ–∫</option>';
                    accounts.forEach(acc => {
                        const opt = document.createElement('option');
                        opt.value = acc.id;
                        opt.textContent = acc.name + ' (' + (acc.balance || 0).toLocaleString('uk-UA') + ' –≥—Ä–Ω)';
                        sel.appendChild(opt);
                    });
                    }
                    function updateOperationModalPeriod() {
                    const periodSel = document.getElementById('opModalPeriod');
                    const locationSel = document.getElementById('opModalLocation');
                    const changeSel = document.getElementById('opModalChange');
                    
                    if (!periodSel || !locationSel || !changeSel) return; // Safety check
                    
                    console.log('üí∞ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥—ñ–≤ —É —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ–π —Ñ–æ—Ä–º—ñ...');
                    
                    // Clear all selects
                    periodSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –∑ –ø–ª–∞–Ω—ñ–≤</option>';
                    locationSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>';
                    changeSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∑–º—ñ–Ω—É</option>';
                    
                    // Collect all periods from all plans
                    const allPeriods = new Set();
                    allPlans.forEach(plan => {
                        if (plan.periods && plan.periods.length > 0) {
                            plan.periods.forEach(period => {
                                const periodName = typeof period === 'string' ? period : period.periodName;
                                if (periodName) {
                                    allPeriods.add(periodName);
                                }
                            });
                        }
                    });
                    
                    // Populate period selector with all available periods
                    Array.from(allPeriods).sort().forEach(periodName => {
                        const option = document.createElement('option');
                        option.value = periodName;
                        option.textContent = periodName;
                        periodSel.appendChild(option);
                    });
                    
                    console.log(`üí∞ –ó–Ω–∞–π–¥–µ–Ω–æ ${allPeriods.size} –ø–µ—Ä—ñ–æ–¥—ñ–≤:`, Array.from(allPeriods));
                    }

                    // –û–Ω–æ–≤–ª—é—î –ª–æ–∫–∞—Ü—ñ—ó —É —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ–π —Ñ–æ—Ä–º—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ–±—Ä–∞–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                    function updateFinanceModalLocation() {
                        const selectedPeriod = document.getElementById('opModalPeriod')?.value;
                        const locationSel = document.getElementById('opModalLocation');
                        const changeSel = document.getElementById('opModalChange');
                        
                        if (!locationSel || !changeSel) return;
                        
                        // Clear dependent selects
                        locationSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>';
                        changeSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∑–º—ñ–Ω—É</option>';
                        
                        if (!selectedPeriod) return;
                        
                        console.log(`üí∞ –ü–æ—à—É–∫ –ª–æ–∫–∞—Ü—ñ–π –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É "${selectedPeriod}"`);
                        
                        // Find plan that contains this period
                        const planWithPeriod = allPlans.find(plan => 
                            plan.periods?.some(period => {
                                const periodName = typeof period === 'string' ? period : period.periodName;
                                return periodName === selectedPeriod;
                            })
                        );
                        
                        if (!planWithPeriod) {
                            console.log(`‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–ª–∞–Ω –∑ –ø–µ—Ä—ñ–æ–¥–æ–º "${selectedPeriod}"`);
                            return;
                        }
                        
                        // Find the specific period
                        const foundPeriod = planWithPeriod.periods.find(period => {
                            const periodName = typeof period === 'string' ? period : period.periodName;
                            return periodName === selectedPeriod;
                        });
                        
                        if (!foundPeriod || typeof foundPeriod === 'string' || !foundPeriod.locations) {
                            console.log(`‚ö†Ô∏è –ü–µ—Ä—ñ–æ–¥ "${selectedPeriod}" –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –ª–æ–∫–∞—Ü—ñ–π`);
                            return;
                        }
                        
                        // Populate locations
                        foundPeriod.locations.forEach(location => {
                            if (location.locationName) {
                                const option = document.createElement('option');
                                option.value = location.locationName;
                                option.textContent = location.locationName;
                                locationSel.appendChild(option);
                            }
                        });
                        
                        console.log(`‚úÖ –î–æ–¥–∞–Ω–æ ${foundPeriod.locations.length} –ª–æ–∫–∞—Ü—ñ–π –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É "${selectedPeriod}"`);
                    }
                    function updateOperationModalLocations() {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ–π
                    updateFinanceModalLocation();
                    }
                    function updateOperationModalChanges() {
                    const period = document.getElementById('opModalPeriod').value;
                    const location = document.getElementById('opModalLocation').value;
                    const changeSel = document.getElementById('opModalChange');
                    
                    changeSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∑–º—ñ–Ω—É</option>';
                    
                    if (!period || !location) return;
                    
                    const plan = getActivePlan();
                    if (!plan) return;
                    if (!plan.periods) return;
                    
                    // Find period and location in plan
                    const periodData = plan.periods.find(p => p.periodName === period);
                    if (!periodData || !periodData.locations) return;
                    
                    const locData = periodData.locations.find(l => l.locationName === location);
                    if (!locData) return;
                    
                    // Populate shifts (changes) - shiftsCount determines number of shifts
                    const shiftsCount = locData.shiftsCount || 1;
                    for (let i = 1; i <= shiftsCount; i++) {
                        const opt = document.createElement('option');
                        opt.value = i.toString();
                        opt.textContent = `${i} –∑–º—ñ–Ω–∞`;
                        changeSel.appendChild(opt);
                    }
                    }
                    function updateOperationModalCategories() {
                    // Categories are fixed in the select, no need to dynamically populate
                    // But we can keep this function for future enhancements
                    const categorySel = document.getElementById('opModalCategory');
                    console.log('Updating categories, element found:', !!categorySel);
                    categorySel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>';
                    
                    // === –î–û–•–û–î–ò ===
                    categorySel.innerHTML += '<optgroup label="üí∞ –î–û–•–û–î–ò">';
                    categorySel.innerHTML += '<option value="–î–æ—Ö–æ–¥–∏.–û–ø–ª–∞—Ç–∞">–û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–∞–±—ñ—Ä</option>';
                    categorySel.innerHTML += '<option value="–î–æ—Ö–æ–¥–∏.–î–æ–¥–∞—Ç–∫–æ–≤—ñ">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—Å–ª—É–≥–∏</option>';
                    categorySel.innerHTML += '<option value="–î–æ—Ö–æ–¥–∏.–ü–∞—Ä—Ç–Ω–µ—Ä–∏">–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫—ñ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</option>';
                    categorySel.innerHTML += '<option value="–î–æ—Ö–æ–¥–∏.–Ü–Ω—à–µ">–Ü–Ω—à—ñ –¥–æ—Ö–æ–¥–∏</option>';
                    categorySel.innerHTML += '</optgroup>';
                    
                    // === –í–ò–¢–†–ê–¢–ò –û–ü–ï–†–ê–¶–Ü–ô–ù–Ü (–ó–ê–ì–ê–õ–¨–ù–Ü) ===
                    categorySel.innerHTML += '<optgroup label="üè¢ –û–ü–ï–†–ê–¶–Ü–ô–ù–Ü –í–ò–¢–†–ê–¢–ò">';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–†–µ–∫–ª–∞–º–∞">–†–µ–∫–ª–∞–º–∞ —Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç">–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç</option>';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–û—Ñ—ñ—Å">–û—Ñ—ñ—Å —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</option>';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–Æ—Ä–∏–¥–∏—á–Ω—ñ">–Æ—Ä–∏–¥–∏—á–Ω—ñ –ø–æ—Å–ª—É–≥–∏</option>';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ë–∞–Ω–∫">–ë–∞–Ω–∫—ñ–≤—Å—å–∫—ñ –ø–æ—Å–ª—É–≥–∏</option>';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ü–æ–¥–∞—Ç–∫–∏">–ü–æ–¥–∞—Ç–∫–∏</option>';
                    categorySel.innerHTML += '<option value="–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–Ü–Ω—à–µ">–Ü–Ω—à—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ</option>';
                    categorySel.innerHTML += '</optgroup>';
                    
                    // === –ü–†–Ø–ú–Ü –í–ò–¢–†–ê–¢–ò –ù–ê –¢–ê–ë–Ü–† ===
                    categorySel.innerHTML += '<optgroup label="üèïÔ∏è –ü–†–Ø–ú–Ü –í–ò–¢–†–ê–¢–ò">';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–ó–ü">–ó–ü –∫–æ–º–∞–Ω–¥–∏</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–î—ñ—Ç–∏">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–ö–æ–º–∞–Ω–¥–∞">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è">–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–ü—Ä–æ–≥—Ä–∞–º–∞">–ü—Ä–æ–≥—Ä–∞–º–∞</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏">–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–ú–µ–¥–∏—Ü–∏–Ω–∞">–ú–µ–¥–∏—á–Ω—ñ –ø–æ—Å–ª—É–≥–∏</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è">–°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è</option>';
                    categorySel.innerHTML += '<option value="–ü—Ä—è–º—ñ.–Ü–Ω—à–µ">–Ü–Ω—à—ñ –ø—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏</option>';
                    categorySel.innerHTML += '</optgroup>';
                    
                    // === –ù–ï–ü–ï–†–ï–î–ë–ê–ß–ï–ù–Ü ===
                    categorySel.innerHTML += '<optgroup label="‚ö†Ô∏è –ù–ï–ü–ï–†–ï–î–ë–ê–ß–ï–ù–Ü">';
                    categorySel.innerHTML += '<option value="–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–ï–∫—Å—Ç—Ä–µ–Ω—ñ">–ï–∫—Å—Ç—Ä–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</option>';
                    categorySel.innerHTML += '<option value="–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–§–æ—Ä—Å–º–∞–∂–æ—Ä">–§–æ—Ä—Å-–º–∞–∂–æ—Ä–Ω—ñ –æ–±—Å—Ç–∞–≤–∏–Ω–∏</option>';
                    categorySel.innerHTML += '<option value="–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–Ü–Ω—à–µ">–Ü–Ω—à—ñ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ</option>';
                    categorySel.innerHTML += '</optgroup>';
                    }
                    function updateAmountSign() {
                    const categorySelect = document.getElementById('opModalCategory');
                    const amountInput = document.getElementById('opModalAmount');
                    
                    if (!categorySelect || !amountInput) return;
                    
                    const category = categorySelect.value;
                    const currentAmount = Math.abs(parseFloat(amountInput.value) || 0);
                    
                    // –Ø–∫—â–æ –Ω–µ–º–∞—î —Å—É–º–∏, —Ç–æ –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ
                    if (currentAmount === 0) {
                        return;
                    }
                    
                    // –î–æ—Ö–æ–¥–∏ - –ø–æ–∑–∏—Ç–∏–≤–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
                    if (category.startsWith('–î–æ—Ö–æ–¥–∏.')) {
                        amountInput.value = currentAmount;
                        amountInput.style.color = '#059669';
                        console.log('Set income amount:', currentAmount);
                    } 
                    // –í–∏—Ç—Ä–∞—Ç–∏ - –Ω–µ–≥–∞—Ç–∏–≤–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
                    else if (category.startsWith('–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.') || category.startsWith('–ü—Ä—è–º—ñ.') || category.startsWith('–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.')) {
                        amountInput.value = -currentAmount;
                        amountInput.style.color = '#ef4444';
                        console.log('Set expense amount:', -currentAmount);
                    }
                    // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—Ç–∏–ª—å —è–∫—â–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –Ω–µ –≤–∏–±—Ä–∞–Ω–∞
                    else {
                        amountInput.style.color = '';
                    }
                    }
                    function updateSubCategories() {
                    const mainCategorySel = document.getElementById('opModalMainCategory');
                    const categorySel = document.getElementById('opModalCategory');
                    
                    if (!mainCategorySel || !categorySel) return;
                    
                    const mainCategory = mainCategorySel.value;
                    categorySel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>';
                    
                    if (!mainCategory) {
                        categorySel.innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó</option>';
                        return;
                    }
                    
                    let options = [];
                    
                    switch(mainCategory) {
                        case '–î–æ—Ö–æ–¥–∏':
                        options = [
                            {value: '–î–æ—Ö–æ–¥–∏.–û–ø–ª–∞—Ç–∞', text: '–û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–∞–±—ñ—Ä'},
                            {value: '–î–æ—Ö–æ–¥–∏.–î–æ–¥–∞—Ç–∫–æ–≤—ñ', text: '–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—Å–ª—É–≥–∏'},
                            {value: '–î–æ—Ö–æ–¥–∏.–ü–∞—Ä—Ç–Ω–µ—Ä–∏', text: '–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫—ñ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è'},
                            {value: '–î–æ—Ö–æ–¥–∏.–Ü–Ω—à–µ', text: '–Ü–Ω—à—ñ –¥–æ—Ö–æ–¥–∏'}
                        ];
                        break;
                        
                        case '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ':
                        options = [
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–†–µ–∫–ª–∞–º–∞', text: '–†–µ–∫–ª–∞–º–∞ —Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥'},
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç', text: '–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç'},
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–û—Ñ—ñ—Å', text: '–û—Ñ—ñ—Å —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è'},
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–Æ—Ä–∏–¥–∏—á–Ω—ñ', text: '–Æ—Ä–∏–¥–∏—á–Ω—ñ –ø–æ—Å–ª—É–≥–∏'},
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ë–∞–Ω–∫', text: '–ë–∞–Ω–∫—ñ–≤—Å—å–∫—ñ –ø–æ—Å–ª—É–≥–∏'},
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ü–æ–¥–∞—Ç–∫–∏', text: '–ü–æ–¥–∞—Ç–∫–∏'},
                            {value: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–Ü–Ω—à–µ', text: '–Ü–Ω—à—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ'}
                        ];
                        break;
                        
                        case '–ü—Ä—è–º—ñ':
                        options = [
                            {value: '–ü—Ä—è–º—ñ.–ó–ü', text: '–ó–ü –∫–æ–º–∞–Ω–¥–∏'},
                            {value: '–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–î—ñ—Ç–∏', text: '–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π'},
                            {value: '–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–ö–æ–º–∞–Ω–¥–∞', text: '–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏'},
                            {value: '–ü—Ä—è–º—ñ.–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è', text: '–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è'},
                            {value: '–ü—Ä—è–º—ñ.–ü—Ä–æ–≥—Ä–∞–º–∞', text: '–ü—Ä–æ–≥—Ä–∞–º–∞'},
                            {value: '–ü—Ä—è–º—ñ.–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', text: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç'},
                            {value: '–ü—Ä—è–º—ñ.–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏', text: '–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è'},
                            {value: '–ü—Ä—è–º—ñ.–ú–µ–¥–∏—Ü–∏–Ω–∞', text: '–ú–µ–¥–∏—á–Ω—ñ –ø–æ—Å–ª—É–≥–∏'},
                            {value: '–ü—Ä—è–º—ñ.–°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è', text: '–°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è'},
                            {value: '–ü—Ä—è–º—ñ.–Ü–Ω—à–µ', text: '–Ü–Ω—à—ñ –ø—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏'}
                        ];
                        break;
                        
                        case '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ':
                        options = [
                            {value: '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–ï–∫—Å—Ç—Ä–µ–Ω—ñ', text: '–ï–∫—Å—Ç—Ä–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏'},
                            {value: '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–§–æ—Ä—Å–º–∞–∂–æ—Ä', text: '–§–æ—Ä—Å-–º–∞–∂–æ—Ä–Ω—ñ –æ–±—Å—Ç–∞–≤–∏–Ω–∏'},
                            {value: '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–Ü–Ω—à–µ', text: '–Ü–Ω—à—ñ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ'}
                        ];
                        break;
                    }
                    
                    // –î–æ–¥–∞—î–º–æ –æ–ø—Ü—ñ—ó –¥–æ —Å–µ–ª–µ–∫—Ç—É
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        categorySel.appendChild(option);
                    });
                    
                    // –û—á–∏—â–∞—î–º–æ —Å—É–º—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ç–∏–ø—É
                    const amountInput = document.getElementById('opModalAmount');
                    if (amountInput) {
                        amountInput.value = '';
                        amountInput.style.color = '';
                    }
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ/–ø—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ–ª—è –ª–æ–∫–∞—Ü—ñ—ó —Ç–∞ –∑–º—ñ–Ω–∏ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É
                    toggleLocationFields(mainCategory);
                    }
                    
                    function toggleLocationFields(mainCategory) {
                    const locationDiv = document.querySelector('#opModalLocation').parentElement;
                    const shiftDiv = document.querySelector('#opModalChange').parentElement;
                    
                    if (mainCategory === '–ü—Ä—è–º—ñ') {
                        // –ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É
                        locationDiv.style.display = 'block';
                        shiftDiv.style.display = 'block';
                        document.getElementById('opModalLocation').required = true;
                        document.getElementById('opModalChange').required = true;
                    } else {
                        // –Ü–Ω—à—ñ —Ç–∏–ø–∏ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É
                        locationDiv.style.display = 'none';
                        shiftDiv.style.display = 'none';
                        document.getElementById('opModalLocation').required = false;
                        document.getElementById('opModalChange').required = false;
                        document.getElementById('opModalLocation').value = '';
                        document.getElementById('opModalChange').value = '';
                    }
                    }
                    function saveOperation() {
                    const accountId = parseInt(document.getElementById('opModalAccount').value);
                    const date = document.getElementById('opModalDate').value;
                    const period = document.getElementById('opModalPeriod').value;
                    const location = document.getElementById('opModalLocation').value;
                    const shift = document.getElementById('opModalChange').value;
                    const category = document.getElementById('opModalCategory').value;
                    const amount = parseFloat(document.getElementById('opModalAmount').value);
                    const comment = document.getElementById('opModalComment').value.trim();
                    
                    console.log('Saving operation:', {category, amount, isExpense: amount < 0});
                    
                    // Use active plan
                    const activePlan = getActivePlan();
                    const planId = activePlan ? activePlan.id : null;
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–∞–∑–æ–≤—ñ –ø–æ–ª—è
                    if (!accountId || !amount || !date || !period || !category || !comment) {
                        alert('‚ö†Ô∏è –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
                        return;
                    }
                    
                    // –î–ª—è –ø—Ä—è–º–∏—Ö –≤–∏—Ç—Ä–∞—Ç —Ç–∞–∫–æ–∂ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É
                    if (category.startsWith('–ü—Ä—è–º—ñ.') && (!location || !shift)) {
                        alert('‚ö†Ô∏è –î–ª—è –ø—Ä—è–º–∏—Ö –≤–∏—Ç—Ä–∞—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É');
                        return;
                    }
                    
                    if (amount === 0) {
                        alert('‚ö†Ô∏è –°—É–º–∞ –Ω–µ –º–æ–∂–µ –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ 0');
                        return;
                    }
                    
                    const op = {
                        id: Date.now(),
                        planId: planId,
                        accountId,
                        date,
                        period,
                        location: location || null,     // –ú–æ–∂–µ –±—É—Ç–∏ null –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç
                        shift: shift || null,           // –ú–æ–∂–µ –±—É—Ç–∏ null –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç
                        category,                       // –ö–∞—Ç–µ–≥–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ—ó
                        amount,
                        comment                         // –û–ø–∏—Å –æ–ø–µ—Ä–∞—Ü—ñ—ó
                    };
                    
                    operations.push(op);
                    saveOperations();
                    
                    // Update account balance (positive = income, negative = expense)
                    const acc = accounts.find(a => a.id === accountId);
                    if (acc) {
                        acc.balance = (acc.balance || 0) + amount; // Add amount (positive for income, negative for expense)
                        saveAccounts();
                        renderAccountsBalances();
                    }
                    
                    // Update plan with operation
                    if (planId) {
                        const plan = allPlans.find(p => p.id === planId);
                        if (plan) {
                        if (!plan.expenses) plan.expenses = [];
                        plan.expenses.push({
                            id: op.id,
                            amount: amount,
                            date: date,
                            period: period,
                            location: location,
                            shift: shift,
                            category: category
                        });
                        saveAllPlans();
                        }
                    }
                    
                    renderOperations();
                    closeOperationModal();
                    const operationType = amount >= 0 ? '–¥–æ—Ö—ñ–¥' : '–≤–∏—Ç—Ä–∞—Ç–∞';
                    alert(`‚úÖ –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è (${operationType}) –¥–æ–¥–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!`);
                    }
                    function renderOperations() {
                    const container = document.getElementById('operationsTable');
                    if (!container) return;
                    
                    if (operations.length === 0) {
                        container.innerHTML = '<tr><td colspan="10" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –æ–ø–µ—Ä–∞—Ü—ñ–π</td></tr>';
                        return;
                    }
                    
                    const sorted = [...operations].sort((a, b) => new Date(b.date) - new Date(a.date));
                    container.innerHTML = sorted.map(op => {
                        const acc = accounts.find(a => a.id === op.accountId);
                        const plan = op.planId ? allPlans.find(p => p.id === op.planId) : null;
                        const amount = op.amount || 0;
                        const amountColor = amount >= 0 ? '#059669' : '#ef4444';
                        const amountSign = amount >= 0 ? '+' : '';
                        return `
                        <tr style="border-bottom:1px solid #e5e7eb">
                        <td style="padding:12px 8px;font-size:13px">${op.date}</td>
                        <td style="padding:12px 8px;font-size:13px">${plan ? plan.name : '‚Äî'}</td>
                        <td style="padding:12px 8px;font-size:13px">${op.period || '‚Äî'}</td>
                        <td style="padding:12px 8px;font-size:13px">${op.location || '‚Äî'}</td>
                        <td style="padding:12px 8px;font-size:13px">${op.shift ? op.shift + ' –∑–º—ñ–Ω–∞' : '‚Äî'}</td>
                        <td style="padding:12px 8px;font-size:13px">${op.category || '‚Äî'}</td>
                        <td style="padding:12px 8px;font-size:13px;color:#0369a1;font-weight:600">${op.comment || '‚Äî'}</td>
                        <td style="padding:12px 8px;text-align:right;font-weight:700;font-size:13px;color:${amountColor}">${amountSign}${amount.toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                        <td style="padding:12px 8px;font-size:13px">${acc?.name || '‚Äî'}</td>
                        <td style="padding:12px 8px;text-align:center">
                            <button onclick="deleteOperation('${op.id}')" class="btn" style="padding:6px 10px;font-size:12px;background:#fee2e2;color:#991b1b">üóëÔ∏è</button>
                        </td>
                        </tr>`;
                    }).join('');
                    }
                    function deleteOperation(id) {
                    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é?')) return;
                    
                    const opIdx = operations.findIndex(o => o && (o.id == id || String(o.id) === String(id)));
                    if (opIdx === -1) return;
                    const op = operations[opIdx];
                    
                    // Restore account balance (reverse the operation)
                    const acc = accounts.find(a => a.id === op.accountId);
                    if (acc && op.amount != null) {
                        acc.balance = (acc.balance || 0) - (op.amount || 0);
                        saveAccounts();
                        renderAccountsBalances();
                    }
                    
                    // Remove from plan expenses
                    if (op.planId) {
                        const plan = allPlans.find(p => p.id === op.planId);
                        if (plan && plan.expenses) {
                        const expIdx = plan.expenses.findIndex(e => e.id === op.id);
                        if (expIdx !== -1) {
                            plan.expenses.splice(expIdx, 1);
                            saveAllPlans();
                        }
                        }
                    }
                    
                    operations.splice(opIdx, 1);
                    saveOperations();
                    renderOperations();
                    alert('‚úÖ –û–ø–µ—Ä–∞—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–∞');
                    }
                    loadOperations();
                    
                    document.addEventListener('DOMContentLoaded', function() {
                    renderAccountsList();
                    renderAccountsBalances();
                    renderOperations();
                    
                    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ select —Ä–∞—Ö—É–Ω–∫—ñ–≤ —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π
                    updateOperationModalAccounts();
                    });function renderAccountsList() {
                    const container = document.getElementById('accountsList');
                    if (!container) return;
                    if (accounts.length === 0) {
                        container.innerHTML = '<div style="color:#64748b;padding:16px;text-align:center">–ù–µ–º–∞—î —Ä–∞—Ö—É–Ω–∫—ñ–≤</div>';
                        return;
                    }
                    container.innerHTML = accounts.map(acc =>
                        `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:12px;background:#f8fafc;border-radius:8px">
                        <span>${acc.name}</span>
                        <span>${(acc.balance||0).toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                        <span>
                            <button onclick="showEditAccountModal('${acc.id}')" class="btn" style="padding:6px 10px;font-size:12px;background:#e2e8f0">‚úèÔ∏è</button>
                            <button onclick="deleteAccount('${acc.id}')" class="btn" style="padding:6px 10px;font-size:12px;background:#fee2e2">üóëÔ∏è</button>
                        </span>
                        </div>`
                    ).join('');
                    }
                    function showAddAccountModal() {
                    document.getElementById('accountModalTitle').innerText = '–î–æ–¥–∞—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫';
                    document.getElementById('accountNameInput').value = '';
                    document.getElementById('accountBalanceInput').value = '';
                    document.getElementById('accountModal').style.display = 'flex';
                    window.editingAccountId = null;
                    }
                    function showEditAccountModal(id) {
                    // Deprecated - use editAccountFromSettings() instead
                    return;
                    }
                    function closeAccountModal() {
                    document.getElementById('accountModal').style.display = 'none';
                    }
                    function saveAccount() {
                    // Deprecated - use addNewAccount() instead
                    return;
                    }
                    function deleteAccount(id) {
                    // Deprecated - use deleteAccountFromSettings() instead
                    return;
                    }
                    
                    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è –Ω–∞–∑–≤ –§–û–ü—ñ–≤
                    function shortenFopName(name) {
                        if (!name || typeof name !== 'string') return name;
                        
                        // –í–∏–¥–∞–ª—è—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å "–§–û–ü " —è–∫—â–æ —î
                        const cleanName = name.replace(/^–§–û–ü\s+/i, '').trim();
                        
                        // –†–æ–∑–¥—ñ–ª—è—î–º–æ –Ω–∞ —Å–ª–æ–≤–∞
                        const parts = cleanName.split(/\s+/);
                        
                        if (parts.length >= 3) {
                            // –§–æ—Ä–º–∞—Ç: –ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ -> –ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü.
                            const surname = parts[0];
                            const firstName = parts[1];
                            const patronymic = parts[2];
                            
                            const firstInitial = firstName.charAt(0).toUpperCase() + '.';
                            const patronymicInitial = patronymic.charAt(0).toUpperCase() + '.';
                            
                            return `–§–û–ü ${surname} ${firstInitial}${patronymicInitial}`;
                        } else if (parts.length === 2) {
                            // –§–æ—Ä–º–∞—Ç: –ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è -> –ü—Ä—ñ–∑–≤–∏—â–µ –Ü.
                            const surname = parts[0];
                            const firstName = parts[1];
                            const firstInitial = firstName.charAt(0).toUpperCase() + '.';
                            
                            return `–§–û–ü ${surname} ${firstInitial}`;
                        } else {
                            // –Ø–∫—â–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–µ —Å–ª–æ–≤–æ –∞–±–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏–π —Ñ–æ—Ä–º–∞—Ç
                            return name.length > 25 ? name.substring(0, 22) + '...' : name;
                        }
                    }
                    
                    function renderAccountsBalances() {
                        const container = document.getElementById('accountsBalances');
                        if (!container) return;
                        
                        if (accounts.length === 0) {
                            container.innerHTML = `
                                <div style="text-align:center;padding:32px;background:#f8fafc;border-radius:12px;border:2px dashed #cbd5e1">
                                    <div style="font-size:48px;margin-bottom:16px;opacity:0.5">üí≥</div>
                                    <div style="color:#475569;font-weight:600;margin-bottom:8px;font-size:16px">–†–∞—Ö—É–Ω–∫–∏ –Ω–µ –¥–æ–¥–∞–Ω–æ</div>
                                    <div style="color:#64748b;font-size:14px;margin-bottom:20px">–î–æ–¥–∞–π—Ç–µ —Ä–∞—Ö—É–Ω–∫–∏ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—ñ–≤</div>
                                    <button onclick="showAccountsSettingsModal()" style="padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600">
                                        ‚ûï –î–æ–¥–∞—Ç–∏ –ø–µ—Ä—à–∏–π —Ä–∞—Ö—É–Ω–æ–∫
                                    </button>
                                </div>
                            `;
                            return;
                        }

                        // –†–æ–∑–¥—ñ–ª—è—î–º–æ —Ä–∞—Ö—É–Ω–∫–∏ –Ω–∞ –∑–≤–∏—á–∞–π–Ω—ñ —Ç–∞ –§–û–ü–∏
                        const regularAccounts = accounts.filter(acc => acc.type !== 'fop');
                        const fopAccounts = accounts.filter(acc => acc.type === 'fop');
                        
                        // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å
                        const totalBalance = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
                        
                        let html = '';
                        
                        // –ó–≤–∏—á–∞–π–Ω—ñ —Ä–∞—Ö—É–Ω–∫–∏
                        if (regularAccounts.length > 0) {
                            html += regularAccounts.map(acc => `
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:12px;background:#ecfdf5;border-radius:8px;border-left:3px solid #10b981;transition:background 0.2s ease" onmouseover="this.style.background='#d1fae5'" onmouseout="this.style.background='#ecfdf5'">
                                    <div style="display:flex;align-items:center;min-width:0;flex:1;margin-right:12px">
                                        <span style="color:#059669;margin-right:8px;font-size:14px">üèõÔ∏è</span>
                                        <span style="font-weight:600;color:#1e293b;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${acc.name}">${acc.name}</span>
                                    </div>
                                    <span style="font-weight:700;color:#10b981;font-size:16px;white-space:nowrap">${(acc.balance||0).toLocaleString('uk-UA')} ‚Ç¥</span>
                                </div>
                            `).join('');
                        }
                        
                        // –§–û–ü–∏
                        if (fopAccounts.length > 0) {
                            if (regularAccounts.length > 0) {
                                html += '<div style="margin:16px 0 8px 0;font-size:12px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.5px">üë§ –§–û–ü —Ä–∞—Ö—É–Ω–∫–∏</div>';
                            }
                            
                            html += fopAccounts.map(acc => {
                                const shortName = shortenFopName(acc.name);
                                return `
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:12px;background:#fef3c7;border-radius:8px;border-left:3px solid #f59e0b;transition:background 0.2s ease" onmouseover="this.style.background='#fde68a'" onmouseout="this.style.background='#fef3c7'">
                                    <div style="display:flex;align-items:center;min-width:0;flex:1;margin-right:12px">
                                        <span style="color:#d97706;margin-right:8px;font-size:14px">üë§</span>
                                        <span style="font-weight:600;color:#1e293b;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${acc.name}">${shortName}</span>
                                    </div>
                                    <span style="font-weight:700;color:#f59e0b;font-size:16px;white-space:nowrap">${(acc.balance||0).toLocaleString('uk-UA')} ‚Ç¥</span>
                                </div>
                                `;
                            }).join('');
                        }
                        
                        // –î–æ–¥–∞—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å –≤–Ω–∏–∑—É
                        html += `
                            <div style="margin-top:20px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:16px;border-radius:12px;text-align:center;box-shadow:0 4px 12px rgba(59,130,246,0.3)">
                                <div style="font-size:12px;opacity:0.9;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">üí∞ –ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å</div>
                                <div style="font-size:24px;font-weight:700">${totalBalance.toLocaleString('uk-UA')} ‚Ç¥</div>
                                <div style="font-size:11px;opacity:0.8;margin-top:2px">${accounts.length} ${accounts.length === 1 ? '—Ä–∞—Ö—É–Ω–æ–∫' : accounts.length < 5 ? '—Ä–∞—Ö—É–Ω–∫–∏' : '—Ä–∞—Ö—É–Ω–∫—ñ–≤'}</div>
                            </div>
                        `;
                        
                        container.innerHTML = html;
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ dashboard –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –±–∞–ª–∞–Ω—Å—ñ–≤
                        if (typeof refreshDashboard === 'function') {
                            refreshDashboard();
                        }
                    }

                    let profitChart = null;

                        const fmt = (v)=> v.toLocaleString('uk-UA') + ' ‚Ç¥';

                        function scrollToSection(sectionId) {
                        const element = document.getElementById(sectionId);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        }

                        function computeRow(basePrice, discPct, taxPct, costAmount, group, fixedCosts, coachQty, coachPay, transfer){
                        const priceAfterDisc = basePrice * (1 - discPct/100) - transfer;
                        const effectivePrice = Math.max(priceAfterDisc, 0);
                        const afterTax = effectivePrice * (1 - taxPct/100);
                        const totalCoachCost = coachQty * coachPay;
                        const coachPer = totalCoachCost / group;
                        const netAfterTax = afterTax - coachPer;
                        const profitPer = netAfterTax - costAmount;
                        const totalProfit = (netAfterTax * group) - (costAmount * group) - fixedCosts;
                        const margin = afterTax > 0 ? (profitPer / afterTax) * 100 : 0;
                        return {effectivePrice, afterTax, netAfterTax, costAmount, coachPer, profitPer, totalProfit, margin, totalCoachCost};
                        }

                        function getApplicableParams(groupSize, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3) {
                        if (groupSize >= 31) return {disc: disc3, taxPct: taxPct3, transfer: transfer3, coachQty: coachQty3, coachPay: coachPay3};
                        if (groupSize >= 21) return {disc: disc2, taxPct: taxPct2, transfer: transfer2, coachQty: coachQty2, coachPay: coachPay2};
                        if (groupSize >= 15) return {disc: disc1, taxPct: taxPct1, transfer: transfer1, coachQty: coachQty1, coachPay: coachPay1};
                        return {disc: 0, taxPct: 0, transfer: 0, coachQty: 0, coachPay: 0};
                        }

                        function calculateCustomGroup(basePrice, costAmount, fixedCosts, totalChildren, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3) {
                        // Helper to safely get element value
                        const getVal = (id, def=0) => { const el = document.getElementById(id); return el ? (Number(el.value)||def) : def; };
                        const getChecked = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
                        
                        // Gather discount data from UI - individual discounts only
                        const individualDiscounts = [
                            {checked:getChecked('customEarlyCheck'), amount:getVal('catEarlyAmount'), count:getVal('customEarlyCount'), type:'sum'},
                            {checked:getChecked('customRepeatCheck'), amount:getVal('catRepeatAmount'), count:getVal('customRepeatCount'), type:'sum'},
                            {checked:getChecked('customFriendsCheck'), amount:getVal('catFriendsAmount'), count:getVal('customFriendsCount'), type:'sum'},
                            {checked:getChecked('customSocCheck'), pct:getVal('catSocPct'), count:getVal('customSocCount'), type:'pct'},
                            {checked:getChecked('customDoubleCheck'), pct:getVal('catDoublePct'), count:getVal('customDoubleCount'), type:'pct'},
                            {checked:getChecked('customEarlySocCheck'), amount:getVal('catEarlySocAmount'), pct:getVal('catEarlySocPct'), count:getVal('customEarlySocCount'), type:'sum_pct'}
                        ];
                        
                        let totalProfitCustom = 0, totalMarginCustom = 0, totalNetCustom = 0, totalEffectiveCustom = 0;
                        let processedChildren = 0;
                        
                        // Process individual discounts (without tax/transfer/coaches)
                        individualDiscounts.forEach((d, idx)=>{
                            if(!d.checked || d.count<=0) return;
                            let count = d.count;
                            let effPrice = basePrice;
                            if(d.type==='sum'){
                            effPrice = basePrice - d.amount;
                            }else if(d.type==='pct'){
                            effPrice = basePrice * (1 - (d.pct||0)/100);
                            }else if(d.type==='sum_pct'){
                            effPrice = (basePrice - (d.amount||0)) * (1 - (d.pct||0)/100);
                            }
                            // No transfer or tax for individual discounts, use defaults
                            effPrice = Math.max(effPrice, 0);
                            let afterTax = effPrice;  // No tax for simplicity
                            let totalCoachCost = 0; // No additional coaches for individual discounts
                            let coachPer = totalCoachCost / totalChildren;
                            let netAfterTax = afterTax - coachPer;
                            let profitPer = netAfterTax - costAmount;
                            let totalProfit = (netAfterTax * count) - (costAmount * count) - fixedCosts * (count/totalChildren);
                            let margin = afterTax > 0 ? (profitPer / afterTax) * 100 : 0;
                            totalProfitCustom += totalProfit;
                            totalMarginCustom += margin * count;
                            totalNetCustom += netAfterTax * count;
                            totalEffectiveCustom += effPrice * count;
                            processedChildren += count;
                        });
                        
                        // Process "Custom category discount" - auto-determines category based on count
                        if(getChecked('customCategoryCheck') && getVal('customCategoryCount') > 0) {
                            let count = getVal('customCategoryCount');
                            // Determine which category applies based on count
                            let params;
                            if(count >= 31) {
                            params = {disc:disc3, taxPct:taxPct3, transfer:transfer3, coachQty:coachQty3, coachPay:coachPay3};
                            } else if(count >= 21) {
                            params = {disc:disc2, taxPct:taxPct2, transfer:transfer2, coachQty:coachQty2, coachPay:coachPay2};
                            } else if(count >= 15) {
                            params = {disc:disc1, taxPct:taxPct1, transfer:transfer1, coachQty:coachQty1, coachPay:coachPay1};
                            } else {
                            // Less than 15 - use full price
                            params = {disc:0, taxPct:0, transfer:0, coachQty:0, coachPay:0};
                            }
                            
                            let effPrice = basePrice * (1 - params.disc/100) - params.transfer;
                            effPrice = Math.max(effPrice, 0);
                            let afterTax = effPrice * (1 - params.taxPct/100);
                            let totalCoachCost = params.coachQty * params.coachPay;
                            let coachPer = totalCoachCost / totalChildren;
                            let netAfterTax = afterTax - coachPer;
                            let profitPer = netAfterTax - costAmount;
                            let totalProfit = (netAfterTax * count) - (costAmount * count) - fixedCosts * (count/totalChildren);
                            let margin = afterTax > 0 ? (profitPer / afterTax) * 100 : 0;
                            totalProfitCustom += totalProfit;
                            totalMarginCustom += margin * count;
                            totalNetCustom += netAfterTax * count;
                            totalEffectiveCustom += effPrice * count;
                            processedChildren += count;
                        }
                        
                        // Remaining children (full price)
                        let childrenLeft = totalChildren - processedChildren;
                        if(childrenLeft>0){
                            let effPrice = basePrice;
                            let afterTax = effPrice;
                            let netAfterTax = afterTax;
                            let profitPer = netAfterTax - costAmount;
                            let totalProfit = (netAfterTax * childrenLeft) - (costAmount * childrenLeft) - fixedCosts * (childrenLeft/totalChildren);
                            let margin = afterTax > 0 ? (profitPer / afterTax) * 100 : 0;
                            totalProfitCustom += totalProfit;
                            totalMarginCustom += margin * childrenLeft;
                            totalNetCustom += netAfterTax * childrenLeft;
                            totalEffectiveCustom += effPrice * childrenLeft;
                        }
                        
                        let avgMarginCustom = totalChildren>0 ? totalMarginCustom/totalChildren : 0;
                        let avgNetCustom = totalChildren>0 ? totalNetCustom/totalChildren : 0;
                        let avgEffCustom = totalChildren>0 ? totalEffectiveCustom/totalChildren : 0;
                        let avgProfitCustom = totalChildren>0 ? (totalNetCustom - costAmount*totalChildren - fixedCosts)/totalChildren : 0;
                        
                        return {
                            avgMarginCustom,
                            avgNetCustom,
                            avgEffCustom,
                            avgProfitCustom,
                            totalProfitCustom,
                            costAmount: costAmount
                        };
                        }


                        function computeBreakEven(basePrice, taxPct, costAmount, fixedCosts, disc, coachQty, coachPay, transfer) {
                        const priceAfterDisc = basePrice * (1 - disc/100) - transfer;
                        const effectivePrice = Math.max(priceAfterDisc, 0);
                        const afterTax = effectivePrice * (1 - taxPct/100);
                        const profitPerBase = afterTax - costAmount;
                        const totalCoachCost = coachQty * coachPay;
                        if (profitPerBase <= 0) {
                            return Infinity;
                        }
                        return Math.ceil((fixedCosts + totalCoachCost) / profitPerBase);
                        }

                        function checkMinMargin(basePrice, taxPct, costAmount, minProfitMaxDisc, discMax, coachQtyMax, coachPayMax, transferMax){
                        const groupMax = 35;
                        const vMax = computeRow(basePrice, discMax, taxPct, costAmount, groupMax, 0, coachQtyMax, coachPayMax, transferMax);
                        const profitPer = vMax.profitPer;

                        let alertClass = 'success';
                        let message = `‚úÖ –î–æ–±—Ä–µ! –ü—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É –ø—Ä–∏ –º–∞–∫—Å. –∑–Ω–∏–∂—Ü—ñ = ${fmt(Math.round(profitPer))}, —â–æ –ø–µ—Ä–µ–≤–∏—â—É—î –º—ñ–Ω—ñ–º—É–º ${fmt(Math.round(minProfitMaxDisc))}.`;
                        let suggestion = '';
                        let requiredBase = null; // Declare requiredBase at function scope

                        if (profitPer < minProfitMaxDisc) {
                            alertClass = 'error';
                            message = `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ! –ü—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É –ø—Ä–∏ –º–∞–∫—Å. –∑–Ω–∏–∂—Ü—ñ = ${fmt(Math.round(profitPer))}, –º–µ–Ω—à–µ –∑–∞ –º—ñ–Ω—ñ–º—É–º ${fmt(Math.round(minProfitMaxDisc))}.`;
                            
                            const requiredAfterTax = costAmount + (coachQtyMax * coachPayMax / groupMax) + minProfitMaxDisc;
                            const requiredEffectivePrice = requiredAfterTax / (1 - taxPct/100);
                            const requiredPriceAfterDisc = requiredEffectivePrice + transferMax;
                            requiredBase = requiredPriceAfterDisc / (1 - discMax/100); // Assign to the function-scoped variable
                            suggestion = `üí° –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –±–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞: ${fmt(Math.round(requiredBase))}.`;
                        } else if (Math.abs(profitPer - minProfitMaxDisc) < 100) {
                            alertClass = 'warning';
                            message = `‚ö†Ô∏è –ë–ª–∏–∑—å–∫–æ –¥–æ –º–µ–∂—ñ! –ü—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É –ø—Ä–∏ –º–∞–∫—Å. –∑–Ω–∏–∂—Ü—ñ = ${fmt(Math.round(profitPer))}, –ª–µ–¥—å –ø–µ—Ä–µ–≤–∏—â—É—î ${fmt(Math.round(minProfitMaxDisc))}.`;
                        }

                        return {alertClass, message, suggestion, profitPer, requiredBase: requiredBase ? Math.round(requiredBase) : null};
                        }

                        function buildTable(){
                        const basePrice = Number(document.getElementById('basePrice').value) || 0;
                        const costAmount = Number(document.getElementById('costAmount').value) || 0;
                        const fixedCosts = Number(document.getElementById('fixedCosts').value) || 0;
                        const minProfitMaxDisc = Number(document.getElementById('minProfitMaxDisc').value) || 0;

                        // Category 1
                        const enableDisc1 = document.getElementById('enableDisc1').checked;
                        const disc1 = enableDisc1 ? Number(document.getElementById('disc1').value) || 0 : 0;
                        const enableCoach1 = document.getElementById('enableCoach1').checked;
                        const coachQty1 = enableCoach1 ? Number(document.getElementById('coachQty1').value) || 0 : 0;
                        const coachPay1 = enableCoach1 ? Number(document.getElementById('coachPay1').value) || 0 : 0;
                        const enableTransfer1 = document.getElementById('enableTransfer1').checked;
                        const transfer1 = enableTransfer1 ? Number(document.getElementById('transferAmount1').value) || 0 : 0;
                        const enableTax1 = document.getElementById('enableTax1').checked;
                        const taxPct1 = enableTax1 ? Number(document.getElementById('taxPct1').value) || 0 : 0;

                        // Category 2
                        const enableDisc2 = document.getElementById('enableDisc2').checked;
                        const disc2 = enableDisc2 ? Number(document.getElementById('disc2').value) || 0 : 0;
                        const enableCoach2 = document.getElementById('enableCoach2').checked;
                        const coachQty2 = enableCoach2 ? Number(document.getElementById('coachQty2').value) || 0 : 0;
                        const coachPay2 = enableCoach2 ? Number(document.getElementById('coachPay2').value) || 0 : 0;
                        const enableTransfer2 = document.getElementById('enableTransfer2').checked;
                        const transfer2 = enableTransfer2 ? Number(document.getElementById('transferAmount2').value) || 0 : 0;
                        const enableTax2 = document.getElementById('enableTax2').checked;
                        const taxPct2 = enableTax2 ? Number(document.getElementById('taxPct2').value) || 0 : 0;

                        // Category 3
                        const enableDisc3 = document.getElementById('enableDisc3').checked;
                        const disc3 = enableDisc3 ? Number(document.getElementById('disc3').value) || 0 : 0;
                        const enableCoach3 = document.getElementById('enableCoach3').checked;
                        const coachQty3 = enableCoach3 ? Number(document.getElementById('coachQty3').value) || 0 : 0;
                        const coachPay3 = enableCoach3 ? Number(document.getElementById('coachPay3').value) || 0 : 0;
                        const enableTransfer3 = document.getElementById('enableTransfer3').checked;
                        const transfer3 = enableTransfer3 ? Number(document.getElementById('transferAmount3').value) || 0 : 0;
                        const enableTax3 = document.getElementById('enableTax3').checked;
                        const taxPct3 = enableTax3 ? Number(document.getElementById('taxPct3').value) || 0 : 0;

                        const rows = [
                            {label:'–≤—ñ–¥ 15 –¥–æ 20', group:15, disc:disc1, taxPct:taxPct1, transfer:transfer1, coachQty:coachQty1, coachPay:coachPay1},
                            {label:'–≤—ñ–¥ 21 –¥–æ 30', group:25, disc:disc2, taxPct:taxPct2, transfer:transfer2, coachQty:coachQty2, coachPay:coachPay2},
                            {label:'–≤—ñ–¥ 31 —ñ –±—ñ–ª—å—à–µ', group:35, disc:disc3, taxPct:taxPct3, transfer:transfer3, coachQty:coachQty3, coachPay:coachPay3},
                        ];

                        const resultDiv = document.getElementById('result');
                        resultDiv.innerHTML = '';

                        const tbl = document.createElement('table');
                        const thead = document.createElement('thead');
                        thead.innerHTML = '<tr><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th class="group-disc">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–Ω–∏–∂–∫–∏</th><th class="group-price">–ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Ü—ñ–Ω–∞</th><th class="group-price">–ù–µ—Ç—Ç–æ –ø—ñ—Å–ª—è –ø–æ–¥–∞—Ç–∫—É</th><th class="group-cost">–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å</th><th class="group-profit">–ü—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É</th><th class="group-profit">–ú–∞—Ä–∂–∞ (%)</th><th class="group-profit">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ (–¥–ª—è –≥—Ä—É–ø–∏)</th></tr>';
                        tbl.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        rows.forEach((r)=>{
                            const v = computeRow(basePrice, r.disc, r.taxPct, costAmount, r.group, fixedCosts, r.coachQty, r.coachPay, r.transfer);
                            const profitClass = v.profitPer >= 0 ? 'positive' : 'negative';
                            const totalProfitClass = v.totalProfit >= 0 ? 'positive' : 'negative';
                            const discStr = r.disc > 0 ? `${r.disc}%` : '';
                            const transferStr = r.transfer > 0 ? ` - ${r.transfer} —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä` : '';
                            const taxStr = r.taxPct > 0 ? ` - ${r.taxPct}% –ø–æ–¥–∞—Ç–æ–∫` : '';
                            const paramsStr = [discStr, transferStr, taxStr].filter(s => s).join(' ');
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${r.label} (${r.group} –¥—ñ—Ç–µ–π)</td><td class="group-disc">${paramsStr}</td><td class="group-price">${fmt(Math.round(v.effectivePrice))}</td><td class="group-price">${fmt(Math.round(v.netAfterTax))}</td><td class="group-cost">${fmt(Math.round(v.costAmount))}</td><td class="${profitClass} group-profit">${fmt(Math.round(v.profitPer))}</td><td class="group-profit">${v.margin.toFixed(1)}%</td><td class="${totalProfitClass} group-profit">${fmt(Math.round(v.totalProfit))}</td>`;
                            tbody.appendChild(tr);
                        });

                        // Get total children from base params
                        const totalChildrenEl = document.getElementById('totalChildren');
                        const groupCustom = totalChildrenEl ? (Number(totalChildrenEl.value) || 35) : 35;

                        // Custom group with discounts (uses category values)
                        const customGroupResult = calculateCustomGroup(basePrice, costAmount, fixedCosts, groupCustom, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3);
                        const {avgMarginCustom, avgNetCustom, avgEffCustom, avgProfitCustom, totalProfitCustom} = customGroupResult;
                        
                        const trc = document.createElement('tr');
                        trc.classList.add('custom-row');
                        trc.innerHTML = `<td>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ –≥—Ä—É–ø–∞ (${groupCustom} –¥—ñ—Ç–µ–π)</td><td class="group-disc">–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –∑–Ω–∏–∂–∫–∏</td><td class="group-price">${fmt(Math.round(avgEffCustom))}</td><td class="group-price">${fmt(Math.round(avgNetCustom))}</td><td class="group-cost">${fmt(Math.round(costAmount))}</td><td class="${avgProfitCustom>=0?'positive':'negative'} group-profit">${fmt(Math.round(avgProfitCustom))}</td><td class="group-profit">${avgMarginCustom.toFixed(1)}%</td><td class="${totalProfitCustom>=0?'positive':'negative'} group-profit">${fmt(Math.round(totalProfitCustom))}</td>`;
                        tbody.appendChild(trc);

                        tbl.appendChild(tbody);
                        resultDiv.appendChild(tbl);

                        // Calculate discount losses and plan comparison
                        const fullPriceRevenue = basePrice * groupCustom;
                        const actualRevenue = avgEffCustom * groupCustom;
                        const discountLoss = fullPriceRevenue - actualRevenue;
                        const discountLossPct = fullPriceRevenue > 0 ? (discountLoss / fullPriceRevenue * 100) : 0;
                        
                        // Get planned cost from Cost tab if available
                        const plannedCostNoOp = parseFloat(document.getElementById('avgCostNoOpResult')?.textContent?.replace(/[^\d.-]/g, '') || '0');
                        const plannedCostWithOp = parseFloat(document.getElementById('avgCostWithOpResult')?.textContent?.replace(/[^\d.-]/g, '') || '0');
                        const hasPlannedData = plannedCostNoOp > 0 || plannedCostWithOp > 0;
                        
                        let planComparisonHTML = '';
                        if(hasPlannedData) {
                            const costDiffNoOp = costAmount - plannedCostNoOp;
                            const costDiffWithOp = costAmount - plannedCostWithOp;
                            const diffPctNoOp = plannedCostNoOp > 0 ? (costDiffNoOp / plannedCostNoOp * 100) : 0;
                            const diffPctWithOp = plannedCostWithOp > 0 ? (costDiffWithOp / plannedCostWithOp * 100) : 0;
                            
                            planComparisonHTML = `
                            <div style="margin-top:16px;padding:16px;background:white;border-radius:8px;border:1px solid #e5e7eb">
                                <div style="font-size:14px;font-weight:700;margin-bottom:12px;color:#374151">üìä –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –ø–ª–∞–Ω–æ–≤–æ—é —Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—é:</div>
                                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;font-size:13px">
                                <div>
                                    <div style="color:#64748b;margin-bottom:4px">–ü–ª–∞–Ω (–±–µ–∑ –æ–ø–µ—Ä. –≤–∏—Ç—Ä–∞—Ç)</div>
                                    <div style="font-weight:600">${fmt(Math.round(plannedCostNoOp))} ‚Üí –ø–æ—Ö–∏–±–∫–∞: <span class="${Math.abs(diffPctNoOp) > 10 ? 'negative' : 'positive'}">${diffPctNoOp >= 0 ? '+' : ''}${diffPctNoOp.toFixed(1)}%</span></div>
                                </div>
                                <div>
                                    <div style="color:#64748b;margin-bottom:4px">–ü–ª–∞–Ω (–∑ –æ–ø–µ—Ä. –≤–∏—Ç—Ä–∞—Ç–∞–º–∏)</div>
                                    <div style="font-weight:600">${fmt(Math.round(plannedCostWithOp))} ‚Üí –ø–æ—Ö–∏–±–∫–∞: <span class="${Math.abs(diffPctWithOp) > 10 ? 'negative' : 'positive'}">${diffPctWithOp >= 0 ? '+' : ''}${diffPctWithOp.toFixed(1)}%</span></div>
                                </div>
                                </div>
                            </div>
                            `;
                        }

                        const sum = document.createElement('div');
                        sum.style.cssText = 'margin-top:20px;padding:20px;background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);border-radius:12px;border-left:4px solid #10b981;box-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                        const profitPerClass = avgProfitCustom >= 0 ? 'positive' : 'negative';
                        const totalProfitClass = totalProfitCustom >= 0 ? 'positive' : 'negative';
                        sum.innerHTML = `
                            <div style="font-size:16px;font-weight:700;margin-bottom:12px;color:#065f46">üìà –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –≥—Ä—É–ø–∏ ${groupCustom} –¥—ñ—Ç–µ–π:</div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                            <div style="background:white;padding:12px;border-radius:8px">
                                <div style="font-size:12px;color:#64748b;margin-bottom:4px">–ü—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É</div>
                                <div class="${profitPerClass}" style="font-size:20px">${fmt(Math.round(avgProfitCustom))}</div>
                            </div>
                            <div style="background:white;padding:12px;border-radius:8px">
                                <div style="font-size:12px;color:#64748b;margin-bottom:4px">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div>
                                <div class="${totalProfitClass}" style="font-size:20px">${fmt(Math.round(totalProfitCustom))}</div>
                            </div>
                            <div style="background:white;padding:12px;border-radius:8px">
                                <div style="font-size:12px;color:#64748b;margin-bottom:4px">–ú–∞—Ä–∂–∞</div>
                                <div style="font-size:20px;font-weight:700;color:#3b82f6">${avgMarginCustom.toFixed(1)}%</div>
                            </div>
                            </div>
                            <div style="margin-top:16px;padding:16px;background:white;border-radius:8px;border:1px solid #fbbf24">
                            <div style="font-size:14px;font-weight:700;margin-bottom:8px;color:#92400e">üí∏ –í—Ç—Ä–∞—Ç–∏ –Ω–∞ –∑–Ω–∏–∂–∫–∞—Ö:</div>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;font-size:13px">
                                <div>
                                <div style="color:#64748b;margin-bottom:4px">–ü–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å</div>
                                <div style="font-weight:600">${fmt(Math.round(fullPriceRevenue))}</div>
                                </div>
                                <div>
                                <div style="color:#64748b;margin-bottom:4px">–§–∞–∫—Ç–∏—á–Ω–∞ –≤–∏—Ä—É—á–∫–∞</div>
                                <div style="font-weight:600">${fmt(Math.round(actualRevenue))}</div>
                                </div>
                                <div>
                                <div style="color:#64748b;margin-bottom:4px">–í—Ç—Ä–∞—Ç–∏ (–∑–Ω–∏–∂–∫–∏)</div>
                                <div style="font-weight:600;color:#dc2626">-${fmt(Math.round(discountLoss))} (${discountLossPct.toFixed(1)}%)</div>
                                </div>
                            </div>
                            </div>
                            ${planComparisonHTML}
                        `;
                        resultDiv.appendChild(sum);

                        // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∞–Ω–∞–ª—ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—ó –º–∞—Ä–∂—ñ (–¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó 31+)
                        const checkDiv = document.getElementById('marginCheck');
                        const check = checkMinMargin(basePrice, taxPct3, costAmount, minProfitMaxDisc, disc3, coachQty3, coachPay3, transfer3);
                        checkDiv.innerHTML = `<div class="alert ${check.alertClass}">${check.message}</div>`;
                        if (check.suggestion) {
                            checkDiv.innerHTML += `<div class="suggestion">${check.suggestion}</div>`;
                        }

                        // –¢–æ—á–∫–∞ –±–µ–∑–∑–±–∏—Ç–∫–æ–≤–æ—Å—Ç—ñ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ—ó –≥—Ä—É–ø–∏
                        const applicableParams = getApplicableParams(groupCustom, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3);
                        const breakeven = computeBreakEven(basePrice, applicableParams.taxPct, costAmount, fixedCosts, applicableParams.disc, applicableParams.coachQty, applicableParams.coachPay, applicableParams.transfer);
                        const breakevenDiv = document.getElementById('breakevenInfo');
                        let breakevenMessage = '';
                        if (fixedCosts === 0 && applicableParams.coachQty === 0 && applicableParams.transfer === 0 && applicableParams.taxPct === 0) {
                            breakevenMessage = '‚ÑπÔ∏è –§—ñ–∫—Å–æ–≤–∞–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏, –≤–æ–∂–∞—Ç—ñ, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä —Ç–∞ –ø–æ–¥–∞—Ç–æ–∫ = 0 ‚Ç¥, —Ç–æ–º—É —Ç–æ—á–∫–∞ –±–µ–∑–∑–±–∏—Ç–∫–æ–≤–æ—Å—Ç—ñ = 1 –¥–∏—Ç–∏–Ω–∞.';
                        } else if (breakeven === Infinity) {
                            breakevenMessage = `‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –¥–æ—Å—è–≥—Ç–∏ –±–µ–∑–∑–±–∏—Ç–∫–æ–≤–æ—Å—Ç—ñ ‚Äî –ø—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É ‚â§ 0.`;
                        } else {
                            const vBreakeven = computeRow(basePrice, applicableParams.disc, applicableParams.taxPct, costAmount, breakeven, fixedCosts, applicableParams.coachQty, applicableParams.coachPay, applicableParams.transfer);
                            breakevenMessage = `‚úÖ –¢–æ—á–∫–∞ –±–µ–∑–∑–±–∏—Ç–∫–æ–≤–æ—Å—Ç—ñ: ${breakeven} –¥—ñ—Ç–µ–π (–∑–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ ‚âà ${fmt(Math.round(vBreakeven.totalProfit))}).`;
                        }
                        breakevenDiv.innerHTML = `<div class="breakeven-info">${breakevenMessage}</div>`;

                        // –ì—Ä–∞—Ñ—ñ–∫ –ø—Ä–∏–±—É—Ç–∫—É
                        buildChart(basePrice, costAmount, fixedCosts, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3, breakeven);
                        }

                        function buildChart(basePrice, costAmount, fixedCosts, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3, breakeven) {
                        const ctx = document.getElementById('profitChart').getContext('2d');
                        const groupSizes = [];
                        const profits = [];
                        const minGroup = 1;
                        const maxGroup = 50;
                        for (let group = minGroup; group <= maxGroup; group++) {
                            groupSizes.push(group);
                            const params = getApplicableParams(group, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3);
                            const v = computeRow(basePrice, params.disc, params.taxPct, costAmount, group, fixedCosts, params.coachQty, params.coachPay, params.transfer);
                            profits.push(v.totalProfit);
                        }

                        if (profitChart) {
                            profitChart.destroy();
                        }

                        const config = {
                            type: 'line',
                            data: {
                            labels: groupSizes,
                            datasets: [{
                                label: '–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ (‚Ç¥)',
                                data: profits,
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                            },
                            options: {
                            responsive: true,
                            scales: {
                                y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                    return fmt(value);
                                    }
                                }
                                }
                            },
                            plugins: {
                                legend: {
                                display: true
                                },
                                tooltip: {
                                callbacks: {
                                    label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += fmt(Math.round(context.parsed.y));
                                    }
                                    if (breakeven !== Infinity && context.parsed.x === breakeven) {
                                        label += ' (—Ç–æ—á–∫–∞ –±–µ–∑–∑–±–∏—Ç–∫–æ–≤–æ—Å—Ç—ñ)';
                                    }
                                    return label;
                                    }
                                }
                                }
                            }
                            }
                        };

                        profitChart = new Chart(ctx, config);
                        }

                        // Global showTab function for compatibility
                        window.showTab = function(tabId) {
                            const btn = document.querySelector(`[data-tab="${tabId}"]`);
                            if (btn) {
                                btn.click();
                            }
                        };
                        
                        // Tabs switching
                        document.querySelectorAll('.tab-btn').forEach(btn=>{
                        btn.addEventListener('click',()=>{
                            // Check if leaving Calculator tab with active plan - save it
                            const currentActive = document.querySelector('.tab-btn.active');
                            if (currentActive && currentActive.getAttribute('data-tab') === 'salesTab') {
                            if (typeof saveActivePlan === 'function' && typeof activePlanId !== 'undefined' && activePlanId) {
                                saveActivePlan();
                            }
                            // syncActivePlanToCRM deprecated - periods now managed via CRM data structure
                            }
                            
                            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                            document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
                            btn.classList.add('active');
                            const id = btn.getAttribute('data-tab');
                            const pane = document.getElementById(id);
                            if (pane) pane.classList.add('active');
                            
                            // Refresh UI when entering certain tabs
                            if (id === 'salesTab') {
                            // Always switch to sales sub-tab when entering Calculator
                            switchCalculatorTab('sales');
                            } else if (id === 'clientsTab') {
                            // Always switch to clients sub-tab when entering CRM
                            switchCrmTab('clients');
                            
                            if (typeof updatePeriodLocationShiftFilters === 'function') {
                                updatePeriodLocationShiftFilters();
                            }
                            if (typeof renderClientsTable === 'function') {
                                renderClientsTable();
                            }
                            if (typeof updateActiveSeasonsStats === 'function') {
                                updateActiveSeasonsStats();
                            }
                            } else if (id === 'financeTab') {
                            if (typeof initFinanceTab === 'function') {
                                initFinanceTab();
                            }
                            } else if (id === 'settingsTab') {
                            if (typeof renderPeriodsManagement === 'function') {
                                renderPeriodsManagement();
                            }
                            } else if (id === 'analyticsTab') {
                            if (typeof updateAnalytics === 'function') {
                                // Initialize with sales tab
                                if (!document.querySelector('.analytics-tab-btn.active')) {
                                    switchAnalyticsTab('sales');
                                }
                                updateAnalytics();
                            }
                            }
                        });
                        });

                        // CRM Sub-tabs switching
                        function switchCrmTab(tabName) {
                            // Remove active class from all CRM tab buttons
                            document.querySelectorAll('.crm-tab-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.style.color = '#6b7280';
                                btn.style.borderBottomColor = 'transparent';
                            });
                            
                            // Hide all CRM sections
                            const clientsSection = document.getElementById('crmClientsSection');
                            const refundsSection = document.getElementById('crmRefundsSection');
                            
                            if (tabName === 'clients') {
                                // Show clients section
                                if (clientsSection) clientsSection.style.display = 'block';
                                if (refundsSection) refundsSection.style.display = 'none';
                                
                                // Activate clients tab button
                                const clientsBtn = document.getElementById('crmClientsTabBtn');
                                if (clientsBtn) {
                                    clientsBtn.classList.add('active');
                                    clientsBtn.style.color = '#3b82f6';
                                    clientsBtn.style.borderBottomColor = '#3b82f6';
                                }
                                
                                // Refresh clients data
                                if (typeof renderClientsTable === 'function') {
                                    renderClientsTable();
                                }
                            } else if (tabName === 'refunds') {
                                // Show refunds section
                                if (clientsSection) clientsSection.style.display = 'none';
                                if (refundsSection) refundsSection.style.display = 'block';
                                
                                // Activate refunds tab button
                                const refundsBtn = document.getElementById('crmRefundsTabBtn');
                                if (refundsBtn) {
                                    refundsBtn.classList.add('active');
                                    refundsBtn.style.color = '#3b82f6';
                                    refundsBtn.style.borderBottomColor = '#3b82f6';
                                }
                                
                                // Refresh refunds data
                                if (typeof renderRefundsTable === 'function') {
                                    renderRefundsTable();
                                }
                            }
                            
                            // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –≤—ñ–¥–º–æ–≤
                            updateRefundsBadge();
                        }

                        // Calculator Sub-tabs switching
                        function switchCalculatorTab(tabName) {
                            // Remove active class from all Calculator tab buttons
                            document.querySelectorAll('.calc-tab-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.style.color = '#6b7280';
                                btn.style.borderBottomColor = 'transparent';
                            });
                            
                            // Hide all Calculator sections
                            const salesSection = document.getElementById('calcSalesSection');
                            const costSection = document.getElementById('calcCostSection');
                            
                            if (tabName === 'sales') {
                                // Show sales section
                                if (salesSection) salesSection.style.display = 'block';
                                if (costSection) costSection.style.display = 'none';
                                
                                // Activate sales tab button
                                const salesBtn = document.getElementById('calcSalesTabBtn');
                                if (salesBtn) {
                                    salesBtn.classList.add('active');
                                    salesBtn.style.color = '#3b82f6';
                                    salesBtn.style.borderBottomColor = '#3b82f6';
                                }
                                
                                // Refresh sales calculations
                                if (typeof buildTable === 'function') {
                                    buildTable();
                                }
                            } else if (tabName === 'cost') {
                                // Show cost section
                                if (salesSection) salesSection.style.display = 'none';
                                if (costSection) costSection.style.display = 'block';
                                
                                // Activate cost tab button
                                const costBtn = document.getElementById('calcCostTabBtn');
                                if (costBtn) {
                                    costBtn.classList.add('active');
                                    costBtn.style.color = '#3b82f6';
                                    costBtn.style.borderBottomColor = '#3b82f6';
                                }
                                
                                // Refresh cost calculations
                                if (typeof renderPlans === 'function') {
                                    renderPlans();
                                }
                                if (typeof calcCostFromUI === 'function') {
                                    calcCostFromUI();
                                }
                            }
                        }

                        document.getElementById('calcBtn').addEventListener('click', buildTable);
                        document.querySelectorAll('input, input[type="checkbox"]').forEach(inp=>inp.addEventListener('input', ()=>{ clearTimeout(inp._t); inp._t=setTimeout(buildTable,150); }));
                        document.querySelectorAll('input[type="checkbox"]').forEach(chk=>chk.addEventListener('change', ()=>{ clearTimeout(chk._t); chk._t=setTimeout(buildTable,150); }));

                        document.getElementById('resetBtn').addEventListener('click', ()=>{
                        document.getElementById('basePrice').value = 26900;
                        document.getElementById('costAmount').value = 17585.36;
                        document.getElementById('fixedCosts').value = 0;
                        document.getElementById('minProfitMaxDisc').value = 5000;

                        // Category 1
                        document.getElementById('enableDisc1').checked = true;
                        document.getElementById('disc1').value = 5;
                        document.getElementById('enableCoach1').checked = true;
                        document.getElementById('coachQty1').value = 1;
                        document.getElementById('coachPay1').value = 5000;
                        document.getElementById('enableTransfer1').checked = true;
                        document.getElementById('transferAmount1').value = 0;
                        document.getElementById('enableTax1').checked = true;
                        document.getElementById('taxPct1').value = 6;

                        // Category 2
                        document.getElementById('enableDisc2').checked = true;
                        document.getElementById('disc2').value = 7;
                        document.getElementById('enableCoach2').checked = true;
                        document.getElementById('coachQty2').value = 2;
                        document.getElementById('coachPay2').value = 5000;
                        document.getElementById('enableTransfer2').checked = true;
                        document.getElementById('transferAmount2').value = 0;
                        document.getElementById('enableTax2').checked = true;
                        document.getElementById('taxPct2').value = 6;

                        // Category 3
                        document.getElementById('enableDisc3').checked = true;
                        document.getElementById('disc3').value = 10;
                        document.getElementById('enableCoach3').checked = true;
                        document.getElementById('coachQty3').value = 3;
                        document.getElementById('coachPay3').value = 5000;
                        document.getElementById('enableTransfer3').checked = true;
                        document.getElementById('transferAmount3').value = 0;
                        document.getElementById('enableTax3').checked = true;
                        document.getElementById('taxPct3').value = 6;

                        if(document.getElementById('totalChildren')) document.getElementById('totalChildren').value = 35;
                        buildTable();
                        });

                        document.getElementById('downloadCsv').addEventListener('click', ()=>{
                        const basePrice = Number(document.getElementById('basePrice').value) || 0;
                        const costAmount = Number(document.getElementById('costAmount').value) || 0;
                        const fixedCosts = Number(document.getElementById('fixedCosts').value) || 0;

                        // Category 1
                        const enableDisc1 = document.getElementById('enableDisc1').checked;
                        const disc1 = enableDisc1 ? Number(document.getElementById('disc1').value) || 0 : 0;
                        const enableCoach1 = document.getElementById('enableCoach1').checked;
                        const coachQty1 = enableCoach1 ? Number(document.getElementById('coachQty1').value) || 0 : 0;
                        const coachPay1 = enableCoach1 ? Number(document.getElementById('coachPay1').value) || 0 : 0;
                        const enableTransfer1 = document.getElementById('enableTransfer1').checked;
                        const transfer1 = enableTransfer1 ? Number(document.getElementById('transferAmount1').value) || 0 : 0;
                        const enableTax1 = document.getElementById('enableTax1').checked;
                        const taxPct1 = enableTax1 ? Number(document.getElementById('taxPct1').value) || 0 : 0;

                        // Category 2
                        const enableDisc2 = document.getElementById('enableDisc2').checked;
                        const disc2 = enableDisc2 ? Number(document.getElementById('disc2').value) || 0 : 0;
                        const enableCoach2 = document.getElementById('enableCoach2').checked;
                        const coachQty2 = enableCoach2 ? Number(document.getElementById('coachQty2').value) || 0 : 0;
                        const coachPay2 = enableCoach2 ? Number(document.getElementById('coachPay2').value) || 0 : 0;
                        const enableTransfer2 = document.getElementById('enableTransfer2').checked;
                        const transfer2 = enableTransfer2 ? Number(document.getElementById('transferAmount2').value) || 0 : 0;
                        const enableTax2 = document.getElementById('enableTax2').checked;
                        const taxPct2 = enableTax2 ? Number(document.getElementById('taxPct2').value) || 0 : 0;

                        // Category 3
                        const enableDisc3 = document.getElementById('enableDisc3').checked;
                        const disc3 = enableDisc3 ? Number(document.getElementById('disc3').value) || 0 : 0;
                        const enableCoach3 = document.getElementById('enableCoach3').checked;
                        const coachQty3 = enableCoach3 ? Number(document.getElementById('coachQty3').value) || 0 : 0;
                        const coachPay3 = enableCoach3 ? Number(document.getElementById('coachPay3').value) || 0 : 0;
                        const enableTransfer3 = document.getElementById('enableTransfer3').checked;
                        const transfer3 = enableTransfer3 ? Number(document.getElementById('transferAmount3').value) || 0 : 0;
                        const enableTax3 = document.getElementById('enableTax3').checked;
                        const taxPct3 = enableTax3 ? Number(document.getElementById('taxPct3').value) || 0 : 0;

                        const groupCustomEl = document.getElementById('totalChildren');
                        const groupCustom = groupCustomEl ? (Number(groupCustomEl.value) || 35) : 35;
                        const rows = [
                            {label:'–≤—ñ–¥ 15 –¥–æ 20', group:15, disc:disc1, taxPct:taxPct1, transfer:transfer1, coachQty:coachQty1, coachPay:coachPay1},
                            {label:'–≤—ñ–¥ 21 –¥–æ 30', group:25, disc:disc2, taxPct:taxPct2, transfer:transfer2, coachQty:coachQty2, coachPay:coachPay2},
                            {label:'–≤—ñ–¥ 31 —ñ –±—ñ–ª—å—à–µ', group:35, disc:disc3, taxPct:taxPct3, transfer:transfer3, coachQty:coachQty3, coachPay:coachPay3},
                        ];
                        let csv = '–ö–∞—Ç–µ–≥–æ—Ä—ñ—è,–ó–Ω–∏–∂–∫–∞ (%),–ü–æ–¥–∞—Ç–æ–∫ (%),–¢—Ä–∞–Ω—Å—Ñ–µ—Ä (‚Ç¥),–ö-—Ç—å –≤–æ–∂–∞—Ç–∏—Ö,–û–ø–ª–∞—Ç–∞ –∑–∞ –≤–æ–∂–∞—Ç–æ–≥–æ (‚Ç¥),–ì—Ä—É–ø–∞ (–¥—ñ—Ç–µ–π),–ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Ü—ñ–Ω–∞,–ù–µ—Ç—Ç–æ –ø—ñ—Å–ª—è –ø–æ–¥–∞—Ç–∫—É,–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å,–ü—Ä–∏–±—É—Ç–æ–∫ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É,–ú–∞—Ä–∂–∞ (%),–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫\n';
                        rows.forEach(r=>{
                            const v = computeRow(basePrice, r.disc, r.taxPct, costAmount, r.group, fixedCosts, r.coachQty, r.coachPay, r.transfer);
                            csv += `${r.label},${r.disc},${r.taxPct},${r.transfer},${r.coachQty},${r.coachPay},${r.group},${Math.round(v.effectivePrice)},${Math.round(v.netAfterTax)},${Math.round(v.costAmount)},${Math.round(v.profitPer)},${v.margin.toFixed(1)},${Math.round(v.totalProfit)}\n`;
                        });
                        const customGroupResult = calculateCustomGroup(basePrice, costAmount, fixedCosts, groupCustom, disc1, taxPct1, transfer1, coachQty1, coachPay1, disc2, taxPct2, transfer2, coachQty2, coachPay2, disc3, taxPct3, transfer3, coachQty3, coachPay3);
                        csv += `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ –≥—Ä—É–ø–∞,–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –∑–Ω–∏–∂–∫–∏,-,-,-,-,${groupCustom},${Math.round(customGroupResult.avgEffCustom)},${Math.round(customGroupResult.avgNetCustom)},${Math.round(customGroupResult.costAmount)},${Math.round(customGroupResult.avgProfitCustom)},${customGroupResult.avgMarginCustom.toFixed(1)},${Math.round(customGroupResult.totalProfitCustom)}\n`;

                        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = 'tabor_calc.csv'; a.click(); URL.revokeObjectURL(url);
                        });

                        // ===== Cost tab calculation engine =====
                        const UAFmt = (v)=> (Number(v)||0).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        const deb = (fn,ms=180)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };

                        function makeTeamRow(container){
                        const row=document.createElement('div');
                        row.className='team-row';
                        row.innerHTML=`
                            <input type="text" placeholder="–ü–æ—Å–∞–¥–∞" />
                            <input type="number" placeholder="–ó–ü –∑–∞ –∑–º—ñ–Ω—É (–≥—Ä–Ω)" min="0" step="100" />
                            <input type="number" placeholder="–ö-—Å—Ç—å" min="1" step="1" value="1" />
                            <button type="button" class="tiny-btn danger">‚úï</button>`;
                        const [pos,salary,count,delBtn]=row.children;
                        const recalc=deb(calcCostFromUI,120);
                        ;[pos,salary,count].forEach(inp=>inp.addEventListener('input',recalc));
                        delBtn.addEventListener('click',()=>{row.remove(); calcCostFromUI();});
                        container.appendChild(row);
                        }

                        // New hierarchical structure: Period ‚Üí Location ‚Üí Shifts
                        function makeLocationCard(periodCard, locationNum = 1){
                        const locationCard = document.createElement('div');
                        locationCard.className = 'location-card';
                        locationCard.style.cssText = 'background:#f0f9ff;padding:16px;border-radius:10px;margin-bottom:12px;border-left:4px solid #3b82f6';
                        
                        locationCard.innerHTML = `
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <input type="text" class="location-name" placeholder="–ù–∞–∑–≤–∞ –ª–æ–∫–∞—Ü—ñ—ó (–ö–∞—Ä–ø–∞—Ç–∏, –ó–∞–∫–∞—Ä–ø–∞—Ç—Ç—è...)" 
                                    style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-weight:600;margin-right:12px" />
                            <button type="button" class="tiny-btn danger" onclick="this.closest('.location-card').remove();calcCostFromUI()">–í–∏–¥–∞–ª–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é</button>
                            </div>
                            <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:12px">
                            <div>
                                <label>–ö-—Å—Ç—å –∑–º—ñ–Ω</label>
                                <input type="number" class="shifts-count" value="2" min="1" step="1" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                            </div>
                            <div>
                                <label>–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –¥—ñ—Ç–µ–π (–Ω–∞ –∑–º—ñ–Ω—É)</label>
                                <input type="number" class="avg-children" value="20" min="0" step="1" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                            </div>
                            <div>
                                <label>–î–Ω—ñ–≤ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</label>
                                <input type="number" class="living-days" value="14" min="1" step="1" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                            </div>
                            <div>
                                <label>üí∞ –¶—ñ–Ω–∞ –ø—É—Ç—ñ–≤–∫–∏ (–≥—Ä–Ω)</label>
                                <input type="number" class="location-price" value="26900" min="0" step="100" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;background:#fef3c7;border-color:#f59e0b" />
                            </div>
                            </div>
                            <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
                            <div>
                                <label>–•–∞—Ä—á—É–≤–∞–Ω–Ω—è 1 –¥–µ–Ω—å (–≥—Ä–Ω)</label>
                                <input type="number" class="food-price" value="400" min="0" step="10" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                            </div>
                            <div>
                                <label>–ü—Ä–æ–≥—Ä–∞–º–∞ (–≥—Ä–Ω/–¥–∏—Ç–∏–Ω–∞)</label>
                                <input type="number" class="program-cost" value="500" min="0" step="10" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                            </div>
                            <div>
                                <label>–î–æ–¥. –≤–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä–Ω/–¥–∏—Ç–∏–Ω–∞)</label>
                                <input type="number" class="extra-cost" value="200" min="0" step="10" 
                                    style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" />
                            </div>
                            </div>
                            <div style="margin-bottom:12px">
                            <label style="font-weight:600;display:block;margin-bottom:8px">üë• –°–∫–ª–∞–¥ –∫–æ–º–∞–Ω–¥–∏ (–∑–∞ –∑–º—ñ–Ω—É)</label>
                            <div class="team-list"></div>
                            <button type="button" class="tiny-btn" data-add-team>+ –î–æ–¥–∞—Ç–∏ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞</button>
                            </div>
                            <div class="shift-metrics" style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:12px">
                            <div style="font-weight:600;color:#0f172a;margin-bottom:8px">üìä –î–µ—Ç–∞–ª—ñ –Ω–∞ 1 –¥–∏—Ç–∏–Ω—É (–∑–º—ñ–Ω–∞)</div>
                            <div style="font-size:13px;color:var(--muted)">–ó–ü –∫–æ–º–∞–Ω–¥–∏: <span class="sm-salary">0 –≥—Ä–Ω</span></div>
                            <div style="font-size:13px;color:var(--muted)">–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏: <span class="sm-living">0 –≥—Ä–Ω</span></div>
                            <div style="font-size:13px;color:var(--muted)">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è: <span class="sm-food">0 –≥—Ä–Ω</span></div>
                            <div style="font-size:13px;color:var(--muted)">–ü—Ä–æ–≥—Ä–∞–º–∞ + –î–æ–¥.: <span class="sm-other">0 –≥—Ä–Ω</span></div>
                            <div style="font-size:13px;color:var(--muted)">–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –±–µ–∑ –æ–ø–µ—Ä.: <span class="sm-cost-noop">0 –≥—Ä–Ω</span></div>
                            <div style="font-size:13px;color:var(--muted)">–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –∑ –æ–ø–µ—Ä.: <span class="sm-cost-op">0 –≥—Ä–Ω</span></div>
                            </div>
                        `;
                        
                        const teamList = locationCard.querySelector('.team-list');
                        locationCard.querySelector('[data-add-team]').addEventListener('click', () => makeTeamRow(teamList));
                        
                        // Default team
                        const defaultTeam = [
                            {pos:'–î–∏—Ä–µ–∫—Ç–æ—Ä', qty:1, salary:25000},
                            {pos:'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä', qty:1, salary:17000},
                            {pos:'–°–∞–ø–æ—Ä—Ç', qty:2, salary:10000},
                            {pos:'–¢—ñ–º–ª—ñ–¥', qty:10, salary:5000},
                            {pos:'–°—Ç–∞—Ä—à–∏–π —Ç—ñ–º–ª—ñ–¥', qty:3, salary:7000},
                            {pos:'–§–æ—Ç–æ–≥—Ä–∞—Ñ', qty:1, salary:10000},
                            {pos:'–ú–µ–¥–∏–∫', qty:1, salary:10000}
                        ];
                        defaultTeam.forEach(t=>{
                            const row=document.createElement('div');
                            row.className='team-row';
                            row.innerHTML=`
                            <input type="text" placeholder="–ü–æ—Å–∞–¥–∞" value="${t.pos}" />
                            <input type="number" placeholder="–ó–ü –∑–∞ –∑–º—ñ–Ω—É (–≥—Ä–Ω)" min="0" step="100" value="${t.salary}" />
                            <input type="number" placeholder="–ö-—Å—Ç—å" min="1" step="1" value="${t.qty}" />
                            <button type="button" class="tiny-btn danger">‚úï</button>`;
                            const [pos,salary,count,delBtn]=row.children;
                            const recalc=deb(calcCostFromUI,120);
                            ;[pos,salary,count].forEach(inp=>inp.addEventListener('input',recalc));
                            delBtn.addEventListener('click',()=>{row.remove(); calcCostFromUI();});
                            teamList.appendChild(row);
                        });
                        
                        locationCard.querySelectorAll('input').forEach(inp => inp.addEventListener('input', deb(calcCostFromUI,120)));
                        
                        periodCard.querySelector('.locations-container').appendChild(locationCard);
                        return locationCard;
                        }

                        function makePeriodCard(){
                        const periodCard = document.createElement('div');
                        periodCard.className = 'period-card';
                        periodCard.style.cssText = 'background:#fef3c7;padding:20px;border-radius:12px;margin-bottom:16px;border:2px solid #f59e0b';
                        
                        periodCard.innerHTML = `
                            <div class="shift-planning-header" style="margin-bottom:16px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <div style="flex:1;margin-right:12px">
                                <label style="font-weight:700;display:block;margin-bottom:6px">üìÖ –ù–∞–∑–≤–∞ –ø–µ—Ä—ñ–æ–¥—É</label>
                                <input type="text" class="period-name" placeholder="–ó–∏–º–∞ 2026, –õ—ñ—Ç–æ 2026..." 
                                        style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px;font-weight:600" />
                                </div>
                                <button type="button" class="tiny-btn danger" onclick="this.closest('.period-card').remove();calcCostFromUI()" 
                                        style="align-self:flex-end">–í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ä—ñ–æ–¥</button>
                            </div>
                            </div>
                            <div class="locations-container"></div>
                            <button type="button" class="btn" data-add-location style="width:100%;margin-top:8px;background:#10b981;color:white">‚ûï –î–æ–¥–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é</button>
                        `;
                        
                        periodCard.querySelector('[data-add-location]').addEventListener('click', () => {
                            makeLocationCard(periodCard);
                            calcCostFromUI();
                        });
                        
                        periodCard.querySelector('.period-name').addEventListener('input', deb(calcCostFromUI,120));
                        
                        // Add first location by default
                        makeLocationCard(periodCard, 1);
                        
                        return periodCard;
                        }

                function collectCostData(){
                const periods = [...document.querySelectorAll('#periodsContainer .period-card')].map(periodCard => {
                    const periodName = (periodCard.querySelector('.period-name')?.value || '').trim();
                    const locations = [...periodCard.querySelectorAll('.location-card')].map(locCard => {
                    const num = (sel) => Number(locCard.querySelector(sel)?.value) || 0;
                    const txt = (sel) => (locCard.querySelector(sel)?.value || '').trim();
                    
                    const locationName = txt('.location-name');
                    const shiftsCount = num('.shifts-count');
                    const avgChildren = num('.avg-children');
                    const days = num('.living-days');
                    const food = num('.food-price');
                    const program = num('.program-cost');
                    const extra = num('.extra-cost');
                    const price = num('.location-price');
                    
                    const team = [...locCard.querySelectorAll('.team-row')].map(r => ({
                        pos: r.children[0].value.trim(),
                        salary: Number(r.children[1].value) || 0,
                        qty: Number(r.children[2].value) || 0
                    })).filter(t => t.salary > 0 && t.qty > 0);
                    
                    return {locationName, shiftsCount, avgChildren, days, food, program, extra, price, team};
                    });
                    
                    return {periodName, locations};
                });
                
                // Read from plan-specific fields if they exist, otherwise fallback to old fields
                const op = {
                    adv: Number(document.getElementById('planOpAdvertising')?.value || document.getElementById('opAdvertising')?.value) || 0,
                    man: Number(document.getElementById('planOpManagers')?.value || document.getElementById('opManagers')?.value) || 0,
                    launch: Number(document.getElementById('planOpLaunch')?.value || document.getElementById('opLaunch')?.value) || 0
                };
                
                return {periods, op};
                }

                function calculatePlanMetrics(periods = [], op = {}, options = {}) {
                const opAdv = Number(op?.adv) || 0;
                const opMan = Number(op?.man) || 0;
                const opLaunch = Number(op?.launch) || 0;
                const opTotal = opAdv + opMan + opLaunch;
                const basePriceInput = parseFloat(options.basePrice);
                const basePrice = isNaN(basePriceInput) ? 26900 : basePriceInput;
                const locationCards = options.locationCards || null;
                
                let totalChildren = 0;
                let totalPriceWeighted = 0;
                let totalWeightedChildren = 0;
                const periodBreakdownMap = new Map();
                
                periods.forEach(period => {
                    (period.locations || []).forEach(loc => {
                    const shiftsCount = Number(loc.shiftsCount) || 0;
                    const avgChildren = Number(loc.avgChildren) || 0;
                    const price = Number(loc.price) || 0;
                    const totalChildrenForLoc = shiftsCount * avgChildren;
                    
                    totalChildren += totalChildrenForLoc;
                    totalWeightedChildren += totalChildrenForLoc;
                    totalPriceWeighted += price * totalChildrenForLoc;
                    });
                });
                
                const opPerChild = totalChildren > 0 ? opTotal / totalChildren : 0;
                
                let aggCostNoOpSum = 0;
                let aggSalarySeason = 0;
                let aggLivingTeamSeason = 0;
                let aggFoodChildSeason = 0;
                let aggProgramExtraSeason = 0;
                let locationIndex = 0;
                
                periods.forEach(period => {
                    (period.locations || []).forEach(loc => {
                    const shiftsCount = Number(loc.shiftsCount) || 0;
                    const avgChildren = Number(loc.avgChildren) || 0;
                    const days = Number(loc.days) || 0;
                    const food = Number(loc.food) || 0;
                    const program = Number(loc.program) || 0;
                    const extra = Number(loc.extra) || 0;
                    const team = Array.isArray(loc.team) ? loc.team : [];
                    const totalChildrenForLoc = shiftsCount * avgChildren;
                    
                    const teamSalaryPerShift = team.reduce((sum, t) => sum + (Number(t.salary) || 0) * (Number(t.qty) || 0), 0);
                    const teamCount = team.reduce((sum, t) => sum + (Number(t.qty) || 0), 0);
                    const teamLivingPerShift = food * days * teamCount;
                    const childFoodPerChild = food * days;
                    const salaryPerChild = avgChildren > 0 ? teamSalaryPerShift / avgChildren : 0;
                    const teamLivingPerChild = avgChildren > 0 ? teamLivingPerShift / avgChildren : 0;
                    const otherPerChild = program + extra;
                    const costNoOpPerChild = salaryPerChild + teamLivingPerChild + childFoodPerChild + otherPerChild;
                    const costOpPerChild = costNoOpPerChild + opPerChild;
                    const salaryTotal = teamSalaryPerShift * shiftsCount;
                    const livingTotal = teamLivingPerShift * shiftsCount;
                    const foodTotal = childFoodPerChild * totalChildrenForLoc;
                    const programTotal = (program + extra) * totalChildrenForLoc;
                    const directTotalLoc = salaryTotal + livingTotal + foodTotal + programTotal;
                    const opShare = opPerChild * totalChildrenForLoc;
                    
                    aggCostNoOpSum += costNoOpPerChild * totalChildrenForLoc;
                    aggSalarySeason += salaryTotal;
                    aggLivingTeamSeason += livingTotal;
                    aggFoodChildSeason += foodTotal;
                    aggProgramExtraSeason += programTotal;
                    
                    if (locationCards && locationCards[locationIndex]) {
                        const card = locationCards[locationIndex];
                        const setTextContent = (selector, value) => {
                        const el = card.querySelector(selector);
                        if (el) el.textContent = UAFmt(value);
                        };
                        setTextContent('.sm-salary', salaryPerChild.toFixed(2));
                        setTextContent('.sm-living', teamLivingPerChild.toFixed(2));
                        setTextContent('.sm-food', childFoodPerChild.toFixed(2));
                        setTextContent('.sm-other', otherPerChild.toFixed(2));
                        setTextContent('.sm-cost-noop', costNoOpPerChild.toFixed(2));
                        setTextContent('.sm-cost-op', costOpPerChild.toFixed(2));
                    }
                    
                    locationIndex++;

                    const periodName = period.periodName || period.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
                    const locationName = loc.locationName || loc.name || `–õ–æ–∫–∞—Ü—ñ—è ${locationIndex}`;
                    const periodEntry = (() => {
                        if (!periodBreakdownMap.has(periodName)) {
                            periodBreakdownMap.set(periodName, {
                                period: periodName,
                                totals: {
                                salary: 0,
                                living: 0,
                                food: 0,
                                program: 0,
                                operational: 0,
                                total: 0
                                },
                                childrenPlanned: 0,
                                locations: []
                            });
                        }
                        return periodBreakdownMap.get(periodName);
                    })();
                    
                    const locationTotals = {
                        location: locationName,
                        salary: salaryTotal,
                        living: livingTotal,
                        food: foodTotal,
                        program: programTotal,
                        operational: opShare,
                        total: directTotalLoc + opShare,
                        children: totalChildrenForLoc
                    };
                    
                    periodEntry.childrenPlanned += totalChildrenForLoc;
                    periodEntry.totals.salary += salaryTotal;
                    periodEntry.totals.living += livingTotal;
                    periodEntry.totals.food += foodTotal;
                    periodEntry.totals.program += programTotal;
                    periodEntry.totals.operational += opShare;
                    periodEntry.totals.total += locationTotals.total;
                    periodEntry.locations.push(locationTotals);
                    });
                });
                
                const directTotal = aggSalarySeason + aggLivingTeamSeason + aggFoodChildSeason + aggProgramExtraSeason;
                const seasonTotalCost = directTotal + opTotal;
                const totalRevenue = totalChildren * basePrice;
                const profit = totalRevenue - seasonTotalCost;
                const margin = totalRevenue > 0 ? (profit / totalRevenue) * 100 : 0;
                const avgCostNoOp = totalChildren > 0 ? aggCostNoOpSum / totalChildren : 0;
                const avgCostWithOp = avgCostNoOp + opPerChild;
                const avgRevenuePerChild = totalChildren > 0 ? totalRevenue / totalChildren : 0;
                const avgPrice = totalWeightedChildren > 0 ? totalPriceWeighted / totalWeightedChildren : 0;
                const costBreakdown = {
                    categories: {
                    salary: aggSalarySeason,
                    living: aggLivingTeamSeason,
                    food: aggFoodChildSeason,
                    program: aggProgramExtraSeason,
                    operational: opTotal,
                    total: seasonTotalCost
                    },
                    periods: Array.from(periodBreakdownMap.values())
                };
                
                return {
                    totalChildren,
                    totalCapacity: totalChildren,
                    totalRevenue,
                    avgRevenuePerChild,
                    avgPrice,
                    opPerChild,
                    avgCostNoOp,
                    avgCostWithOp,
                    teamSalarySeason: aggSalarySeason,
                    teamLivingSeason: aggLivingTeamSeason,
                    childrenFoodSeason: aggFoodChildSeason,
                    programExtraSeason: aggProgramExtraSeason,
                    directTotal,
                    operationalTotal: opTotal,
                    seasonTotalCost,
                    netProfit: profit,
                    profitMargin: margin,
                    costNoOpPool: aggCostNoOpSum,
                    costBreakdown
                };
                }

                function classifyExpenseCategory(category = '') {
                const normalized = (category || '').toLowerCase();
                const mainCategory = (category || '').split('.')[0]?.trim().toLowerCase();
                
                if (mainCategory === '–æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ' || mainCategory === '–Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ') {
                    return 'operational';
                }
                
                if (normalized.includes('—Ö–∞—Ä—á')) return 'food';
                if (normalized.includes('–ø—Ä–æ–∂') || normalized.includes('–∂–∏—Ç–ª')) return 'living';
                if (normalized.includes('–∑–∞—Ä–ø') || normalized.includes('–ø–µ—Ä—Å–æ–Ω–∞–ª')) return 'salary';
                if (normalized.includes('–æ–ø–µ—Ä–∞—Ü')) return 'operational';
                if (normalized.includes('–∫–æ–º—É–Ω') || normalized.includes('–æ—Ä–µ–Ω–¥–∞') || normalized.includes('—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç')) return 'operational';
                
                return 'program';
                }

                function calculateFactCostBreakdown(operations = []) {
                const categories = { salary: 0, living: 0, food: 0, program: 0, operational: 0, total: 0 };
                const periodsMap = new Map();
                
                operations.forEach(op => {
                    const amountNumber = parseFloat(op.amount) || 0;
                    if (!(amountNumber < 0)) return;
                    
                    const amount = Math.abs(amountNumber);
                    const bucket = classifyExpenseCategory(op.category || '');
                    categories[bucket] += amount;
                    categories.total += amount;
                    
                    const periodName = op.period || '–ë–µ–∑ –ø–µ—Ä—ñ–æ–¥—É';
                    if (!periodsMap.has(periodName)) {
                    periodsMap.set(periodName, {
                        period: periodName,
                        totals: { salary: 0, living: 0, food: 0, program: 0, operational: 0, total: 0 },
                        locations: []
                    });
                    }
                    const periodEntry = periodsMap.get(periodName);
                    periodEntry.totals[bucket] += amount;
                    periodEntry.totals.total += amount;
                    
                    const locationName = op.location || '‚Äî';
                    let locationEntry = periodEntry.locations.find(loc => loc.location === locationName);
                    if (!locationEntry) {
                    locationEntry = { location: locationName, salary: 0, living: 0, food: 0, program: 0, operational: 0, total: 0, children: 0 };
                    periodEntry.locations.push(locationEntry);
                    }
                    locationEntry[bucket] += amount;
                    locationEntry.total += amount;
                });
                
                return {
                    categories,
                    periods: Array.from(periodsMap.values())
                };
                }

                function calcCostFromUI(){
                const {periods, op} = collectCostData();
                const locationCards = document.querySelectorAll('#periodsContainer .location-card');
                const basePrice = parseFloat(document.getElementById('basePrice')?.value || 26900);
                const metrics = calculatePlanMetrics(periods, op, { locationCards, basePrice });
                
                window.latestPlanMetrics = metrics;

                // update UI (top five)
                const setIf = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                setIf('sumTotalChildren', metrics.totalChildren.toLocaleString('uk-UA'));
                setIf('sumOpPerChild', UAFmt(metrics.avgCostWithOp > 0 ? metrics.opPerChild.toFixed(2) : 0));
                setIf('sumCostNoOp', UAFmt(metrics.avgCostNoOp.toFixed(2)));
                setIf('sumCostWithOp', UAFmt(metrics.avgCostWithOp.toFixed(2)));
                setIf('sumAvgPrice', UAFmt(metrics.avgPrice.toFixed(2)));

                // metrics list
                const setText = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
                setText('sumRevenueSeason', UAFmt(Math.round(metrics.totalRevenue)));
                setText('sumDirectSalary', UAFmt(Math.round(metrics.teamSalarySeason)));
                setText('sumDirectLivingTeam', UAFmt(Math.round(metrics.teamLivingSeason)));
                setText('sumDirectFoodChild', UAFmt(Math.round(metrics.childrenFoodSeason)));
                setText('sumDirectProgramExtra', UAFmt(Math.round(metrics.programExtraSeason)));
                setText('sumDirectTotal', UAFmt(Math.round(metrics.directTotal)));
                setText('sumOpSeason', UAFmt(Math.round(metrics.operationalTotal)));
                setText('sumTotalCostSeason', UAFmt(Math.round(metrics.seasonTotalCost)));
                setText('sumProfitSeason', UAFmt(Math.round(metrics.netProfit)));
                setText('sumProfitMargin', `${metrics.profitMargin.toFixed(2)}%`);
                setText('sumAvgRevenuePerChild', UAFmt(metrics.avgRevenuePerChild.toFixed(2)));

                        // sync to sales
                        const sync = document.getElementById('syncCostToSales');
                if (sync && sync.checked) {
                            const costInput = document.getElementById('costAmount');
                            const basePriceInput = document.getElementById('basePrice');
                            
                            if (costInput) { 
                        costInput.value = Math.round(metrics.avgCostWithOp);
                            }
                            
                            // Update base price with calculated average
                    if (basePriceInput && metrics.avgPrice > 0) {
                        basePriceInput.value = Math.round(metrics.avgPrice);
                            }
                            
                            // Only call buildTable if it exists and all required elements are ready
                            if (typeof buildTable === 'function') {
                                try {
                                buildTable();
                                } catch (e) {
                                console.log('buildTable not ready yet:', e);
                                }
                            }
                        }
                        }

                        // Sync Cost planning to CRM structure
                        function syncCostPlanningToCRM() {
                        // Check if crmData exists
                        if (typeof crmData === 'undefined') {
                            console.log('CRM not initialized yet, skipping sync');
                            return;
                        }
                        
                        const {periods} = collectCostData();
                        
                        // Extract unique period names
                        const periodNames = periods.map(p => p.periodName).filter(p => p);
                        
                        // Extract locations per period and shifts per location
                        const locationsByPeriod = {};
                        const shiftsByKey = {};
                        
                        periods.forEach(period => {
                            if (!period.periodName) return;
                            
                            period.locations.forEach(loc => {
                            if (!loc.locationName) return;
                            
                            // Add location to period
                            if (!locationsByPeriod[period.periodName]) {
                                locationsByPeriod[period.periodName] = [];
                            }
                            if (!locationsByPeriod[period.periodName].includes(loc.locationName)) {
                                locationsByPeriod[period.periodName].push(loc.locationName);
                            }
                            
                            // Generate shifts for this location
                            const key = `${period.periodName}|${loc.locationName}`;
                            if (!shiftsByKey[key]) shiftsByKey[key] = [];
                            
                            // Auto-generate shift names: "1 –∑–º—ñ–Ω–∞", "2 –∑–º—ñ–Ω–∞", etc.
                            for (let i = 1; i <= loc.shiftsCount; i++) {
                                const shiftName = `${i} –∑–º—ñ–Ω–∞`;
                                if (!shiftsByKey[key].find(s => (typeof s === 'string' ? s : s.name) === shiftName)) {
                                shiftsByKey[key].push({
                                    name: shiftName,
                                    plannedChildren: loc.avgChildren || 0
                                });
                                }
                            }
                            });
                        });
                        
                        // Update crmData structure
                        crmData.periods = periodNames;
                        crmData.locations = locationsByPeriod;
                        
                        // Update shifts, preserving existing shift data if shift names match
                        const oldShifts = {...crmData.shifts};
                        crmData.shifts = {};
                        Object.keys(shiftsByKey).forEach(key => {
                            const newShifts = shiftsByKey[key];
                            const oldShiftsForKey = oldShifts[key] || [];
                            
                            // Merge: keep planned children from Cost, preserve other shift details from CRM
                            crmData.shifts[key] = newShifts.map(ns => {
                            const existing = oldShiftsForKey.find(os => 
                                (typeof os === 'string' ? os : os.name) === ns.name
                            );
                            if (existing && typeof existing === 'object') {
                                return {...existing, plannedChildren: ns.plannedChildren};
                            }
                            return ns; // Return object with name and plannedChildren
                            });
                        });
                        
                        // Save to localStorage
                        if (typeof saveCRMData === 'function') {
                            saveCRMData();
                        } else {
                            console.log('saveCRMData not available yet');
                        }
                        
                        // Update CRM dropdowns
                        if (typeof updatePeriodSelect === 'function') {
                            updatePeriodSelect();
                            console.log('üìã –û–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–ª–µ–∫—Ç –ø–µ—Ä—ñ–æ–¥—ñ–≤');
                        }
                        if (typeof updateLocationSelect === 'function') {
                            updateLocationSelect();
                            console.log('üìã –û–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–ª–µ–∫—Ç –ª–æ–∫–∞—Ü—ñ–π');
                        }
                        if (typeof updateShiftSelect === 'function') {
                            updateShiftSelect();
                            console.log('üìã –û–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–ª–µ–∫—Ç –∑–º—ñ–Ω');
                        }
                        
                        console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –∑ CRM:', {periods: periodNames, locations: locationsByPeriod, shifts: shiftsByKey});
                        console.log('üìä CRM Data –ø—ñ—Å–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó:', crmData);
                        }

                        // Save planning data to localStorage
                        function savePlanningData() {
                        const {periods, op} = collectCostData();
                        const planningData = {
                            periods,
                            operationalCosts: op,
                            lastSaved: new Date().toISOString()
                        };
                        localStorage.setItem('campPlanning', JSON.stringify(planningData));
                        console.log('üíæ –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ localStorage:', planningData);
                        console.log('üì¶ Periods count:', periods.length);
                        periods.forEach((p, i) => {
                            console.log(`   –ü–µ—Ä—ñ–æ–¥ ${i+1}: "${p.periodName}", –ª–æ–∫–∞—Ü—ñ–π: ${p.locations.length}`);
                        });
                        }

                        // Load planning data from localStorage
                        function loadPlanningData() {
                        const saved = localStorage.getItem('campPlanning');
                        if (!saved) return null;
                        
                        try {
                            return JSON.parse(saved);
                        } catch (e) {
                            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è:', e);
                            return null;
                        }
                        }

                        // Restore planning from saved data
                        function restorePlanningUI(planningData) {
                        if (!planningData || !planningData.periods) {
                            console.log('‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è');
                            return;
                        }
                        
                        console.log('üîÑ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è...', planningData);
                        
                        const cont = document.getElementById('periodsContainer');
                        if (!cont) return;
                        
                        // Clear existing
                        cont.innerHTML = '';
                        
                        // Restore operational costs
                        if (planningData.operationalCosts) {
                            const op = planningData.operationalCosts;
                            if (document.getElementById('opAdvertising')) document.getElementById('opAdvertising').value = op.adv || 0;
                            if (document.getElementById('opManagers')) document.getElementById('opManagers').value = op.man || 0;
                            if (document.getElementById('opLaunch')) document.getElementById('opLaunch').value = op.launch || 0;
                        }
                        
                        // Restore periods and locations
                        planningData.periods.forEach(periodData => {
                            const periodCard = makePeriodCard();
                            cont.appendChild(periodCard);
                            
                            // Set period name
                            const periodInput = periodCard.querySelector('.period-name');
                            if (periodInput) periodInput.value = periodData.periodName || '';
                            
                            // Clear default location and add saved locations
                            const locationsContainer = periodCard.querySelector('.locations-container');
                            if (locationsContainer) {
                            locationsContainer.innerHTML = '';
                            
                            periodData.locations.forEach(locData => {
                                const locCard = makeLocationCard(periodCard);
                                
                                // Set location data
                                locCard.querySelector('.location-name').value = locData.locationName || '';
                                locCard.querySelector('.shifts-count').value = locData.shiftsCount || 1;
                                locCard.querySelector('.avg-children').value = locData.avgChildren || 20;
                                locCard.querySelector('.living-days').value = locData.days || 14;
                                locCard.querySelector('.food-price').value = locData.food || 400;
                                locCard.querySelector('.program-cost').value = locData.program || 500;
                                locCard.querySelector('.extra-cost').value = locData.extra || 200;
                                
                                // Restore team (clear default team first)
                                const teamList = locCard.querySelector('.team-list');
                                if (teamList && locData.team) {
                                teamList.innerHTML = '';
                                locData.team.forEach(t => {
                                    const row = document.createElement('div');
                                    row.className = 'team-row';
                                    row.innerHTML = `
                                    <input type="text" placeholder="–ü–æ—Å–∞–¥–∞" value="${t.pos}" />
                                    <input type="number" placeholder="–ó–ü –∑–∞ –∑–º—ñ–Ω—É (–≥—Ä–Ω)" min="0" step="100" value="${t.salary}" />
                                    <input type="number" placeholder="–ö-—Å—Ç—å" min="1" step="1" value="${t.qty}" />
                                    <button type="button" class="tiny-btn danger">‚úï</button>`;
                                    const [pos, salary, count, delBtn] = row.children;
                                    const recalc = deb(calcCostFromUI, 120);
                                    [pos, salary, count].forEach(inp => inp.addEventListener('input', recalc));
                                    delBtn.addEventListener('click', () => { row.remove(); calcCostFromUI(); });
                                    teamList.appendChild(row);
                                });
                                }
                            });
                            }
                        });
                        
                        console.log('üì• –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∑ localStorage');
                        }

                        // ===== Plans Management System =====
                        let allPlans = []; // Array of {id, name, operationalCosts: {adv, man, launch}, periods: [...]}
                        let activePlanId = null;

                        // Active Plan Management Functions (Deprecated)
                        function getActivePlan() {
                            if (!activePlanId) {
                                console.log('‚ùå –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ plan ID');
                                return null;
                            }
                            
                            const plan = allPlans.find(p => p.id === activePlanId);
                            if (!plan) {
                                console.log('‚ùå –ê–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ allPlans:', activePlanId);
                                console.log('–î–æ—Å—Ç—É–ø–Ω—ñ –ø–ª–∞–Ω–∏:', allPlans.map(p => ({id: p.id, name: p.name})));
                                return null;
                            }
                            
                            console.log('‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω:', plan.name, '–∑', plan.periods?.length || 0, '–ø–µ—Ä—ñ–æ–¥–∞–º–∏');
                            return plan;
                        }

                        function updateActivePlanSelector() {
                            const selector = document.getElementById('activePlanSelector');
                            if (!selector) return;
                            
                            selector.innerHTML = '';
                            
                            if (allPlans.length === 0) {
                                selector.innerHTML = '<option value="">–ù–µ–º–∞—î –ø–ª–∞–Ω—ñ–≤</option>';
                                activePlanId = null;
                                return;
                            }
                            
                            allPlans.forEach(plan => {
                                const option = document.createElement('option');
                                option.value = plan.id;
                                option.textContent = `${plan.name} (${plan.periods?.length || 0} –ø–µ—Ä—ñ–æ–¥—ñ–≤)`;
                                selector.appendChild(option);
                            });
                            
                            // Set active plan (if none selected, use first)
                            if (!activePlanId || !allPlans.find(p => p.id === activePlanId)) {
                                activePlanId = allPlans[0].id;
                            }
                            selector.value = activePlanId;
                            
                            // Update related data
                            // syncActivePlanToCRM deprecated
                        }

                        function onActivePlanChange() {
                            const selector = document.getElementById('activePlanSelector');
                            if (!selector) return;
                            
                            activePlanId = selector.value;
                            localStorage.setItem('activePlanId', activePlanId);
                            
                            console.log('üîÑ –ó–º—ñ–Ω–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –Ω–∞:', getActivePlan()?.name);
                            
                            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–ª–∞–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                            if (activePlanId) {
                                loadPlanIntoEditor(activePlanId);
                            }
                            
                            // Update all dependent systems
                            // syncActivePlanToCRM deprecated
                            
                            // Update CRM active seasons analytics
                            updateActiveSeasonsStats();
                            
                            // Refresh current tab if needed
                            const activeTab = document.querySelector('.tab-btn.active')?.dataset?.tab;
                            if (activeTab === 'analyticsTab') {
                                updateAnalytics();
                            }
                        }

                        function refreshPlans() {
                            loadAllPlans();
                            updateActivePlanSelector();
                        }

                        function loadAllPlans() {
                        const saved = localStorage.getItem('campPlans');
                        if (!saved) return [];
                        try {
                            return JSON.parse(saved);
                        } catch (e) {
                            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–ª–∞–Ω—ñ–≤:', e);
                            return [];
                        }
                        }

                        function saveAllPlans() {
                        localStorage.setItem('campPlans', JSON.stringify(allPlans));
                        console.log('üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤—Å—ñ –ø–ª–∞–Ω–∏:', allPlans);
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –≤—Å—ñ –ø–ª–∞–Ω–∏ –∑ CRM –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                        allPlans.forEach(plan => {
                            if (typeof syncPlanToCRM === 'function') {
                                syncPlanToCRM(plan);
                            }
                        });
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –ø–µ—Ä—ñ–æ–¥—ñ–≤
                        if (typeof updatePeriodSelectors === 'function') {
                            updatePeriodSelectors();
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–ª–∞–Ω—ñ–≤ –≤ –ü–ª–∞–Ω vs –§–∞–∫—Ç
                        if (typeof initPlanVsFactPlanSelector === 'function') {
                            initPlanVsFactPlanSelector();
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –ø—ñ—Å–ª—è –∑–º—ñ–Ω –≤ –ø–ª–∞–Ω–∞—Ö
                        if (typeof updateAnalytics === 'function') {
                            setTimeout(updateAnalytics, 200);
                        }
                        }

                        function renderPlansList() {
                        const container = document.getElementById('plansListContainer');
                        if (!container) return;

                        if (allPlans.length === 0) {
                            container.innerHTML = '<div style="padding:20px;text-align:center;color:#94a3b8;background:#f8fafc;border-radius:8px;border:2px dashed #e2e8f0">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ –ø–ª–∞–Ω" —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à–∏–π.</div>';
                            return;
                        }

                        container.innerHTML = allPlans.map(plan => {
                            const periodsCount = plan.periods?.length || 0;
                            const locationsCount = plan.periods?.reduce((sum, p) => sum + (p.locations?.length || 0), 0) || 0;
                            const isActive = plan.id === activePlanId;
                            
                            return `
                            <div class="plan-card ${isActive ? 'active' : ''}" data-plan-id="${plan.id}" style="padding:12px;margin-bottom:8px;background:${isActive ? '#dbeafe' : '#fff'};border:2px solid ${isActive ? '#3b82f6' : '#e5e7eb'};border-radius:10px;cursor:pointer;transition:all 0.2s">
                                <div style="display:flex;justify-content:space-between;align-items:start">
                                <div style="flex:1">
                                    <div style="font-weight:700;font-size:15px;color:#0f172a;margin-bottom:4px">${plan.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                                    <div style="font-size:12px;color:#64748b">
                                    üìÖ –ü–µ—Ä—ñ–æ–¥—ñ–≤: ${periodsCount} ‚Ä¢ üìç –õ–æ–∫–∞—Ü—ñ–π: ${locationsCount}
                                    </div>
                                </div>
                                <div style="display:flex;gap:6px">
                                    <button class="tiny-btn" onclick="event.stopPropagation(); editPlan('${plan.id}')" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>
                                    <button class="tiny-btn danger" onclick="event.stopPropagation(); deletePlan('${plan.id}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                                </div>
                                </div>
                            </div>
                            `;
                        }).join('');

                        // Add click handlers
                        container.querySelectorAll('.plan-card').forEach(card => {
                            card.addEventListener('click', () => {
                            const planId = card.getAttribute('data-plan-id');
                            editPlan(planId);
                            });
                        });
                        }

                        function createNewPlan() {
                        const newPlan = {
                            id: Date.now().toString(),
                            name: '',
                            operationalCosts: { adv: 0, man: 0, launch: 0 },
                            periods: []
                        };
                        allPlans.push(newPlan);
                        saveAllPlans();
                        editPlan(newPlan.id);
                        renderPlansList();
                        }

                        function loadPlanIntoEditor(planId) {
                        const plan = allPlans.find(p => p.id === planId);
                        if (!plan) {
                            console.error('‚ùå –ü–ª–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ:', planId);
                            return;
                        }

                        console.log('üìù –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–ª–∞–Ω—É –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä:', plan.name);
                        activePlanId = planId;
                        renderPlansList();

                        // Show editor
                        const editor = document.getElementById('activePlanEditor');
                        if (editor) editor.style.display = 'block';

                        // Fill form
                        document.getElementById('planName').value = plan.name || '';
                        document.getElementById('planOpAdvertising').value = plan.operationalCosts?.adv || 0;
                        document.getElementById('planOpManagers').value = plan.operationalCosts?.man || 0;
                        document.getElementById('planOpLaunch').value = plan.operationalCosts?.launch || 0;

                        // Clear and restore periods
                        const periodsContainer = document.getElementById('periodsContainer');
                        if (periodsContainer) {
                            periodsContainer.innerHTML = '';
                            
                            if (plan.periods && plan.periods.length > 0) {
                            plan.periods.forEach(periodData => {
                                const periodCard = makePeriodCard();
                                periodsContainer.appendChild(periodCard);
                                
                                const periodInput = periodCard.querySelector('.period-name');
                                if (periodInput) periodInput.value = periodData.periodName || '';
                                
                                const locationsContainer = periodCard.querySelector('.locations-container');
                                if (locationsContainer) {
                                locationsContainer.innerHTML = '';
                                
                                periodData.locations.forEach(locData => {
                                    const locCard = makeLocationCard(periodCard);
                                    locCard.querySelector('.location-name').value = locData.locationName || '';
                                    locCard.querySelector('.shifts-count').value = locData.shiftsCount || 1;
                                    locCard.querySelector('.avg-children').value = locData.avgChildren || 20;
                                    locCard.querySelector('.living-days').value = locData.days || 14;
                                    locCard.querySelector('.food-price').value = locData.food || 400;
                                    locCard.querySelector('.program-cost').value = locData.program || 500;
                                    locCard.querySelector('.extra-cost').value = locData.extra || 200;
                                    locCard.querySelector('.location-price').value = locData.price || 26900;
                                    
                                    const teamList = locCard.querySelector('.team-list');
                                    if (teamList && locData.team) {
                                    teamList.innerHTML = '';
                                    locData.team.forEach(t => {
                                        const row = document.createElement('div');
                                        row.className = 'team-row';
                                        row.innerHTML = `
                                        <input type="text" placeholder="–ü–æ—Å–∞–¥–∞" value="${t.pos}" />
                                        <input type="number" placeholder="–ó–ü –∑–∞ –∑–º—ñ–Ω—É (–≥—Ä–Ω)" min="0" step="100" value="${t.salary}" />
                                        <input type="number" placeholder="–ö-—Å—Ç—å" min="1" step="1" value="${t.qty}" />
                                        <button type="button" class="tiny-btn danger">‚úï</button>`;
                                        const [pos, salary, count, delBtn] = row.children;
                                        const recalc = deb(calcCostFromUI, 120);
                                        [pos, salary, count].forEach(inp => inp.addEventListener('input', recalc));
                                        delBtn.addEventListener('click', () => { row.remove(); calcCostFromUI(); });
                                        teamList.appendChild(row);
                                    });
                                    }
                                });
                                }
                            });
                            } else {
                            // Add default period if empty
                            periodsContainer.appendChild(makePeriodCard());
                            }
                        }

                        calcCostFromUI();
                        }

                        // –ü—Å–µ–≤–¥–æ–Ω—ñ–º –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ —ñ—Å–Ω—É—é—á–∏–º –∫–æ–¥–æ–º
                        function editPlan(planId) {
                            loadPlanIntoEditor(planId);
                        }

                function saveActivePlan() {
                if (!activePlanId) {
                    console.error('‚ùå –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
                    return;
                }

                const plan = allPlans.find(p => p.id === activePlanId);
                if (!plan) {
                    console.error('‚ùå –ê–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø–∏—Å–∫—É –ø–ª–∞–Ω—ñ–≤');
                    return;
                }

                console.log('üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É:', plan.name);

                // Update plan data from form
                plan.name = document.getElementById('planName')?.value || '';

                // Collect periods data
                const {periods, op} = collectCostData();
                plan.periods = periods;
                plan.operationalCosts = {
                    adv: op.adv || 0,
                    man: op.man || 0,
                    launch: op.launch || 0
                };

                const basePrice = parseFloat(document.getElementById('basePrice')?.value || 26900);
                plan.metrics = calculatePlanMetrics(periods, plan.operationalCosts, { basePrice });

                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω ID
                localStorage.setItem('activePlanId', activePlanId);

                saveAllPlans();
                
                // Sync to CRM
                syncPlanToCRM(plan);
                
                renderPlansList();
                
                console.log('‚úÖ –ü–ª–∞–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ:', {
                    name: plan.name,
                    periods: plan.periods?.length || 0,
                    activePlanId: activePlanId
                });

                // Success feedback
                const saveBtn = document.getElementById('savePlanBtn');
                if (saveBtn) {
                    const originalText = saveBtn.textContent;
                    saveBtn.style.background = '#059669';
                    saveBtn.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ!';
                    setTimeout(() => {
                    saveBtn.style.background = '#10b981';
                    saveBtn.textContent = originalText;
                    }, 1500);
                }
                }

                        function cancelPlanEdit() {
                        activePlanId = null;
                        const editor = document.getElementById('activePlanEditor');
                        if (editor) editor.style.display = 'none';
                        renderPlansList();
                        }

                        function deletePlan(planId) {
                        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø–ª–∞–Ω? –¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞ –¥—ñ—è.')) return;
                        
                        allPlans = allPlans.filter(p => p.id !== planId);
                        saveAllPlans();
                        
                        if (activePlanId === planId) {
                            cancelPlanEdit();
                        }
                        
                        renderPlansList();
                        
                        // Re-sync active plan to CRM
                        // syncActivePlanToCRM deprecated
                        }

                        function syncPlanToCRM(plan) {
                        if (typeof crmData === 'undefined') {
                            console.log('CRM not initialized yet');
                            return;
                        }

                        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏ –∑ –ø–ª–∞–Ω—É –≤ CRM
                        plan.periods?.forEach(period => {
                            if (!period.periodName) return;
                            
                            // –î–æ–¥–∞—î–º–æ –ø–µ—Ä—ñ–æ–¥ –¥–æ CRM, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
                            if (!crmData.periods.includes(period.periodName)) {
                                crmData.periods.push(period.periodName);
                            }
                            
                            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É
                            if (!crmData.locations[period.periodName]) {
                                crmData.locations[period.periodName] = [];
                            }
                            
                            // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –ª–æ–∫–∞—Ü—ñ—ó –∑ –ø–µ—Ä—ñ–æ–¥—É
                            period.locations?.forEach(loc => {
                                if (!loc.locationName) return;
                                
                                // –î–æ–¥–∞—î–º–æ –ª–æ–∫–∞—Ü—ñ—é –¥–æ –ø–µ—Ä—ñ–æ–¥—É, —è–∫—â–æ —ó—ó –Ω–µ–º–∞—î
                                if (!crmData.locations[period.periodName].includes(loc.locationName)) {
                                    crmData.locations[period.periodName].push(loc.locationName);
                                }
                                
                                // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è –∑–º—ñ–Ω (—Ñ–æ—Ä–º–∞—Ç: –ø–µ—Ä—ñ–æ–¥|–ª–æ–∫–∞—Ü—ñ—è)
                                const shiftKey = `${period.periodName}|${loc.locationName}`;
                                
                                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑–º—ñ–Ω–∏ –¥–ª—è –ª–æ–∫–∞—Ü—ñ—ó
                                if (!crmData.shifts[shiftKey]) {
                                    crmData.shifts[shiftKey] = [];
                                }
                                
                                // –î–æ–¥–∞—î–º–æ –∑–º—ñ–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ shiftsCount
                                const shiftsCount = loc.shiftsCount || 1;
                                const currentShifts = crmData.shifts[shiftKey];
                                
                                // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–º—ñ–Ω–∏, —è–∫—â–æ —ó—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ
                                for (let i = currentShifts.length; i < shiftsCount; i++) {
                                    currentShifts.push(`–ó–º—ñ–Ω–∞ ${i + 1}`);
                                }
                            });
                        });
                        
                        // –û—á–∏—â—É—î–º–æ —Å–∏—Ä—ñ—Ç—Å—å–∫—ñ –ø–µ—Ä—ñ–æ–¥–∏ (–≤–∏–¥–∞–ª–µ–Ω—ñ –∑ –ø–ª–∞–Ω—ñ–≤)
                        const activePlanIds = new Set();
                        const allPlansData = JSON.parse(localStorage.getItem('campPlans') || '[]');
                        allPlansData.forEach(p => {
                            p.periods?.forEach(period => {
                                if (period.periodName) activePlanIds.add(period.periodName);
                            });
                        });
                        
                        // –í–∏–¥–∞–ª—è—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏, —è–∫—ñ –±—ñ–ª—å—à–µ –Ω–µ –≤ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω–∞—Ö
                        crmData.periods = crmData.periods.filter(periodName => {
                            if (!activePlanIds.has(periodName)) {
                                console.log(`üóëÔ∏è  –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å–∏—Ä—ñ—Ç—Å—å–∫–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É –∑ CRM: "${periodName}"`);
                                // –í–∏–¥–∞–ª—è—î–º–æ –ª–æ–∫–∞—Ü—ñ—ó —Ç–∞ –∑–º—ñ–Ω–∏ –¥–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                                delete crmData.locations[periodName];
                                Object.keys(crmData.shifts).forEach(key => {
                                    if (key.startsWith(periodName + '|')) {
                                        delete crmData.shifts[key];
                                    }
                                });
                                return false;
                            }
                            return true;
                        });
                        
                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—ñ CRM –¥–∞–Ω—ñ
                        localStorage.setItem('crmData', JSON.stringify(crmData));
                        console.log('‚úÖ –ü–ª–∞–Ω —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ CRM:', plan.name || plan.planName || '–ë–µ–∑ –Ω–∞–∑–≤–∏');
                        }

                        function syncActivePlanToCRM() {
                        // Deprecated: Active plan system removed - periods managed via CRM data structure
                        return;
                            if (!period.periodName) return;
                            
                            periodNames.push(period.periodName);

                            period.locations.forEach(loc => {
                                if (!loc.locationName) return;

                                if (!locationsByPeriod[period.periodName]) {
                                    locationsByPeriod[period.periodName] = [];
                                }
                                if (!locationsByPeriod[period.periodName].includes(loc.locationName)) {
                                    locationsByPeriod[period.periodName].push(loc.locationName);
                                }

                                const key = `${period.periodName}|${loc.locationName}`;
                                if (!shiftsByKey[key]) shiftsByKey[key] = [];

                                for (let i = 1; i <= loc.shiftsCount; i++) {
                                    const shiftName = `${i} –∑–º—ñ–Ω–∞`;
                                    if (!shiftsByKey[key].find(s => (typeof s === 'string' ? s : s.name) === shiftName)) {
                                        shiftsByKey[key].push({
                                            name: shiftName,
                                            plannedChildren: loc.avgChildren || 0
                                        });
                                    }
                                }
                            });
                        }

                        (function initCostTab(){
                        // Load all plans
                        allPlans = loadAllPlans();
                        renderPlansList();

                        // "Add Plan" button
                        const addPlanBtn = document.getElementById('addPlanBtn');
                        if (addPlanBtn) {
                            addPlanBtn.addEventListener('click', createNewPlan);
                        }

                        // "Save Plan" button
                        const savePlanBtn = document.getElementById('savePlanBtn');
                        if (savePlanBtn) {
                            savePlanBtn.addEventListener('click', saveActivePlan);
                        }

                        // "Cancel" button
                        const cancelPlanBtn = document.getElementById('cancelPlanBtn');
                        if (cancelPlanBtn) {
                            cancelPlanBtn.addEventListener('click', cancelPlanEdit);
                        }

                        // "Add Period" button
                        const addPeriodBtn = document.getElementById('addPeriodBtn');
                        if (addPeriodBtn) {
                            addPeriodBtn.addEventListener('click', () => {
                            const cont = document.getElementById('periodsContainer');
                            if (cont) {
                                cont.appendChild(makePeriodCard());
                                calcCostFromUI();
                            }
                            });
                        }

                        // Input listeners for operational costs
                        ;['planOpAdvertising', 'planOpManagers', 'planOpLaunch'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.addEventListener('input', deb(calcCostFromUI, 120));
                        });

                        const sync = document.getElementById('syncCostToSales');
                        if (sync) sync.addEventListener('change', calcCostFromUI);

                        // Auto-sync deprecated - using simple periods now
                        // setTimeout(() => {
                        //     syncActivePlanToCRM();
                        // }, 300);
                        })();

                        // ===== Settings System =====
                        let settings = JSON.parse(localStorage.getItem('campSettings') || '{"discounts":{},"transferTo":[],"transferFrom":[],"paymentInstructions":""}');

                        function saveSettings() {
                        localStorage.setItem('campSettings', JSON.stringify(settings));
                        syncSettingsToSales();
                        }

                        function syncSettingsToSales() {
                        // Sync discount settings to sales tab
                        if (settings.discounts.early) document.getElementById('catEarlyAmount').value = settings.discounts.early;
                        if (settings.discounts.repeat) document.getElementById('catRepeatAmount').value = settings.discounts.repeat;
                        if (settings.discounts.friends) document.getElementById('catFriendsAmount').value = settings.discounts.friends;
                        if (settings.discounts.social) document.getElementById('catSocPct').value = settings.discounts.social;
                        if (settings.discounts.double) document.getElementById('catDoublePct').value = settings.discounts.double;
                        if (settings.discounts.earlySocial) document.getElementById('catEarlySocAmount').value = settings.discounts.earlySocial;
                        }

                        function loadSettingsUI() {
                        // Load discounts
                        document.getElementById('settingEarlyDiscount').value = settings.discounts.early || 1000;
                        document.getElementById('settingRepeatDiscount').value = settings.discounts.repeat || 1000;
                        document.getElementById('settingFriendsDiscount').value = settings.discounts.friends || 1000;
                        document.getElementById('settingSocialDiscount').value = settings.discounts.social || 10;
                        document.getElementById('settingDoubleDiscount').value = settings.discounts.double || 5;
                        document.getElementById('settingEarlySocialDiscount').value = settings.discounts.earlySocial || 1000;
                        
                        // Load payment instructions
                        if (settings.paymentInstructions) {
                            document.getElementById('settingPaymentInstructions').value = settings.paymentInstructions;
                        }
                        
                        renderTransferLists();
                        renderFopList();
                        renderPeriodsManagement();
                        }

                        function renderPeriodsManagement() {
                        const container = document.getElementById('periodsManagement');
                        
                        // Show info message that structure is managed from Cost tab
                        const infoMessage = `
                            <div style="padding:16px;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;margin-bottom:20px">
                            <div style="display:flex;align-items:center;gap:12px">
                                <span style="font-size:24px">‚ÑπÔ∏è</span>
                                <div>
                                <div style="font-weight:700;color:#92400e;margin-bottom:4px">–ü–µ—Ä—ñ–æ–¥–∏, –ª–æ–∫–∞—Ü—ñ—ó —Ç–∞ –∑–º—ñ–Ω–∏ –∫–µ—Ä—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å</div>
                                <div style="font-size:13px;color:#78350f">–î–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–µ—Ä—ñ–æ–¥—ñ–≤ –ø–µ—Ä–µ–π–¥—ñ—Ç—å —É –≤–∫–ª–∞–¥–∫—É "üèïÔ∏è –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å (–ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è)" —Ç–∞ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è —É –∫–∞—Ä—Ç–∫–∞—Ö –∑–º—ñ–Ω.</div>
                                </div>
                            </div>
                            </div>
                        `;
                        
                        if (!crmData.periods || crmData.periods.length === 0) {
                            container.innerHTML = infoMessage + '<div style="padding:20px;background:#f8fafc;border-radius:8px;color:#64748b;text-align:center">–ù–µ–º–∞—î –ø–µ—Ä—ñ–æ–¥—ñ–≤. –°—Ç–≤–æ—Ä—ñ—Ç—å —ó—Ö —É –≤–∫–ª–∞–¥—Ü—ñ –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å.</div>';
                            return;
                        }
                        
                        const periodsHtml = crmData.periods.map((period, pIdx) => {
                            const locations = crmData.locations[period] || [];
                            
                            const locationsHtml = locations.map((location, lIdx) => {
                            const shiftKey = `${period}|${location}`;
                            const shifts = crmData.shifts[shiftKey] || [];
                            
                            const shiftsHtml = shifts.map((shift, sIdx) => {
                                const shiftName = typeof shift === 'string' ? shift : shift.name;
                                const planned = typeof shift === 'object' ? shift.plannedChildren : 0;
                                return `
                                <div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:white;border-radius:6px;margin-bottom:4px">
                                    <span style="flex:1;font-size:13px">${shiftName}</span>
                                    ${planned > 0 ? `<span style="font-size:11px;color:#64748b;padding:2px 8px;background:#f1f5f9;border-radius:4px">–ü–ª–∞–Ω: ${planned} –¥—ñ—Ç–µ–π</span>` : ''}
                                </div>
                                `;
                            }).join('');
                            
                            return `
                                <div style="padding:12px;background:#f0f9ff;border-radius:8px;margin-bottom:8px;border-left:4px solid #3b82f6">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                    <span style="font-weight:700;color:#1e40af">üìç ${location}</span>
                                </div>
                                ${shiftsHtml || '<div style="padding:8px;text-align:center;color:#64748b;font-size:12px;background:white;border-radius:6px">–ù–µ–º–∞—î –∑–º—ñ–Ω</div>'}
                                </div>
                            `;
                            }).join('');
                            
                            return `
                            <div style="padding:16px;background:#f8fafc;border-radius:12px;margin-bottom:16px;border:1px solid #e2e8f0">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                                <h4 style="margin:0;color:#0f172a;font-size:16px">ÔøΩ ${period}</h4>
                                </div>
                                ${locationsHtml || '<div style="padding:12px;text-align:center;color:#64748b;background:#f1f5f9;border-radius:8px">–ù–µ–º–∞—î –ª–æ–∫–∞—Ü—ñ–π</div>'}
                            </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = infoMessage + periodsHtml;
                        }

                        // Period management functions
                        window.editPeriod = function(idx) {
                        const oldName = crmData.periods[idx];
                        const newName = prompt('–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É –ø–µ—Ä—ñ–æ–¥—É:', oldName);
                        if (newName && newName !== oldName) {
                            // Update period name
                            crmData.periods[idx] = newName;
                            
                            // Update locations mapping
                            if (crmData.locations[oldName]) {
                            crmData.locations[newName] = crmData.locations[oldName];
                            delete crmData.locations[oldName];
                            }
                            
                            // Update shifts mappings
                            const oldLocations = crmData.locations[newName] || [];
                            oldLocations.forEach(loc => {
                            const oldKey = `${oldName}|${loc}`;
                            const newKey = `${newName}|${loc}`;
                            if (crmData.shifts[oldKey]) {
                                crmData.shifts[newKey] = crmData.shifts[oldKey];
                                delete crmData.shifts[oldKey];
                            }
                            });
                            
                            // Update clients
                            crmData.clients.forEach(client => {
                            if (client.period === oldName) {
                                client.period = newName;
                            }
                            });
                            
                            saveCRM();
                            renderPeriodsManagement();
                            updatePeriodSelect();
                        }
                        };

                        window.deletePeriod = function(idx) {
                        const period = crmData.periods[idx];
                        const clientsCount = crmData.clients.filter(c => c.period === period).length;
                        
                        if (clientsCount > 0) {
                            if (!confirm(`–£ –ø–µ—Ä—ñ–æ–¥—ñ "${period}" —î ${clientsCount} –∫–ª—ñ—î–Ω—Ç—ñ–≤. –í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ä—ñ–æ–¥ —Ä–∞–∑–æ–º –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏?`)) {
                            return;
                            }
                        } else if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ä—ñ–æ–¥ "${period}"?`)) {
                            return;
                        }
                        
                        // Delete period
                        crmData.periods.splice(idx, 1);
                        
                        // Delete locations
                        delete crmData.locations[period];
                        
                        // Delete shifts
                        Object.keys(crmData.shifts).forEach(key => {
                            if (key.startsWith(period + '|')) {
                            delete crmData.shifts[key];
                            }
                        });
                        
                        // Delete clients
                        crmData.clients = crmData.clients.filter(c => c.period !== period);
                        
                        saveCRM();
                        renderPeriodsManagement();
                        updatePeriodSelect();
                        };

                        window.addLocationToPeriod = function(period) {
                        const name = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó:');
                        if (name && name.trim()) {
                            if (!crmData.locations[period]) crmData.locations[period] = [];
                            if (!crmData.locations[period].includes(name)) {
                            crmData.locations[period].push(name);
                            saveCRM();
                            renderPeriodsManagement();
                            updateLocationSelect();
                            }
                        }
                        };

                        window.editLocation = function(period, idx) {
                        const oldName = crmData.locations[period][idx];
                        const newName = prompt('–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó:', oldName);
                        if (newName && newName !== oldName) {
                            // Update location name
                            crmData.locations[period][idx] = newName;
                            
                            // Update shifts mapping
                            const oldKey = `${period}|${oldName}`;
                            const newKey = `${period}|${newName}`;
                            if (crmData.shifts[oldKey]) {
                            crmData.shifts[newKey] = crmData.shifts[oldKey];
                            delete crmData.shifts[oldKey];
                            }
                            
                            // Update clients
                            crmData.clients.forEach(client => {
                            if (client.period === period && client.location === oldName) {
                                client.location = newName;
                            }
                            });
                            
                            saveCRM();
                            renderPeriodsManagement();
                            updateLocationSelect();
                        }
                        };

                        window.deleteLocation = function(period, idx) {
                        const location = crmData.locations[period][idx];
                        const clientsCount = crmData.clients.filter(c => c.period === period && c.location === location).length;
                        
                        if (clientsCount > 0) {
                            if (!confirm(`–£ –ª–æ–∫–∞—Ü—ñ—ó "${location}" —î ${clientsCount} –∫–ª—ñ—î–Ω—Ç—ñ–≤. –í–∏–¥–∞–ª–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é —Ä–∞–∑–æ–º –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏?`)) {
                            return;
                            }
                        } else if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é "${location}"?`)) {
                            return;
                        }
                        
                        // Delete location
                        crmData.locations[period].splice(idx, 1);
                        
                        // Delete shifts
                        const key = `${period}|${location}`;
                        delete crmData.shifts[key];
                        
                        // Delete clients
                        crmData.clients = crmData.clients.filter(c => !(c.period === period && c.location === location));
                        
                        saveCRM();
                        renderPeriodsManagement();
                        updateLocationSelect();
                        };

                        window.addShiftToLocation = function(period, location) {
                        const name = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∑–º—ñ–Ω–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "1 –∑–º—ñ–Ω–∞ (1-14 —á–µ—Ä–≤–Ω—è)"):');
                        if (name && name.trim()) {
                            const key = `${period}|${location}`;
                            if (!crmData.shifts[key]) crmData.shifts[key] = [];
                            if (!crmData.shifts[key].includes(name)) {
                            crmData.shifts[key].push(name);
                            saveCRM();
                            renderPeriodsManagement();
                            updateShiftSelect();
                            }
                        }
                        };

                        window.editShift = function(period, location, idx) {
                        const key = `${period}|${location}`;
                        const oldName = crmData.shifts[key][idx];
                        const newName = prompt('–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É –∑–º—ñ–Ω–∏:', oldName);
                        if (newName && newName !== oldName) {
                            crmData.shifts[key][idx] = newName;
                            
                            // Update clients
                            crmData.clients.forEach(client => {
                            if (client.period === period && client.location === location && client.shift === oldName) {
                                client.shift = newName;
                            }
                            });
                            
                            saveCRM();
                            renderPeriodsManagement();
                            updateShiftSelect();
                        }
                        };

                        window.deleteShift = function(period, location, idx) {
                        const key = `${period}|${location}`;
                        const shift = crmData.shifts[key][idx];
                        const clientsCount = crmData.clients.filter(c => c.period === period && c.location === location && c.shift === shift).length;
                        
                        if (clientsCount > 0) {
                            if (!confirm(`–£ –∑–º—ñ–Ω—ñ "${shift}" —î ${clientsCount} –∫–ª—ñ—î–Ω—Ç—ñ–≤. –í–∏–¥–∞–ª–∏—Ç–∏ –∑–º—ñ–Ω—É —Ä–∞–∑–æ–º –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏?`)) {
                            return;
                            }
                        } else if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∑–º—ñ–Ω—É "${shift}"?`)) {
                            return;
                        }
                        
                        // Delete shift
                        crmData.shifts[key].splice(idx, 1);
                        
                        // Delete clients
                        crmData.clients = crmData.clients.filter(c => !(c.period === period && c.location === location && c.shift === shift));
                        
                        saveCRM();
                        renderPeriodsManagement();
                        updateShiftSelect();
                        };

                        document.getElementById('addPeriodSetting')?.addEventListener('click', () => {
                        const name = document.getElementById('newPeriodName').value.trim();
                        if (!name) {
                            alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø–µ—Ä—ñ–æ–¥—É!');
                            return;
                        }
                        
                        if (crmData.periods.includes(name)) {
                            alert('–ü–µ—Ä—ñ–æ–¥ –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î!');
                            return;
                        }
                        
                        crmData.periods.push(name);
                        crmData.locations[name] = [];
                        saveCRM();
                        renderPeriodsManagement();
                        updatePeriodSelect();
                        
                        document.getElementById('newPeriodName').value = '';
                        });

                        function renderFopList() {
                        const fopList = document.getElementById('fopList');
                        if (!crmData.fops || crmData.fops.length === 0) {
                            fopList.innerHTML = '<div style="padding:12px;background:#f8fafc;border-radius:8px;color:#64748b;text-align:center">–ù–µ–º–∞—î –§–û–ü. –î–æ–¥–∞–π—Ç–µ –§–û–ü –¥–ª—è –æ–±–ª—ñ–∫—É –ø–ª–∞—Ç–µ–∂—ñ–≤.</div>';
                            return;
                        }
                        
                        fopList.innerHTML = crmData.fops.map((fop, idx) => `
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:8px">
                            <span style="font-weight:600">${fop}</span>
                            <button onclick="deleteFop(${idx})" style="padding:4px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </div>
                        `).join('');
                        }

                        window.deleteFop = function(idx) {
                        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –§–û–ü?')) {
                            crmData.fops.splice(idx, 1);
                            saveCRM();
                            renderFopList();
                        }
                        };

                        document.getElementById('addFop')?.addEventListener('click', () => {
                        const name = document.getElementById('newFopName').value.trim();
                        if (!name) {
                            alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –§–û–ü!');
                            return;
                        }
                        
                        if (!crmData.fops) crmData.fops = [];
                        crmData.fops.push(name);
                        saveCRM();
                        renderFopList();
                        
                        document.getElementById('newFopName').value = '';
                        });

                        function renderTransferLists() {
                        const toList = document.getElementById('transferToList');
                        const fromList = document.getElementById('transferFromList');
                        
                        toList.innerHTML = (settings.transferTo || []).map((t, idx) => `
                            <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;margin-bottom:8px">
                            <div style="flex:1;font-weight:600">${t.location}</div>
                            <div style="color:#3b82f6;font-weight:700">${t.price} –≥—Ä–Ω</div>
                            <button onclick="deleteTransferTo(${idx})" style="padding:4px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer">üóëÔ∏è</button>
                            </div>
                        `).join('') || '<div style="padding:12px;text-align:center;color:#94a3b8;font-size:13px">–ù–µ–º–∞—î –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏—Ö —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ñ–≤</div>';
                        
                        fromList.innerHTML = (settings.transferFrom || []).map((t, idx) => `
                            <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;margin-bottom:8px">
                            <div style="flex:1;font-weight:600">${t.location}</div>
                            <div style="color:#3b82f6;font-weight:700">${t.price} –≥—Ä–Ω</div>
                            <button onclick="deleteTransferFrom(${idx})" style="padding:4px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer">üóëÔ∏è</button>
                            </div>
                        `).join('') || '<div style="padding:12px;text-align:center;color:#94a3b8;font-size:13px">–ù–µ–º–∞—î –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏—Ö —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ñ–≤</div>';
                        }

                        document.getElementById('saveDiscountSettings')?.addEventListener('click', () => {
                        settings.discounts = {
                            early: parseFloat(document.getElementById('settingEarlyDiscount').value) || 1000,
                            repeat: parseFloat(document.getElementById('settingRepeatDiscount').value) || 1000,
                            friends: parseFloat(document.getElementById('settingFriendsDiscount').value) || 1000,
                            social: parseFloat(document.getElementById('settingSocialDiscount').value) || 10,
                            double: parseFloat(document.getElementById('settingDoubleDiscount').value) || 5,
                            earlySocial: parseFloat(document.getElementById('settingEarlySocialDiscount').value) || 1000
                        };
                        saveSettings();
                        alert('‚úÖ –ó–Ω–∏–∂–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ –≤–∫–ª–∞–¥–∫–æ—é –ü—Ä–æ–¥–∞–∂—ñ!');
                        });

                        document.getElementById('addTransferTo')?.addEventListener('click', () => {
                        const location = document.getElementById('newTransferToLocation').value.trim();
                        const price = parseFloat(document.getElementById('newTransferToPrice').value) || 0;
                        
                        if (!location || price <= 0) {
                            alert('–í–≤–µ–¥—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ —Å—É–º—É!');
                            return;
                        }
                        
                        if (!settings.transferTo) settings.transferTo = [];
                        settings.transferTo.push({ location, price });
                        saveSettings();
                        renderTransferLists();
                        
                        document.getElementById('newTransferToLocation').value = '';
                        document.getElementById('newTransferToPrice').value = '';
                        });

                        document.getElementById('addTransferFrom')?.addEventListener('click', () => {
                        const location = document.getElementById('newTransferFromLocation').value.trim();
                        const price = parseFloat(document.getElementById('newTransferFromPrice').value) || 0;
                        
                        if (!location || price <= 0) {
                            alert('–í–≤–µ–¥—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ —Å—É–º—É!');
                            return;
                        }
                        
                        if (!settings.transferFrom) settings.transferFrom = [];
                        settings.transferFrom.push({ location, price });
                        saveSettings();
                        renderTransferLists();
                        
                        document.getElementById('newTransferFromLocation').value = '';
                        document.getElementById('newTransferFromPrice').value = '';
                        });

                        window.deleteTransferTo = function(idx) {
                        settings.transferTo.splice(idx, 1);
                        saveSettings();
                        renderTransferLists();
                        };

                        window.deleteTransferFrom = function(idx) {
                        settings.transferFrom.splice(idx, 1);
                        saveSettings();
                        renderTransferLists();
                        };

                        document.getElementById('savePaymentInstructions')?.addEventListener('click', () => {
                        settings.paymentInstructions = document.getElementById('settingPaymentInstructions').value;
                        saveSettings();
                        alert('‚úÖ –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
                        });

                        // ===== CRM System =====
                        let crmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');

                        // –§—É–Ω–∫—Ü—ñ—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ø–µ—Ä—ñ–æ–¥—ñ–≤ –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏ (–æ–≥–æ–ª–æ—à—É—î–º–æ —Ä–∞–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ)
                        function syncPeriodSelection() {
                            const crmPeriod = document.getElementById('crmPeriod')?.value;
                            const analyticsPeriod = document.getElementById('analyticsPeriodFilter')?.value;
                            
                            // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –≤–∏–±—ñ—Ä, —è–∫—â–æ –æ–¥–∏–Ω –∑ –Ω–∏—Ö –º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è
                            if (crmPeriod && crmPeriod !== analyticsPeriod) {
                                const analyticsSelect = document.getElementById('analyticsPeriodFilter');
                                if (analyticsSelect) {
                                    analyticsSelect.value = crmPeriod;
                                    if (typeof updateAnalyticsLocationFilter === 'function') {
                                        updateAnalyticsLocationFilter();
                                    }
                                    if (typeof updateAnalytics === 'function') {
                                        updateAnalytics();
                                    }
                                }
                            } else if (analyticsPeriod && analyticsPeriod !== crmPeriod) {
                                const crmSelect = document.getElementById('crmPeriod');
                                if (crmSelect) {
                                    crmSelect.value = analyticsPeriod;
                                    if (typeof updateLocationSelect === 'function') {
                                        updateLocationSelect();
                                    }
                                    if (typeof updateShiftSelect === 'function') {
                                        updateShiftSelect();
                                    }
                                }
                            }
                        }

                        // Migrate old data structure to new one
                        if (Array.isArray(crmData.locations)) {
                        // Old structure - migrate to new
                        const oldLocations = crmData.locations;
                        const oldShifts = crmData.shifts || [];
                        
                        // Create default period if there's old data
                        if (oldLocations.length > 0) {
                            const defaultPeriod = "–ê—Ä—Ö—ñ–≤ (–¥–æ –ø–µ—Ä—ñ–æ–¥—ñ–≤)";
                            crmData.periods = [defaultPeriod];
                            crmData.locations = { [defaultPeriod]: oldLocations };
                            
                            // Convert shifts to new format
                            crmData.shifts = {};
                            oldLocations.forEach(loc => {
                            const key = `${defaultPeriod}|${loc}`;
                            crmData.shifts[key] = oldShifts;
                            });
                            
                            // Add period to all existing clients
                            crmData.clients.forEach(client => {
                            if (!client.period) {
                                client.period = defaultPeriod;
                            }
                            });
                            
                            // Save migrated data
                            localStorage.setItem('crmData', JSON.stringify(crmData));
                        } else {
                            // No old data, just initialize new structure
                            crmData.locations = {};
                            crmData.shifts = {};
                        }
                        }

                        // Ensure refunds array exists
                        if (!crmData.refunds) {
                        crmData.refunds = [];
                        }

                        // Load settings on init (after crmData is initialized)
                        loadSettingsUI();

                        function saveCRM() {
                        localStorage.setItem('crmData', JSON.stringify(crmData));
                        updateManagerFilter();
                        updateCRMStats();
                        renderClientsTable();
                        updateRefundsBadge();
                        }

                        function updateRefundsBadge() {
                            const badge = document.getElementById('refundsCountBadge');
                            if (!badge) return;
                            
                            // –†–∞—Ö—É—î–º–æ –≤—Å—ñ –≤—ñ–¥–º–æ–≤–∏ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
                            const pendingRefunds = crmData.refunds ? crmData.refunds.filter(r => r.status !== 'processed').length : 0;
                            
                            if (pendingRefunds > 0) {
                                badge.textContent = pendingRefunds;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }

                        function updateRefundsStats() {
                        // Build per-period stats
                        const statsContainer = document.getElementById('crmRefundsStatsByPeriod');
                        const refunds = crmData.refunds || [];
                        const periods = (crmData.periods && crmData.periods.length>0) 
                            ? crmData.periods 
                            : [...new Set(refunds.map(r=>r.period))];

                        if (statsContainer) {
                            if (!periods || periods.length===0) {
                            statsContainer.innerHTML = '<div style="padding:16px;background:#f8fafc;border-radius:8px;color:#64748b;text-align:center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö</div>';
                            } else {
                            statsContainer.innerHTML = periods.map(p => {
                                const list = refunds.filter(r=>r.period===p);
                                const total = list.length;
                                const full = list.filter(r=>r.refundType==='full').length;
                                const amount = list.reduce((s,r)=> s + (parseFloat(r.amount||0)||0), 0);
                                return `
                                <div style="padding:12px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:var(--shadow)">
                                    <div style="font-weight:700;color:#0f172a;margin-bottom:8px">üìÖ ${p}</div>
                                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                                    <div>
                                        <div style="font-size:12px;color:#991b1b">–í—Å—å–æ–≥–æ –≤—ñ–¥–º–æ–≤</div>
                                        <div style="font-size:20px;font-weight:700;color:#dc2626">${total.toLocaleString('uk-UA')}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:12px;color:#991b1b">–ü–æ–≤–Ω–∏—Ö –≤—ñ–¥–º–æ–≤</div>
                                        <div style="font-size:20px;font-weight:700;color:#dc2626">${full.toLocaleString('uk-UA')}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:12px;color:#991b1b">–î–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</div>
                                        <div style="font-size:20px;font-weight:700;color:#dc2626">${amount.toLocaleString('uk-UA')} –≥—Ä–Ω</div>
                                    </div>
                                    </div>
                                </div>`;
                            }).join('');
                            }
                        }

                        // Pending banner (overall unpaid)
                        const pendingCount = refunds.filter(r => r.status === 'pending' && (parseFloat(r.amount||0) > 0)).length;
                        const banner = document.getElementById('crmRefundsPendingBanner');
                        if (banner) {
                            if (pendingCount > 0) {
                            const txt = pendingCount === 1 ? '–Ñ 1 –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞ –≤—ñ–¥–º–æ–≤–∞' : `–Ñ ${pendingCount} –Ω–µ –æ–ø–ª–∞—á–µ–Ω—ñ –≤—ñ–¥–º–æ–≤–∏`;
                            banner.innerHTML = `<div class=\"alert warning\">${txt}</div>`;
                            } else {
                            banner.innerHTML = `<div class=\"alert success\">–ü–æ–∫–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω—å –Ω–µ–º–∞—î</div>`;
                            }
                        }
                        }

                        function updateCRMStats() {
                        const period = document.getElementById('crmPeriod')?.value;
                        const location = document.getElementById('crmLocation')?.value;
                        const shift = document.getElementById('crmShift')?.value;
                        
                        const filtered = crmData.clients.filter(c => 
                            (!period || c.period === period) && 
                            (!location || c.location === location) && 
                            (!shift || c.shift === shift)
                        );
                        
                        document.getElementById('statTotalClients').textContent = filtered.length;
                        document.getElementById('statFullPaid').textContent = filtered.filter(c => c.paymentStatus === '–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞').length;
                        document.getElementById('statPrepaid').textContent = filtered.filter(c => c.paymentStatus === '–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞').length;
                        
                        const totalPaid = filtered.reduce((sum, c) => sum + (parseFloat(c.amountPaid) || 0), 0);
                        document.getElementById('statTotalPaid').textContent = Math.round(totalPaid).toLocaleString('uk-UA');
                        
                        // Calculate expected based on base price and discounts
                        const basePrice = parseFloat(document.getElementById('basePrice')?.value || 26900);
                        const expected = filtered.reduce((sum, c) => {
                            const clientPrice = calculateClientPrice(basePrice, c.discount, c.transferCost);
                            return sum + (clientPrice - (parseFloat(c.amountPaid) || 0));
                        }, 0);
                        document.getElementById('statExpected').textContent = Math.round(expected).toLocaleString('uk-UA');
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –≤—ñ–¥–º–æ–≤
                        updateRefundsBadge();
                        }

                        // Update Active Seasons Analytics
                        function updateActiveSeasonsStats() {
                            const container = document.getElementById('activeSeasonsStats');
                            if (!container) return;

                            // Get all periods and their stats
                            if (!crmData.periods || crmData.periods.length === 0) {
                                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#64748b;padding:20px">–ù–µ–º–∞—î –ø–µ—Ä—ñ–æ–¥—ñ–≤</div>';
                                return;
                            }

                            // Calculate stats per period
                            const periodStats = [];
                            
                            crmData.periods.forEach(period => {
                                const clients = crmData.clients.filter(c => c.period === period);
                                const totalClients = clients.length;
                                const paidClients = clients.filter(c => c.paymentStatus === '–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞').length;
                                const pendingClients = totalClients - paidClients;

                                periodStats.push({
                                    name: period,
                                    total: totalClients,
                                    paid: paidClients,
                                    pending: pendingClients
                                });
                            });

                            // Render period cards
                            const html = periodStats.map(stat => `
                                <div style="background:white;border:1px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center">
                                    <div style="font-weight:700;color:#374151;margin-bottom:8px">${stat.name}</div>
                                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                        <span style="font-size:12px;color:#64748b">–í—Å—å–æ–≥–æ:</span>
                                        <span style="font-weight:600;color:#0f172a">${stat.total}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                        <span style="font-size:12px;color:#64748b">–û–ø–ª–∞—á–µ–Ω–æ:</span>
                                        <span style="font-weight:600;color:#10b981">${stat.paid}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between">
                                        <span style="font-size:12px;color:#64748b">–û—á—ñ–∫—É—î—Ç—å—Å—è:</span>
                                        <span style="font-weight:600;color:#f59e0b">${stat.pending}</span>
                                    </div>
                                </div>
                            `).join('');

                            container.innerHTML = html;
                        }

                        // Handle Client Management Button
                        function handleClientManagement() {
                            // Switch to clients view mode
                            document.getElementById('crmPeriod').style.display = 'block';
                            document.getElementById('crmLocation').style.display = 'block';
                            document.getElementById('crmShift').style.display = 'block';
                            
                            // Show message to select period/location/shift
                            showNotification('–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥, –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏', 'info');
                        }

                        // Handle Refunds Button
                        function handleRefunds() {
                            // Show refunds modal or interface
                            showRefundsInterface();
                        }

                        // Show Refunds Interface
                        function showRefundsInterface() {
                            const modal = document.createElement('div');
                            modal.style.cssText = `
                                position:fixed;top:0;left:0;width:100%;height:100%;
                                background:rgba(0,0,0,0.5);z-index:1000;
                                display:flex;align-items:center;justify-content:center
                            `;

                            const content = document.createElement('div');
                            content.style.cssText = `
                                background:white;border-radius:12px;padding:24px;
                                width:90%;max-width:800px;max-height:80%;overflow-y:auto
                            `;

                            content.innerHTML = `
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                                    <h3 style="margin:0;color:#374151">üí∏ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤—ñ–¥–º–æ–≤–∞–º–∏</h3>
                                    <button onclick="this.closest('div').parentElement.remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#64748b">√ó</button>
                                </div>
                                
                                <div style="margin-bottom:20px;padding:16px;background:#fef3c7;border-radius:8px;border-left:4px solid #f59e0b">
                                    <div style="font-weight:600;color:#92400e;margin-bottom:4px">üìã –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</div>
                                    <div style="color:#92400e;font-size:14px">
                                        1. –û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –≤—ñ–¥–º–æ–≤–∏<br>
                                        2. –í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É —Ç–∞ –¥–∞—Ç—É –≤—ñ–¥–º–æ–≤–∏<br>
                                        3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö—É—î —Å—É–º—É –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è<br>
                                        4. –í—ñ–¥–º–æ–≤–∞ –±—É–¥–µ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—É –∑–≤—ñ—Ç–Ω—ñ—Å—Ç—å
                                    </div>
                                </div>

                                <div id="refundsContent">
                                    <div style="text-align:center;color:#64748b;padding:40px">
                                        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–ª—ñ—î–Ω—Ç—ñ–≤...
                                    </div>
                                </div>
                            `;

                            modal.appendChild(content);
                            document.body.appendChild(modal);

                            // Load clients for refunds
                            loadClientsForRefunds();
                        }

                        // Load clients eligible for refunds
                        function loadClientsForRefunds() {
                            const activePlan = getActivePlan();
                            if (!activePlan) return;

                            const eligibleClients = crmData.clients.filter(c => 
                                c.paymentStatus === '–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞' || c.paymentStatus === '–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞'
                            );

                            const container = document.getElementById('refundsContent');
                            if (!container) return;

                            if (eligibleClients.length === 0) {
                                container.innerHTML = `
                                    <div style="text-align:center;color:#64748b;padding:40px">
                                        –ù–µ–º–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ –æ–ø–ª–∞—Ç–∞–º–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –≤—ñ–¥–º–æ–≤
                                    </div>
                                `;
                                return;
                            }

                            const html = `
                                <div style="overflow-x:auto">
                                    <table style="width:100%;border-collapse:collapse;font-size:13px">
                                        <thead>
                                            <tr style="background:#f1f5f9">
                                                <th style="padding:12px 8px;text-align:left;border-bottom:1px solid #e2e8f0">–ü–Ü–ë</th>
                                                <th style="padding:12px 8px;text-align:left;border-bottom:1px solid #e2e8f0">–õ–æ–∫–∞—Ü—ñ—è</th>
                                                <th style="padding:12px 8px;text-align:left;border-bottom:1px solid #e2e8f0">–ó–º—ñ–Ω–∞</th>
                                                <th style="padding:12px 8px;text-align:left;border-bottom:1px solid #e2e8f0">–°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏</th>
                                                <th style="padding:12px 8px;text-align:left;border-bottom:1px solid #e2e8f0">–°—É–º–∞ –≤–Ω–µ—Å–µ–Ω–∞</th>
                                                <th style="padding:12px 8px;text-align:center;border-bottom:1px solid #e2e8f0">–î—ñ—ó</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${eligibleClients.map(client => `
                                                <tr>
                                                    <td style="padding:12px 8px;border-bottom:1px solid #f1f5f9">${client.name}</td>
                                                    <td style="padding:12px 8px;border-bottom:1px solid #f1f5f9">${client.location}</td>
                                                    <td style="padding:12px 8px;border-bottom:1px solid #f1f5f9">${client.shift}</td>
                                                    <td style="padding:12px 8px;border-bottom:1px solid #f1f5f9">${client.paymentStatus}</td>
                                                    <td style="padding:12px 8px;border-bottom:1px solid #f1f5f9">${Math.round(client.amountPaid || 0)} –≥—Ä–Ω</td>
                                                    <td style="padding:12px 8px;border-bottom:1px solid #f1f5f9;text-align:center">
                                                        <button onclick="processRefund('${client.id}')" 
                                                                class="btn" style="padding:6px 12px;font-size:12px;background:#ef4444;color:white">
                                                            üí∏ –í—ñ–¥–º–æ–≤–∞
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;

                            container.innerHTML = html;
                        }

                        // Process refund for a client
                        function processRefund(clientId) {
                            const client = crmData.clients.find(c => c.id === clientId);
                            if (!client) {
                                alert('–ö–ª—ñ—î–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                                return;
                            }

                            const refundModal = document.createElement('div');
                            refundModal.style.cssText = `
                                position:fixed;top:0;left:0;width:100%;height:100%;
                                background:rgba(0,0,0,0.7);z-index:1001;
                                display:flex;align-items:center;justify-content:center
                            `;

                            const refundContent = document.createElement('div');
                            refundContent.style.cssText = `
                                background:white;border-radius:12px;padding:24px;
                                width:90%;max-width:500px;max-height:80%;overflow-y:auto
                            `;

                            const totalPrice = getClientTotalPrice(client);
                            const amountPaid = client.amountPaid || 0;

                            refundContent.innerHTML = `
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                                    <h3 style="margin:0;color:#374151">üí∏ –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –≤—ñ–¥–º–æ–≤–∏</h3>
                                    <button onclick="this.closest('div').parentElement.remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#64748b">√ó</button>
                                </div>
                                
                                <div style="background:#f8fafc;padding:16px;border-radius:8px;margin-bottom:20px">
                                    <div style="font-weight:600;margin-bottom:12px">${client.name}</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
                                        <div>–õ–æ–∫–∞—Ü—ñ—è: <strong>${client.location}</strong></div>
                                        <div>–ó–º—ñ–Ω–∞: <strong>${client.shift}</strong></div>
                                        <div>–í–∞—Ä—Ç—ñ—Å—Ç—å: <strong>${Math.round(totalPrice)} –≥—Ä–Ω</strong></div>
                                        <div>–í–Ω–µ—Å–µ–Ω–æ: <strong>${Math.round(amountPaid)} –≥—Ä–Ω</strong></div>
                                    </div>
                                </div>

                                <div style="margin-bottom:16px">
                                    <label style="display:block;font-weight:600;margin-bottom:8px">–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏</label>
                                    <select id="refundReason" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                        <option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É...</option>
                                        <option value="–û—Å–æ–±–∏—Å—Ç—ñ –æ–±—Å—Ç–∞–≤–∏–Ω–∏">–û—Å–æ–±–∏—Å—Ç—ñ –æ–±—Å—Ç–∞–≤–∏–Ω–∏</option>
                                        <option value="–•–≤–æ—Ä–æ–±–∞">–•–≤–æ—Ä–æ–±–∞</option>
                                        <option value="–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Ç—Ä—É–¥–Ω–æ—â—ñ">–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Ç—Ä—É–¥–Ω–æ—â—ñ</option>
                                        <option value="–ó–º—ñ–Ω–∞ –ø–ª–∞–Ω—ñ–≤">–ó–º—ñ–Ω–∞ –ø–ª–∞–Ω—ñ–≤</option>
                                        <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
                                    </select>
                                </div>

                                <div style="margin-bottom:16px">
                                    <label style="display:block;font-weight:600;margin-bottom:8px">–°—É–º–∞ –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–≥—Ä–Ω)</label>
                                    <input type="number" id="refundAmount" value="${Math.round(amountPaid)}" 
                                        style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px" max="${amountPaid}">
                                </div>

                                <div style="margin-bottom:20px">
                                    <label style="display:block;font-weight:600;margin-bottom:8px">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                                    <textarea id="refundComment" rows="3" 
                                            style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px" 
                                            placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–µ—Ç–∞–ª—ñ..."></textarea>
                                </div>

                                <div style="display:flex;gap:12px">
                                    <button onclick="this.closest('div').parentElement.remove()" 
                                            class="mutebtn" style="flex:1;padding:12px">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                    <button onclick="confirmRefund('${clientId}')" 
                                            class="btn" style="flex:1;padding:12px;background:#ef4444;color:white">–û—Ñ–æ—Ä–º–∏—Ç–∏ –≤—ñ–¥–º–æ–≤—É</button>
                                </div>
                            `;

                            refundModal.appendChild(refundContent);
                            document.body.appendChild(refundModal);
                        }

                        // Confirm and process refund
                        function confirmRefund(clientId) {
                            const reason = document.getElementById('refundReason')?.value;
                            const amount = parseFloat(document.getElementById('refundAmount')?.value || 0);
                            const comment = document.getElementById('refundComment')?.value || '';

                            if (!reason) {
                                alert('–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –≤—ñ–¥–º–æ–≤–∏');
                                return;
                            }

                            if (amount < 0) {
                                alert('–°—É–º–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥\'—î–º–Ω–æ—é');
                                return;
                            }

                            const client = crmData.clients.find(c => c.id === clientId);
                            if (!client) return;

                            // Remove client from CRM
                            const clientIndex = crmData.clients.findIndex(c => c.id === clientId);
                            if (clientIndex >= 0) {
                                crmData.clients.splice(clientIndex, 1);
                            }

                            // Add refund operation to finance
                            const refundOperation = {
                                id: Date.now(),
                                date: getCurrentDate(),
                                period: client.period,
                                location: client.location,
                                shift: client.shift,
                                description: `–í—ñ–¥–º–æ–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞: ${client.name}. –ü—Ä–∏—á–∏–Ω–∞: ${reason}`,
                                category: '–í–∏—Ç—Ä–∞—Ç–∏.–í—ñ–¥—à–∫–æ–¥—É–≤–∞–Ω–Ω—è',
                                amount: -amount,
                                comment: comment,
                                planId: getActivePlan()?.id
                            };

                            if (!financeData.operations) financeData.operations = [];
                            financeData.operations.push(refundOperation);

                            // Save changes
                            saveCRM();
                            saveFinance();

                            // Update displays
                            renderClientsTable();
                            updateCRMStats();
                            updateActiveSeasonsStats();

                            // Close modals
                            document.querySelectorAll('div[style*="position:fixed"]').forEach(modal => modal.remove());

                            alert(`–í—ñ–¥–º–æ–≤—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ. –°—É–º–∞ –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è: ${amount} –≥—Ä–Ω`);
                        }

                        // Show notification function
                        function showNotification(message, type = 'info') {
                            const notification = document.createElement('div');
                            const bgColor = type === 'info' ? '#3b82f6' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444';
                            
                            notification.style.cssText = `
                                position:fixed;top:20px;right:20px;z-index:1000;
                                background:${bgColor};color:white;padding:16px 20px;
                                border-radius:8px;font-weight:500;
                                box-shadow:0 10px 15px rgba(0,0,0,0.1);
                                animation:slideIn 0.3s ease-out
                            `;
                            
                            notification.textContent = message;
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                notification.style.animation = 'slideOut 0.3s ease-out';
                                setTimeout(() => notification.remove(), 300);
                            }, 3000);
                        }

                        function calculateClientPrice(basePrice, discount, transferCost) {
                        let price = basePrice;
                        const transfer = parseFloat(transferCost) || 0;
                        
                        // Apply discount
                        if (discount === '–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è') price -= parseFloat(document.getElementById('catEarlyAmount')?.value || 1000);
                        else if (discount === '–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å') price -= parseFloat(document.getElementById('catRepeatAmount')?.value || 1000);
                        else if (discount === '–î—Ä—É–∑—ñ') price -= parseFloat(document.getElementById('catFriendsAmount')?.value || 1000);
                        else if (discount === '–£–ë–î —ñ –í–ü–û') price *= (1 - (parseFloat(document.getElementById('catSocPct')?.value || 10) / 100));
                        else if (discount === '2 –∑–º—ñ–Ω–∏') price *= (1 - (parseFloat(document.getElementById('catDoublePct')?.value || 5) / 100));
                        
                        return price + transfer;
                        }

                        function getClientTotalPrice(client) {
                        const basePrice = parseFloat(document.getElementById('basePrice')?.value || 26900);
                        return calculateClientPrice(basePrice, client.discount, client.transferCost || 0);
                        }

                        function getPaymentColor(amountPaid, totalPrice) {
                        const percentage = (amountPaid / totalPrice) * 100;
                        
                        if (amountPaid >= totalPrice) {
                            // –ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞ –∞–±–æ –ø–µ—Ä–µ–ø–ª–∞—Ç–∞
                            if (amountPaid > totalPrice) {
                            // –ü–µ—Ä–µ–ø–ª–∞—Ç–∞ - —Å–∏–Ω—ñ–π
                            return { bg: '#dbeafe', color: '#1e40af', label: `+${(amountPaid - totalPrice).toLocaleString('uk-UA')} –≥—Ä–Ω` };
                            } else {
                            // –¢–æ—á–Ω–∞ –æ–ø–ª–∞—Ç–∞ - –∑–µ–ª–µ–Ω–∏–π
                            return { bg: '#d1fae5', color: '#065f46', label: '' };
                            }
                        } else if (percentage >= 75) {
                            // 75-99% - —Å–≤—ñ—Ç–ª–æ-–∑–µ–ª–µ–Ω–∏–π
                            return { bg: '#dcfce7', color: '#166534', label: '' };
                        } else if (percentage >= 50) {
                            // 50-74% - –∂–æ–≤—Ç–æ-–∑–µ–ª–µ–Ω–∏–π
                            return { bg: '#fef9c3', color: '#854d0e', label: '' };
                        } else if (percentage >= 25) {
                            // 25-49% - –ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π
                            return { bg: '#fed7aa', color: '#9a3412', label: '' };
                        } else if (percentage > 0) {
                            // 1-24% - —á–µ—Ä–≤–æ–Ω–∏–π
                            return { bg: '#fecaca', color: '#991b1b', label: '' };
                        } else {
                            // –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ - —Å—ñ—Ä–∏–π
                            return { bg: '#f1f5f9', color: '#64748b', label: '' };
                        }
                        }

                        function renderClientsTable() {
                        const period = document.getElementById('crmPeriod')?.value;
                        const location = document.getElementById('crmLocation')?.value;
                        const shift = document.getElementById('crmShift')?.value;
                        const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
                        const filterPaymentStatus = document.getElementById('filterPaymentStatus')?.value || '';
                        const filterClientType = document.getElementById('filterClientType')?.value || '';
                        const filterDiscount = document.getElementById('filterDiscount')?.value || '';
                        const filterManager = document.getElementById('filterManager')?.value || '';
                        const tbody = document.getElementById('clientsTableBody');
                        
                        if (!period || !location || !shift) {
                            tbody.innerHTML = '<tr><td colspan="13" style="padding:40px;text-align:center;color:#94a3b8">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥, –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤</td></tr>';
                            return;
                        }
                        
                        let filtered = crmData.clients.filter(c => c.period === period && c.location === location && c.shift === shift);
                        
                        // Apply search filter
                        if (searchTerm) {
                            filtered = filtered.filter(c => {
                            return (c.name || '').toLowerCase().includes(searchTerm) ||
                                    (c.phone || '').toLowerCase().includes(searchTerm) ||
                                    (c.city || '').toLowerCase().includes(searchTerm) ||
                                    (c.contactPerson || '').toLowerCase().includes(searchTerm) ||
                                    (c.comment || '').toLowerCase().includes(searchTerm);
                            });
                        }
                        
                        // Apply additional filters
                        if (filterPaymentStatus) {
                            filtered = filtered.filter(c => c.paymentStatus === filterPaymentStatus);
                        }
                        if (filterClientType) {
                            filtered = filtered.filter(c => c.clientType === filterClientType);
                        }
                        if (filterDiscount) {
                            filtered = filtered.filter(c => c.discount === filterDiscount);
                        }
                        if (filterManager) {
                            filtered = filtered.filter(c => c.manager === filterManager);
                        }
                        
                        if (filtered.length === 0) {
                            const msg = searchTerm || filterPaymentStatus || filterClientType || filterDiscount || filterManager 
                            ? '–ù–µ–º–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –æ–±—Ä–∞–Ω–∏–º —Ñ—ñ–ª—å—Ç—Ä–∞–º' 
                            : '–ù–µ–º–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è —Ü—ñ—î—ó –∑–º—ñ–Ω–∏. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞"';
                            tbody.innerHTML = `<tr><td colspan="13" style="padding:40px;text-align:center;color:#94a3b8">${msg}</td></tr>`;
                            return;
                        }
                        
                        tbody.innerHTML = filtered.map((client, idx) => {
                            let transferDisplay = '';
                            if (client.transferTo || client.transferFrom) {
                            const parts = [];
                            if (client.transferTo) parts.push(`‚û°Ô∏è ${client.transferTo}`);
                            if (client.transferFrom) parts.push(`‚¨ÖÔ∏è ${client.transferFrom}`);
                            transferDisplay = `${parts.join(' ')}<br><b>${client.transferCost || 0} –≥—Ä–Ω</b>`;
                            } else if (client.transferCost) {
                            transferDisplay = `${client.transferCost} –≥—Ä–Ω`;
                            } else {
                            transferDisplay = '‚Äî';
                            }
                            
                            const paymentsCount = client.payments?.length || 0;
                            const paymentsInfo = paymentsCount > 0 
                            ? `<button onclick="showPaymentHistory(${client.id})" style="padding:2px 6px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px;margin-left:4px" title="–ü–æ–∫–∞–∑–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é">üìã ${paymentsCount}</button>`
                            : '';
                            
                            const hasComment = client.comment && client.comment.trim() !== '';
                            const rowBg = hasComment ? '#fff9e6' : (idx % 2 === 0 ? 'white' : '#f9fafb');
                            const commentDisplay = hasComment ? client.comment : '‚Äî';
                            const nameWithManager = client.manager 
                            ? `${client.name}<br><span style="font-size:10px;color:#64748b;font-weight:400">üë§ ${client.manager}</span>`
                            : client.name;
                            
                            // Calculate payment color
                            const totalPrice = getClientTotalPrice(client);
                            const amountPaid = parseFloat(client.amountPaid || 0);
                            const paymentColor = getPaymentColor(amountPaid, totalPrice);
                            
                            return `
                            <tr style="border-bottom:1px solid #e2e8f0;background:${rowBg}">
                            <td style="padding:10px 8px">${idx + 1}</td>
                            <td style="padding:10px 8px;font-weight:600;line-height:1.4">${nameWithManager}</td>
                            <td style="padding:10px 8px"><span style="padding:4px 8px;background:${client.paymentStatus==='–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞'?'#d1fae5':client.paymentStatus==='–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞'?'#fef3c7':client.paymentStatus==='–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ'?'#fed7aa':'#fee2e2'};color:${client.paymentStatus==='–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞'?'#065f46':client.paymentStatus==='–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞'?'#92400e':client.paymentStatus==='–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ'?'#9a3412':'#991b1b'};border-radius:6px;font-size:11px;font-weight:600">${client.paymentStatus}</span></td>
                            <td style="padding:10px 8px">
                                <div style="display:inline-block;padding:6px 10px;background:${paymentColor.bg};color:${paymentColor.color};border-radius:6px;font-weight:700">
                                ${amountPaid.toLocaleString('uk-UA')} –≥—Ä–Ω
                                ${paymentColor.label ? `<br><span style="font-size:10px">${paymentColor.label}</span>` : ''}
                                </div>
                                ${paymentsInfo}
                            </td>
                            <td style="padding:10px 8px;font-size:11px">${client.discount}</td>
                            <td style="padding:10px 8px;font-size:11px;line-height:1.4">${transferDisplay}</td>
                            <td style="padding:10px 8px">${client.birthDate}</td>
                            <td style="padding:10px 8px">${client.contactPerson}</td>
                            <td style="padding:10px 8px">${client.phone}</td>
                            <td style="padding:10px 8px">${client.city}</td>
                            <td style="padding:10px 8px"><span style="padding:4px 8px;background:${client.clientType==='–Ω–æ–≤–∏–π'?'#dbeafe':'#f3e8ff'};color:${client.clientType==='–Ω–æ–≤–∏–π'?'#1e40af':'#6b21a8'};border-radius:6px;font-size:11px;font-weight:600">${client.clientType}</span></td>
                            <td style="padding:10px 8px;font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${commentDisplay}">${commentDisplay}</td>
                            <td style="padding:10px 8px">
                                <button onclick="editClient(${client.id})" style="padding:4px 8px;margin-right:4px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px">‚úèÔ∏è</button>
                                <button onclick="showRefundDialog(${client.id})" style="padding:4px 8px;margin-right:4px;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px" title="–í—ñ–¥–º–æ–≤–∞">‚ö†Ô∏è</button>
                                <button onclick="deleteClient(${client.id})" style="padding:4px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px">üóëÔ∏è</button>
                            </td>
                            </tr>
                            `;
                        }).join('');
                        }

                        // Initialize period, locations and shifts selects
                        function updatePeriodSelect() {
                        const select = document.getElementById('crmPeriod');
                        const currentValue = select?.value;
                        
                        if (select) {
                            select.innerHTML = '<option value="">–í–∏–±—Ä–∞—Ç–∏ –ø–µ—Ä—ñ–æ–¥...</option>' + 
                                crmData.periods.map(period => `<option value="${period}">${period}</option>`).join('');
                            
                            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –≤–∏–±—ñ—Ä, —è–∫—â–æ –≤—ñ–Ω —â–µ —ñ—Å–Ω—É—î
                            if (currentValue && crmData.periods.includes(currentValue)) {
                                select.value = currentValue;
                            }
                        }
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –∑ —ñ–Ω—à–∏–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏
                        if (typeof syncPeriodSelection === 'function') {
                            setTimeout(syncPeriodSelection, 50);
                        }
                        }

                        function updatePeriodSelectors() {
                        // –û–Ω–æ–≤–ª—é—î–º–æ CRM —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–µ—Ä—ñ–æ–¥—ñ–≤
                        if (typeof updatePeriodSelect === 'function') {
                            updatePeriodSelect();
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–µ—Ä—ñ–æ–¥—ñ–≤
                        if (typeof updateAnalyticsPeriodFilter === 'function') {
                            updateAnalyticsPeriodFilter();
                        }
                        
                        console.log('üîÑ –û–Ω–æ–≤–ª–µ–Ω–æ –≤—Å—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –ø–µ—Ä—ñ–æ–¥—ñ–≤');
                        }

                        function updateLocationSelect() {
                        const period = document.getElementById('crmPeriod')?.value;
                        const select = document.getElementById('crmLocation');
                        
                        if (!period) {
                            select.innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥...</option>';
                            select.disabled = true;
                            return;
                        }
                        
                        select.disabled = false;
                        const locations = crmData.locations[period] || [];
                        select.innerHTML = '<option value="">–í–∏–±—Ä–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é...</option>' + 
                            locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
                        }

                        function updateShiftSelect() {
                        const period = document.getElementById('crmPeriod')?.value;
                        const location = document.getElementById('crmLocation')?.value;
                        const select = document.getElementById('crmShift');
                        
                        if (!period || !location) {
                            select.innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—é...</option>';
                            select.disabled = true;
                            return;
                        }
                        
                        select.disabled = false;
                        const key = `${period}|${location}`;
                        const shifts = crmData.shifts[key] || [];
                        select.innerHTML = '<option value="">–í–∏–±—Ä–∞—Ç–∏ –∑–º—ñ–Ω—É...</option>' + 
                            shifts.map(shift => {
                            const shiftName = typeof shift === 'string' ? shift : shift.name;
                            return `<option value="${shiftName}">${shiftName}</option>`;
                            }).join('');
                        }

                        function updateManagerFilter() {
                        const managers = [...new Set(crmData.clients.map(c => c.manager).filter(m => m))];
                        const select = document.getElementById('filterManager');
                        select.innerHTML = '<option value="">–í—Å—ñ</option>' + 
                            managers.map(m => `<option value="${m}">${m}</option>`).join('');
                        }

                        document.getElementById('addPeriod')?.addEventListener('click', () => {
                        const name = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø–µ—Ä—ñ–æ–¥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–ó–∏–º–∞ 2026", "–õ—ñ—Ç–æ 2026"):');
                        if (name && !crmData.periods.includes(name)) {
                            crmData.periods.push(name);
                            crmData.locations[name] = [];
                            updatePeriodSelect();
                            saveCRM();
                        }
                        });

                        document.getElementById('addLocation')?.addEventListener('click', () => {
                        const period = document.getElementById('crmPeriod').value;
                        if (!period) {
                            alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥!');
                            return;
                        }
                        
                        const name = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó:');
                        if (name) {
                            if (!crmData.locations[period]) crmData.locations[period] = [];
                            if (!crmData.locations[period].includes(name)) {
                            crmData.locations[period].push(name);
                            updateLocationSelect();
                            saveCRM();
                            }
                        }
                        });

                        document.getElementById('addShift')?.addEventListener('click', () => {
                        const period = document.getElementById('crmPeriod').value;
                        const location = document.getElementById('crmLocation').value;
                        
                        if (!period || !location) {
                            alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—é!');
                            return;
                        }
                        
                        const name = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∑–º—ñ–Ω–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "1 –∑–º—ñ–Ω–∞ (1-14 —á–µ—Ä–≤–Ω—è)"):');
                        if (name) {
                            const key = `${period}|${location}`;
                            if (!crmData.shifts[key]) crmData.shifts[key] = [];
                            if (!crmData.shifts[key].includes(name)) {
                            crmData.shifts[key].push(name);
                            updateShiftSelect();
                            saveCRM();
                            }
                        }
                        });

                        document.getElementById('crmPeriod')?.addEventListener('change', () => {
                        updateLocationSelect();
                        updateShiftSelect();
                        updateCRMStats();
                        renderClientsTable();
                        updateFopAssignmentDisplay(); // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ –§–û–ü–∞
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –æ–±—Ä–∞–Ω–æ–º—É –ø–µ—Ä—ñ–æ–¥—É
                        autoSwitchActivePlan();
                        });

                        document.getElementById('crmLocation')?.addEventListener('change', () => {
                        updateShiftSelect();
                        updateCRMStats();
                        renderClientsTable();
                        updateFopAssignmentDisplay(); // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ –§–û–ü–∞
                        });

                        document.getElementById('crmShift')?.addEventListener('change', () => {
                        updateCRMStats();
                        renderClientsTable();
                        updateFopAssignmentDisplay(); // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ –§–û–ü–∞
                        });

                        document.getElementById('addClient')?.addEventListener('click', () => {
                        const period = document.getElementById('crmPeriod').value;
                        const location = document.getElementById('crmLocation').value;
                        const shift = document.getElementById('crmShift').value;
                        
                        if (!period || !location || !shift) {
                            alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥, –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É!');
                            return;
                        }
                        
                        showClientDialog();
                        });

                        function showClientDialog(clientId = null) {
                        const client = clientId ? crmData.clients.find(c => c.id === clientId) : null;
                        const isEdit = !!client;
                        
                        const transferToOptions = (settings.transferTo || []).map(t => {
                            const valueStr = `${t.location}:${t.price}`;
                            const isSelected = client?.transferTo === t.location;
                            return `<option value="${valueStr}" ${isSelected ? 'selected' : ''}>${t.location} (${t.price} –≥—Ä–Ω)</option>`;
                        }).join('');
                        
                        const transferFromOptions = (settings.transferFrom || []).map(t => {
                            const valueStr = `${t.location}:${t.price}`;
                            const isSelected = client?.transferFrom === t.location;
                            return `<option value="${valueStr}" ${isSelected ? 'selected' : ''}>${t.location} (${t.price} –≥—Ä–Ω)</option>`;
                        }).join('');
                        
                        const fopOptions = (crmData.fops || []).map(fop => `<option value="${fop}">${fop}</option>`).join('');
                        
                        // Calculate total from payments
                        const payments = client?.payments || [];
                        const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        
                        const paymentsHtml = payments.map((p, idx) => `
                            <div style="display:grid;grid-template-columns:80px 1fr 1fr 100px 30px;gap:8px;align-items:center;padding:8px;background:white;border-radius:6px;margin-bottom:6px">
                            <span style="font-size:12px;color:#64748b">${p.date}</span>
                            <span style="font-size:13px;font-weight:600">${p.method}</span>
                            <span style="font-size:12px;color:#64748b">${p.payer ? 'üë§ ' + p.payer : '‚Äî'}</span>
                            <span style="font-weight:700;color:#059669;text-align:right">${parseFloat(p.amount).toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                            <button onclick="deletePayment(${idx})" style="padding:2px 6px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px">üóëÔ∏è</button>
                            </div>
                        `).join('') || '<div style="padding:12px;text-align:center;color:#94a3b8;font-size:13px">–ù–µ–º–∞—î –ø–ª–∞—Ç–µ–∂—ñ–≤</div>';
                        
                        const html = `
                            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center" id="clientDialog">
                            <div style="background:white;padding:24px;border-radius:12px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto">
                                <h3 style="margin:0 0 20px 0">${isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–î–æ–¥–∞—Ç–∏'} –∫–ª—ñ—î–Ω—Ç–∞</h3>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div style="grid-column:1/-1"><label>–ü–Ü–ë –¥–∏—Ç–∏–Ω–∏</label><input id="dialogName" type="text" value="${client?.name || ''}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" /></div>
                                <div><label>–°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏</label><select id="dialogPayment" onchange="updateClientPriceCalculation()" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px"><option ${client?.paymentStatus==='–ù–∞–¥—ñ—Å–ª–∞–Ω—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏'?'selected':''}>–ù–∞–¥—ñ—Å–ª–∞–Ω—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏</option><option ${client?.paymentStatus==='–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞'?'selected':''}>–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option><option ${client?.paymentStatus==='–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ'?'selected':''}>–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ</option><option ${client?.paymentStatus==='–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞'?'selected':''}>–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞</option></select></div>
                                <div><label>–ó–Ω–∏–∂–∫–∞</label><select id="dialogDiscount" onchange="updateClientPriceCalculation()" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px"><option ${client?.discount==='–ë–µ–∑ –∑–Ω–∏–∂–∫–∏'?'selected':''}>–ë–µ–∑ –∑–Ω–∏–∂–∫–∏</option><option ${client?.discount==='–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è'?'selected':''}>–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</option><option ${client?.discount==='–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å'?'selected':''}>–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å</option><option ${client?.discount==='–î—Ä—É–∑—ñ'?'selected':''}>–î—Ä—É–∑—ñ</option><option ${client?.discount==='–£–ë–î —ñ –í–ü–û'?'selected':''}>–£–ë–î —ñ –í–ü–û</option><option ${client?.discount==='2 –∑–º—ñ–Ω–∏'?'selected':''}>2 –∑–º—ñ–Ω–∏</option></select></div>
                                
                                <!-- Payment History -->
                                <div style="grid-column:1/-1;padding:16px;background:#f0fdf4;border-radius:8px;border:2px solid #10b981">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <div style="font-weight:700;color:#065f46;font-size:15px">üíµ –Ü—Å—Ç–æ—Ä—ñ—è –ø–ª–∞—Ç–µ–∂—ñ–≤</div>
                                    <div style="font-weight:700;color:#059669;font-size:16px">–í—Å—å–æ–≥–æ: <span id="totalPaymentsAmount">${totalPaid.toLocaleString('uk-UA')}</span> –≥—Ä–Ω</div>
                                    </div>
                                    <div id="paymentsContainer" style="max-height:150px;overflow-y:auto;margin-bottom:12px;padding:8px;background:#f8fafc;border-radius:6px">
                                    ${paymentsHtml}
                                    </div>
                                    <div style="background:white;padding:12px;border-radius:8px;border:1px solid #d1fae5">
                                    <div style="font-weight:600;margin-bottom:8px;color:#065f46">‚ûï –î–æ–¥–∞—Ç–∏ –ø–ª–∞—Ç—ñ–∂</div>
                                    <div style="display:grid;grid-template-columns:100px 1fr 1fr 120px 80px;gap:8px">
                                        <input id="newPaymentDate" type="date" style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px" />
                                        <select id="newPaymentMethod" style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px">
                                        <option value="">–í–∏–±—Ä–∞—Ç–∏ –º–µ—Ç–æ–¥...</option>
                                        <option value="–ì–æ—Ç—ñ–≤–∫–∞">–ì–æ—Ç—ñ–≤–∫–∞</option>
                                        ${fopOptions}
                                        </select>
                                        <input id="newPaymentPayer" type="text" placeholder="–ü–ª–∞—Ç–Ω–∏–∫ (–ü–Ü–ë)" style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px" />
                                        <input id="newPaymentAmount" type="number" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" min="0" step="100" style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px" />
                                        <button onclick="addPayment()" class="btn" style="padding:8px;font-size:12px">–î–æ–¥–∞—Ç–∏</button>
                                    </div>
                                    </div>
                                </div>
                                <div style="grid-column:1/-1;padding:16px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:8px;border:2px solid #3b82f6">
                                    <div style="font-weight:700;margin-bottom:12px;color:#1e40af;font-size:15px">üí∞ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;background:white;padding:12px;border-radius:6px;margin-bottom:8px">
                                    <div style="color:#64748b;font-size:13px">–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞:</div>
                                    <div style="text-align:right;font-weight:600" id="calcBasePrice">0 –≥—Ä–Ω</div>
                                    <div style="color:#64748b;font-size:13px">–ó–Ω–∏–∂–∫–∞:</div>
                                    <div style="text-align:right;font-weight:600;color:#ef4444" id="calcDiscount">0 –≥—Ä–Ω</div>
                                    <div style="color:#64748b;font-size:13px">–¢—Ä–∞–Ω—Å—Ñ–µ—Ä:</div>
                                    <div style="text-align:right;font-weight:600;color:#3b82f6" id="calcTransfer">0 –≥—Ä–Ω</div>
                                    <div style="border-top:2px solid #e5e7eb;padding-top:8px;color:#0f172a;font-weight:700">–í–°–¨–û–ì–û:</div>
                                    <div style="border-top:2px solid #e5e7eb;padding-top:8px;text-align:right;font-weight:700;color:#059669;font-size:18px" id="calcTotal">0 –≥—Ä–Ω</div>
                                    </div>
                                    <div style="background:#fef3c7;padding:10px;border-radius:6px;border-left:4px solid #f59e0b">
                                    <div style="color:#92400e;font-size:12px;margin-bottom:4px">–í–Ω–µ—Å–µ–Ω–æ: <span id="calcPaid" style="font-weight:700">0 –≥—Ä–Ω</span></div>
                                    <div style="color:#92400e;font-weight:700;font-size:14px">–ó–∞–ª–∏—à–æ–∫ –¥–æ –æ–ø–ª–∞—Ç–∏: <span id="calcRemaining" style="font-size:16px">0 –≥—Ä–Ω</span></div>
                                    </div>
                                </div>
                                <div style="grid-column:1/-1;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e5e7eb">
                                    <div style="font-weight:600;margin-bottom:8px;color:#0f172a">üöå –¢—Ä–∞–Ω—Å—Ñ–µ—Ä</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                    <div>
                                        <label style="font-size:12px;color:#64748b">‚û°Ô∏è –î–æ —Ç–∞–±–æ—Ä—É</label>
                                        <select id="dialogTransferTo" onchange="updateTotalTransfer();updateClientPriceCalculation()" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px">
                                        <option value="">–ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω</option>
                                        ${transferToOptions}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:12px;color:#64748b">‚¨ÖÔ∏è –ó —Ç–∞–±–æ—Ä—É</label>
                                        <select id="dialogTransferFrom" onchange="updateTotalTransfer();updateClientPriceCalculation()" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px">
                                        <option value="">–ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω</option>
                                        ${transferFromOptions}
                                        </select>
                                    </div>
                                    </div>
                                    <div style="margin-top:8px;padding:8px;background:white;border-radius:6px;text-align:center">
                                    <span style="color:#64748b;font-size:12px">–í—Å—å–æ–≥–æ –∑–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä:</span>
                                    <span id="totalTransferCost" style="font-weight:700;color:#3b82f6;font-size:16px;margin-left:8px">0 –≥—Ä–Ω</span>
                                    </div>
                                </div>
                                <div><label>–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label><input id="dialogBirthDate" type="date" value="${client?.birthDate || ''}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" /></div>
                                <div><label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞</label><input id="dialogContact" type="text" value="${client?.contactPerson || ''}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" /></div>
                                <div><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label><input id="dialogPhone" type="tel" value="${client?.phone || ''}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" /></div>
                                <div><label>–ú—ñ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è</label><input id="dialogCity" type="text" value="${client?.city || ''}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" /></div>
                                <div><label>–¢–∏–ø –∫–ª—ñ—î–Ω—Ç–∞</label><select id="dialogType" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px"><option ${client?.clientType==='–Ω–æ–≤–∏–π'?'selected':''}>–Ω–æ–≤–∏–π</option><option ${client?.clientType==='—Å—Ç–∞—Ä–∏–π'?'selected':''}>—Å—Ç–∞—Ä–∏–π</option></select></div>
                                <div><label>–ú–µ–Ω–µ–¥–∂–µ—Ä</label><input id="dialogManager" type="text" value="${client?.manager || ''}" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px" /></div>
                                <div style="grid-column:1/-1"><label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label><textarea id="dialogComment" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;min-height:60px">${client?.comment || ''}</textarea></div>
                                </div>
                                <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end">
                                <button onclick="closeClientDialog()" class="mutebtn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                <button onclick="saveClient(${isEdit ? client.id : 'null'})" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                </div>
                            </div>
                            </div>
                        `;
                        
                        document.body.insertAdjacentHTML('beforeend', html);
                        
                        // Initialize temp payments from client data
                        tempPayments = client?.payments ? JSON.parse(JSON.stringify(client.payments)) : [];
                        
                        // Initialize total transfer cost and price calculation
                        setTimeout(() => {
                            updateTotalTransfer();
                            updateClientPriceCalculation();
                        }, 100);
                        }

                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—î –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ–±—Ä–∞–Ω–æ–≥–æ per√≠odu –≤ CRM
                        function autoSwitchActivePlan() {
                            const selectedPeriod = document.getElementById('crmPeriod')?.value;
                            if (!selectedPeriod) return;
                            
                            // –®—É–∫–∞—î–º–æ –ø–ª–∞–Ω, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç—å –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
                            const matchingPlan = allPlans.find(plan => {
                                return plan.periods?.some(period => period.periodName === selectedPeriod);
                            });
                            
                            if (matchingPlan && matchingPlan.id !== activePlanId) {
                                console.log(`üîÑ –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –Ω–∞ –ø–ª–∞–Ω "${matchingPlan.name}" –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É "${selectedPeriod}"`);
                                activePlanId = matchingPlan.id;
                                localStorage.setItem('activePlanId', activePlanId);
                                
                                // –û–Ω–æ–≤–ª—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É
                                const selector = document.getElementById('activePlanSelector');
                                if (selector) {
                                    selector.value = activePlanId;
                                }
                                
                                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–ª–∞–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                loadPlanIntoEditor(activePlanId);
                            } else if (!matchingPlan) {
                                console.log(`‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–ª–∞–Ω –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É "${selectedPeriod}". –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏...`);
                                
                                // –Ø–∫—â–æ –ø–µ—Ä—ñ–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –º–æ–∂–ª–∏–≤–æ –≤—ñ–Ω –±—É–≤ –≤–∏–¥–∞–ª–µ–Ω–∏–π - –æ–Ω–æ–≤–ª—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏
                                setTimeout(() => {
                                    if (typeof updatePeriodSelectors === 'function') {
                                        updatePeriodSelectors();
                                    }
                                }, 100);
                            }
                        }

                        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü—ñ–Ω–∏ –ª–æ–∫–∞—Ü—ñ—ó –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ–±—Ä–∞–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É —Ç–∞ –ª–æ–∫–∞—Ü—ñ—ó –≤ CRM
                        function getLocationPriceFromPlan() {
                            // –ë–µ—Ä–µ–º –ø–µ—Ä—ñ–æ–¥ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—é –∑ –æ—Å–Ω–æ–≤–Ω–∏—Ö CRM —Å–µ–ª–µ–∫—Ç–æ—Ä—ñ–≤
                            const period = document.getElementById('crmPeriod')?.value;
                            const location = document.getElementById('crmLocation')?.value;
                            
                            console.log(`üîé –ü–æ—à—É–∫ —Ü—ñ–Ω–∏: –ø–µ—Ä—ñ–æ–¥="${period}", –ª–æ–∫–∞—Ü—ñ—è="${location}"`);
                            
                            if (!period || !location) {
                                return 0; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ 0, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —â–æ —Ü—ñ–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞
                            }
                            
                            // –®—É–∫–∞—î–º–æ —Ü—ñ–Ω—É –≤ –∞–∫—Ç–∏–≤–Ω–æ–º—É –ø–ª–∞–Ω—ñ
                            const activePlan = getActivePlan();
                            if (!activePlan?.periods) {
                                console.log('üìã –ê–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–º–∞—î –ø–µ—Ä—ñ–æ–¥—ñ–≤');
                                return 0;
                            }
                            
                            const foundPeriod = activePlan.periods.find(p => p.periodName === period);
                            if (!foundPeriod?.locations) {
                                console.log(`üìã –ü–µ—Ä—ñ–æ–¥ "${period}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º—É –ø–ª–∞–Ω—ñ "${activePlan.name}" –∞–±–æ –Ω–µ–º–∞—î –ª–æ–∫–∞—Ü—ñ–π`);
                                console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏ –≤ –ø–ª–∞–Ω—ñ:`, activePlan.periods.map(p => p.periodName));
                                
                                // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –ø–µ—Ä—ñ–æ–¥ –≤ —ñ–Ω—à–∏—Ö –ø–ª–∞–Ω–∞—Ö —ñ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏—Å—è
                                const planWithPeriod = allPlans.find(plan => 
                                    plan.periods?.some(p => p.periodName === period)
                                );
                                
                                if (planWithPeriod && planWithPeriod.id !== activePlanId) {
                                    console.log(`üîÑ –ó–Ω–∞–π–¥–µ–Ω–æ –ø–µ—Ä—ñ–æ–¥ "${period}" –≤ –ø–ª–∞–Ω—ñ "${planWithPeriod.name}". –ü–µ—Ä–µ–∫–ª—é—á–∞—î–º–æ—Å—è...`);
                                    autoSwitchActivePlan();
                                    // –ü–æ–≤—Ç–æ—Ä—é—î–º–æ –ø–æ—à—É–∫ –∑ –Ω–æ–≤–∏–º –∞–∫—Ç–∏–≤–Ω–∏–º –ø–ª–∞–Ω–æ–º
                                    return getLocationPriceFromPlan();
                                }
                                
                                return 0;
                            }
                            
                            const foundLocation = foundPeriod.locations.find(l => l.locationName === location);
                            if (!foundLocation) {
                                console.log(`üìã –õ–æ–∫–∞—Ü—ñ—é "${location}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –ø–µ—Ä—ñ–æ–¥—ñ "${period}"`);
                                console.log('–î–æ—Å—Ç—É–ø–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó:', foundPeriod.locations.map(l => l.locationName));
                                return 0;
                            }
                            
                            // –¶—ñ–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ø–æ–ª—ñ 'price' –≤ –¥–∞–Ω–∏—Ö –ø–ª–∞–Ω—É
                            const price = foundLocation.price || 0;
                            console.log(`üí∞ –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –¥–ª—è ${location} (${period}): ${price} –≥—Ä–Ω`);
                            console.log('–î–∞–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó:', foundLocation);
                            return price;
                        }

                        window.updateClientPriceCalculation = function() {
                        // –û—Ç—Ä–∏–º—É—î–º–æ —Ü—ñ–Ω—É –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ –∞–±–æ –∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —è–∫ fallback
                        console.log('üîç –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ü—ñ–Ω–∏ –∫–ª—ñ—î–Ω—Ç–∞...');
                        const planPrice = getLocationPriceFromPlan();
                        const calculatorPrice = parseFloat(document.getElementById('basePrice')?.value || 0);
                        
                        // –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ü—ñ–Ω—É –∑ –ø–ª–∞–Ω—É, —è–∫—â–æ –≤–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
                        let basePrice;
                        if (planPrice && planPrice > 0) {
                            basePrice = planPrice;
                            console.log(`‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ü—ñ–Ω—É –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞: ${planPrice} –≥—Ä–Ω`);
                        } else {
                            basePrice = calculatorPrice || 26900;
                            console.log(`‚ö†Ô∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback —Ü—ñ–Ω—É: ${basePrice} –≥—Ä–Ω (–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)`);
                        }
                        
                        console.log(`üìä –§—ñ–Ω–∞–ª—å–Ω–∞ –±–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞: ${basePrice} –≥—Ä–Ω`);
                        
                        const discount = document.getElementById('dialogDiscount')?.value || '–ë–µ–∑ –∑–Ω–∏–∂–∫–∏';
                        
                        // Calculate total from payments display
                        const totalPaidText = document.getElementById('totalPaymentsAmount')?.textContent?.replace(/\s/g, '') || '0';
                        const totalPaid = parseFloat(totalPaidText.replace(',', '')) || 0;
                        
                        // Calculate transfer cost
                        const toSelect = document.getElementById('dialogTransferTo');
                        const fromSelect = document.getElementById('dialogTransferFrom');
                        let transferCost = 0;
                        if (toSelect?.value) {
                            transferCost += parseFloat(toSelect.value.split(':')[1]) || 0;
                        }
                        if (fromSelect?.value) {
                            transferCost += parseFloat(fromSelect.value.split(':')[1]) || 0;
                        }
                        
                        // Calculate discount amount
                        let discountAmount = 0;
                        let priceAfterDiscount = basePrice;
                        
                        if (discount === '–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è') {
                            discountAmount = parseFloat(document.getElementById('catEarlyAmount')?.value || 1000);
                            priceAfterDiscount = basePrice - discountAmount;
                        } else if (discount === '–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å') {
                            discountAmount = parseFloat(document.getElementById('catRepeatAmount')?.value || 1000);
                            priceAfterDiscount = basePrice - discountAmount;
                        } else if (discount === '–î—Ä—É–∑—ñ') {
                            discountAmount = parseFloat(document.getElementById('catFriendsAmount')?.value || 1000);
                            priceAfterDiscount = basePrice - discountAmount;
                        } else if (discount === '–£–ë–î —ñ –í–ü–û') {
                            const pct = parseFloat(document.getElementById('catSocPct')?.value || 10);
                            discountAmount = basePrice * (pct / 100);
                            priceAfterDiscount = basePrice - discountAmount;
                        } else if (discount === '2 –∑–º—ñ–Ω–∏') {
                            const pct = parseFloat(document.getElementById('catDoublePct')?.value || 5);
                            discountAmount = basePrice * (pct / 100);
                            priceAfterDiscount = basePrice - discountAmount;
                        }
                        
                        const totalPrice = priceAfterDiscount + transferCost;
                        const remaining = totalPrice - totalPaid;
                        
                        // Update display
                        document.getElementById('calcBasePrice').textContent = basePrice.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('calcDiscount').textContent = '-' + Math.round(discountAmount).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('calcTransfer').textContent = '+' + transferCost.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('calcTotal').textContent = Math.round(totalPrice).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('calcPaid').textContent = totalPaid.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('calcRemaining').textContent = Math.round(remaining).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        
                        // Highlight remaining amount based on value
                        const remainingEl = document.getElementById('calcRemaining');
                        if (remaining <= 0) {
                            remainingEl.style.color = '#059669';
                        } else if (remaining < totalPrice / 2) {
                            remainingEl.style.color = '#f59e0b';
                        } else {
                            remainingEl.style.color = '#dc2626';
                        }
                        };

                        let tempPayments = [];

                        window.addPayment = function() {
                        const date = document.getElementById('newPaymentDate').value;
                        const method = document.getElementById('newPaymentMethod').value;
                        const amount = parseFloat(document.getElementById('newPaymentAmount').value);
                        const payer = document.getElementById('newPaymentPayer').value?.trim();
                        
                        if (!date || !method || !amount) {
                            alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –ø–ª–∞—Ç–µ–∂—É!');
                            return;
                        }
                        
                        tempPayments.push({ date, method, amount, payer });
                        
                        // Update payments display
                        updatePaymentsDisplay();
                        
                        // Clear inputs
                        document.getElementById('newPaymentDate').value = getCurrentDate();
                        document.getElementById('newPaymentMethod').value = '';
                        document.getElementById('newPaymentAmount').value = '';
                        if (document.getElementById('newPaymentPayer')) document.getElementById('newPaymentPayer').value = '';
                        
                        // Recalculate
                        updateClientPriceCalculation();
                        };

                        window.deletePayment = function(idx) {
                        tempPayments.splice(idx, 1);
                        updatePaymentsDisplay();
                        updateClientPriceCalculation();
                        };

                        function updatePaymentsDisplay() {
                        const container = document.getElementById('paymentsContainer');
                        const totalEl = document.getElementById('totalPaymentsAmount');
                        
                        if (tempPayments.length === 0) {
                            container.innerHTML = '<div style="padding:12px;text-align:center;color:#94a3b8;font-size:13px">–ù–µ–º–∞—î –ø–ª–∞—Ç–µ–∂—ñ–≤</div>';
                            totalEl.textContent = '0';
                            return;
                        }
                        
                        const total = tempPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        
                        container.innerHTML = tempPayments.map((p, idx) => `
                            <div style="display:grid;grid-template-columns:80px 1fr 1fr 100px 30px;gap:8px;align-items:center;padding:8px;background:white;border-radius:6px;margin-bottom:6px">
                            <span style="font-size:12px;color:#64748b">${p.date}</span>
                            <span style="font-size:13px;font-weight:600">${p.method}</span>
                            <span style="font-size:12px;color:#64748b">${p.payer ? 'üë§ ' + p.payer : '‚Äî'}</span>
                            <span style="font-weight:700;color:#059669;text-align:right">${parseFloat(p.amount).toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                            <button onclick="deletePayment(${idx})" style="padding:2px 6px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px">üóëÔ∏è</button>
                            </div>
                        `).join('');
                        
                        totalEl.textContent = total.toLocaleString('uk-UA');
                        }

                        window.updateTotalTransfer = function() {
                        const toSelect = document.getElementById('dialogTransferTo');
                        const fromSelect = document.getElementById('dialogTransferFrom');
                        const totalEl = document.getElementById('totalTransferCost');
                        
                        if (!toSelect || !fromSelect || !totalEl) return;
                        
                        let total = 0;
                        if (toSelect.value) {
                            const price = parseFloat(toSelect.value.split(':')[1]) || 0;
                            total += price;
                        }
                        if (fromSelect.value) {
                            const price = parseFloat(fromSelect.value.split(':')[1]) || 0;
                            total += price;
                        }
                        
                        totalEl.textContent = total + ' –≥—Ä–Ω';
                        };

                        window.closeClientDialog = function() {
                        document.getElementById('clientDialog')?.remove();
                        };

                        window.saveClient = function(clientId) {
                        const period = document.getElementById('crmPeriod').value;
                        const location = document.getElementById('crmLocation').value;
                        const shift = document.getElementById('crmShift').value;
                        
                        // Calculate total transfer cost
                        const transferTo = document.getElementById('dialogTransferTo').value;
                        const transferFrom = document.getElementById('dialogTransferFrom').value;
                        let transferCost = 0;
                        let transferToLocation = '';
                        let transferFromLocation = '';
                        
                        if (transferTo) {
                            const [loc, price] = transferTo.split(':');
                            transferToLocation = loc;
                            transferCost += parseFloat(price) || 0;
                        }
                        if (transferFrom) {
                            const [loc, price] = transferFrom.split(':');
                            transferFromLocation = loc;
                            transferCost += parseFloat(price) || 0;
                        }
                        
                        // Calculate total amount paid from payments
                        const totalPaid = tempPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        
                        const clientData = {
                            id: clientId || Date.now(),
                            period,
                            location,
                            shift,
                            name: document.getElementById('dialogName').value,
                            paymentStatus: document.getElementById('dialogPayment').value,
                            amountPaid: totalPaid,
                            payments: tempPayments,
                            discount: document.getElementById('dialogDiscount').value,
                            transferCost: transferCost,
                            transferTo: transferToLocation,
                            transferFrom: transferFromLocation,
                            birthDate: document.getElementById('dialogBirthDate').value,
                            contactPerson: document.getElementById('dialogContact').value,
                            phone: document.getElementById('dialogPhone').value,
                            city: document.getElementById('dialogCity').value,
                            clientType: document.getElementById('dialogType').value,
                            manager: document.getElementById('dialogManager').value,
                            comment: document.getElementById('dialogComment').value,
                            createdAt: clientId ? (crmData.clients.find(c => c.id === clientId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
                        };
                        
                        if (clientId) {
                            const index = crmData.clients.findIndex(c => c.id === clientId);
                            crmData.clients[index] = clientData;
                        } else {
                            crmData.clients.push(clientData);
                        }
                        
                        saveCRM();
                        closeClientDialog();
                        };

                        window.editClient = function(clientId) {
                        showClientDialog(clientId);
                        };

                        window.deleteClient = function(clientId) {
                        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞?')) {
                            crmData.clients = crmData.clients.filter(c => c.id !== clientId);
                            saveCRM();
                        }
                        };

                        window.showPaymentHistory = function(clientId) {
                        const client = crmData.clients.find(c => c.id === clientId);
                        if (!client || !client.payments || client.payments.length === 0) {
                            alert('–ù–µ–º–∞—î —ñ—Å—Ç–æ—Ä—ñ—ó –ø–ª–∞—Ç–µ–∂—ñ–≤');
                            return;
                        }
                        
                        const total = client.payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        
                        const paymentsHtml = client.payments.map((p, idx) => {
                            const amount = parseFloat(p.amount) || 0;
                            const isPending = p.status === 'pending';
                            const isRefund = amount < 0 || p.method.includes('–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è') || p.method.includes('–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è');
                            const displayAmount = Math.abs(amount);
                            
                            let statusBadge = '';
                            if (isPending && p.pendingAmount) {
                            statusBadge = `<div style="margin-top:4px;padding:4px 8px;background:#fef3c7;color:#92400e;border-radius:4px;font-size:10px;font-weight:600">‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ ${p.pendingAmount.toLocaleString('uk-UA')} –≥—Ä–Ω –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –æ–±—Ä–æ–±–∫—É</div>`;
                            } else if (p.status === 'processed' && p.processedBy) {
                            statusBadge = `<div style="margin-top:4px;padding:4px 8px;background:#d1fae5;color:#065f46;border-radius:4px;font-size:10px;font-weight:600">‚úì –£—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ: ${p.processedBy}</div>`;
                            }
                            
                            return `
                            <div style="padding:12px;background:${idx % 2 === 0 ? 'white' : '#f9fafb'};border-bottom:1px solid #e5e7eb">
                            <div style="display:grid;grid-template-columns:20px 90px 1fr 120px;gap:12px;align-items:center">
                                <span style="font-weight:700;color:#64748b">${idx + 1}.</span>
                                <span style="font-size:13px;color:#64748b">${p.date}</span>
                                <span style="font-size:14px;font-weight:600;color:${isRefund ? '#dc2626' : (isPending ? '#f59e0b' : 'inherit')}">${p.method}
                                ${p.payer ? `<br><span style="font-size:12px;color:#64748b;font-weight:500">üë§ ${p.payer}</span>` : ''}
                                </span>
                                <span style="font-weight:700;color:${isRefund ? '#dc2626' : (isPending ? '#f59e0b' : '#059669')};text-align:right;font-size:15px">
                                ${isPending ? '' : (isRefund ? '‚àí' : '')}${isPending ? '0' : displayAmount.toLocaleString('uk-UA')} –≥—Ä–Ω
                                </span>
                            </div>
                            ${statusBadge}
                            </div>
                            `;
                        }).join('');
                        
                        const html = `
                            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center" id="paymentHistoryDialog">
                            <div style="background:white;padding:24px;border-radius:12px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
                                <h3 style="margin:0 0 8px 0">üíµ –Ü—Å—Ç–æ—Ä—ñ—è –ø–ª–∞—Ç–µ–∂—ñ–≤</h3>
                                <div style="color:#64748b;margin-bottom:20px;font-size:14px">${client.name}</div>
                                <div style="border:2px solid #10b981;border-radius:8px;overflow:hidden">
                                ${paymentsHtml}
                                <div style="padding:16px;background:#f0fdf4;border-top:2px solid #10b981;display:flex;justify-content:space-between;align-items:center">
                                    <span style="font-weight:700;color:#065f46;font-size:16px">–í–°–¨–û–ì–û:</span>
                                    <span style="font-weight:700;color:${total >= 0 ? '#059669' : '#dc2626'};font-size:20px">${total.toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                                </div>
                                </div>
                                <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end">
                                <button onclick="closePaymentHistoryDialog()" class="btn">–ó–∞–∫—Ä–∏—Ç–∏</button>
                                </div>
                            </div>
                            </div>
                        `;
                        
                        document.body.insertAdjacentHTML('beforeend', html);
                        };

                        window.closePaymentHistoryDialog = function() {
                        document.getElementById('paymentHistoryDialog')?.remove();
                        };

                        // Refund Dialog
                        window.showRefundDialog = function(clientId) {
                        const client = crmData.clients.find(c => c.id === clientId);
                        if (!client) return;
                        
                        const totalPrice = getClientTotalPrice(client);
                        const alreadyPaid = parseFloat(client.amountPaid || 0);
                        
                        const html = `
                            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center" id="refundDialog">
                            <div style="background:white;padding:24px;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto">
                                <h3 style="margin:0 0 8px 0;color:#dc2626">‚ö†Ô∏è –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –≤—ñ–¥–º–æ–≤–∏</h3>
                                <div style="color:#64748b;margin-bottom:20px;font-size:14px;padding:12px;background:#fef2f2;border-radius:8px">
                                <strong>${client.name}</strong><br>
                                ${client.period} ‚Üí ${client.location} ‚Üí ${client.shift}<br>
                                –°–ø–ª–∞—á–µ–Ω–æ: <strong>${alreadyPaid.toLocaleString('uk-UA')} –≥—Ä–Ω</strong>
                                </div>
                                
                                <div style="margin-bottom:16px">
                                <label style="font-weight:600;display:block;margin-bottom:8px">–¢–∏–ø –≤—ñ–¥–º–æ–≤–∏ *</label>
                                <select id="refundType" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                    <option value="full">–ü–æ–≤–Ω–∞ –≤—ñ–¥–º–æ–≤–∞ (–∫–ª—ñ—î–Ω—Ç –Ω–µ —ó–¥–µ)</option>
                                    <option value="partial">–ß–∞—Å—Ç–∫–æ–≤–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–∫–ª—ñ—î–Ω—Ç —ó–¥–µ, –∞–ª–µ –ø–µ—Ä–µ–ø–ª–∞—Ç–∏–≤)</option>
                                </select>
                                </div>
                                
                                <div style="margin-bottom:16px">
                                <label style="font-weight:600;display:block;margin-bottom:8px">–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏ *</label>
                                <textarea id="refundReason" rows="3" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –°—ñ–º–µ–π–Ω—ñ –æ–±—Å—Ç–∞–≤–∏–Ω–∏, —Ö–≤–æ—Ä–æ–±–∞, –∑–º—ñ–Ω–∞ –ø–ª–∞–Ω—ñ–≤..." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;resize:vertical"></textarea>
                                </div>
                                
                                <div style="margin-bottom:16px">
                                <label style="font-weight:600;display:block;margin-bottom:8px">–°—É–º–∞ –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–≥—Ä–Ω) *</label>
                                <input type="number" id="refundAmount" value="${alreadyPaid}" min="0" step="100" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                </div>
                                
                                <div style="margin-bottom:20px">
                                <label style="font-weight:600;display:block;margin-bottom:8px">–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è *</label>
                                <textarea id="refundDetails" rows="2" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ –∞–±–æ IBAN –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;resize:vertical"></textarea>
                                </div>
                                
                                <div style="display:flex;gap:12px;justify-content:flex-end">
                                <button onclick="closeRefundDialog()" class="mutebtn" style="padding:10px 20px">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                <button onclick="processRefund(${clientId})" class="btn" style="padding:10px 20px;background:#dc2626">–û—Ñ–æ—Ä–º–∏—Ç–∏ –≤—ñ–¥–º–æ–≤—É</button>
                                </div>
                            </div>
                            </div>
                        `;
                        
                        document.body.insertAdjacentHTML('beforeend', html);
                        };

                        window.closeRefundDialog = function() {
                        document.getElementById('refundDialog')?.remove();
                        };

                        window.processRefund = function(clientId) {
                        const client = crmData.clients.find(c => c.id === clientId);
                        if (!client) return;
                        
                        const refundType = document.getElementById('refundType').value;
                        const refundReason = document.getElementById('refundReason').value.trim();
                        const refundAmount = parseFloat(document.getElementById('refundAmount').value || 0);
                        const refundDetails = document.getElementById('refundDetails').value.trim();
                        
                        if (!refundReason) {
                            alert('–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –≤—ñ–¥–º–æ–≤–∏');
                            return;
                        }
                        if (refundAmount < 0) {
                            alert('–°—É–º–∞ –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥‚Äô—î–º–Ω–æ—é');
                            return;
                        }
                        if (refundType === 'partial' && refundAmount <= 0) {
                            alert('–î–ª—è —á–∞—Å—Ç–∫–æ–≤–æ–≥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤–∫–∞–∂—ñ—Ç—å —Å—É–º—É –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è');
                            return;
                        }
                        if (refundAmount > 0 && !refundDetails) {
                            alert('–í–∫–∞–∂—ñ—Ç—å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è');
                            return;
                        }
                        
                        const refund = {
                            id: Date.now(),
                            refundDate: getCurrentDate(),
                            clientName: client.name,
                            clientId: clientId, // Save client ID for future reference
                            period: client.period,
                            location: client.location,
                            shift: client.shift,
                            refundType: refundType,
                            reason: refundReason,
                            amount: refundAmount,
                            details: refundDetails,
                            manager: client.manager,
                            status: 'pending', // pending, processed
                            appliedToClient: false, // Will be true when processed
                            clientData: {...client} // Save full client data for reference
                        };
                        
                        crmData.refunds.push(refund);
                        
                        if (refundType === 'full') {
                            // For full refund, still remove client immediately
                            crmData.clients = crmData.clients.filter(c => c.id !== clientId);
                        } else {
                            // For partial refund, add a pending record to payment history
                            const clientIndex = crmData.clients.findIndex(c => c.id === clientId);
                            if (clientIndex !== -1) {
                            const client = crmData.clients[clientIndex];
                            
                            if (!client.payments) {
                                client.payments = [];
                            }
                            
                            // Add pending refund record (will not affect total until processed)
                            client.payments.push({
                                date: getCurrentDate(),
                                method: '–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è',
                                amount: 0, // Zero amount - doesn't affect total yet
                                refundId: refund.id, // Link to refund record
                                status: 'pending',
                                pendingAmount: refundAmount // Store pending amount for display
                            });
                            
                            crmData.clients[clientIndex] = client;
                            }
                        }
                        
                        saveCRM();
                        closeRefundDialog();
                    renderRefundsView();
                        renderClientsTable();
                        updateRefundsBadge();
                        
                        // Send Telegram notification (placeholder for future integration)
                        sendTelegramNotification(client.name, refundType, refundAmount);
                        
                        alert(`–ó–∞—è–≤–∫—É –Ω–∞ ${refundType === 'full' ? '–ø–æ–≤–Ω—É –≤—ñ–¥–º–æ–≤—É' : '—á–∞—Å—Ç–∫–æ–≤–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è'} —Å—Ç–≤–æ—Ä–µ–Ω–æ!\n\n–ö–ª—ñ—î–Ω—Ç: ${client.name}\n–°—É–º–∞: ${refundAmount} –≥—Ä–Ω\n\n${refundType === 'partial' ? '–°—É–º–∞ –∫–ª—ñ—î–Ω—Ç–∞ –±—É–¥–µ –∑–º–µ–Ω—à–µ–Ω–∞ –ø—ñ—Å–ª—è –æ–±—Ä–æ–±–∫–∏ —Ñ—ñ–Ω. –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.' : ''}`);
                        };

                        window.sendTelegramNotification = function(clientName, refundType, amount) {
                        // TODO: Implement Telegram Bot API integration
                        console.log(`[Telegram Bot] –ù–∞–∂–∞–ª—å ${clientName} ${refundType === 'full' ? '–Ω–µ –∑–º–æ–∂–µ –≤—ñ–¥–≤—ñ–¥–∞—Ç–∏ –Ω–∞—à —Ç–∞–±—ñ—Ä' : '–ø–æ—Ç—Ä–µ–±—É—î —á–∞—Å—Ç–∫–æ–≤–æ–≥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è ' + amount + ' –≥—Ä–Ω'}, –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, –≤—Å—ñ –¥–µ—Ç–∞–ª—ñ –≤ —Å–∏—Å—Ç–µ–º—ñ!`);
                        
                        // Future implementation:
                        // fetch('/api/telegram/send', {
                        //   method: 'POST',
                        //   headers: {'Content-Type': 'application/json'},
                        //   body: JSON.stringify({
                        //     message: `‚ö†Ô∏è –ù–æ–≤–∞ –≤—ñ–¥–º–æ–≤–∞!\n\n–ö–ª—ñ—î–Ω—Ç: ${clientName}\n–¢–∏–ø: ${refundType === 'full' ? '–ü–æ–≤–Ω–∞ –≤—ñ–¥–º–æ–≤–∞' : '–ß–∞—Å—Ç–∫–æ–≤–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è'}\n–°—É–º–∞: ${amount} –≥—Ä–Ω\n\nüíº –í—Å—ñ –¥–µ—Ç–∞–ª—ñ –≤ —Å–∏—Å—Ç–µ–º—ñ CRM`
                        //   })
                        // });
                        };

                        // ===== Finance System =====
                        let financeOperations = JSON.parse(localStorage.getItem('financeOperations') || '[]');

                        // Income categories are automatic from CRM payments
                        const expenseCategories = [
                        '–†–µ–∫–ª–∞–º–∞',
                        '–û–ø–ª–∞—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤',
                        '–ó–∞–ø—É—Å–∫ —Å–µ–∑–æ–Ω—É',
                        '–•–∞—Ä—á—É–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π',
                        '–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏',
                        '–ó–∞—Ä–ø–ª–∞—Ç–∞ –∫–æ–º–∞–Ω–¥–∏',
                        '–ü—Ä–æ–≥—Ä–∞–º–∞',
                        '–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—Å–ª—É–≥–∏',
                        '–¢—Ä–∞–Ω—Å—Ñ–µ—Ä',
                        '–û—Ä–µ–Ω–¥–∞ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è',
                        '–ö–æ–º—É–Ω–∞–ª—å–Ω—ñ –ø–æ—Å–ª—É–≥–∏',
                        '–Ü–Ω–≤–µ–Ω—Ç–∞—Ä —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è',
                        '–ú–µ–¥–∏—á–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è',
                        '–°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è',
                        '–Ü–Ω—à–µ'
                        ];

                        function saveFinanceOperations() {
                        localStorage.setItem('financeOperations', JSON.stringify(financeOperations));
                        }

                        function renderFinanceStats() {
                        const filtered = getFilteredFinanceOperations();
                        
                        let totalIncome = 0;
                        let totalExpenses = 0;

                        // Auto income from CRM (paid amounts)
                        const crmIncome = crmData.clients.reduce((sum, c) => sum + (parseFloat(c.paid) || 0), 0);
                        totalIncome += crmIncome;

                        // Manual operations
                        filtered.forEach(op => {
                            if (op.type === 'income') {
                            totalIncome += parseFloat(op.amount) || 0;
                            } else {
                            totalExpenses += parseFloat(op.amount) || 0;
                            }
                        });

                        const balance = totalIncome - totalExpenses;
                        const profitMargin = totalIncome > 0 ? ((balance / totalIncome) * 100).toFixed(1) : 0;

                        document.getElementById('finTotalIncome').textContent = totalIncome.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('finTotalExpenses').textContent = totalExpenses.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('finBalance').textContent = balance.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('finProfitMargin').textContent = profitMargin + '%';
                        }

                        function getFilteredFinanceOperations() {
                        const planFilter = document.getElementById('finFilterPlan')?.value || '';
                        const typeFilter = document.getElementById('finFilterType')?.value || '';
                        const categoryFilter = document.getElementById('finFilterCategory')?.value || '';
                        const periodFilter = document.getElementById('finFilterPeriod')?.value || 'all';

                        let filtered = financeOperations;

                        if (planFilter) {
                            filtered = filtered.filter(op => op.planId === planFilter);
                        }

                        if (typeFilter) {
                            filtered = filtered.filter(op => op.type === typeFilter);
                        }

                        if (categoryFilter) {
                            filtered = filtered.filter(op => op.category === categoryFilter);
                        }

                        if (periodFilter !== 'all') {
                            const now = new Date();
                            filtered = filtered.filter(op => {
                            const opDate = new Date(op.date);
                            if (periodFilter === 'current-month') {
                                return opDate.getMonth() === now.getMonth() && opDate.getFullYear() === now.getFullYear();
                            } else if (periodFilter === 'last-month') {
                                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                                return opDate.getMonth() === lastMonth.getMonth() && opDate.getFullYear() === lastMonth.getFullYear();
                            } else if (periodFilter === 'current-year') {
                                return opDate.getFullYear() === now.getFullYear();
                            }
                            return true;
                            });
                        }

                        return filtered;
                        }

                        function renderFinanceOperations() {
                        const tbody = document.getElementById('financeOperationsBody');
                        if (!tbody) return; // –Ø–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ–º–∞—î, –ø—Ä–æ—Å—Ç–æ –≤–∏—Ö–æ–¥–∏–º–æ (–Ω–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

                        const filtered = getFilteredFinanceOperations();

                        if (filtered.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏</td></tr>';
                            return;
                        }

                        // Sort by date desc
                        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

                        tbody.innerHTML = filtered.map(op => {
                            const plan = allPlans.find(p => p.id === op.planId);
                            const planName = plan ? plan.name : '‚Äî';
                            const isIncome = op.type === 'income';
                            const typeColor = isIncome ? '#10b981' : '#ef4444';
                            const typeIcon = isIncome ? 'üìà' : 'üìâ';
                            const formattedDate = new Date(op.date).toLocaleDateString('uk-UA');

                            return `
                            <tr style="border-bottom:1px solid #e5e7eb">
                                <td style="padding:12px 8px">${formattedDate}</td>
                                <td style="padding:12px 8px"><span style="color:${typeColor};font-weight:600">${typeIcon} ${isIncome ? '–î–æ—Ö—ñ–¥' : '–í–∏—Ç—Ä–∞—Ç–∞'}</span></td>
                                <td style="padding:12px 8px">${op.category || '‚Äî'}</td>
                                <td style="padding:12px 8px">${planName}</td>
                                <td style="padding:12px 8px;max-width:300px;overflow:hidden;text-overflow:ellipsis">${op.description || '‚Äî'}</td>
                                <td style="padding:12px 8px;text-align:right;font-weight:700;color:${typeColor}">${(parseFloat(op.amount) || 0).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:12px 8px;text-align:center">
                                <button onclick="editFinanceOperation('${op.id}')" class="tiny-btn" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>
                                <button onclick="deleteFinanceOperation('${op.id}')" class="tiny-btn danger" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                                </td>
                            </tr>
                            `;
                        }).join('');

                        renderFinanceStats();
                        }

                        function showAddFinanceOperationModal() {
                        const modal = document.createElement('div');
                        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000';
                        
                        modal.innerHTML = `
                            <div style="background:white;border-radius:16px;padding:32px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto">
                            <h2 style="margin:0 0 24px 0">‚ûï –î–æ–¥–∞—Ç–∏ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—É –æ–ø–µ—Ä–∞—Ü—ñ—é</h2>
                            
                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó *</label>
                                <select id="modalFinType" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="expense">üìâ –í–∏—Ç—Ä–∞—Ç–∞</option>
                                <option value="income">üìà –î–æ—Ö—ñ–¥</option>
                                </select>
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–î–∞—Ç–∞ *</label>
                                <input type="date" id="modalFinDate" 
                                    style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
                                <select id="modalFinCategory" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é...</option>
                                ${expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–ü–ª–∞–Ω (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                                <select id="modalFinPlan" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–ù–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–æ –¥–æ –ø–ª–∞–Ω—É</option>
                                ${allPlans.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–°—É–º–∞ (–≥—Ä–Ω) *</label>
                                <input type="number" id="modalFinAmount" placeholder="0" min="0" step="0.01"
                                    style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                            </div>

                            <div style="margin-bottom:24px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–û–ø–∏—Å</label>
                                <textarea id="modalFinDescription" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–µ—Ä–∞—Ü—ñ—é..."
                                        style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;resize:vertical"></textarea>
                            </div>

                            <div style="display:flex;gap:12px;justify-content:flex-end">
                                <button onclick="this.closest('[style*=fixed]').remove()" class="mutebtn" style="padding:10px 24px">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                <button onclick="saveNewFinanceOperation()" class="btn" style="padding:10px 24px;background:#10b981;color:white">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            </div>
                            </div>
                        `;

                        document.body.appendChild(modal);
                        
                        // Initialize date field
                        document.getElementById('modalFinDate').value = getCurrentDate();
                        
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) modal.remove();
                        });
                        }

                        function saveNewFinanceOperation() {
                        const type = document.getElementById('modalFinType').value;
                        const date = document.getElementById('modalFinDate').value;
                        const category = document.getElementById('modalFinCategory').value;
                        const planId = document.getElementById('modalFinPlan').value;
                        const amount = document.getElementById('modalFinAmount').value;
                        const description = document.getElementById('modalFinDescription').value;

                        if (!date || !category || !amount || parseFloat(amount) <= 0) {
                            alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: –î–∞—Ç–∞, –ö–∞—Ç–µ–≥–æ—Ä—ñ—è, –°—É–º–∞');
                            return;
                        }

                        const operation = {
                            id: Date.now().toString(),
                            type,
                            date,
                            category,
                            planId: planId || null,
                            amount: parseFloat(amount),
                            description,
                            createdAt: new Date().toISOString()
                        };

                        financeOperations.push(operation);
                        saveFinanceOperations();
                        renderFinanceOperations();
                        
                        document.querySelector('[style*="fixed"]').remove();
                        }

                        function editFinanceOperation(id) {
                        const operation = financeOperations.find(op => op.id === id);
                        if (!operation) return;

                        const modal = document.createElement('div');
                        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000';
                        
                        modal.innerHTML = `
                            <div style="background:white;border-radius:16px;padding:32px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto">
                            <h2 style="margin:0 0 24px 0">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é</h2>
                            
                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó *</label>
                                <select id="modalEditFinType" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="expense" ${operation.type === 'expense' ? 'selected' : ''}>üìâ –í–∏—Ç—Ä–∞—Ç–∞</option>
                                <option value="income" ${operation.type === 'income' ? 'selected' : ''}>üìà –î–æ—Ö—ñ–¥</option>
                                </select>
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–î–∞—Ç–∞ *</label>
                                <input type="date" id="modalEditFinDate" value="${operation.date}" 
                                    style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
                                <select id="modalEditFinCategory" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                ${expenseCategories.map(cat => `<option value="${cat}" ${cat === operation.category ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–ü–ª–∞–Ω</label>
                                <select id="modalEditFinPlan" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
                                <option value="">–ù–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–æ</option>
                                ${allPlans.map(p => `<option value="${p.id}" ${p.id === operation.planId ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>

                            <div style="margin-bottom:16px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–°—É–º–∞ (–≥—Ä–Ω) *</label>
                                <input type="number" id="modalEditFinAmount" value="${operation.amount}" min="0" step="0.01"
                                    style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                            </div>

                            <div style="margin-bottom:24px">
                                <label style="display:block;font-weight:700;margin-bottom:8px">–û–ø–∏—Å</label>
                                <textarea id="modalEditFinDescription" rows="3" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;resize:vertical">${operation.description || ''}</textarea>
                            </div>

                            <div style="display:flex;gap:12px;justify-content:flex-end">
                                <button onclick="this.closest('[style*=fixed]').remove()" class="mutebtn" style="padding:10px 24px">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                <button onclick="updateFinanceOperation('${id}')" class="btn" style="padding:10px 24px;background:#10b981;color:white">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            </div>
                            </div>
                        `;

                        document.body.appendChild(modal);
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) modal.remove();
                        });
                        }

                        function updateFinanceOperation(id) {
                        const operation = financeOperations.find(op => op.id === id);
                        if (!operation) return;

                        operation.type = document.getElementById('modalEditFinType').value;
                        operation.date = document.getElementById('modalEditFinDate').value;
                        operation.category = document.getElementById('modalEditFinCategory').value;
                        operation.planId = document.getElementById('modalEditFinPlan').value || null;
                        operation.amount = parseFloat(document.getElementById('modalEditFinAmount').value);
                        operation.description = document.getElementById('modalEditFinDescription').value;

                        saveFinanceOperations();
                        renderFinanceOperations();
                        document.querySelector('[style*="fixed"]').remove();
                        }

                        function deleteFinanceOperation(id) {
                        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –æ–ø–µ—Ä–∞—Ü—ñ—é?')) return;
                        
                        financeOperations = financeOperations.filter(op => op.id !== id);
                        saveFinanceOperations();
                        renderFinanceOperations();
                        }

                        function initFinanceTab() {
                        // Populate plan filter
                        const planFilter = document.getElementById('finFilterPlan');
                        if (planFilter) {
                            planFilter.innerHTML = '<option value="">–í—Å—ñ –ø–ª–∞–Ω–∏</option>' + 
                            allPlans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                        }

                        // Populate category filter
                        const categoryFilter = document.getElementById('finFilterCategory');
                        if (categoryFilter) {
                            categoryFilter.innerHTML = '<option value="">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>' + 
                            expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                        }

                        // Add event listeners
                        document.getElementById('addFinanceOperation')?.addEventListener('click', showAddFinanceOperationModal);
                        document.getElementById('finFilterPlan')?.addEventListener('change', renderFinanceOperations);
                        document.getElementById('finFilterType')?.addEventListener('change', renderFinanceOperations);
                        document.getElementById('finFilterCategory')?.addEventListener('change', renderFinanceOperations);
                        document.getElementById('finFilterPeriod')?.addEventListener('change', renderFinanceOperations);

                        renderFinanceOperations();
                        }

                        // Refunds navigation state
                        let refundNav = { period: null, location: null, shift: null };

                        function renderRefundsBreadcrumb() {
                        const bc = document.getElementById('crmRefundsBreadcrumb');
                        const parts = [];
                        parts.push(`<a href="#" onclick="event.preventDefault();setRefundNav(null,null,null)" style="color:#1e40af;text-decoration:none;font-weight:600">–ü–µ—Ä—ñ–æ–¥–∏</a>`);
                        if (refundNav.period) {
                            parts.push(`<span style="margin:0 6px">‚Ä∫</span><a href="#" onclick="event.preventDefault();setRefundNav('${encodeURIComponent(refundNav.period)}',null,null)" style="color:#1e40af;text-decoration:none;font-weight:600">${refundNav.period}</a>`);
                        }
                        if (refundNav.location) {
                            parts.push(`<span style="margin:0 6px">‚Ä∫</span><a href="#" onclick="event.preventDefault();setRefundNav('${encodeURIComponent(refundNav.period)}','${encodeURIComponent(refundNav.location)}',null)" style="color:#1e40af;text-decoration:none;font-weight:600">${refundNav.location}</a>`);
                        }
                        if (refundNav.shift) {
                            parts.push(`<span style="margin:0 6px">‚Ä∫</span><span style="font-weight:700;color:#0f172a">${refundNav.shift}</span>`);
                        }
                        bc.innerHTML = parts.join(' ');
                        }

                        function setRefundNav(period, location, shift) {
                        refundNav = {
                            period: period ? decodeURIComponent(period) : null,
                            location: location ? decodeURIComponent(location) : null,
                            shift: shift ? decodeURIComponent(shift) : null
                        };
                        renderRefundsView();
                        }

                        function renderRefundsNavigator() {
                        const nav = document.getElementById('crmRefundsNavigator');
                        const makeCard = (title, count, onClick) => `
                            <div onclick="${onClick}" style="cursor:pointer;padding:14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center">
                            <div style="font-weight:700;color:#0f172a">${title}</div>
                            ${count>0 ? `<span style=\"padding:4px 8px;background:#fee2e2;color:#991b1b;border-radius:999px;font-size:12px;font-weight:700\">—î ${count} –Ω–µ –æ–ø–ª–∞—á.</span>` : `<span style=\"padding:4px 8px;background:#f1f5f9;color:#64748b;border-radius:999px;font-size:12px\">0</span>`}
                            </div>`;

                        if (!refundNav.period) {
                            // Show periods
                            const periods = (crmData.periods && crmData.periods.length>0) ? crmData.periods : [...new Set(crmData.refunds.map(r=>r.period))];
                            if (!periods || periods.length===0) {
                            nav.innerHTML = '<div style="padding:20px;background:#f8fafc;border-radius:8px;color:#64748b;text-align:center">–ù–µ–º–∞—î –ø–µ—Ä—ñ–æ–¥—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>';
                            return;
                            }
                            nav.innerHTML = periods.map(p => {
                            const count = crmData.refunds.filter(r=>r.period===p && r.status === 'pending' && (parseFloat(r.amount||0) > 0)).length;
                            return makeCard(p, count, `setRefundNav('${encodeURIComponent(p)}',null,null)`);
                            }).join('');
                            return;
                        }

                        if (refundNav.period && !refundNav.location) {
                            // Show locations for period
                            const locations = crmData.locations[refundNav.period] || [];
                            if (locations.length===0) {
                            nav.innerHTML = '<div style="padding:20px;background:#f8fafc;border-radius:8px;color:#64748b;text-align:center">–ù–µ–º–∞—î –ª–æ–∫–∞—Ü—ñ–π –¥–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É</div>';
                            return;
                            }
                            nav.innerHTML = locations.map(loc => {
                            const count = crmData.refunds.filter(r=>r.period===refundNav.period && r.location===loc && r.status === 'pending' && (parseFloat(r.amount||0) > 0)).length;
                            return makeCard(loc, count, `setRefundNav('${encodeURIComponent(refundNav.period)}','${encodeURIComponent(loc)}',null)`);
                            }).join('');
                            return;
                        }

                        if (refundNav.period && refundNav.location && !refundNav.shift) {
                            // Show shifts for location
                            const key = `${refundNav.period}|${refundNav.location}`;
                            const shifts = crmData.shifts[key] || [];
                            if (shifts.length===0) {
                            nav.innerHTML = '<div style="padding:20px;background:#f8fafc;border-radius:8px;color:#64748b;text-align:center">–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è —Ü—ñ—î—ó –ª–æ–∫–∞—Ü—ñ—ó</div>';
                            return;
                            }
                            nav.innerHTML = shifts.map(sh => {
                            const count = crmData.refunds.filter(r=>r.period===refundNav.period && r.location===refundNav.location && r.shift===sh && r.status === 'pending' && (parseFloat(r.amount||0) > 0)).length;
                            return makeCard(sh, count, `setRefundNav('${encodeURIComponent(refundNav.period)}','${encodeURIComponent(refundNav.location)}','${encodeURIComponent(sh)}')`);
                            }).join('');
                            return;
                        }

                        // If shift selected, hide navigator (table will show)
                        nav.innerHTML = '';
                        }

                        function getFilteredRefunds() {
                        return crmData.refunds.filter(r =>
                            (!refundNav.period || r.period === refundNav.period) &&
                            (!refundNav.location || r.location === refundNav.location) &&
                            (!refundNav.shift || r.shift === refundNav.shift)
                        );
                        }

                        function renderRefundsTable(list) {
                        const tbody = document.getElementById('crmRefundsTableBody');
                        const data = list || getFilteredRefunds();
                        
                        if (!data || data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="11" style="padding:40px;text-align:center;color:#94a3b8">–í—ñ–¥–º–æ–≤ –Ω–µ–º–∞—î –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è</td></tr>';
                            updateRefundsStats();
                            return;
                        }
                        
                        tbody.innerHTML = data.map((refund, idx) => `
                            <tr style="border-bottom:1px solid #fecaca;background:${idx % 2 === 0 ? 'white' : '#fef2f2'}">
                            <td style="padding:10px 8px">${idx + 1}</td>
                            <td style="padding:10px 8px">${refund.refundDate}</td>
                            <td style="padding:10px 8px;font-weight:600">${refund.clientName}</td>
                            <td style="padding:10px 8px;font-size:11px">${refund.period}<br>${refund.location}<br>${refund.shift}</td>
                            <td style="padding:10px 8px">
                                <span style="padding:4px 8px;background:${refund.refundType === 'full' ? '#fecaca' : '#fed7aa'};color:${refund.refundType === 'full' ? '#991b1b' : '#9a3412'};border-radius:6px;font-size:11px;font-weight:600">
                                ${refund.refundType === 'full' ? '–ü–æ–≤–Ω–∞' : '–ß–∞—Å—Ç–∫–æ–≤–∞'}
                                </span>
                            </td>
                            <td style="padding:10px 8px;font-size:12px;max-width:200px">${refund.reason}</td>
                            <td style="padding:10px 8px;font-weight:700;color:#dc2626">${parseFloat(refund.amount).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                            <td style="padding:10px 8px;font-size:11px;max-width:150px;overflow:hidden;text-overflow:ellipsis" title="${refund.details}">${refund.details}</td>
                            <td style="padding:10px 8px;font-size:11px">${refund.manager || '‚Äî'}</td>
                            <td style="padding:10px 8px">
                                <button onclick="toggleRefundStatus(${refund.id})" style="padding:4px 8px;background:${refund.status === 'processed' ? '#10b981' : '#f59e0b'};color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px">
                                ${refund.status === 'processed' ? '‚úì –û–±—Ä–æ–±–ª–µ–Ω–æ' : '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—ñ'}
                                </button>
                            </td>
                            <td style="padding:10px 8px">
                                <button onclick="deleteRefund(${refund.id})" style="padding:4px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px">üóëÔ∏è</button>
                            </td>
                            </tr>
                        `).join('');
                        
                        updateRefundsStats();
                        }

                        function renderRefundsView() {
                        // Always update overall stats
                        updateRefundsStats();
                        renderRefundsBreadcrumb();
                        renderRefundsNavigator();
                        const tableContainer = document.getElementById('crmRefundsTableContainer');
                        if (refundNav.shift) {
                            tableContainer.style.display = 'block';
                            renderRefundsTable();
                        } else {
                            tableContainer.style.display = 'none';
                        }
                        }


                        window.toggleRefundStatus = function(refundId) {
                        const refund = crmData.refunds.find(r => r.id === refundId);
                        if (!refund) return;
                        
                        const newStatus = refund.status === 'pending' ? 'processed' : 'pending';
                        
                        if (newStatus === 'processed' && !refund.appliedToClient) {
                            // Apply refund when marking as processed
                            if (refund.refundType === 'partial' && refund.clientId) {
                            const clientIndex = crmData.clients.findIndex(c => c.id === refund.clientId);
                            
                            if (clientIndex !== -1) {
                                const client = crmData.clients[clientIndex];
                                
                                // Find and update the pending payment record
                                if (client.payments) {
                                const pendingPaymentIndex = client.payments.findIndex(p => p.refundId === refundId && p.status === 'pending');
                                
                                if (pendingPaymentIndex !== -1) {
                                    // Update pending record to actual refund
                                    client.payments[pendingPaymentIndex] = {
                                    date: getCurrentDate(),
                                    method: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–æ–±—Ä–æ–±–ª–µ–Ω–æ)',
                                    amount: -refund.amount, // Apply negative amount
                                    refundId: refund.id,
                                    status: 'processed',
                                    processedBy: '–§—ñ–Ω. –º–µ–Ω–µ–¥–∂–µ—Ä'
                                    };
                                } else {
                                    // If no pending record found, add processed refund
                                    client.payments.push({
                                    date: getCurrentDate(),
                                    method: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–æ–±—Ä–æ–±–ª–µ–Ω–æ)',
                                    amount: -refund.amount,
                                    refundId: refund.id,
                                    status: 'processed',
                                    processedBy: '–§—ñ–Ω. –º–µ–Ω–µ–¥–∂–µ—Ä'
                                    });
                                }
                                
                                // Recalculate total amount paid
                                const totalPaid = client.payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                client.amountPaid = totalPaid;
                                
                                // Recalculate payment status
                                const totalPrice = getClientTotalPrice(client);
                                if (totalPaid >= totalPrice) {
                                    client.paymentStatus = '–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞';
                                } else if (totalPaid > 0) {
                                    client.paymentStatus = '–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ';
                                } else {
                                    client.paymentStatus = '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                                }
                                
                                crmData.clients[clientIndex] = client;
                                refund.appliedToClient = true;
                                }
                            }
                            }
                        } else if (newStatus === 'pending' && refund.appliedToClient) {
                            // Reverse the refund if marking as pending again
                            if (refund.refundType === 'partial' && refund.clientId) {
                            const clientIndex = crmData.clients.findIndex(c => c.id === refund.clientId);
                            
                            if (clientIndex !== -1) {
                                const client = crmData.clients[clientIndex];
                                
                                if (client.payments) {
                                // Find and revert the processed payment
                                const processedPaymentIndex = client.payments.findIndex(p => p.refundId === refundId && p.status === 'processed');
                                
                                if (processedPaymentIndex !== -1) {
                                    // Change back to pending
                                    client.payments[processedPaymentIndex] = {
                                    date: client.payments[processedPaymentIndex].date,
                                    method: '–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è',
                                    amount: 0, // Zero amount again
                                    refundId: refund.id,
                                    status: 'pending',
                                    pendingAmount: refund.amount
                                    };
                                    
                                    // Recalculate
                                    const totalPaid = client.payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                    client.amountPaid = totalPaid;
                                    
                                    const totalPrice = getClientTotalPrice(client);
                                    if (totalPaid >= totalPrice) {
                                    client.paymentStatus = '–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞';
                                    } else if (totalPaid > 0) {
                                    client.paymentStatus = '–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ';
                                    } else {
                                    client.paymentStatus = '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                                    }
                                    
                                    crmData.clients[clientIndex] = client;
                                    refund.appliedToClient = false;
                                }
                                }
                            }
                            }
                        }
                        
                        refund.status = newStatus;
                        saveCRM();
                    renderRefundsView();
                        renderClientsTable();
                        updateRefundsBadge();
                        };

                        window.deleteRefund = function(refundId) {
                        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å –ø—Ä–æ –≤—ñ–¥–º–æ–≤—É?')) {
                            crmData.refunds = crmData.refunds.filter(r => r.id !== refundId);
                            saveCRM();
                    renderRefundsView();
                            updateRefundsBadge();
                        }
                        };

                        document.getElementById('exportClients')?.addEventListener('click', () => {
                        const period = document.getElementById('crmPeriod').value;
                        const location = document.getElementById('crmLocation').value;
                        const shift = document.getElementById('crmShift').value;
                        const filtered = crmData.clients.filter(c => 
                            (!period || c.period === period) && 
                            (!location || c.location === location) && 
                            (!shift || c.shift === shift)
                        );
                        
                        const csv = '–ü–µ—Ä—ñ–æ–¥,–õ–æ–∫–∞—Ü—ñ—è,–ó–º—ñ–Ω–∞,‚Ññ,–ü–Ü–ë,–°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏,–°—É–º–∞ –≤–Ω–µ—Å–µ–Ω–∞,–ó–Ω–∏–∂–∫–∞,–í–∞—Ä—Ç—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—É,–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è,–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞,–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É,–ú—ñ—Å—Ç–æ,–¢–∏–ø,–ú–µ–Ω–µ–¥–∂–µ—Ä,–ö–æ–º–µ–Ω—Ç–∞—Ä\n' +
                            filtered.map((c, idx) => `"${c.period}","${c.location}","${c.shift}",${idx+1},"${c.name}","${c.paymentStatus}",${c.amountPaid},"${c.discount}",${c.transferCost},"${c.birthDate}","${c.contactPerson}","${c.phone}","${c.city}","${c.clientType}","${c.manager}","${c.comment}"`).join('\n');
                        
                        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `clients_${period}_${location}_${shift}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                        });

                        // ===== Import from Google Sheets/CSV =====
                        document.getElementById('importClients')?.addEventListener('click', showImportDialog);

                        function showImportDialog() {
                        const html = `
                            <div id="importDialog" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center">
                            <div style="background:#fff;padding:20px;border-radius:12px;max-width:720px;width:92%;max-height:90vh;overflow:auto">
                                <h3 style="margin:0 0 12px 0">üì§ –Ü–º–ø–æ—Ä—Ç –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ Google Sheets/CSV</h3>
                                <div style="color:#64748b;font-size:13px;margin-bottom:12px">
                                –û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥/–ª–æ–∫–∞—Ü—ñ—é/–∑–º—ñ–Ω—É –∑–≤–µ—Ä—Ö—É ‚Äî —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —Å–∞–º–µ —Ç—É–¥–∏. –ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–∏: ¬´–ü–Ü–ë, –°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏, –°—É–º–∞ –≤–Ω–µ—Å–µ–Ω–∞, –ó–Ω–∏–∂–∫–∞, –í–∞—Ä—Ç—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—É, –î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, –î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞, –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É, –¢—Ä–∞–Ω—Å—Ñ–µ—Ä —Ç—É–¥–∏, –¢—Ä–∞–Ω—Å—Ñ–µ—Ä –Ω–∞–∑–∞–¥, –ú—ñ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è, –ö–æ–º–µ–Ω—Ç–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞, —Å—Ç–∞—Ä–∏–π —á–∏ –Ω–æ–≤–∏–π –ª—ñ–¥, –ú–µ–Ω–µ–¥–∂–µ—Ä¬ª.
                                </div>
                                <div style="display:grid;grid-template-columns:1fr;gap:14px">
                                <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px">
                                    <div style="font-weight:600;margin-bottom:8px">–í—Å—Ç–∞–≤–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ Google Sheets (CSV)</div>
                                    <input id="importUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../edit#gid=... –∞–±–æ export?format=csv&gid=..." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                                    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                                    <button class="btn" style="padding:8px 14px" onclick="startImportFromUrl()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>
                                    <span style="font-size:12px;color:#64748b">–ü–æ—Ä–∞–¥–∞: –£ Google Sheets –æ–±–µ—Ä—ñ—Ç—å –§–∞–π–ª ‚Üí –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ ‚Üí CSV, –∞–±–æ –∑–∞–º—ñ–Ω—ñ—Ç—å /edit#gid=... –Ω–∞ /export?format=csv&gid=...</span>
                                    </div>
                                </div>
                                <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px">
                                    <div style="font-weight:600;margin-bottom:8px">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV —Ñ–∞–π–ª</div>
                                    <input id="importFile" type="file" accept=".csv" style="width:100%" />
                                    <div style="margin-top:8px">
                                    <button class="btn" style="padding:8px 14px" onclick="startImportFromFile()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª</button>
                                    </div>
                                </div>
                                </div>
                                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
                                <button class="mutebtn" onclick="closeImportDialog()">–ó–∞–∫—Ä–∏—Ç–∏</button>
                                </div>
                            </div>
                            </div>`;
                        document.body.insertAdjacentHTML('beforeend', html);
                        }

                        window.closeImportDialog = function() {
                        document.getElementById('importDialog')?.remove();
                        }

                        function convertGoogleSheetsToCsvUrl(url) {
                        try {
                            if (!url) return '';
                            if (url.includes('/export?format=csv')) return url;
                            // Convert /edit#gid= to /export?format=csv&gid=
                            const m = url.match(/\/d\/([a-zA-Z0-9-_]+)\//);
                            const gid = (url.match(/gid=(\d+)/) || [])[1] || '0';
                            const docId = m ? m[1] : null;
                            if (docId) return 'https://docs.google.com/spreadsheets/d/' + docId + '/export?format=csv&gid=' + gid;
                            return url;
                        } catch { return url; }
                        }

                        function parseUaNumber(val) {
                        if (val === undefined || val === null) return 0;
                        const s = String(val).replace(/\s/g,'').replace(/,/g,'.');
                        const n = parseFloat(s);
                        return isNaN(n) ? 0 : n;
                        }

                        function toIsoDate(ua) {
                        if (!ua) return '';
                        const s = String(ua).trim();
                        // If already ISO-like
                        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                        // dd.mm.yyyy
                        let m = s.match(/^(\d{1,2})[\.\/-](\d{1,2})[\.\/-](\d{2,4})$/);
                        if (m) {
                            let [_, d, mo, y] = m;
                            if (y.length === 2) y = '20' + y;
                            d = d.padStart(2,'0'); mo = mo.padStart(2,'0');
                            return `${y}-${mo}-${d}`;
                        }
                        // dd.mm (assume current year)
                        m = s.match(/^(\d{1,2})[\.\/-](\d{1,2})$/);
                        if (m) {
                            const nowY = String(new Date().getFullYear());
                            const d = m[1].padStart(2,'0');
                            const mo = m[2].padStart(2,'0');
                            return `${nowY}-${mo}-${d}`;
                        }
                        return '';
                        }

                        function normalizeTransferLabel(val) {
                        if (!val) return '';
                        let s = String(val).trim();
                        // Remove words like '—Ç–∞–±—ñ—Ä-' or '-—Ç–∞–±—ñ—Ä' and arrows/dashes
                        s = s.replace(/—Ç–∞–±—ñ—Ä-?/gi,'').replace(/-?—Ç–∞–±—ñ—Ä/gi,'');
                        s = s.replace(/[‚Üí‚Äì‚Äî-]/g,' ').replace(/\s+/g,' ').trim();
                        return s;
                        }

                        function deriveTransferCostIfMissing(row) {
                        // Try to compute from settings by matching normalized names
                        let total = 0;
                        const toName = normalizeTransferLabel(row['–¢—Ä–∞–Ω—Å—Ñ–µ—Ä —Ç—É–¥–∏']);
                        const fromName = normalizeTransferLabel(row['–¢—Ä–∞–Ω—Å—Ñ–µ—Ä –Ω–∞–∑–∞–¥']);
                        if (toName) {
                            const t = (settings.transferTo||[]).find(x => String(x.location).trim().toLowerCase() === toName.toLowerCase());
                            if (t) total += Number(t.price)||0;
                        }
                        if (fromName) {
                            const t = (settings.transferFrom||[]).find(x => String(x.location).trim().toLowerCase() === fromName.toLowerCase());
                            if (t) total += Number(t.price)||0;
                        }
                        return total;
                        }

                        function mapRowToClient(row, period, location, shift, idBase) {
                        // Column keys expected in Ukrainian
                        const name = (row['–ü–Ü–ë'] || '').toString().trim();
                        if (!name) return null;
                        const paymentStatus = (row['–°—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏'] || '').toString().trim() || '–ù–∞–¥—ñ—Å–ª–∞–Ω—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏';
                        const amountPaid = parseUaNumber(row['–°—É–º–∞ –≤–Ω–µ—Å–µ–Ω–∞']);
                        const discount = (row['–ó–Ω–∏–∂–∫–∞'] || '–ë–µ–∑ –∑–Ω–∏–∂–∫–∏').toString().trim();
                        let transferCost = parseUaNumber(row['–í–∞—Ä—Ç—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—É']);
                        const createdAt = toIsoDate(row['–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è']) || new Date().toISOString();
                        const birthDate = toIsoDate(row['–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è']);
                        const contactPerson = (row['–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞'] || '').toString().trim();
                        const phone = (row['–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É'] || '').toString().trim();
                        const transferTo = normalizeTransferLabel(row['–¢—Ä–∞–Ω—Å—Ñ–µ—Ä —Ç—É–¥–∏']);
                        const transferFrom = normalizeTransferLabel(row['–¢—Ä–∞–Ω—Å—Ñ–µ—Ä –Ω–∞–∑–∞–¥']);
                        const city = (row['–ú—ñ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è'] || '').toString().trim();
                        const comment = (row['–ö–æ–º–µ–Ω—Ç–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞'] || '').toString().trim();
                        let clientType = (row['—Å—Ç–∞—Ä–∏–π —á–∏ –Ω–æ–≤–∏–π –ª—ñ–¥'] || '').toString().trim().toLowerCase();
                        const manager = (row['–ú–µ–Ω–µ–¥–∂–µ—Ä'] || '').toString().trim();

                        if (!transferCost) transferCost = deriveTransferCostIfMissing(row);

                        if (clientType === '–æ–ª–¥' || clientType === '—Å—Ç–∞—Ä–∏–π' || clientType.includes('—Å—Ç–∞—Ä')) clientType = '—Å—Ç–∞—Ä–∏–π';
                        else if (clientType.includes('–Ω–æ–≤')) clientType = '–Ω–æ–≤–∏–π';
                        else clientType = '–Ω–æ–≤–∏–π';

                        return {
                            id: idBase,
                            period,
                            location,
                            shift,
                            name,
                            paymentStatus,
                            amountPaid,
                            payments: [],
                            discount,
                            transferCost,
                            transferTo,
                            transferFrom,
                            birthDate,
                            contactPerson,
                            phone,
                            city,
                            clientType,
                            manager,
                            comment,
                            createdAt
                        };
                        }

                        function importRows(rows) {
                        const period = document.getElementById('crmPeriod')?.value;
                        const location = document.getElementById('crmLocation')?.value;
                        const shift = document.getElementById('crmShift')?.value;
                        if (!period || !location || !shift) {
                            alert('–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥, –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ –∑–º—ñ–Ω—É –ø–µ—Ä–µ–¥ —ñ–º–ø–æ—Ä—Ç–æ–º.');
                            return;
                        }

                        let added = 0, updated = 0;
                        rows.forEach((row, idx) => {
                            const client = mapRowToClient(row, period, location, shift, Date.now() + idx);
                            if (!client) return;
                            // Try deduplicate by phone (preferred) or name within same shift
                            let existingIdx = -1;
                            if (client.phone) existingIdx = crmData.clients.findIndex(c => c.period===period && c.location===location && c.shift===shift && c.phone && c.phone === client.phone);
                            if (existingIdx === -1) existingIdx = crmData.clients.findIndex(c => c.period===period && c.location===location && c.shift===shift && c.name === client.name);
                            if (existingIdx >= 0) {
                            // Update existing basic fields, keep existing payments
                            const keepPayments = crmData.clients[existingIdx].payments || [];
                            crmData.clients[existingIdx] = { ...crmData.clients[existingIdx], ...client, payments: keepPayments };
                            updated++;
                            } else {
                            crmData.clients.push(client);
                            added++;
                            }
                        });

                        saveCRM();
                        renderClientsTable();
                        updateCRMStats();
                        alert(`–Ü–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –î–æ–¥–∞–Ω–æ: ${added}, –æ–Ω–æ–≤–ª–µ–Ω–æ: ${updated}.`);
                        closeImportDialog();
                        }

                        window.startImportFromUrl = function() {
                        const rawUrl = document.getElementById('importUrl')?.value.trim();
                        if (!rawUrl) { alert('–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è'); return; }
                        const url = convertGoogleSheetsToCsvUrl(rawUrl);
                        Papa.parse(url, {
                            download: true,
                            header: true,
                            skipEmptyLines: true,
                            complete: (res) => {
                            if (!res || !res.data) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –¥–∞–Ω—ñ'); return; }
                            importRows(res.data);
                            },
                            error: (err) => {
                            console.error(err);
                            alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è CSV. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å/–ø—É–±–ª—ñ–∫–∞—Ü—ñ—é —Ç–∞–±–ª–∏—Ü—ñ.');
                            }
                        });
                        }

                        window.startImportFromFile = function() {
                        const fileInput = document.getElementById('importFile');
                        const file = fileInput?.files?.[0];
                        if (!file) { alert('–û–±–µ—Ä—ñ—Ç—å CSV —Ñ–∞–π–ª'); return; }
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (res) => {
                            if (!res || !res.data) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª'); return; }
                            importRows(res.data);
                            },
                            error: (err) => {
                            console.error(err);
                            alert('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è CSV —Ñ–∞–π–ª—É');
                            }
                        });
                        }

                        // Initialize CRM
                        updatePeriodSelect();
                        updateLocationSelect();
                        updateShiftSelect();
                        updateManagerFilter();
                        updateCRMStats();
                        updateActiveSeasonsStats();

                        // Add event listeners for CRM filters and search
                        document.getElementById('crmPeriod')?.addEventListener('change', () => {
                        updateLocationSelect();
                        updateShiftSelect();
                        renderClientsTable();
                        updateCRMStats();
                        });

                        document.getElementById('crmLocation')?.addEventListener('change', () => {
                        updateShiftSelect();
                        renderClientsTable();
                        updateCRMStats();
                        });

                        document.getElementById('crmShift')?.addEventListener('change', () => {
                        renderClientsTable();
                        updateCRMStats();
                        });

                        document.getElementById('clientSearch')?.addEventListener('input', () => {
                        renderClientsTable();
                        });

                        // Filter event listeners
                        document.getElementById('filterPaymentStatus')?.addEventListener('change', renderClientsTable);
                        document.getElementById('filterClientType')?.addEventListener('change', renderClientsTable);
                        document.getElementById('filterDiscount')?.addEventListener('change', renderClientsTable);
                        document.getElementById('filterManager')?.addEventListener('change', renderClientsTable);

                        // Clear filters button
                        document.getElementById('clearFilters')?.addEventListener('click', () => {
                        document.getElementById('clientSearch').value = '';
                        document.getElementById('filterPaymentStatus').value = '';
                        document.getElementById('filterClientType').value = '';
                        document.getElementById('filterDiscount').value = '';
                        document.getElementById('filterManager').value = '';
                        renderClientsTable();
                        });

                        // CRM action buttons
                        document.getElementById('clientManagementBtn')?.addEventListener('click', handleClientManagement);
                        document.getElementById('refundsBtn')?.addEventListener('click', handleRefunds);

                    // Initialize refunds view (navigator + table)
                    renderRefundsView();

                        // ===== Analytics Tab =====
                        let analyticsSalesChart = null;
                        let analyticsRevenueChart = null;

                        function updateAnalyticsPeriodFilter() {
                        const select = document.getElementById('analyticsPeriodFilter');
                        if (!select) return;
                        
                        console.log('üìä –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥—ñ–≤ –≤ –∞–Ω–∞–ª—ñ—Ç–∏—Ü—ñ...');
                        const currentValue = select.value;
                        
                        // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏ –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞
                        const allPeriods = new Set();
                        allPlans.forEach(plan => {
                            if (plan.periods && plan.periods.length > 0) {
                                plan.periods.forEach(period => {
                                    const periodName = typeof period === 'string' ? period : period.periodName;
                                    if (periodName) {
                                        allPeriods.add(periodName);
                                    }
                                });
                            }
                        });
                        
                        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä
                        select.innerHTML = '<option value="">–í—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏</option>';
                        Array.from(allPeriods).sort().forEach(periodName => {
                            const option = document.createElement('option');
                            option.value = periodName;
                            option.textContent = periodName;
                            select.appendChild(option);
                        });
                        
                        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–∞–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
                        if (currentValue && allPeriods.has(currentValue)) {
                            select.value = currentValue;
                        }
                        
                        console.log(`üìä –î–æ–¥–∞–Ω–æ ${allPeriods.size} –ø–µ—Ä—ñ–æ–¥—ñ–≤ –≤ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É:`, Array.from(allPeriods));
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –∑ —ñ–Ω—à–∏–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏ (—Ç–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ)
                        // if (typeof syncPeriodSelection === 'function') {
                        //     setTimeout(syncPeriodSelection, 50);
                        // }
                        }

                        function updateAnalyticsLocationFilter() {
                        const select = document.getElementById('analyticsLocationFilter');
                        const periodFilter = document.getElementById('analyticsPeriodFilter')?.value;
                        if (!select) return;
                        
                        console.log('üìä –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ–π –≤ –∞–Ω–∞–ª—ñ—Ç–∏—Ü—ñ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É:', periodFilter);
                        select.innerHTML = '<option value="">–í—Å—ñ –ª–æ–∫–∞—Ü—ñ—ó</option>';
                        
                        if (periodFilter) {
                            // –®—É–∫–∞—î–º–æ –ø–ª–∞–Ω –∑ —Ü–∏–º –ø–µ—Ä—ñ–æ–¥–æ–º
                            const planWithPeriod = allPlans.find(plan => 
                                plan.periods?.some(period => {
                                    const periodName = typeof period === 'string' ? period : period.periodName;
                                    return periodName === periodFilter;
                                })
                            );
                            
                            if (planWithPeriod) {
                                const foundPeriod = planWithPeriod.periods.find(period => {
                                    const periodName = typeof period === 'string' ? period : period.periodName;
                                    return periodName === periodFilter;
                                });
                                
                                if (foundPeriod && typeof foundPeriod !== 'string' && foundPeriod.locations) {
                                    foundPeriod.locations.forEach(location => {
                                        if (location.locationName) {
                                            const option = document.createElement('option');
                                            option.value = location.locationName;
                                            option.textContent = location.locationName;
                                            select.appendChild(option);
                                        }
                                    });
                                    console.log(`üìä –î–æ–¥–∞–Ω–æ ${foundPeriod.locations.length} –ª–æ–∫–∞—Ü—ñ–π –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É "${periodFilter}"`);
                                }
                            }
                        } else {
                            // –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –ª–æ–∫–∞—Ü—ñ—ó –∑ —É—Å—ñ—Ö –ø–ª–∞–Ω—ñ–≤
                            const allLocations = new Set();
                            allPlans.forEach(plan => {
                                if (plan.periods) {
                                    plan.periods.forEach(period => {
                                        if (typeof period !== 'string' && period.locations) {
                                            period.locations.forEach(location => {
                                                if (location.locationName) {
                                                    allLocations.add(location.locationName);
                                                }
                                            });
                                        }
                                    });
                                }
                            });
                            
                            Array.from(allLocations).sort().forEach(locationName => {
                                const option = document.createElement('option');
                                option.value = locationName;
                                option.textContent = locationName;
                                select.appendChild(option);
                            });
                            
                            console.log(`üìä –î–æ–¥–∞–Ω–æ ${allLocations.size} —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –ª–æ–∫–∞—Ü—ñ–π –∑ —É—Å—ñ—Ö –ø–ª–∞–Ω—ñ–≤`);
                        }
                        }

                        // Analytics tabs switching - make it global
                        window.switchAnalyticsTab = function(tabName) {
                        // Hide all analytics sections with display: none
                        const sections = [
                            'salesAnalyticsSection',
                            'financialAnalyticsSection', 
                            'profitabilityAnalyticsSection',
                            'pnlAnalyticsSection',
                            'kpiAnalyticsSection',
                            'planVsFactAnalyticsSection'
                        ];
                        
                        sections.forEach(sectionId => {
                            const section = document.getElementById(sectionId);
                            if (section) {
                                section.style.display = 'none';
                                section.style.visibility = 'hidden';
                                section.style.height = '0';
                                section.style.overflow = 'hidden';
                            }
                        });
                        
                        // Remove active class from all buttons
                        document.querySelectorAll('.analytics-tab-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Show selected section and activate button
                        if (tabName === 'sales') {
                            const section = document.getElementById('salesAnalyticsSection');
                            if (section) {
                                section.style.display = 'block';
                                section.style.visibility = 'visible';
                                section.style.height = 'auto';
                                section.style.overflow = 'visible';
                            }
                            document.getElementById('salesAnalyticsBtn').classList.add('active');
                            updateSalesAnalytics();
                        } else if (tabName === 'financial') {
                            const section = document.getElementById('financialAnalyticsSection');
                            if (section) {
                                section.style.display = 'block';
                                section.style.visibility = 'visible';
                                section.style.height = 'auto';
                                section.style.overflow = 'visible';
                            }
                            document.getElementById('financialAnalyticsBtn').classList.add('active');
                            updateFinancialAnalytics();
                        } else if (tabName === 'profitability') {
                            const section = document.getElementById('profitabilityAnalyticsSection');
                            if (section) {
                                section.style.display = 'block';
                                section.style.visibility = 'visible';
                                section.style.height = 'auto';
                                section.style.overflow = 'visible';
                            }
                            document.getElementById('profitabilityAnalyticsBtn').classList.add('active');
                            updateProfitabilityPeriodFilter();
                            updateProfitabilityAnalytics();
                        } else if (tabName === 'pnl') {
                            const section = document.getElementById('pnlAnalyticsSection');
                            if (section) {
                                section.style.display = 'block';
                                section.style.visibility = 'visible';
                                section.style.height = 'auto';
                                section.style.overflow = 'visible';
                            }
                            document.getElementById('pnlAnalyticsBtn').classList.add('active');
                            updatePnlAnalytics();
                        } else if (tabName === 'kpi') {
                            const section = document.getElementById('kpiAnalyticsSection');
                            if (section) {
                                section.style.display = 'block';
                                section.style.visibility = 'visible';
                                section.style.height = 'auto';
                                section.style.overflow = 'visible';
                            }
                            document.getElementById('kpiAnalyticsBtn').classList.add('active');
                            updateKPIAnalytics();
                        } else if (tabName === 'planVsFact') {
                            const section = document.getElementById('planVsFactAnalyticsSection');
                            if (section) {
                                section.style.display = 'block';
                                section.style.visibility = 'visible';
                                section.style.height = 'auto';
                                section.style.overflow = 'visible';
                            }
                            document.getElementById('planVsFactAnalyticsBtn').classList.add('active');
                            initPlanVsFactPlanSelector();
                            updatePlanVsFactAnalytics();
                        }
                        }

                        window.updateAnalytics = function() {
                        // Update current active tab
                        const activeBtn = document.querySelector('.analytics-tab-btn.active');
                        if (!activeBtn) {
                            switchAnalyticsTab('sales');
                            return;
                        }
                        
                        const activeTab = activeBtn.id.replace('AnalyticsBtn', '');
                        if (activeTab === 'sales') {
                            updateSalesAnalytics();
                        } else if (activeTab === 'financial') {
                            updateFinancialAnalytics();
                        } else if (activeTab === 'profitability') {
                            updateProfitabilityAnalytics();
                        } else if (activeTab === 'pnl') {
                            updatePnlAnalytics();
                        } else if (activeTab === 'planVsFact') {
                            initPlanVsFactPlanSelector();
                            updatePlanVsFactAnalytics();
                        }
                        }

                        function updateSalesAnalytics() {
                        console.log('üìä –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂—ñ–≤...');
                        
                        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∑ localStorage
                        const currentCrmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');
                        
                        const periodFilter = document.getElementById('analyticsPeriodFilter')?.value || '';
                        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || '';
                        
                        console.log(`üìä –§—ñ–ª—å—Ç—Ä–∏: –ø–µ—Ä—ñ–æ–¥="${periodFilter}", –ª–æ–∫–∞—Ü—ñ—è="${locationFilter}"`);
                        console.log(`üìä –í—Å—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –≤ –±–∞–∑—ñ: ${currentCrmData.clients.length}`);
                        
                        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –ø–æ –ø–µ—Ä—ñ–æ–¥—É —Ç–∞ –ª–æ–∫–∞—Ü—ñ—ó (–±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É)
                        const filteredClients = currentCrmData.clients.filter(c => {
                            const periodMatch = !periodFilter || c.period === periodFilter;
                            const locationMatch = !locationFilter || c.location === locationFilter;
                            return periodMatch && locationMatch;
                        });
                        
                        console.log(`üìä –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤: ${filteredClients.length}`);
                        
                        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –≤—ñ–¥–º–æ–≤–∏ –ø–æ –ø–µ—Ä—ñ–æ–¥—É —Ç–∞ –ª–æ–∫–∞—Ü—ñ—ó
                        const filteredRefunds = currentCrmData.refunds.filter(r => {
                            const periodMatch = !periodFilter || r.period === periodFilter;
                            const locationMatch = !locationFilter || r.location === locationFilter;
                            return periodMatch && locationMatch;
                        });
                        
                        // Overall KPIs
                        const totalClients = filteredClients.length;
                        const totalRevenue = filteredClients.reduce((sum, c) => sum + (parseFloat(c.amountPaid) || 0), 0);
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ—á—ñ–∫—É–≤–∞–Ω–∏—Ö –∫–æ—à—Ç—ñ–≤ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏—Ö —Ü—ñ–Ω –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞
                        const totalExpected = filteredClients.reduce((sum, c) => {
                            // –û—Ç—Ä–∏–º—É—î–º–æ —Ü—ñ–Ω—É –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É/–ª–æ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞
                            let clientBasePrice = 26900; // –¥–µ—Ñ–æ–ª—Ç
                            
                            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–ª–∞–Ω –∑ –ø–µ—Ä—ñ–æ–¥–æ–º –∫–ª—ñ—î–Ω—Ç–∞
                            const planWithPeriod = allPlans.find(plan => 
                                plan.periods?.some(period => {
                                    const periodName = typeof period === 'string' ? period : period.periodName;
                                    return periodName === c.period;
                                })
                            );
                            
                            if (planWithPeriod) {
                                const foundPeriod = planWithPeriod.periods.find(period => {
                                    const periodName = typeof period === 'string' ? period : period.periodName;
                                    return periodName === c.period;
                                });
                                
                                if (foundPeriod && typeof foundPeriod !== 'string' && foundPeriod.locations) {
                                    const foundLocation = foundPeriod.locations.find(loc => loc.locationName === c.location);
                                    if (foundLocation && foundLocation.price) {
                                        clientBasePrice = foundLocation.price;
                                    }
                                }
                            }
                            
                            let clientPrice = clientBasePrice;
                            
                            // –ë–µ–∑–ø–µ—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ü—ñ–Ω–∏ –∫–ª—ñ—î–Ω—Ç–∞
                            if (typeof calculateClientPrice === 'function') {
                                try {
                                    // –ü–µ—Ä–µ–≤—ñ—Ä—è–µ–º–æ —Ç–∏–ø –∑–Ω–∏–∂–∫–∏ - –º–æ–∂–µ –±—É—Ç–∏ —Ç–µ–∫—Å—Ç –∞–±–æ —á–∏—Å–ª–æ
                                    let discountValue = 0;
                                    if (typeof c.discount === 'string' && c.discount !== '') {
                                        // –Ø–∫—â–æ –∑–Ω–∏–∂–∫–∞ - —Ç–µ–∫—Å—Ç (—è–∫ "–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è"), –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–µ—Ä—à—É —Ñ—É–Ω–∫—Ü—ñ—é
                                        clientPrice = clientBasePrice;
                                        if (c.discount === '–†–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è') clientPrice -= 1000;
                                        else if (c.discount === '–í–∂–µ –±—É–ª–∏ —É –Ω–∞—Å') clientPrice -= 1000;
                                        else if (c.discount === '–î—Ä—É–∑—ñ') clientPrice -= 1000;
                                        else if (c.discount === '–£–ë–î —ñ –í–ü–û') clientPrice *= 0.9;
                                        else if (c.discount === '2 –∑–º—ñ–Ω–∏') clientPrice *= 0.95;
                                    } else {
                                        // –Ø–∫—â–æ –∑–Ω–∏–∂–∫–∞ - —á–∏—Å–ª–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥—Ä—É–≥—É —Ñ—É–Ω–∫—Ü—ñ—é
                                        discountValue = parseFloat(c.discount) || 0;
                                        clientPrice = calculateClientPrice(clientBasePrice, discountValue, parseFloat(c.transferCost) || 0);
                                    }
                                    
                                    // –î–æ–¥–∞—î–º–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—É
                                    clientPrice += parseFloat(c.transferCost) || 0;
                                } catch (e) {
                                    console.warn(`‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω–∏ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ ${c.childName}:`, e);
                                    clientPrice = clientBasePrice;
                                }
                            }
                            
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ clientPrice –Ω–µ NaN
                            if (isNaN(clientPrice) || clientPrice < 0) {
                                clientPrice = clientBasePrice;
                            }
                            
                            const expectedFromClient = Math.max(0, clientPrice - (parseFloat(c.amountPaid) || 0));
                            return sum + expectedFromClient;
                        }, 0);
                        const totalRefunds = filteredRefunds.length;
                        const conversionRate = totalClients > 0 ? ((totalClients / (totalClients + totalRefunds)) * 100) : 0;
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ—Å—Ç—ñ –∑–º—ñ–Ω –∑ –¥–∞–Ω–∏—Ö –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞
                        const shiftStats = [];
                        
                        // –ó–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞
                        allPlans.forEach(plan => {
                            if (!plan.periods) return;
                            
                            plan.periods.forEach(period => {
                                if (typeof period === 'string' || !period.locations) return;
                                
                                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ñ—ñ–ª—å—Ç—Ä—É –ø–µ—Ä—ñ–æ–¥—É
                                if (periodFilter && period.periodName !== periodFilter) return;
                                
                                period.locations.forEach(location => {
                                    // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ñ—ñ–ª—å—Ç—Ä—É –ª–æ–∫–∞—Ü—ñ—ó
                                    if (locationFilter && location.locationName !== locationFilter) return;
                                    
                                    const plannedChildren = location.avgChildren || 0;
                                    const shiftsCount = location.shiftsCount || 1;
                                    
                                    // –†–∞—Ö—É—î–º–æ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∑–º—ñ–Ω–∏
                                    for (let shiftNum = 1; shiftNum <= shiftsCount; shiftNum++) {
                                        const shiftName = `–ó–º—ñ–Ω–∞ ${shiftNum}`;
                                        const key = `${period.periodName}|${location.locationName}|${shiftName}`;
                                        
                                        const actualClients = filteredClients.filter(client => 
                                            client.period === period.periodName && 
                                            client.location === location.locationName && 
                                            client.shift === shiftName
                                        ).length;
                                        
                                        shiftStats.push({
                                            key,
                                            period: period.periodName,
                                            location: location.locationName,
                                            shift: shiftName,
                                            planned: plannedChildren,
                                            actual: actualClients
                                        });
                                    }
                                });
                            });
                        });
                        
                        let avgFillRate = 0;
                        if (shiftStats.length > 0) {
                            const totalPlanned = shiftStats.reduce((sum, s) => sum + s.planned, 0);
                            const totalActual = shiftStats.reduce((sum, s) => sum + s.actual, 0);
                            avgFillRate = totalPlanned > 0 ? (totalActual / totalPlanned * 100) : 0;
                            
                            console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–º—ñ–Ω: ${shiftStats.length} –∑–º—ñ–Ω, –ø–ª–∞–Ω: ${totalPlanned}, —Ñ–∞–∫—Ç: ${totalActual}, –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å: ${avgFillRate.toFixed(1)}%`);
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                        const analyticsAllClientsEl = document.getElementById('analyticsAllClients');
                        const analyticsRevenueEl = document.getElementById('analyticsRevenue');
                        const analyticsExpectedEl = document.getElementById('analyticsExpected');
                        const analyticsRefundsEl = document.getElementById('analyticsRefunds');
                        const analyticsConversionEl = document.getElementById('analyticsConversion');
                        const analyticsFillRateEl = document.getElementById('analyticsFillRate');
                        
                        if (analyticsAllClientsEl) analyticsAllClientsEl.textContent = totalClients.toLocaleString('uk-UA');
                        if (analyticsRevenueEl) analyticsRevenueEl.textContent = Math.round(totalRevenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        if (analyticsExpectedEl) {
                            const expectedText = isNaN(totalExpected) ? '0' : Math.round(totalExpected).toLocaleString('uk-UA');
                            analyticsExpectedEl.textContent = expectedText + ' –≥—Ä–Ω';
                        }
                        if (analyticsRefundsEl) analyticsRefundsEl.textContent = totalRefunds.toLocaleString('uk-UA');
                        if (analyticsConversionEl) analyticsConversionEl.textContent = conversionRate.toFixed(1) + '%';
                        if (analyticsFillRateEl) analyticsFillRateEl.textContent = shiftStats.length > 0 ? avgFillRate.toFixed(0) + '%' : '‚Äî';
                        
                        console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏: –∫–ª—ñ—î–Ω—Ç—ñ–≤=${totalClients}, –¥–æ—Ö–æ–¥–∏=${totalRevenue.toFixed(0)}, –æ—á—ñ–∫—É—î—Ç—å—Å—è=${totalExpected.toFixed(0)} (${isNaN(totalExpected) ? 'NaN!' : 'OK'}), –≤—ñ–¥–º–æ–≤–∏=${totalRefunds}, –∫–æ–Ω–≤–µ—Ä—Å—ñ—è=${conversionRate.toFixed(1)}%`);
                        
                        // Period breakdown
                        renderAnalyticsBreakdown(filteredClients, shiftStats, periodFilter, locationFilter);
                        
                        // Charts
                        renderAnalyticsSalesChart(filteredClients);
                        renderAnalyticsRevenueChart(filteredClients, basePrice);
                        
                        // Managers performance
                        renderManagersPerformance(filteredClients, filteredRefunds, basePrice);
                        }

                        function updateFinancialAnalytics() {
                        const periodFilter = document.getElementById('analyticsPeriodFilter')?.value || '';
                        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || '';
                        const activePlan = getActivePlan();
                        
                        // Load operations data
                        loadOperations();
                        
                        // Filter operations by active plan, period and location
                        const filteredOperations = operations.filter(op => 
                            (!activePlan || op.planId === activePlan.id) &&
                            (!periodFilter || op.period === periodFilter) &&
                            (!locationFilter || op.location === locationFilter)
                        );
                        
                        // Calculate financial KPIs
                        const incomeOps = filteredOperations.filter(op => {
                            const mainCategory = (op.category || '').split('.')[0];
                            return mainCategory === '–î–æ—Ö–æ–¥–∏';
                        });
                        const expenseOps = filteredOperations.filter(op => {
                            const mainCategory = (op.category || '').split('.')[0];
                            return mainCategory !== '–î–æ—Ö–æ–¥–∏';
                        });
                        
                        const income = incomeOps.reduce((sum, op) => {
                                const amount = parseFloat(op.amount) || 0;
                                return sum + Math.abs(amount); // –î–æ—Ö–æ–¥–∏ –∑–∞–≤–∂–¥–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ
                            }, 0);
                            
                        const expenses = expenseOps.reduce((sum, op) => {
                                const amount = parseFloat(op.amount) || 0;
                                return sum + Math.abs(amount); // –í–∏—Ç—Ä–∞—Ç–∏ —Ç–µ–∂ –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É
                            }, 0);
                            
                        const netProfit = income - expenses;
                        const profitMargin = income > 0 ? ((netProfit / income) * 100) : 0;
                        
                        // Update KPI cards
                        document.getElementById('financialTotalIncome').textContent = Math.round(income).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('financialTotalExpenses').textContent = Math.round(expenses).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('financialNetProfit').textContent = Math.round(netProfit).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('financialProfitMargin').textContent = profitMargin.toFixed(1) + '%';
                        
                        // Render financial charts and tables
                        try {
                            renderFinancialIncomeChart(filteredOperations);
                            renderFinancialExpensesChart(filteredOperations);
                            renderFinancialOperationsTable(filteredOperations);
                            renderFinancialTrendChart(filteredOperations);
                        } catch (error) {
                            console.error('Error rendering financial analytics:', error);
                        }
                        }

                        function updateProfitabilityAnalytics() {
                        console.log('üìä –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π...');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î–º–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ CRM –¥–∞–Ω–∏—Ö, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
                        const existingOperationsCount = JSON.parse(localStorage.getItem('operations') || '[]').length;
                        if (existingOperationsCount === 0) {
                            console.log('üí∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π...');
                            generateFinancialOperationsFromCRM();
                        }
                        
                        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä –¥–ª—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ
                        const periodFilter = document.getElementById('profitabilityPeriodFilter')?.value || '';
                        
                        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
                        const currentOperations = JSON.parse(localStorage.getItem('operations') || '[]');
                        const currentAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                        
                        console.log(`üìä –§—ñ–ª—å—Ç—Ä —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ: –ø–µ—Ä—ñ–æ–¥="${periodFilter}"`);
                        console.log(`üìä –í—Å—å–æ–≥–æ –æ–ø–µ—Ä–∞—Ü—ñ–π: ${currentOperations.length}, —Ä–∞—Ö—É–Ω–∫—ñ–≤: ${currentAccounts.length}`);
                        
                        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–º –ø–µ—Ä—ñ–æ–¥–æ–º
                        const filteredOperations = currentOperations.filter(op => {
                            const periodMatch = !periodFilter || op.period === periodFilter;
                            return periodMatch;
                        });
                        
                        console.log(`üìä –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –æ–ø–µ—Ä–∞—Ü—ñ–π: ${filteredOperations.length}`);
                        
                        // –î–æ–¥–∞—Ç–∫–æ–≤–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                        if (periodFilter) {
                            const uniquePeriods = [...new Set(currentOperations.map(op => op.period).filter(p => p))];
                            console.log(`üìä –î–æ—Å—Ç—É–ø–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏ –≤ –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö: [${uniquePeriods.join(', ')}]`);
                            console.log(`üìä –®—É–∫–∞—î–º–æ –ø–µ—Ä—ñ–æ–¥: "${periodFilter}"`);
                            
                            if (filteredOperations.length === 0) {
                                console.log('‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü—ñ–π –¥–ª—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ CRM...');
                                
                                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∫–ª—ñ—î–Ω—Ç–∏ –¥–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É –≤ CRM
                                const crmData = JSON.parse(localStorage.getItem('crmData') || '{"clients":[]}');
                                const periodClients = crmData.clients.filter(c => c.period === periodFilter);
                                
                                if (periodClients.length > 0) {
                                    console.log(`‚ÑπÔ∏è –ó–Ω–∞–π–¥–µ–Ω–æ ${periodClients.length} –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É "${periodFilter}", –∞–ª–µ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–∞`);
                                    // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π –≤–∏–º–∫–Ω–µ–Ω–∞ –∑–∞ –∑–∞–ø–∏—Ç–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                                }
                            }
                        }
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–æ—Ö–æ–¥—ñ–≤ –∑ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
                        const revenueOperations = filteredOperations.filter(op => {
                            const amount = parseFloat(op.amount) || 0;
                            return amount > 0; // –ü–æ–∑–∏—Ç–∏–≤–Ω—ñ —Å—É–º–∏ = –¥–æ—Ö–æ–¥–∏
                        });
                        
                        const totalRevenue = revenueOperations.reduce((sum, op) => {
                            return sum + (parseFloat(op.amount) || 0);
                        }, 0);
                        
                        console.log(`üìä –î–æ—Ö–æ–¥–∏ –∑ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π: ${totalRevenue.toFixed(0)} –≥—Ä–Ω (–∑ ${revenueOperations.length} –æ–ø–µ—Ä–∞—Ü—ñ–π)`);
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∏—Ç—Ä–∞—Ç –∑ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏
                        const expenseOperations = filteredOperations.filter(op => {
                            const amount = parseFloat(op.amount) || 0;
                            return amount < 0; // –ù–µ–≥–∞—Ç–∏–≤–Ω—ñ —Å—É–º–∏ = –≤–∏—Ç—Ä–∞—Ç–∏
                        });
                        
                        const directExpenses = expenseOperations
                            .filter(op => (op.category || '').split('.')[0] === '–ü—Ä—è–º—ñ')
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                            
                        const operationalExpenses = expenseOperations
                            .filter(op => (op.category || '').split('.')[0] === '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ')
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                            
                        const unexpectedExpenses = expenseOperations
                            .filter(op => (op.category || '').split('.')[0] === '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ')
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                            
                        const otherExpenses = expenseOperations
                            .filter(op => {
                                const category = (op.category || '').split('.')[0];
                                return !['–ü—Ä—è–º—ñ', '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ', '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ'].includes(category);
                            })
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                        
                        const totalExpenses = directExpenses + operationalExpenses + unexpectedExpenses + otherExpenses;
                        
                        console.log(`üìä –†–û–ó–†–ê–•–£–ù–û–ö –í–ò–¢–†–ê–¢ –ó –§–Ü–ù–ê–ù–°–û–í–ò–• –û–ü–ï–†–ê–¶–Ü–ô:`);
                        console.log(`üìä –ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏: ${directExpenses.toFixed(0)} –≥—Ä–Ω`);
                        console.log(`üìä –û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏: ${operationalExpenses.toFixed(0)} –≥—Ä–Ω`);
                        console.log(`üìä –ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏: ${unexpectedExpenses.toFixed(0)} –≥—Ä–Ω`);
                        console.log(`üìä –Ü–Ω—à—ñ –≤–∏—Ç—Ä–∞—Ç–∏: ${otherExpenses.toFixed(0)} –≥—Ä–Ω`);
                        console.log(`üìä –í—Å—å–æ–≥–æ –≤–∏—Ç—Ä–∞—Ç: ${totalExpenses.toFixed(0)} –≥—Ä–Ω`);
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –ø—Ä–∏–±—É—Ç–∫–æ–≤–æ—Å—Ç—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                        const grossProfit = totalRevenue - directExpenses;
                        const operatingProfit = grossProfit - operationalExpenses;
                        const netProfit = operatingProfit - unexpectedExpenses - otherExpenses;
                        
                        console.log(`üìä –†–û–ó–†–ê–•–£–ù–û–ö –ü–†–ò–ë–£–¢–ö–£:`);
                        console.log(`üìä –í–∞–ª–æ–≤–∏–π –ø—Ä–∏–±—É—Ç–æ–∫: ${totalRevenue.toFixed(0)} - ${directExpenses.toFixed(0)} = ${grossProfit.toFixed(0)} –≥—Ä–Ω`);
                        console.log(`üìä –û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫: ${grossProfit.toFixed(0)} - ${operationalExpenses.toFixed(0)} = ${operatingProfit.toFixed(0)} –≥—Ä–Ω`);
                        console.log(`üìä –ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫: ${operatingProfit.toFixed(0)} - ${(unexpectedExpenses + otherExpenses).toFixed(0)} = ${netProfit.toFixed(0)} –≥—Ä–Ω`);
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ
                        const grossMargin = totalRevenue > 0 ? ((grossProfit / totalRevenue) * 100) : 0;
                        const operatingMargin = totalRevenue > 0 ? ((operatingProfit / totalRevenue) * 100) : 0;
                        const periodMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100) : 0;
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –¥—ñ—Ç–µ–π –∑ CRM (–¥–ª—è –≤–∏—Ç—Ä–∞—Ç –Ω–∞ –¥–∏—Ç–∏–Ω—É)
                        const currentCrmData = JSON.parse(localStorage.getItem('crmData') || '{"clients":[]}');
                        const filteredClients = currentCrmData.clients.filter(c => {
                            const periodMatch = !periodFilter || c.period === periodFilter;
                            return periodMatch;
                        });
                        
                        const totalChildren = filteredClients.length;
                        const costPerChild = totalChildren > 0 ? (totalExpenses / totalChildren) : 0;
                        
                        console.log(`üìä –ü–û–ö–ê–ó–ù–ò–ö–ò –†–ï–ù–¢–ê–ë–ï–õ–¨–ù–û–°–¢–Ü (–Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π):`);
                        console.log(`üìä –í–∞–ª–æ–≤–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å: (${grossProfit.toFixed(0)} / ${totalRevenue.toFixed(0)}) * 100 = ${grossMargin.toFixed(1)}%`);
                        console.log(`üìä –û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å: (${operatingProfit.toFixed(0)} / ${totalRevenue.toFixed(0)}) * 100 = ${operatingMargin.toFixed(1)}%`);
                        console.log(`üìä –ß–∏—Å—Ç–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å: (${netProfit.toFixed(0)} / ${totalRevenue.toFixed(0)}) * 100 = ${periodMargin.toFixed(1)}%`);
                        console.log(`üìä –í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É: ${costPerChild.toFixed(0)} –≥—Ä–Ω (–≤—Å—å–æ–≥–æ –¥—ñ—Ç–µ–π: ${totalChildren})`);
                        console.log(`üìä –í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥–∏—Ç–∏–Ω—É: ${totalExpenses.toFixed(0)} / ${totalChildren} = ${costPerChild.toFixed(0)} –≥—Ä–Ω`);
                        
                        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
                        const profitabilityGrossMarginEl = document.getElementById('profitabilityGrossMargin');
                        const profitabilityOperatingMarginEl = document.getElementById('profitabilityOperatingMargin');
                        const profitabilityPeriodMarginEl = document.getElementById('profitabilityPeriodMargin');
                        const profitabilityCostPerChildEl = document.getElementById('profitabilityCostPerChild');
                        
                        if (profitabilityGrossMarginEl) {
                            profitabilityGrossMarginEl.textContent = grossMargin.toFixed(1) + '%';
                            profitabilityGrossMarginEl.style.color = grossMargin >= 0 ? '#15803d' : '#dc2626';
                        }
                        if (profitabilityOperatingMarginEl) {
                            profitabilityOperatingMarginEl.textContent = operatingMargin.toFixed(1) + '%';
                            profitabilityOperatingMarginEl.style.color = operatingMargin >= 0 ? '#15803d' : '#dc2626';
                        }
                        if (profitabilityPeriodMarginEl) {
                            profitabilityPeriodMarginEl.textContent = periodMargin.toFixed(1) + '%';
                            profitabilityPeriodMarginEl.style.color = periodMargin >= 0 ? '#15803d' : '#dc2626';
                        }
                        if (profitabilityCostPerChildEl) {
                            profitabilityCostPerChildEl.textContent = Math.round(costPerChild).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        }
                        
                        console.log('‚úÖ –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π');
                        
                        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å —Ç–∞ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ
                        renderProfitabilityByPeriod(filteredOperations, totalRevenue, directExpenses, operationalExpenses, unexpectedExpenses);
                        renderProfitabilityCostStructureChart(directExpenses, operationalExpenses, unexpectedExpenses, otherExpenses);
                        renderProfitabilityTrendChart(filteredOperations);
                        }
                        
                        function updateProfitabilityPeriodFilter() {
                        console.log('üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä–∞ –ø–µ—Ä—ñ–æ–¥—ñ–≤ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ...');
                        
                        const select = document.getElementById('profitabilityPeriodFilter');
                        if (!select) return;
                        
                        const currentValue = select.value;
                        
                        // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏ –∑ CRM
                        const crmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[]}');
                        const periods = crmData.periods || [];
                        
                        // –¢–∞–∫–æ–∂ –æ—Ç—Ä–∏–º—É—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏ –∑ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —è–∫—â–æ —î –æ–ø–µ—Ä–∞—Ü—ñ—ó –±–µ–∑ CRM)
                        const operations = JSON.parse(localStorage.getItem('operations') || '[]');
                        const operationPeriods = [...new Set(operations.map(op => op.period).filter(p => p))];
                        
                        // –û–±'—î–¥–Ω—É—î–º–æ –≤—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏
                        const allPeriods = [...new Set([...periods, ...operationPeriods])].sort();
                        
                        select.innerHTML = '<option value="">–í—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏</option>' + 
                            allPeriods.map(period => 
                                `<option value="${period}" ${period === currentValue ? 'selected' : ''}>${period}</option>`
                            ).join('');
                            
                        console.log(`üîÑ –î–æ–¥–∞–Ω–æ ${allPeriods.length} –ø–µ—Ä—ñ–æ–¥—ñ–≤ –¥–æ —Ñ—ñ–ª—å—Ç—Ä–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ`);
                        }

                        function generateFinancialOperationsFromCRM() {
                        console.log('üí∞ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ CRM –¥–∞–Ω–∏—Ö...');
                        
                        const currentCrmData = JSON.parse(localStorage.getItem('crmData') || '{"clients":[]}');
                        const existingOperations = JSON.parse(localStorage.getItem('operations') || '[]');
                        const existingAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                        
                        console.log(`üí∞ –ö–ª—ñ—î–Ω—Ç—ñ–≤ –≤ CRM: ${currentCrmData.clients.length}, —ñ—Å–Ω—É—é—á–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π: ${existingOperations.length}`);
                        
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –±–∞–∑–æ–≤—ñ —Ä–∞—Ö—É–Ω–∫–∏, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
                        if (existingAccounts.length === 0) {
                            const defaultAccounts = [
                                { id: 'main', name: '–û—Å–Ω–æ–≤–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫', balance: 0 },
                                { id: 'revenue', name: '–î–æ—Ö–æ–¥–∏ –≤—ñ–¥ —Ç–∞–±–æ—Ä—É', balance: 0 },
                                { id: 'expenses', name: '–í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å', balance: 0 }
                            ];
                            localStorage.setItem('accounts', JSON.stringify(defaultAccounts));
                            console.log('üí∞ –°—Ç–≤–æ—Ä–µ–Ω–æ –±–∞–∑–æ–≤—ñ —Ä–∞—Ö—É–Ω–∫–∏');
                        }
                        
                        const newOperations = [];
                        const basePrice = 26900; // –ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞
                        
                        // –ì–µ–Ω–µ—Ä—É—î–º–æ –æ–ø–µ—Ä–∞—Ü—ñ—ó –¥–æ—Ö–æ–¥—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
                        currentCrmData.clients.forEach(client => {
                            const clientPrice = calculateClientPrice(basePrice, client.discount || 0, client.transferCost || 0);
                            
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ —î –æ–ø–µ—Ä–∞—Ü—ñ—è –¥–ª—è —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
                            const existingClientOperation = existingOperations.find(op => 
                                op.clientId === client.id && op.type === 'revenue'
                            );
                            
                            if (!existingClientOperation && clientPrice > 0) {
                                const revenueOperation = {
                                    id: 'op_' + Date.now() + '_' + client.id,
                                    clientId: client.id,
                                    type: 'revenue',
                                    amount: clientPrice,
                                    description: `–û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–∞–±—ñ—Ä - ${client.name || '–ö–ª—ñ—î–Ω—Ç'}`,
                                    category: '–î–æ—Ö–æ–¥–∏.–û–ø–ª–∞—Ç–∞ —Ç–∞–±–æ—Ä—É',
                                    period: client.period || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø–µ—Ä—ñ–æ–¥',
                                    location: '', // –î–æ—Ö–æ–¥–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ –ø–µ—Ä—ñ–æ–¥—É, –Ω–µ –ª–æ–∫–∞—Ü—ñ—ó
                                    shift: client.shift || '',
                                    date: new Date().toISOString().split('T')[0],
                                    account: 'revenue'
                                };
                                newOperations.push(revenueOperation);
                            }
                        });
                        
                        // –ì—Ä—É–ø—É—î–º–æ –≤–∏—Ç—Ä–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö (–Ω–µ –ø–æ –ª–æ–∫–∞—Ü—ñ—è—Ö)
                        const periods = {};
                        currentCrmData.clients.forEach(client => {
                            const period = client.period || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø–µ—Ä—ñ–æ–¥';
                            if (!periods[period]) {
                                periods[period] = {
                                    period: period,
                                    children: []
                                };
                            }
                            periods[period].children.push(client);
                        });
                        
                        // –ì–µ–Ω–µ—Ä—É—î–º–æ –≤–∏—Ç—Ä–∞—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                        Object.values(periods).forEach(periodData => {
                            if (periodData.children.length === 0) return;
                            
                            const expenseKey = `${periodData.period}_expenses`;
                            const existingExpenses = existingOperations.find(op => 
                                op.expenseKey === expenseKey
                            );
                            
                            if (!existingExpenses) {
                                const childrenCount = periodData.children.length;
                                
                                // –†–æ–∑—Ä–∞—Ö—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥ –¥–ª—è –≤—Å—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                                const totalRevenue = periodData.children.reduce((sum, c) => 
                                    sum + calculateClientPrice(basePrice, c.discount || 0, c.transferCost || 0), 0
                                );
                                
                                // –î–µ—Ç–∞–ª—å–Ω—ñ –ø—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (45% –≤—ñ–¥ –¥–æ—Ö–æ–¥—ñ–≤)
                                const detailedDirectExpenses = [
                                    { category: '–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–°–Ω—ñ–¥–∞–Ω–∫–∏', percent: 0.12, name: '–°–Ω—ñ–¥–∞–Ω–∫–∏' },
                                    { category: '–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–û–±—ñ–¥–∏', percent: 0.15, name: '–û–±—ñ–¥–∏' },
                                    { category: '–ü—Ä—è–º—ñ.–•–∞—Ä—á—É–≤–∞–Ω–Ω—è.–í–µ—á–µ—Ä—ñ', percent: 0.10, name: '–í–µ—á–µ—Ä—ñ' },
                                    { category: '–ü—Ä—è–º—ñ.–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏.–°–ø–æ—Ä—Ç —ñ–Ω–≤–µ–Ω—Ç–∞—Ä', percent: 0.03, name: '–°–ø–æ—Ä—Ç–∏–≤–Ω–∏–π —ñ–Ω–≤–µ–Ω—Ç–∞—Ä' },
                                    { category: '–ü—Ä—è–º—ñ.–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏.–¢–≤–æ—Ä—á—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏', percent: 0.03, name: '–¢–≤–æ—Ä—á—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏' },
                                    { category: '–ü—Ä—è–º—ñ.–ü–æ—Å–ª—É–≥–∏.–ú–µ–¥–∏—á–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª', percent: 0.02, name: '–ú–µ–¥–∏—á–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª' }
                                ];
                                
                                detailedDirectExpenses.forEach((expense, idx) => {
                                    const amount = totalRevenue * expense.percent;
                                    newOperations.push({
                                        id: 'op_' + Date.now() + '_' + idx + '_' + Math.random().toString(36).substr(2, 6),
                                        expenseKey: expenseKey,
                                        type: 'expense',
                                        amount: -amount,
                                        description: `${expense.name} - ${periodData.period} (${childrenCount} –¥—ñ—Ç–µ–π)`,
                                        category: expense.category,
                                        period: periodData.period,
                                        location: '',
                                        date: new Date().toISOString().split('T')[0],
                                        account: 'expenses'
                                    });
                                });
                                
                                // –î–µ—Ç–∞–ª—å–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (20% –≤—ñ–¥ –¥–æ—Ö–æ–¥—ñ–≤)
                                const detailedOperationalExpenses = [
                                    { category: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ü–µ—Ä—Å–æ–Ω–∞–ª.–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–∂–∞—Ç–∏—Ö', percent: 0.08, name: '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–∂–∞—Ç–∏—Ö' },
                                    { category: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ü–µ—Ä—Å–æ–Ω–∞–ª.–ó–∞—Ä–ø–ª–∞—Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó', percent: 0.04, name: '–ó–∞—Ä–ø–ª–∞—Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó' },
                                    { category: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–û—Ä–µ–Ω–¥–∞.–ü—Ä–∏–º—ñ—â–µ–Ω—å', percent: 0.04, name: '–û—Ä–µ–Ω–¥–∞ –ø—Ä–∏–º—ñ—â–µ–Ω—å' },
                                    { category: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ö–æ–º—É–Ω–∞–ª—å–Ω—ñ.–ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è', percent: 0.02, name: '–ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è' },
                                    { category: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–ö–æ–º—É–Ω–∞–ª—å–Ω—ñ.–í–æ–¥–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è', percent: 0.01, name: '–í–æ–¥–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è' },
                                    { category: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ.–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç.–ï–∫—Å–∫—É—Ä—Å—ñ—ó', percent: 0.01, name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –µ–∫—Å–∫—É—Ä—Å—ñ–π' }
                                ];
                                
                                detailedOperationalExpenses.forEach((expense, idx) => {
                                    const amount = totalRevenue * expense.percent;
                                    newOperations.push({
                                        id: 'op_' + Date.now() + '_op_' + idx + '_' + Math.random().toString(36).substr(2, 6),
                                        expenseKey: expenseKey,
                                        type: 'expense',
                                        amount: -amount,
                                        description: `${expense.name} - ${periodData.period} (${childrenCount} –¥—ñ—Ç–µ–π)`,
                                        category: expense.category,
                                        period: periodData.period,
                                        location: '',
                                        date: new Date().toISOString().split('T')[0],
                                        account: 'expenses'
                                    });
                                });
                                
                                // –î–µ—Ç–∞–ª—å–Ω—ñ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (3% –≤—ñ–¥ –¥–æ—Ö–æ–¥—ñ–≤)
                                const detailedUnexpectedExpenses = [
                                    { category: '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–†–µ–º–æ–Ω—Ç.–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è', percent: 0.01, name: '–†–µ–º–æ–Ω—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è' },
                                    { category: '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–ú–µ–¥–∏—á–Ω—ñ.–ü—Ä–µ–ø–∞—Ä–∞—Ç–∏', percent: 0.005, name: '–ú–µ–¥–∏—á–Ω—ñ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏' },
                                    { category: '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ.–†–µ–∑–µ—Ä–≤.–ó–∞–≥–∞–ª—å–Ω–∏–π', percent: 0.015, name: '–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑–µ—Ä–≤' }
                                ];
                                
                                detailedUnexpectedExpenses.forEach((expense, idx) => {
                                    const amount = totalRevenue * expense.percent;
                                    newOperations.push({
                                        id: 'op_' + Date.now() + '_un_' + idx + '_' + Math.random().toString(36).substr(2, 6),
                                        expenseKey: expenseKey,
                                        type: 'expense',
                                        amount: -amount,
                                        description: `${expense.name} - ${periodData.period} (${childrenCount} –¥—ñ—Ç–µ–π)`,
                                        category: expense.category,
                                        period: periodData.period,
                                        location: '',
                                        date: new Date().toISOString().split('T')[0],
                                        account: 'expenses'
                                    });
                                });
                            }
                        });
                        
                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
                        if (newOperations.length > 0) {
                            const allOperations = [...existingOperations, ...newOperations];
                            localStorage.setItem('operations', JSON.stringify(allOperations));
                            console.log(`üí∞ –î–æ–¥–∞–Ω–æ ${newOperations.length} –Ω–æ–≤–∏—Ö —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π`);
                        } else {
                            console.log('üí∞ –í—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤–∂–µ —ñ—Å–Ω—É—é—Ç—å');
                        }
                        
                        return newOperations.length;
                        }
                        
                        function calculateClientPrice(basePrice, discount = 0, transferCost = 0) {
                        const discountAmount = basePrice * (discount / 100);
                        return basePrice - discountAmount + transferCost;
                        }
                        
                        function resetFinancialOperations() {
                        if (confirm('–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç—å –Ω–æ–≤—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ CRM –¥–∞–Ω–∏—Ö. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
                            localStorage.removeItem('operations');
                            localStorage.removeItem('accounts');
                            console.log('üóëÔ∏è –û—á–∏—â–µ–Ω–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó');
                            
                            generateFinancialOperationsFromCRM();
                            updateProfitabilityPeriodFilter();
                            updateProfitabilityAnalytics();
                            
                            alert('–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                        }
                        }

                        function updatePnlAnalytics() {
                        const periodFilter = document.getElementById('analyticsPeriodFilter')?.value || '';
                        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || '';
                        const activePlan = getActivePlan();
                        
                        // Load both CRM and operations data filtered by active plan
                        const filteredClients = crmData.clients.filter(c => 
                            (!activePlan || c.planId === activePlan.id) &&
                            (!periodFilter || c.period === periodFilter) &&
                            (!locationFilter || c.location === locationFilter)
                        );
                        
                        loadOperations();
                        const filteredOperations = operations.filter(op => 
                            (!activePlan || op.planId === activePlan.id) &&
                            (!periodFilter || op.period === periodFilter) &&
                            (!locationFilter || op.location === locationFilter)
                        );
                        
                        // Calculate P&L components
                        const basePrice = parseFloat(document.getElementById('basePrice')?.value || 26900);
                        
                        // Revenue from sales (expected revenue from all sales)
                        const totalRevenue = filteredClients.reduce((sum, c) => {
                            const clientPrice = calculateClientPrice(basePrice, c.discount, c.transferCost);
                            return sum + clientPrice;
                        }, 0);
                        
                        // Actual expenses from operations
                        const directExpenses = filteredOperations
                            .filter(op => (op.category || '').split('.')[0] === '–ü—Ä—è–º—ñ')
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                            
                        const operatingExpenses = filteredOperations
                            .filter(op => (op.category || '').split('.')[0] === '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ')
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                            
                        const otherExpenses = filteredOperations
                            .filter(op => (op.category || '').split('.')[0] === '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ')
                            .reduce((sum, op) => sum + Math.abs(parseFloat(op.amount) || 0), 0);
                        
                        // Calculate P&L metrics
                        const grossProfit = totalRevenue - directExpenses;
                        const ebitda = grossProfit - operatingExpenses;
                        const netProfit = ebitda - otherExpenses;
                        
                        const grossMargin = totalRevenue > 0 ? ((grossProfit / totalRevenue) * 100) : 0;
                        const ebitdaMargin = totalRevenue > 0 ? ((ebitda / totalRevenue) * 100) : 0;
                        const netMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100) : 0;
                        
                        // Update P&L display
                        document.getElementById('pnlTotalRevenue').textContent = Math.round(totalRevenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlSalesRevenue').textContent = Math.round(totalRevenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlDirectCosts').textContent = Math.round(directExpenses).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlGrossProfit').textContent = Math.round(grossProfit).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlGrossMargin').textContent = grossMargin.toFixed(1) + '%';
                        document.getElementById('pnlOperatingExpenses').textContent = Math.round(operatingExpenses).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlEbitda').textContent = Math.round(ebitda).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlEbitdaMargin').textContent = ebitdaMargin.toFixed(1) + '%';
                        document.getElementById('pnlOtherExpenses').textContent = Math.round(otherExpenses).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlNetProfit').textContent = Math.round(netProfit).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        document.getElementById('pnlNetMargin').textContent = netMargin.toFixed(1) + '%';
                        
                        // Render P&L charts
                        try {
                            renderPnlRevenueChart(filteredClients, basePrice);
                            renderPnlWaterfallChart(totalRevenue, directExpenses, operatingExpenses, otherExpenses);
                            renderPnlTrendChart(filteredClients, filteredOperations, basePrice);
                        } catch (error) {
                            console.error('Error rendering P&L analytics:', error);
                        }
                        }

                        // KPI Analytics - –Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –¥–ª—è –±—ñ–∑–Ω–µ—Å-—Ä—ñ—à–µ–Ω—å
                        function updateKPIAnalytics() {
                            console.log('üéØ –û–Ω–æ–≤–ª–µ–Ω–Ω—è KPI –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏...');
                            
                            // –û—Ç—Ä–∏–º—É—î–º–æ CRM –¥–∞–Ω—ñ
                            const crmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');
                            const clients = crmData.clients || [];
                            
                            if (clients.length === 0) {
                                document.getElementById('kpiOverallRevenue').textContent = '0 ‚Ç¥';
                                document.getElementById('kpiAvgMargin').textContent = '0%';
                                document.getElementById('kpiAvgOccupancy').textContent = '0%';
                                document.getElementById('kpiAvgCheck').textContent = '0 ‚Ç¥';
                                return;
                            }
                            
                            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫–ª—é—á–æ–≤–∏—Ö –º–µ—Ç—Ä–∏–∫
                            const totalRevenue = clients.reduce((sum, client) => {
                                return sum + (client.amountPaid || 0) + (client.transferCost || 0);
                            }, 0);
                            
                            const averageCheck = totalRevenue / clients.length;
                            
                            // –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –ø–æ –ª–æ–∫–∞—Ü—ñ—è—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
                            const locationStats = {};
                            const shiftStats = {};
                            
                            clients.forEach(client => {
                                const location = client.location;
                                const shift = client.shift;
                                const period = client.period;
                                
                                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–∫–∞—Ü—ñ–π
                                if (!locationStats[location]) {
                                    locationStats[location] = {
                                        clients: 0,
                                        revenue: 0,
                                        periods: new Set()
                                    };
                                }
                                locationStats[location].clients++;
                                locationStats[location].revenue += (client.amountPaid || 0) + (client.transferCost || 0);
                                locationStats[location].periods.add(period);
                                
                                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–º—ñ–Ω
                                const shiftKey = `${location} - ${shift}`;
                                if (!shiftStats[shiftKey]) {
                                    shiftStats[shiftKey] = {
                                        clients: 0,
                                        revenue: 0,
                                        location: location,
                                        shift: shift
                                    };
                                }
                                shiftStats[shiftKey].clients++;
                                shiftStats[shiftKey].revenue += (client.amountPaid || 0) + (client.transferCost || 0);
                            });
                            
                            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å–µ—Ä–µ–¥–Ω—å–æ—ó –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω–æ—Å—Ç—ñ (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ —î–º–Ω—ñ—Å—Ç—å 20 –¥—ñ—Ç–µ–π –Ω–∞ –∑–º—ñ–Ω—É)
                            const totalShifts = Object.keys(shiftStats).length;
                            const avgOccupancy = totalShifts > 0 ? (clients.length / (totalShifts * 20)) * 100 : 0;
                            
                            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö KPI
                            document.getElementById('kpiOverallRevenue').textContent = Math.round(totalRevenue).toLocaleString('uk-UA') + ' ‚Ç¥';
                            document.getElementById('kpiAvgMargin').textContent = '45%'; // –°–µ—Ä–µ–¥–Ω—è –º–∞—Ä–∂–∞ —Ç–∞–±—ñ—Ä–Ω–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É
                            document.getElementById('kpiAvgOccupancy').textContent = Math.min(100, avgOccupancy).toFixed(1) + '%';
                            document.getElementById('kpiAvgCheck').textContent = Math.round(averageCheck).toLocaleString('uk-UA') + ' ‚Ç¥';
                            
                            // –ê–Ω–∞–ª—ñ–∑ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ª–æ–∫–∞—Ü—ñ–π
                            renderLocationAnalysis(locationStats);
                            
                            // –ê–Ω–∞–ª—ñ–∑ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∑–º—ñ–Ω
                            renderShiftAnalysis(shiftStats);
                            
                            // –°—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
                            generateRecommendations(locationStats, shiftStats, avgOccupancy, averageCheck);
                            
                            // –§—ñ–Ω–∞–Ω—Å–æ–≤–µ –∑–¥–æ—Ä–æ–≤'—è –±—ñ–∑–Ω–µ—Å—É
                            calculateHealthScore(totalRevenue, clients.length, avgOccupancy);
                        }
                        
                        // –†–µ–Ω–¥–µ—Ä –∞–Ω–∞–ª—ñ–∑—É –ª–æ–∫–∞—Ü—ñ–π
                        function renderLocationAnalysis(locationStats) {
                            const container = document.getElementById('kpiLocationAnalysis');
                            const locations = Object.entries(locationStats)
                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                .slice(0, 5);
                            
                            let html = '';
                            locations.forEach(([location, stats], index) => {
                                const avgRevenue = stats.revenue / stats.clients;
                                const isTop = index < 2;
                                const color = isTop ? '#10b981' : '#6366f1';
                                const icon = isTop ? 'üèÜ' : 'üìç';
                                
                                html += `
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-left:4px solid ${color};background:#f8fafc;margin-bottom:8px;border-radius:6px">
                                        <div>
                                            <div style="font-weight:600;color:#1e293b">${icon} ${location}</div>
                                            <div style="font-size:12px;color:#64748b">${stats.clients} –¥—ñ—Ç–µ–π ‚Ä¢ ${stats.periods.size} –ø–µ—Ä—ñ–æ–¥—ñ–≤</div>
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-weight:600;color:${color}">${Math.round(stats.revenue).toLocaleString()} ‚Ç¥</div>
                                            <div style="font-size:12px;color:#64748b">${Math.round(avgRevenue)} ‚Ç¥/–¥–∏—Ç–∏–Ω–∞</div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            container.innerHTML = html || '<div style="color:#64748b;text-align:center;padding:20px">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</div>';
                        }
                        
                        // –†–µ–Ω–¥–µ—Ä –∞–Ω–∞–ª—ñ–∑—É –∑–º—ñ–Ω
                        function renderShiftAnalysis(shiftStats) {
                            const container = document.getElementById('kpiShiftAnalysis');
                            const shifts = Object.entries(shiftStats)
                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                .slice(0, 5);
                            
                            let html = '';
                            shifts.forEach(([shiftKey, stats], index) => {
                                const avgRevenue = stats.revenue / stats.clients;
                                const occupancy = (stats.clients / 20) * 100; // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ —î–º–Ω—ñ—Å—Ç—å 20
                                const isEfficient = occupancy > 70;
                                const color = isEfficient ? '#10b981' : occupancy > 50 ? '#f59e0b' : '#ef4444';
                                const icon = isEfficient ? '‚≠ê' : '‚è∞';
                                
                                html += `
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-left:4px solid ${color};background:#f8fafc;margin-bottom:8px;border-radius:6px">
                                        <div>
                                            <div style="font-weight:600;color:#1e293b">${icon} ${shiftKey}</div>
                                            <div style="font-size:12px;color:#64748b">–ó–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å: ${occupancy.toFixed(1)}%</div>
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-weight:600;color:${color}">${stats.clients} –¥—ñ—Ç–µ–π</div>
                                            <div style="font-size:12px;color:#64748b">${Math.round(avgRevenue)} ‚Ç¥/–¥–∏—Ç–∏–Ω–∞</div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            container.innerHTML = html || '<div style="color:#64748b;text-align:center;padding:20px">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</div>';
                        }
                        
                        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π
                        function generateRecommendations(locationStats, shiftStats, avgOccupancy, averageCheck) {
                            const container = document.getElementById('kpiRecommendations');
                            let recommendations = [];
                            
                            // –ê–Ω–∞–ª—ñ–∑ –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω–æ—Å—Ç—ñ
                            if (avgOccupancy < 50) {
                                recommendations.push({
                                    type: 'danger',
                                    title: '‚ö†Ô∏è –ù–∏–∑—å–∫–∞ –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å',
                                    text: `–°–µ—Ä–µ–¥–Ω—è –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å ${avgOccupancy.toFixed(1)}% - –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ—Å–∏–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ —Ç–∞ –∑–Ω–∏–∑–∏—Ç–∏ —Ü—ñ–Ω–∏.`,
                                    action: '–†–æ–∑–≥–ª—è–Ω—å—Ç–µ —Ä–∞–Ω–Ω—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∑—ñ –∑–Ω–∏–∂–∫–æ—é 15-20%'
                                });
                            } else if (avgOccupancy > 85) {
                                recommendations.push({
                                    type: 'success',
                                    title: 'üöÄ –í–∏—Å–æ–∫–∞ –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å',
                                    text: `–ó–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å ${avgOccupancy.toFixed(1)}% - –º–æ–∂–Ω–∞ –ø—ñ–¥–≤–∏—â—É–≤–∞—Ç–∏ —Ü—ñ–Ω–∏.`,
                                    action: '–ü—ñ–¥–≤–∏—â—Ç–µ –±–∞–∑–æ–≤—ñ —Ü—ñ–Ω–∏ –Ω–∞ 8-12% –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Å–µ–∑–æ–Ω—É'
                                });
                            }
                            
                            // –ê–Ω–∞–ª—ñ–∑ –ª–æ–∫–∞—Ü—ñ–π
                            const locations = Object.entries(locationStats).sort((a, b) => b[1].revenue - a[1].revenue);
                            if (locations.length > 1) {
                                const topLocation = locations[0];
                                const avgLocationRevenue = locations.reduce((sum, [_, stats]) => sum + stats.revenue, 0) / locations.length;
                                
                                if (topLocation[1].revenue > avgLocationRevenue * 1.5) {
                                    recommendations.push({
                                        type: 'info',
                                        title: 'üèÜ –¢–æ–ø-–ª–æ–∫–∞—Ü—ñ—è',
                                        text: `${topLocation[0]} –≥–µ–Ω–µ—Ä—É—î ${((topLocation[1].revenue / avgLocationRevenue - 1) * 100).toFixed(0)}% –±—ñ–ª—å—à–µ –¥–æ—Ö–æ–¥—É.`,
                                        action: '–í–∏–≤—á—ñ—Ç—å —É—Å–ø—ñ—à–Ω—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ü—ñ—î—ó –ª–æ–∫–∞—Ü—ñ—ó –¥–ª—è —ñ–Ω—à–∏—Ö —Ç–∞–±–æ—Ä—ñ–≤'
                                    });
                                }
                            }
                            
                            // –ê–Ω–∞–ª—ñ–∑ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —á–µ–∫—É
                            if (averageCheck < 15000) {
                                recommendations.push({
                                    type: 'warning',
                                    title: 'üí∞ –ù–∏–∑—å–∫–∏–π —Å–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫',
                                    text: `–°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫ ${Math.round(averageCheck)} ‚Ç¥ - –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—Å–ª—É–≥–∏.`,
                                    action: '–í–ø—Ä–æ–≤–∞–¥—å—Ç–µ –ø–∞–∫–µ—Ç–∏ –∑ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–º, —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è–º premium, –µ–∫—Å–∫—É—Ä—Å—ñ—è–º–∏'
                                });
                            }
                            
                            if (recommendations.length === 0) {
                                recommendations.push({
                                    type: 'success',
                                    title: '‚úÖ –í—ñ–¥–º—ñ–Ω–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏',
                                    text: '–í–∞—à –±—ñ–∑–Ω–µ—Å –ø–æ–∫–∞–∑—É—î —Å—Ç–∞–±—ñ–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞ –≤—Å—ñ–º–∞ –∫–ª—é—á–æ–≤–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.',
                                    action: '–ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ –ø–æ—Ç–æ—á–Ω—É —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é —Ç–∞ –ø–ª–∞–Ω—É–π—Ç–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è'
                                });
                            }
                            
                            let html = '';
                            recommendations.forEach(rec => {
                                const colors = {
                                    success: { bg: '#f0fdf4', border: '#10b981', text: '#059669' },
                                    info: { bg: '#f0f9ff', border: '#3b82f6', text: '#1d4ed8' },
                                    warning: { bg: '#fffbeb', border: '#f59e0b', text: '#d97706' },
                                    danger: { bg: '#fef2f2', border: '#ef4444', text: '#dc2626' }
                                };
                                const color = colors[rec.type];
                                
                                html += `
                                    <div style="border-left:4px solid ${color.border};background:${color.bg};padding:16px;margin-bottom:12px;border-radius:6px">
                                        <div style="font-weight:600;color:${color.text};margin-bottom:8px">${rec.title}</div>
                                        <div style="color:#374151;margin-bottom:8px">${rec.text}</div>
                                        <div style="font-size:14px;color:#6b7280;font-style:italic">üí° ${rec.action}</div>
                                    </div>
                                `;
                            });
                            
                            container.innerHTML = html;
                        }
                        
                        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è –±—ñ–∑–Ω–µ—Å—É
                        function calculateHealthScore(totalRevenue, clientsCount, avgOccupancy) {
                            const container = document.getElementById('healthScoreDetails');
                            
                            // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –æ—Ü—ñ–Ω–∫–∏ (–º–∞–∫—Å–∏–º—É–º 100 –±–∞–ª—ñ–≤)
                            let revenueScore = Math.min(30, (totalRevenue / 1000000) * 30); // –î–æ 1–ú ‚Ç¥ = 30 –±–∞–ª—ñ–≤
                            let volumeScore = Math.min(25, (clientsCount / 500) * 25); // –î–æ 500 –¥—ñ—Ç–µ–π = 25 –±–∞–ª—ñ–≤
                            let occupancyScore = Math.min(25, (avgOccupancy / 85) * 25); // 85% –∑–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å = 25 –±–∞–ª—ñ–≤
                            let diversityScore = Math.min(20, (Object.keys(JSON.parse(localStorage.getItem('crmData') || '{}').locations || {}).length / 3) * 20); // 3+ –ª–æ–∫–∞—Ü—ñ—ó = 20 –±–∞–ª—ñ–≤
                            
                            const totalScore = revenueScore + volumeScore + occupancyScore + diversityScore;
                            
                            let healthLevel, healthColor, healthText;
                            if (totalScore >= 80) {
                                healthLevel = '–í—ñ–¥–º—ñ–Ω–Ω–µ';
                                healthColor = '#10b981';
                                healthText = '–í–∞—à –±—ñ–∑–Ω–µ—Å –ø–æ–∫–∞–∑—É—î –≤–∏–Ω—è—Ç–∫–æ–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞ –≤—Å—ñ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.';
                            } else if (totalScore >= 60) {
                                healthLevel = '–•–æ—Ä–æ—à–µ';
                                healthColor = '#3b82f6';
                                healthText = '–°—Ç–∞–±—ñ–ª—å–Ω–∏–π –±—ñ–∑–Ω–µ—Å –∑ –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª–æ–º –¥–ª—è –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è.';
                            } else if (totalScore >= 40) {
                                healthLevel = '–ó–∞–¥–æ–≤—ñ–ª—å–Ω–µ';
                                healthColor = '#f59e0b';
                                healthText = '–Ñ –ø—Ä–æ—Å—Ç—ñ—Ä –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω—å –≤ –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫–∞—Ö.';
                            } else {
                                healthLevel = '–ü–æ—Ç—Ä–µ–±—É—î —É–≤–∞–≥–∏';
                                healthColor = '#ef4444';
                                healthText = '–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å–∏.';
                            }
                            
                            container.innerHTML = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
                                    <div>
                                        <div style="font-size:48px;font-weight:bold;color:${healthColor};text-align:center">${Math.round(totalScore)}</div>
                                        <div style="text-align:center;color:#64748b;font-size:14px">–±–∞–ª—ñ–≤ –∑—ñ 100</div>
                                        <div style="text-align:center;font-weight:600;color:${healthColor};margin-top:8px">${healthLevel}</div>
                                    </div>
                                    <div style="display:flex;flex-direction:column;gap:8px">
                                        <div style="display:flex;justify-content:space-between">
                                            <span>–î–æ—Ö–æ–¥–∏:</span>
                                            <span style="font-weight:600">${Math.round(revenueScore)}/30</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between">
                                            <span>–û–±'—î–º:</span>
                                            <span style="font-weight:600">${Math.round(volumeScore)}/25</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between">
                                            <span>–ó–∞–ø–æ–≤–Ω—é–≤–∞–Ω—ñ—Å—Ç—å:</span>
                                            <span style="font-weight:600">${Math.round(occupancyScore)}/25</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between">
                                            <span>–î–∏–≤–µ—Ä—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è:</span>
                                            <span style="font-weight:600">${Math.round(diversityScore)}/20</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="color:#374151;line-height:1.5">${healthText}</div>
                            `;
                            
                            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ä–∞–¥—ñ–∞–ª—å–Ω—É –¥—ñ–∞–≥—Ä–∞–º—É –∑–¥–æ—Ä–æ–≤'—è
                            try {
                                const canvas = document.getElementById('healthScoreChart');
                                if (canvas && typeof Chart !== 'undefined') {
                                    const ctx = canvas.getContext('2d');
                                    
                                    // –ó–Ω–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –¥—ñ–∞–≥—Ä–∞–º—É —è–∫—â–æ —î
                                    if (window.healthChart) {
                                        window.healthChart.destroy();
                                    }
                                    
                                    window.healthChart = new Chart(ctx, {
                                        type: 'doughnut',
                                        data: {
                                            datasets: [{
                                                data: [totalScore, 100 - totalScore],
                                                backgroundColor: [healthColor, '#e5e7eb'],
                                                borderWidth: 0
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            cutout: '70%',
                                            plugins: {
                                                legend: { display: false },
                                                tooltip: { enabled: false }
                                            }
                                        }
                                    });
                                }
                            } catch (error) {
                                console.log('Chart.js –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è health score');
                            }
                        }

                        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ø–ª–∞–Ω—ñ–≤ –≤ –ü–ª–∞–Ω vs –§–∞–∫—Ç
                        function initPlanVsFactPlanSelector() {
                            const selector = document.getElementById('pvfPlanSelector');
                            if (!selector) return;
                            
                            const allPlans = JSON.parse(localStorage.getItem('campPlans') || '[]');
                            const activePlanId = localStorage.getItem('activePlanId');
                            
                            selector.innerHTML = '';
                            if (allPlans.length === 0) {
                                selector.innerHTML = '<option value="">–ü–ª–∞–Ω—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
                                return;
                            }
                            
                            allPlans.forEach(plan => {
                                const option = document.createElement('option');
                                option.value = plan.id;
                                option.textContent = plan.name;
                                if (plan.id == activePlanId) {
                                    option.selected = true;
                                }
                                selector.appendChild(option);
                            });
                        }
                        
                        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–º—ñ–Ω–∏ –ø–ª–∞–Ω—É –≤ –ü–ª–∞–Ω vs –§–∞–∫—Ç
                        function changePlanVsFactPlan() {
                            const selector = document.getElementById('pvfPlanSelector');
                            const planId = selector.value;
                            
                            if (!planId) return;
                            
                            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∏–±—Ä–∞–Ω–∏–π –ø–ª–∞–Ω —è–∫ –∞–∫—Ç–∏–≤–Ω–∏–π
                            localStorage.setItem('activePlanId', planId);
                            
                            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω—É
                            updatePlanVsFactAnalytics();
                        }

                        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ü–ª–∞–Ω vs –§–∞–∫—Ç
                        function updatePlanVsFactAnalytics() {
                            console.log('üìä –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ü–ª–∞–Ω vs –§–∞–∫—Ç...');
                            
                            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ —Ç–∞ CRM
                            const crmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');
                            const allPlans = JSON.parse(localStorage.getItem('campPlans') || '[]');
                            const clients = crmData.clients || [];
                            const financeOperations = JSON.parse(localStorage.getItem('financeOperations') || '[]');
                            const operations = JSON.parse(localStorage.getItem('operations') || '[]');
                            
                            console.log('üìä –ó–Ω–∞–π–¥–µ–Ω–æ –ø–ª–∞–Ω—ñ–≤:', allPlans.length);
                            console.log('üìä –û–ø–µ—Ä–∞—Ü—ñ–π –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö:', financeOperations.length);
                            if (allPlans.length > 0) {
                                console.log('üìä –ü–µ—Ä—à–∏–π –ø–ª–∞–Ω:', allPlans[0].name, '| –ü–µ—Ä—ñ–æ–¥—ñ–≤:', allPlans[0].periods?.length);
                                console.log('üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä—ñ–æ–¥—É 0:', allPlans[0].periods?.[0]);
                            }
                            console.log('üìä –ö–ª—ñ—î–Ω—Ç—ñ–≤ –≤ CRM:', clients.length);
                            
                            // –ó–∞–≥–∞–ª—å–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏
                            let totalPlannedChildren = 0;
                            let totalFactChildren = clients.length;
                            let totalPlannedRevenue = 0;
                            let totalFactRevenue = 0;
                            let totalPlannedExpenses = 0;
                            let totalFactExpenses = 0;
                            let totalPlannedCapacity = 0;
                            
                            // –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ
                            const periodComparisons = [];
                            
                            // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤
                            const activePlanId = localStorage.getItem('activePlanId');
                            const activePlan = allPlans.find(plan => plan.id === activePlanId || plan.id == activePlanId);
                            const allPeriods = new Set();
                            console.log('üìä –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–ª–∞–Ω–∏ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—ñ–≤ (activePlanId:', activePlanId, ')...');
                            allPlans.forEach((plan, idx) => {
                                const isActive = plan.id === activePlanId || plan.id == activePlanId;
                                console.log(`  –ü–ª–∞–Ω ${idx}: ${plan.name}, id: ${plan.id}, –∞–∫—Ç–∏–≤–Ω–∏–π: ${isActive}, periods:`, plan.periods?.length);
                                if (isActive && plan.periods) {
                                    plan.periods.forEach((p, pidx) => {
                                        // –ü–µ—Ä—ñ–æ–¥ –º–∞—î –ø–æ–ª–µ periodName, –Ω–µ name
                                        const periodName = p.periodName || p.name;
                                        console.log(`    –ü–µ—Ä—ñ–æ–¥ ${pidx}: periodName="${p.periodName}", name="${p.name}", —Ä–µ–∑—É–ª—å—Ç–∞—Ç="${periodName}"`);
                                        if (periodName) allPeriods.add(periodName);
                                    });
                                }
                            });
                            
                            console.log('üìä –£–Ω—ñ–∫–∞–ª—å–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏ –∑ –ø–ª–∞–Ω—ñ–≤:', Array.from(allPeriods));
                            
                            // –û–±—Ä–æ–±–ª—è—î–º–æ –∫–æ–∂–µ–Ω –ø–µ—Ä—ñ–æ–¥ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤
                            allPeriods.forEach(periodName => {
                                let periodPlannedChildren = 0;
                                let periodPlannedRevenue = 0;
                                let periodPlannedExpenses = 0;
                                let periodCapacity = 0;
                                
                                // –®—É–∫–∞—î–º–æ —Ü–µ–π –ø–µ—Ä—ñ–æ–¥ –≤ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω–∞—Ö
                                allPlans.forEach(plan => {
                                    const isActive = plan.id === activePlanId || plan.id == activePlanId;
                                    if (!isActive || !plan.periods) return;
                                    
                                    const period = plan.periods.find(p => (p.periodName || p.name) === periodName);
                                    if (!period) return;
                                    
                                    // –û–±—Ä–æ–±–ª—è—î–º–æ –∫–æ–∂–Ω—É –ª–æ–∫–∞—Ü—ñ—é –≤ –ø–µ—Ä—ñ–æ–¥—ñ
                                    (period.locations || []).forEach((location, locIdx) => {
                                        if (locIdx === 0) {
                                            console.log(`  üìç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–∫–∞—Ü—ñ—ó 0:`, location);
                                        }
                                        
                                        // –ü–æ–ª—è: locationName, shiftsCount, avgChildren (–¥—ñ—Ç–µ–π –Ω–∞ –∑–º—ñ–Ω—É)
                                        const locName = location.locationName || location.name || '–ù–µ–≤—ñ–¥–æ–º–∞ –ª–æ–∫–∞—Ü—ñ—è';
                                        const shiftsCount = location.shiftsCount || location.shifts || 1;
                                        const capacityPerShift = location.avgChildren || location.capacity || location.childrenPerShift || 0;
                                        const price = location.price || 0;
                                        const expenses = location.expenses || 0;
                                        
                                        const locationCapacity = shiftsCount * capacityPerShift;
                                        
                                        periodCapacity += locationCapacity;
                                        periodPlannedChildren += locationCapacity;
                                        periodPlannedRevenue += locationCapacity * price;
                                        periodPlannedExpenses += locationCapacity * (expenses || 0);
                                        
                                        console.log(`  üìç ${locName}: ${shiftsCount} –∑–º—ñ–Ω x ${capacityPerShift} –¥—ñ—Ç–µ–π = ${locationCapacity} (—Ü—ñ–Ω–∞: ${price}, –≤–∏—Ç—Ä–∞—Ç–∏: ${expenses})`);
                                    });
                                });
                                
                                console.log(`üìä –ü–µ—Ä—ñ–æ–¥ "${periodName}": –ø–ª–∞–Ω ${periodPlannedChildren}, –º—ñ—Å—Ç–∫—ñ—Å—Ç—å ${periodCapacity}, –¥–æ—Ö—ñ–¥ ${periodPlannedRevenue}, –≤–∏—Ç—Ä–∞—Ç–∏ ${periodPlannedExpenses}`);
                                
                                // –§–∞–∫—Ç–∏—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –¥–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                                const periodClients = clients.filter(c => c.period === periodName);
                                const periodFactChildren = periodClients.length;
                                
                                // –§–∞–∫—Ç –¥–æ—Ö—ñ–¥ - –±–µ—Ä–µ–º–æ –∑ –æ–ø–µ—Ä–∞—Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "–î–æ—Ö–æ–¥–∏"
                                let periodFactRevenue = 0;
                                financeOperations.forEach(op => {
                                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –æ–ø–µ—Ä–∞—Ü—ñ—è –¥–æ—Ö–æ–¥—É –¥–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É
                                    if (op.period === periodName && op.category && op.category.includes('–î–æ—Ö–æ–¥–∏')) {
                                        const amount = parseFloat(op.amount) || 0;
                                        periodFactRevenue += amount;
                                    }
                                });
                                // –¢–∞–∫–æ–∂ –±–µ—Ä–µ–º–æ –∑ –æ–ø–µ—Ä–∞—Ü—ñ–π —Ä–∞—Ö—É–Ω–∫—ñ–≤ (–¥–æ—Ö—ñ–¥–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó - amount > 0)
                                operations.forEach(op => {
                                    if (op.period === periodName && op.amount > 0 && (!op.category || !op.category.startsWith('–ü—Ä—è–º—ñ.'))) {
                                        const amount = parseFloat(op.amount) || 0;
                                        periodFactRevenue += amount;
                                    }
                                });
                                
                                // –§–∞–∫—Ç –≤–∏—Ç—Ä–∞—Ç–∏ - –±–µ—Ä–µ–º–æ –≤–∏—Ç—Ä–∞—á–µ–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó (amount < 0)
                                let periodFactExpenses = 0;
                                operations.forEach(op => {
                                    if (op.period === periodName && op.amount < 0) {
                                        const amount = Math.abs(parseFloat(op.amount)) || 0;
                                        periodFactExpenses += amount;
                                    }
                                });
                                
                                console.log(`üìä –ü–µ—Ä—ñ–æ–¥ "${periodName}" —Ñ–∞–∫—Ç –¥–æ—Ö—ñ–¥: ${periodFactRevenue}, —Ñ–∞–∫—Ç –≤–∏—Ç—Ä–∞—Ç–∏: ${periodFactExpenses}`);
                                
                                // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                                const childrenExecution = periodPlannedChildren > 0 ? (periodFactChildren / periodPlannedChildren * 100) : 0;
                                const revenueExecution = periodPlannedRevenue > 0 ? (periodFactRevenue / periodPlannedRevenue * 100) : 0;
                                const occupancyPlan = 85; // –¶—ñ–ª—å–æ–≤–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å 85%
                                const occupancyFact = periodCapacity > 0 ? (periodFactChildren / periodCapacity * 100) : 0;
                                
                                // –°—Ç–∞—Ç—É—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                                let status, statusColor;
                                if (childrenExecution >= 90) {
                                    status = 'üü¢ –í—ñ–¥–º—ñ–Ω–Ω–æ';
                                    statusColor = '#10b981';
                                } else if (childrenExecution >= 70) {
                                    status = 'üü° –î–æ–±—Ä–µ';
                                    statusColor = '#f59e0b';
                                } else if (childrenExecution >= 50) {
                                    status = 'üü† –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ';
                                    statusColor = '#f97316';
                                } else {
                                    status = 'üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ';
                                    statusColor = '#ef4444';
                                }
                                
                                periodComparisons.push({
                                    period: periodName,
                                    plannedChildren: periodPlannedChildren,
                                    factChildren: periodFactChildren,
                                    plannedRevenue: periodPlannedRevenue,
                                    factRevenue: periodFactRevenue,
                                    plannedExpenses: periodPlannedExpenses,
                                    factExpenses: periodFactExpenses,
                                    occupancyPlan: occupancyPlan,
                                    occupancyFact: occupancyFact,
                                    childrenExecution: childrenExecution,
                                    revenueExecution: revenueExecution,
                                    status: status,
                                    statusColor: statusColor
                                });
                                
                                // –î–æ–¥–∞—î–º–æ –¥–æ –∑–∞–≥–∞–ª—å–Ω–∏—Ö
                                totalPlannedChildren += periodPlannedChildren;
                                totalPlannedRevenue += periodPlannedRevenue;
                                totalPlannedExpenses += periodPlannedExpenses;
                                totalPlannedCapacity += periodCapacity;
                            });
                            
                            // –î–æ–¥–∞—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏, —è–∫—ñ —î –≤ CRM, –∞–ª–µ –Ω–µ –≤ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω–∞—Ö
                            const crmPeriods = crmData.periods || [];
                            crmPeriods.forEach(periodName => {
                                if (!allPeriods.has(periodName)) {
                                    console.log(`üìä –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –ø–µ—Ä—ñ–æ–¥ –∑ CRM (–±–µ–∑ –ø–ª–∞–Ω—É): "${periodName}"`);
                                    allPeriods.add(periodName);
                                    
                                    // –§–∞–∫—Ç–∏—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É –±–µ–∑ –ø–ª–∞–Ω—É
                                    const periodClients = clients.filter(c => c.period === periodName);
                                    const periodFactChildren = periodClients.length;
                                    
                                    // –§–∞–∫—Ç –¥–æ—Ö—ñ–¥ - –±–µ—Ä–µ–º–æ –∑ –æ–ø–µ—Ä–∞—Ü—ñ–π
                                    let periodFactRevenue = 0;
                                    financeOperations.forEach(op => {
                                        if (op.period === periodName && op.category && op.category.includes('–î–æ—Ö–æ–¥–∏')) {
                                            const amount = parseFloat(op.amount) || 0;
                                            periodFactRevenue += amount;
                                        }
                                    });
                                    // –¢–∞–∫–æ–∂ –±–µ—Ä–µ–º–æ –∑ –æ–ø–µ—Ä–∞—Ü—ñ–π —Ä–∞—Ö—É–Ω–∫—ñ–≤ (–¥–æ—Ö—ñ–¥–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó - amount > 0)
                                    operations.forEach(op => {
                                        if (op.period === periodName && op.amount > 0 && (!op.category || !op.category.startsWith('–ü—Ä—è–º—ñ.'))) {
                                            const amount = parseFloat(op.amount) || 0;
                                            periodFactRevenue += amount;
                                        }
                                    });
                                    
                                    // –§–∞–∫—Ç –≤–∏—Ç—Ä–∞—Ç–∏ - –±–µ—Ä–µ–º–æ –≤–∏—Ç—Ä–∞—á–µ–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó (amount < 0)
                                    let periodFactExpenses = 0;
                                    operations.forEach(op => {
                                        if (op.period === periodName && op.amount < 0) {
                                            const amount = Math.abs(parseFloat(op.amount)) || 0;
                                            periodFactExpenses += amount;
                                        }
                                    });
                                    
                                    periodComparisons.push({
                                        period: periodName,
                                        plannedChildren: 0,
                                        factChildren: periodFactChildren,
                                        plannedRevenue: 0,
                                        factRevenue: periodFactRevenue,
                                        plannedExpenses: 0,
                                        factExpenses: periodFactExpenses,
                                        occupancyPlan: 85,
                                        occupancyFact: 0,
                                        childrenExecution: 0,
                                        revenueExecution: 0,
                                        status: 'üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ',
                                        statusColor: '#ef4444'
                                    });
                                }
                            });
                            
                            // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ–∞–∫—Ç –¥–æ—Ö–æ–¥—ñ–≤ –∑ –æ–ø–µ—Ä–∞—Ü—ñ–π
                            totalFactRevenue = 0;
                            financeOperations.forEach(op => {
                                if (op.category && op.category.includes('–î–æ—Ö–æ–¥–∏')) {
                                    const amount = parseFloat(op.amount) || 0;
                                    totalFactRevenue += amount;
                                }
                            });
                            // –¢–∞–∫–æ–∂ –±–µ—Ä–µ–º–æ –¥–æ—Ö—ñ–¥–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ —Ä–∞—Ö—É–Ω–∫—ñ–≤ (amount > 0, –Ω–µ –≤–∏—Ç—Ä–∞—Ç–∏)
                            operations.forEach(op => {
                                if (op.amount > 0 && (!op.category || !op.category.startsWith('–ü—Ä—è–º—ñ.'))) {
                                    const amount = parseFloat(op.amount) || 0;
                                    totalFactRevenue += amount;
                                }
                            });
                            console.log(`üìä –ó–∞–≥–∞–ª—å–Ω–∏–π —Ñ–∞–∫—Ç –¥–æ—Ö—ñ–¥ (–∑ –æ–ø–µ—Ä–∞—Ü—ñ–π): ${totalFactRevenue} –≥—Ä–Ω`);
                            
                            // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏
                            totalFactExpenses = 0;
                            operations.forEach(op => {
                                if (op.amount < 0) {
                                    const amount = Math.abs(parseFloat(op.amount)) || 0;
                                    totalFactExpenses += amount;
                                }
                            });
                            console.log(`üìä –ó–∞–≥–∞–ª—å–Ω—ñ —Ñ–∞–∫—Ç–∏—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏: ${totalFactExpenses} –≥—Ä–Ω`);
                            
                            const factCostBreakdown = calculateFactCostBreakdown(operations);
                            
                            const metricsOverride = activePlan?.metrics || null;
                            const summaryPlannedChildren = metricsOverride?.totalChildren ?? totalPlannedChildren;
                            const summaryPlannedRevenue = metricsOverride?.totalRevenue ?? totalPlannedRevenue;
                            const summaryPlannedExpenses = metricsOverride?.seasonTotalCost ?? totalPlannedExpenses;
                            const summaryPlannedCapacity = metricsOverride?.totalCapacity ?? totalPlannedCapacity;

                            // –û–Ω–æ–≤–ª—é—î–º–æ Summary KPI –∫–∞—Ä—Ç–∫–∏
                            updatePlanVsFactSummaryCards(
                                summaryPlannedChildren, 
                                totalFactChildren,
                                summaryPlannedRevenue,
                                totalFactRevenue,
                                summaryPlannedExpenses,
                                totalFactExpenses,
                                summaryPlannedCapacity
                            );
                            renderPlanVsFactCostBreakdown(activePlan?.metrics || null, factCostBreakdown);
                            
                            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥—ñ–≤
                            renderPlanVsFactPeriodTable(periodComparisons);
                            
                            // –û–Ω–æ–≤–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫–∏
                            renderPlanVsFactCharts(periodComparisons);
                            
                            // –ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥—Ö–∏–ª–µ–Ω—å
                            renderDeviationsAnalysis(periodComparisons);
                        }
                        
                        function renderPlanVsFactCostBreakdown(planMetrics, factBreakdown) {
                        const section = document.getElementById('pvfCostBreakdownSection');
                        const chipsContainer = document.getElementById('pvfCostCategoryChips');
                        const totalLabel = document.getElementById('pvfCostBreakdownTotal');
                        const tbody = document.getElementById('pvfCostBreakdownBody');
                        
                        if (!section) return;
                        
                        if (!planMetrics?.costBreakdown && !factBreakdown?.categories) {
                            section.style.display = 'none';
                            return;
                        }
                        
                        section.style.display = 'block';
                        const planCategories = planMetrics?.costBreakdown?.categories || {};
                        const factCategories = factBreakdown?.categories || {};
                        const planPeriods = planMetrics?.costBreakdown?.periods || [];
                        const factPeriods = factBreakdown?.periods || [];
                        const totalPlan = planCategories.total || 0;
                        const totalFact = factCategories.total || 0;
                        
                        if (totalLabel) {
                            totalLabel.textContent = [
                            totalPlan ? `–ü–ª–∞–Ω: ${Math.round(totalPlan).toLocaleString('uk-UA')} –≥—Ä–Ω` : '',
                            totalFact ? `–§–∞–∫—Ç: ${Math.round(totalFact).toLocaleString('uk-UA')} –≥—Ä–Ω` : ''
                            ].filter(Boolean).join(' ‚Ä¢ ') || '0 –≥—Ä–Ω';
                        }
                        
                        if (chipsContainer) {
                            const catMeta = [
                            { key: 'salary', label: '–ó–ü –∫–æ–º–∞–Ω–¥–∏', color: '#3b82f6', icon: 'üë•' },
                            { key: 'living', label: '–ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è', color: '#0ea5e9', icon: 'üè®' },
                            { key: 'food', label: '–•–∞—Ä—á—É–≤–∞–Ω–Ω—è', color: '#f97316', icon: 'üçΩÔ∏è' },
                            { key: 'program', label: '–ü—Ä–æ–≥—Ä–∞–º–∞ + –¥–æ–¥.', color: '#a855f7', icon: 'üé≠' },
                            { key: 'operational', label: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ', color: '#f59e0b', icon: '‚öôÔ∏è' }
                            ];
                            
                            chipsContainer.innerHTML = catMeta.map(cat => {
                            const planValue = planCategories[cat.key] || 0;
                            const factValue = factCategories[cat.key] || 0;
                            const planPercent = totalPlan > 0 ? (planValue / totalPlan * 100) : 0;
                            const factPercent = totalFact > 0 ? (factValue / totalFact * 100) : 0;
                            return `
                                <div style="padding:12px;border-radius:10px;border:1px solid #e2e8f0;background:#f8fafc">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                                        <span style="font-size:13px;color:#64748b;font-weight:600">${cat.icon} ${cat.label}</span>
                                        <span style="font-size:11px;color:#475569;font-weight:600">${planPercent.toFixed(1)}% ¬∑ ${factPercent.toFixed(1)}%</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:12px;color:#94a3b8;margin-bottom:4px">
                                        <span>–ü–ª–∞–Ω</span><span>–§–∞–∫—Ç</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:15px;font-weight:700">
                                        <span style="color:#3b82f6">${Math.round(planValue).toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                                        <span style="color:#ef4444">${Math.round(factValue).toLocaleString('uk-UA')} –≥—Ä–Ω</span>
                                    </div>
                                    <div style="height:6px;background:#e2e8f0;border-radius:999px;margin-top:8px;overflow:hidden;position:relative">
                                        <div style="width:${Math.min(100, planPercent)}%;height:100%;background:${cat.color};opacity:0.5;position:absolute;left:0;top:0;border-radius:999px"></div>
                                        <div style="width:${Math.min(100, factPercent)}%;height:100%;background:${cat.color};position:absolute;left:0;top:0;border-radius:999px"></div>
                                    </div>
                                </div>`;
                            }).join('');
                        }
                        
                        if (tbody) {
                            const planMap = new Map((planPeriods || []).map(p => [p.period, p]));
                            const factMap = new Map((factPeriods || []).map(p => [p.period, p]));
                            const periodNames = Array.from(new Set([...planMap.keys(), ...factMap.keys()]));
                            
                            if (periodNames.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="8" style="padding:32px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ –≤–∏—Ç—Ä–∞—Ç–∞–º</td></tr>';
                            } else {
                            periodNames.sort();
                            const formatValue = (value) => Math.round(value || 0).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            const renderCell = (planVal, factVal) => `
                                <div style="display:flex;justify-content:space-between;color:#94a3b8;font-size:11px">
                                    <span>–ü–ª–∞–Ω</span><span>${formatValue(planVal)}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;color:#475569;font-weight:600;font-size:12px">
                                    <span>–§–∞–∫—Ç</span><span>${formatValue(factVal)}</span>
                                </div>`;
                            
                            tbody.innerHTML = periodNames.map(periodName => {
                                const planPeriod = planMap.get(periodName);
                                const factPeriod = factMap.get(periodName);
                                const planTotals = planPeriod?.totals || {};
                                const factTotals = factPeriod?.totals || {};
                                const planTotalRow = planTotals.total || 0;
                                const factTotalRow = factTotals.total || 0;
                                const planTopLocation = planPeriod?.locations?.reduce((best, loc) => !best || loc.total > best.total ? loc : best, null);
                                const factTopLocation = factPeriod?.locations?.reduce((best, loc) => !best || loc.total > best.total ? loc : best, null);
                                
                                const topLocationCell = `
                                    <div style="font-size:12px;color:#3b82f6;font-weight:600">
                                        ${planTopLocation ? `${planTopLocation.location || '‚Äî'} ¬∑ ${formatValue(planTopLocation.total)} (${planTotalRow > 0 ? (planTopLocation.total / planTotalRow * 100).toFixed(1) : 0}%)` : '‚Äî'}
                                    </div>
                                    <div style="font-size:12px;color:#ef4444;font-weight:600">
                                        ${factTopLocation ? `${factTopLocation.location || '‚Äî'} ¬∑ ${formatValue(factTopLocation.total)} (${factTotalRow > 0 ? (factTopLocation.total / factTotalRow * 100).toFixed(1) : 0}%)` : '‚Äî'}
                                    </div>`;
                                
                                return `
                                <tr style="border-bottom:1px solid #e5e7eb">
                                    <td style="padding:10px 8px;font-weight:600;color:#0f172a">${periodName}</td>
                                    <td style="padding:10px 8px;text-align:right">${renderCell(planTotals.salary || 0, factTotals.salary || 0)}</td>
                                    <td style="padding:10px 8px;text-align:right">${renderCell(planTotals.living || 0, factTotals.living || 0)}</td>
                                    <td style="padding:10px 8px;text-align:right">${renderCell(planTotals.food || 0, factTotals.food || 0)}</td>
                                    <td style="padding:10px 8px;text-align:right">${renderCell(planTotals.program || 0, factTotals.program || 0)}</td>
                                    <td style="padding:10px 8px;text-align:right">${renderCell(planTotals.operational || 0, factTotals.operational || 0)}</td>
                                    <td style="padding:10px 8px;text-align:right;font-weight:700;color:#0f172a">${renderCell(planTotalRow, factTotalRow)}</td>
                                    <td style="padding:10px 8px;color:#475569">${topLocationCell}</td>
                                </tr>`;
                            }).join('');
                            }
                        }
                        }
                        
                        function updatePlanVsFactSummaryCards(plannedChildren, factChildren, plannedRevenue, factRevenue, plannedExpenses, factExpenses, plannedCapacity) {
                            // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                            const childrenExecution = plannedChildren > 0 ? (factChildren / plannedChildren * 100) : 0;
                            const revenueExecution = plannedRevenue > 0 ? (factRevenue / plannedRevenue * 100) : 0;
                            const expensesExecution = plannedExpenses > 0 ? (factExpenses / plannedExpenses * 100) : 0;
                            const avgCheckPlan = plannedChildren > 0 ? plannedRevenue / plannedChildren : 0;
                            const avgCheckFact = factChildren > 0 ? factRevenue / factChildren : 0;
                            const avgCheckExecution = avgCheckPlan > 0 ? (avgCheckFact / avgCheckPlan * 100) : 0;
                            const occupancyPlan = 85;
                            const occupancyFact = plannedCapacity > 0 ? (factChildren / plannedCapacity * 100) : 0;
                            const occupancyExecution = occupancyPlan > 0 ? (occupancyFact / occupancyPlan * 100) : 0;
                            
                            // –§—É–Ω–∫—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É
                            function getStatus(execution) {
                                if (execution >= 90) return { text: 'üü¢ –í—ñ–¥–º—ñ–Ω–Ω–æ', color: '#10b981', bg: '#d1fae5' };
                                if (execution >= 70) return { text: 'üü° –î–æ–±—Ä–µ', color: '#f59e0b', bg: '#fef3c7' };
                                if (execution >= 50) return { text: 'üü† –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ', color: '#f97316', bg: '#fed7aa' };
                                return { text: 'üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ', color: '#ef4444', bg: '#fee2e2' };
                            }
                            
                            // –î—ñ—Ç–∏
                            const childrenStatus = getStatus(childrenExecution);
                            document.getElementById('pvfChildrenPlan').textContent = plannedChildren.toLocaleString('uk-UA');
                            document.getElementById('pvfChildrenFact').textContent = factChildren.toLocaleString('uk-UA');
                            document.getElementById('pvfChildrenProgress').style.width = Math.min(100, childrenExecution) + '%';
                            document.getElementById('pvfChildrenPercent').textContent = childrenExecution.toFixed(1) + '% –≤–∏–∫–æ–Ω–∞–Ω–Ω—è';
                            const childrenStatusEl = document.getElementById('pvfChildrenStatus');
                            childrenStatusEl.textContent = childrenStatus.text;
                            childrenStatusEl.style.background = childrenStatus.bg;
                            childrenStatusEl.style.color = childrenStatus.color;
                            
                            // –î–æ—Ö–æ–¥–∏
                            const revenueStatus = getStatus(revenueExecution);
                            document.getElementById('pvfRevenuePlan').textContent = Math.round(plannedRevenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            document.getElementById('pvfRevenueFact').textContent = Math.round(factRevenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            document.getElementById('pvfRevenueProgress').style.width = Math.min(100, revenueExecution) + '%';
                            document.getElementById('pvfRevenuePercent').textContent = revenueExecution.toFixed(1) + '% –≤–∏–∫–æ–Ω–∞–Ω–Ω—è';
                            const revenueStatusEl = document.getElementById('pvfRevenueStatus');
                            revenueStatusEl.textContent = revenueStatus.text;
                            revenueStatusEl.style.background = revenueStatus.bg;
                            revenueStatusEl.style.color = revenueStatus.color;
                            
                            // –í–∏—Ç—Ä–∞—Ç–∏
                            const expensesStatus = getStatus(100 - expensesExecution);  // –ú–µ–Ω—à–µ –≤–∏—Ç—Ä–∞—Ç = –∫—Ä–∞—â–µ
                            document.getElementById('pvfExpensesPlan').textContent = Math.round(plannedExpenses).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            document.getElementById('pvfExpensesFact').textContent = Math.round(factExpenses).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            document.getElementById('pvfExpensesProgress').style.width = Math.min(100, expensesExecution) + '%';
                            document.getElementById('pvfExpensesPercent').textContent = expensesExecution.toFixed(1) + '% –≤—ñ–¥ –ø–ª–∞–Ω—É';
                            const expensesStatusEl = document.getElementById('pvfExpensesStatus');
                            expensesStatusEl.textContent = expensesStatus.text;
                            expensesStatusEl.style.background = expensesStatus.bg;
                            expensesStatusEl.style.color = expensesStatus.color;
                            
                            // –ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å
                            const occupancyStatus = getStatus(occupancyExecution);
                            document.getElementById('pvfOccupancyPlan').textContent = occupancyPlan.toFixed(0) + '%';
                            document.getElementById('pvfOccupancyFact').textContent = occupancyFact.toFixed(1) + '%';
                            document.getElementById('pvfOccupancyProgress').style.width = Math.min(100, occupancyExecution) + '%';
                            document.getElementById('pvfOccupancyPercent').textContent = occupancyExecution.toFixed(1) + '% –≤–∏–∫–æ–Ω–∞–Ω–Ω—è';
                            const occupancyStatusEl = document.getElementById('pvfOccupancyStatus');
                            occupancyStatusEl.textContent = occupancyStatus.text;
                            occupancyStatusEl.style.background = occupancyStatus.bg;
                            occupancyStatusEl.style.color = occupancyStatus.color;
                            
                            // –°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫
                            const avgCheckStatus = getStatus(avgCheckExecution);
                            document.getElementById('pvfAvgCheckPlan').textContent = Math.round(avgCheckPlan).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            document.getElementById('pvfAvgCheckFact').textContent = Math.round(avgCheckFact).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            document.getElementById('pvfAvgCheckProgress').style.width = Math.min(100, avgCheckExecution) + '%';
                            document.getElementById('pvfAvgCheckPercent').textContent = avgCheckExecution.toFixed(1) + '% –≤–∏–∫–æ–Ω–∞–Ω–Ω—è';
                            const avgCheckStatusEl = document.getElementById('pvfAvgCheckStatus');
                            avgCheckStatusEl.textContent = avgCheckStatus.text;
                            avgCheckStatusEl.style.background = avgCheckStatus.bg;
                            avgCheckStatusEl.style.color = avgCheckStatus.color;
                        }
                        
                        function renderPlanVsFactPeriodTable(comparisons) {
                            const tbody = document.getElementById('pvfPeriodComparisonBody');
                            
                            if (comparisons.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</td></tr>';
                                return;
                            }
                            
                            tbody.innerHTML = comparisons.map(comp => `
                                <tr style="border-bottom:1px solid #e5e7eb">
                                    <td style="padding:12px 8px;font-weight:600;color:#1e293b">${comp.period}</td>
                                    <td style="padding:12px 8px;text-align:center">
                                        <div style="color:#3b82f6;font-weight:600">${comp.plannedChildren}</div>
                                        <div style="color:#10b981;font-weight:600">${comp.factChildren}</div>
                                        <div style="font-size:11px;color:#64748b">${comp.factChildren - comp.plannedChildren >= 0 ? '+' : ''}${comp.factChildren - comp.plannedChildren}</div>
                                    </td>
                                    <td style="padding:12px 8px;text-align:center">
                                        <div style="color:#3b82f6;font-weight:600">${comp.occupancyPlan.toFixed(0)}%</div>
                                        <div style="color:#10b981;font-weight:600">${comp.occupancyFact.toFixed(1)}%</div>
                                        <div style="font-size:11px;color:#64748b">${(comp.occupancyFact - comp.occupancyPlan).toFixed(1)}%</div>
                                    </td>
                                    <td style="padding:12px 8px;text-align:right">
                                        <div style="color:#3b82f6;font-weight:600">${Math.round(comp.plannedRevenue / 1000).toLocaleString('uk-UA')}K</div>
                                        <div style="color:#10b981;font-weight:600">${Math.round(comp.factRevenue / 1000).toLocaleString('uk-UA')}K</div>
                                        <div style="font-size:11px;color:#64748b">${comp.factRevenue - comp.plannedRevenue >= 0 ? '+' : ''}${Math.round((comp.factRevenue - comp.plannedRevenue) / 1000).toLocaleString('uk-UA')}K</div>
                                    </td>
                                    <td style="padding:12px 8px;text-align:right">
                                        <div style="color:#3b82f6;font-weight:600">${Math.round(comp.plannedExpenses / 1000).toLocaleString('uk-UA')}K</div>
                                        <div style="color:#ef4444;font-weight:600">${Math.round(comp.factExpenses / 1000).toLocaleString('uk-UA')}K</div>
                                        <div style="font-size:11px;color:#64748b">${comp.factExpenses - comp.plannedExpenses >= 0 ? '+' : ''}${Math.round((comp.factExpenses - comp.plannedExpenses) / 1000).toLocaleString('uk-UA')}K</div>
                                    </td>
                                    <td style="padding:12px 8px;text-align:center">
                                        <div style="font-weight:700;font-size:16px;color:${comp.statusColor}">${comp.childrenExecution.toFixed(1)}%</div>
                                        <div style="background:#f1f5f9;border-radius:8px;height:6px;margin-top:4px;overflow:hidden">
                                            <div style="background:${comp.statusColor};height:100%;width:${Math.min(100, comp.childrenExecution)}%"></div>
                                        </div>
                                    </td>
                                    <td style="padding:12px 8px;text-align:center">
                                        <span style="padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;background:${comp.statusColor}20;color:${comp.statusColor}">${comp.status}</span>
                                    </td>
                                </tr>
                            `).join('');
                        }
                        
                        function renderPlanVsFactCharts(comparisons) {
                            if (comparisons.length === 0 || typeof Chart === 'undefined') return;
                            
                            // –ì—Ä–∞—Ñ—ñ–∫ –¥—ñ—Ç–µ–π –ü–ª–∞–Ω vs –§–∞–∫—Ç
                            try {
                                const ctxChildren = document.getElementById('pvfChildrenChart');
                                if (ctxChildren) {
                                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ canvas –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ –æ–±'—î–∫—Ç –≥—Ä–∞—Ñ—ñ–∫–∞)
                                    if (window.pvfChildrenChart && typeof window.pvfChildrenChart.destroy === 'function') {
                                        window.pvfChildrenChart.destroy();
                                    }
                                    
                                    window.pvfChildrenChart = new Chart(ctxChildren, {
                                        type: 'bar',
                                        data: {
                                            labels: comparisons.map(c => c.period),
                                            datasets: [
                                                {
                                                    label: '–ü–ª–∞–Ω',
                                                    data: comparisons.map(c => c.plannedChildren),
                                                    backgroundColor: '#3b82f6',
                                                    borderRadius: 6
                                                },
                                                {
                                                    label: '–§–∞–∫—Ç',
                                                    data: comparisons.map(c => c.factChildren),
                                                    backgroundColor: '#10b981',
                                                    borderRadius: 6
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: true,
                                            plugins: {
                                                legend: { position: 'bottom' },
                                                tooltip: {
                                                    callbacks: {
                                                        label: function(context) {
                                                            return context.dataset.label + ': ' + context.parsed.y + ' –¥—ñ—Ç–µ–π';
                                                        }
                                                    }
                                                }
                                            },
                                            scales: {
                                                y: { beginAtZero: true }
                                            }
                                        }
                                    });
                                }
                            } catch (e) {
                                console.log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É –¥—ñ—Ç–µ–π:', e);
                            }
                            
                            // –ì—Ä–∞—Ñ—ñ–∫ –¥–æ—Ö–æ–¥—ñ–≤ –ü–ª–∞–Ω vs –§–∞–∫—Ç
                            try {
                                const ctxRevenue = document.getElementById('pvfRevenueChart');
                                if (ctxRevenue) {
                                    if (window.pvfRevenueChart && typeof window.pvfRevenueChart.destroy === 'function') {
                                        window.pvfRevenueChart.destroy();
                                    }
                                    
                                    window.pvfRevenueChart = new Chart(ctxRevenue, {
                                        type: 'bar',
                                        data: {
                                            labels: comparisons.map(c => c.period),
                                            datasets: [
                                                {
                                                    label: '–ü–ª–∞–Ω (—Ç–∏—Å. –≥—Ä–Ω)',
                                                    data: comparisons.map(c => Math.round(c.plannedRevenue / 1000)),
                                                    backgroundColor: '#f59e0b',
                                                    borderRadius: 6
                                                },
                                                {
                                                    label: '–§–∞–∫—Ç (—Ç–∏—Å. –≥—Ä–Ω)',
                                                    data: comparisons.map(c => Math.round(c.factRevenue / 1000)),
                                                    backgroundColor: '#10b981',
                                                    borderRadius: 6
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: true,
                                            plugins: {
                                                legend: { position: 'bottom' },
                                                tooltip: {
                                                    callbacks: {
                                                        label: function(context) {
                                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString('uk-UA') + ' —Ç–∏—Å. –≥—Ä–Ω';
                                                        }
                                                    }
                                                }
                                            },
                                            scales: {
                                                y: { beginAtZero: true }
                                            }
                                        }
                                    });
                                }
                            } catch (e) {
                                console.log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É –¥–æ—Ö–æ–¥—ñ–≤:', e);
                            }
                            
                            // –ì—Ä–∞—Ñ—ñ–∫ –≤–∏—Ç—Ä–∞—Ç –ü–ª–∞–Ω vs –§–∞–∫—Ç
                            try {
                                const ctxExpenses = document.getElementById('pvfExpensesChart');
                                if (ctxExpenses) {
                                    if (window.pvfExpensesChart && typeof window.pvfExpensesChart.destroy === 'function') {
                                        window.pvfExpensesChart.destroy();
                                    }
                                    
                                    window.pvfExpensesChart = new Chart(ctxExpenses, {
                                        type: 'bar',
                                        data: {
                                            labels: comparisons.map(c => c.period),
                                            datasets: [
                                                {
                                                    label: '–ü–ª–∞–Ω (—Ç–∏—Å. –≥—Ä–Ω)',
                                                    data: comparisons.map(c => Math.round(c.plannedExpenses / 1000)),
                                                    backgroundColor: '#8b5cf6',
                                                    borderRadius: 6
                                                },
                                                {
                                                    label: '–§–∞–∫—Ç (—Ç–∏—Å. –≥—Ä–Ω)',
                                                    data: comparisons.map(c => Math.round(c.factExpenses / 1000)),
                                                    backgroundColor: '#ef4444',
                                                    borderRadius: 6
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: true,
                                            plugins: {
                                                legend: { position: 'bottom' },
                                                tooltip: {
                                                    callbacks: {
                                                        label: function(context) {
                                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString('uk-UA') + ' —Ç–∏—Å. –≥—Ä–Ω';
                                                        }
                                                    }
                                                }
                                            },
                                            scales: {
                                                y: { beginAtZero: true }
                                            }
                                        }
                                    });
                                }
                            } catch (e) {
                                console.log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É –≤–∏—Ç—Ä–∞—Ç:', e);
                            }
                        }
                        
                        function renderDeviationsAnalysis(comparisons) {
                            const container = document.getElementById('pvfDeviationsAnalysis');
                            
                            if (comparisons.length === 0) {
                                container.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</div>';
                                return;
                            }
                            
                            let html = '<div style="display:grid;gap:16px">';
                            
                            comparisons.forEach(comp => {
                                const childrenDeviation = comp.factChildren - comp.plannedChildren;
                                const revenueDeviation = comp.factRevenue - comp.plannedRevenue;
                                const deviationPercent = comp.childrenExecution - 100;
                                
                                const isPositive = childrenDeviation >= 0;
                                const deviationColor = isPositive ? '#10b981' : '#ef4444';
                                const deviationIcon = isPositive ? 'üìà' : 'üìâ';
                                
                                html += `
                                    <div style="padding:16px;border-left:4px solid ${deviationColor};background:#f8fafc;border-radius:8px">
                                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                            <div>
                                                <div style="font-weight:700;font-size:16px;color:#1e293b">${deviationIcon} ${comp.period}</div>
                                                <div style="font-size:13px;color:#64748b;margin-top:4px">–ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥—Ö–∏–ª–µ–Ω—å –≤—ñ–¥ –ø–ª–∞–Ω—É</div>
                                            </div>
                                            <div style="text-align:right">
                                                <div style="font-size:24px;font-weight:700;color:${deviationColor}">${deviationPercent > 0 ? '+' : ''}${deviationPercent.toFixed(1)}%</div>
                                                <div style="font-size:11px;color:#64748b">–≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</div>
                                            </div>
                                        </div>
                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                            <div>
                                                <div style="font-size:12px;color:#64748b;margin-bottom:4px">–î—ñ—Ç–∏</div>
                                                <div style="font-weight:600;color:${deviationColor}">${childrenDeviation >= 0 ? '+' : ''}${childrenDeviation} –¥—ñ—Ç–µ–π</div>
                                            </div>
                                            <div>
                                                <div style="font-size:12px;color:#64748b;margin-bottom:4px">–î–æ—Ö–æ–¥–∏</div>
                                                <div style="font-weight:600;color:${deviationColor}">${revenueDeviation >= 0 ? '+' : ''}${Math.round(revenueDeviation / 1000).toLocaleString('uk-UA')}K –≥—Ä–Ω</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += '</div>';
                            container.innerHTML = html;
                        }

                        // –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
                        function updateAnalytics() {
                            try {
                                console.log('üìä –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏...');
                                
                                // –°–ø–æ—á–∞—Ç–∫—É –æ–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –∑ –¥–∞–Ω–∏—Ö –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞
                                updateAnalyticsPeriodFilter();
                                updateAnalyticsLocationFilter();
                                
                                // –ü–æ—Ç—ñ–º –æ–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ —Å–µ–∫—Ü—ñ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
                                updateSalesAnalytics();
                                updateFinancialAnalytics();
                                updateProfitabilityAnalytics();
                                updatePnlAnalytics();
                                
                                console.log('‚úÖ –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ');
                            } catch (error) {
                                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏:', error);
                            }
                        }

                        function renderAnalyticsBreakdown(clients, shiftStats, periodFilter, locationFilter) {
                        const tbody = document.getElementById('analyticsBreakdownBody');
                        if (!tbody) {
                            console.log('‚ö†Ô∏è –ï–ª–µ–º–µ–Ω—Ç analyticsBreakdownBody –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                            return;
                        }
                        
                        console.log(`üìä –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–æ–∑–±–∏–≤–∫–∏: ${shiftStats.length} –∑–º—ñ–Ω, ${clients.length} –∫–ª—ñ—î–Ω—Ç—ñ–≤`);
                        
                        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –≤—ñ–¥–º–æ–≤
                        const currentCrmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');
                        
                        // –†–∞—Ö—É—î–º–æ –≤—ñ–¥–º–æ–≤–∏ per shift
                        const refundCounts = {};
                        currentCrmData.refunds.forEach(r => {
                            const key = `${r.period}|${r.location}|${r.shift}`;
                            refundCounts[key] = (refundCounts[key] || 0) + 1;
                        });
                        
                        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ä—è–¥–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –∑ shiftStats
                        const rows = shiftStats.map(stat => {
                            const count = stat.actual;
                            const plannedChildren = stat.planned;
                            const fillRate = plannedChildren > 0 ? (count / plannedChildren * 100) : 0;
                            
                            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è —Ü—ñ—î—ó –∑–º—ñ–Ω–∏
                            const shiftClients = clients.filter(c => 
                                c.period === stat.period && 
                                c.location === stat.location && 
                                c.shift === stat.shift
                            );
                            
                            const revenue = shiftClients.reduce((s, c) => s + (parseFloat(c.amountPaid) || 0), 0);
                            
                            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ—á—ñ–∫—É–≤–∞–Ω–∏—Ö –∫–æ—à—Ç—ñ–≤ –¥–ª—è —Ü—ñ—î—ó –∑–º—ñ–Ω–∏
                            const expected = shiftClients.reduce((s, c) => {
                                // –û—Ç—Ä–∏–º—É—î–º–æ —Ü—ñ–Ω—É –∑ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ –¥–ª—è —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
                                let clientBasePrice = 26900;
                                
                                const planWithPeriod = allPlans.find(plan => 
                                    plan.periods?.some(period => {
                                        const periodName = typeof period === 'string' ? period : period.periodName;
                                        return periodName === c.period;
                                    })
                                );
                                
                                if (planWithPeriod) {
                                    const foundPeriod = planWithPeriod.periods.find(period => {
                                        const periodName = typeof period === 'string' ? period : period.periodName;
                                        return periodName === c.period;
                                    });
                                    
                                    if (foundPeriod && typeof foundPeriod !== 'string' && foundPeriod.locations) {
                                        const foundLocation = foundPeriod.locations.find(loc => loc.locationName === c.location);
                                        if (foundLocation && foundLocation.price) {
                                            clientBasePrice = foundLocation.price;
                                        }
                                    }
                                }
                                
                                const price = (typeof calculateClientPrice === 'function') ? 
                                    calculateClientPrice(clientBasePrice, c.discount, c.transferCost) : 
                                    clientBasePrice;
                                return s + Math.max(0, price - (parseFloat(c.amountPaid) || 0));
                            }, 0);
                            
                            const total = revenue + expected;
                            const paymentPct = total > 0 ? (revenue / total * 100) : 0;
                            const refunds = refundCounts[`${stat.period}|${stat.location}|${stat.shift}`] || 0;
                            
                            return {
                                period: stat.period,
                                location: stat.location,
                                shift: stat.shift,
                                count,
                                plannedChildren,
                                fillRate,
                                revenue,
                                expected,
                                paymentPct,
                                refunds
                            };
                        });
                        
                        if (rows.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="10" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</td></tr>';
                            return;
                        }
                        
                        tbody.innerHTML = rows.map((r, idx) => {
                            const pctColor = r.paymentPct >= 75 ? '#10b981' : r.paymentPct >= 50 ? '#f59e0b' : '#ef4444';
                            const fillColor = r.fillRate >= 90 ? '#10b981' : r.fillRate >= 70 ? '#3b82f6' : r.fillRate >= 50 ? '#f59e0b' : '#ef4444';
                            const fillBg = r.fillRate >= 90 ? '#d1fae5' : r.fillRate >= 70 ? '#dbeafe' : r.fillRate >= 50 ? '#fef3c7' : '#fee2e2';
                            
                            return '<tr style="background:' + (idx % 2 === 0 ? 'white' : '#f9fafb') + ';border-bottom:1px solid #e5e7eb">' +
                            '<td style="padding:10px 8px;font-weight:600">' + r.period + '</td>' +
                            '<td style="padding:10px 8px">' + r.location + '</td>' +
                            '<td style="padding:10px 8px">' + r.shift + '</td>' +
                            '<td style="padding:10px 8px;text-align:center;font-weight:700;color:#64748b">' + (r.plannedChildren || '‚Äî') + '</td>' +
                            '<td style="padding:10px 8px;text-align:center;font-weight:700;color:#3b82f6">' + r.count + '</td>' +
                            '<td style="padding:10px 8px;text-align:center"><span style="padding:4px 8px;background:' + fillBg + ';color:' + fillColor + ';border-radius:6px;font-weight:700">' + (r.plannedChildren > 0 ? r.fillRate.toFixed(0) + '%' : '‚Äî') + '</span></td>' +
                            '<td style="padding:10px 8px;text-align:right;font-weight:700;color:#10b981">' + Math.round(r.revenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω</td>' +
                            '<td style="padding:10px 8px;text-align:right;font-weight:700;color:#f59e0b">' + Math.round(r.expected).toLocaleString('uk-UA') + ' –≥—Ä–Ω</td>' +
                            '<td style="padding:10px 8px;text-align:center"><span style="padding:4px 8px;background:' + (r.paymentPct >= 75 ? '#d1fae5' : r.paymentPct >= 50 ? '#fef3c7' : '#fee2e2') + ';color:' + pctColor + ';border-radius:6px;font-weight:700">' + r.paymentPct.toFixed(0) + '%</span></td>' +
                            '<td style="padding:10px 8px;text-align:center;font-weight:700;color:#ef4444">' + r.refunds + '</td>' +
                            '</tr>';
                        }).join('');
                        }

                        function renderAnalyticsSalesChart(clients) {
                        const ctx = document.getElementById('analyticsSalesChart');
                        if (!ctx) return;
                        
                        // Group by creation date and client type (–Ω–æ–≤–∏–π/—Å—Ç–∞—Ä–∏–π)
                        const dateMapNew = {};
                        const dateMapOld = {};
                        
                        clients.forEach(c => {
                            const date = c.createdAt ? c.createdAt.split('T')[0] : getCurrentDate();
                            const isOld = c.clientType === '—Å—Ç–∞—Ä–∏–π';
                            
                            if (isOld) {
                            dateMapOld[date] = (dateMapOld[date] || 0) + 1;
                            } else {
                            dateMapNew[date] = (dateMapNew[date] || 0) + 1;
                            }
                        });
                        
                        // Get all unique dates and sort
                        const allDates = new Set([...Object.keys(dateMapNew), ...Object.keys(dateMapOld)]);
                        const dates = Array.from(allDates).sort();
                        
                        const newCounts = dates.map(d => dateMapNew[d] || 0);
                        const oldCounts = dates.map(d => dateMapOld[d] || 0);
                        
                        if (analyticsSalesChart) analyticsSalesChart.destroy();
                        
                        analyticsSalesChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                            labels: dates,
                            datasets: [{
                                label: '–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏',
                                data: newCounts,
                                backgroundColor: '#3b82f6',
                                borderColor: '#2563eb',
                                borderWidth: 1
                            }, {
                                label: '–ü–æ—Å—Ç—ñ–π–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∏',
                                data: oldCounts,
                                backgroundColor: '#10b981',
                                borderColor: '#059669',
                                borderWidth: 1
                            }]
                            },
                            options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true, position: 'bottom' },
                                tooltip: {
                                callbacks: {
                                    footer: function(items) {
                                    const idx = items[0].dataIndex;
                                    const total = newCounts[idx] + oldCounts[idx];
                                    return '–í—Å—å–æ–≥–æ: ' + total + ' –∫–ª—ñ—î–Ω—Ç—ñ–≤';
                                    }
                                }
                                }
                            },
                            scales: { 
                                y: { 
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                                },
                                x: { 
                                stacked: true
                                },
                                y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                                }
                            }
                            }
                        });
                        }

                        function renderAnalyticsRevenueChart(clients, basePrice) {
                        const ctx = document.getElementById('analyticsRevenueChart');
                        if (!ctx) return;
                        
                        // Group by period
                        const periodRevenue = {};
                        const periodExpected = {};
                        
                        clients.forEach(c => {
                            const p = c.period || '–ë–µ–∑ –ø–µ—Ä—ñ–æ–¥—É';
                            const revenue = parseFloat(c.amountPaid) || 0;
                            const clientPrice = calculateClientPrice(basePrice, c.discount, c.transferCost);
                            const expected = clientPrice - revenue;
                            
                            periodRevenue[p] = (periodRevenue[p] || 0) + revenue;
                            periodExpected[p] = (periodExpected[p] || 0) + expected;
                        });
                        
                        const periods = Object.keys(periodRevenue);
                        const revenueData = periods.map(p => periodRevenue[p]);
                        const expectedData = periods.map(p => periodExpected[p]);
                        
                        if (analyticsRevenueChart) analyticsRevenueChart.destroy();
                        
                        analyticsRevenueChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                            labels: periods,
                            datasets: [{
                                label: '–û—Ç—Ä–∏–º–∞–Ω–æ (–≥—Ä–Ω)',
                                data: revenueData,
                                backgroundColor: '#10b981'
                            }, {
                                label: '–û—á—ñ–∫—É—î—Ç—å—Å—è (–≥—Ä–Ω)',
                                data: expectedData,
                                backgroundColor: '#f59e0b'
                            }]
                            },
                            options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'bottom' } },
                            scales: { 
                                y: { beginAtZero: true },
                                x: { stacked: false }
                            }
                            }
                        });
                        }

                        function renderManagersPerformance(clients, refunds, basePrice) {
                        const tbody = document.getElementById('analyticsManagersBody');
                        if (!tbody) return;
                        
                        const managerStats = {};
                        
                        clients.forEach(c => {
                            const mgr = c.manager || '–ë–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞';
                            if (!managerStats[mgr]) {
                            managerStats[mgr] = { clients: 0, revenue: 0, refunds: 0 };
                            }
                            managerStats[mgr].clients += 1;
                            managerStats[mgr].revenue += parseFloat(c.amountPaid) || 0;
                        });
                        
                        refunds.forEach(r => {
                            const mgr = r.manager || '–ë–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞';
                            if (!managerStats[mgr]) {
                            managerStats[mgr] = { clients: 0, revenue: 0, refunds: 0 };
                            }
                            managerStats[mgr].refunds += 1;
                        });
                        
                        const managers = Object.keys(managerStats).map(m => {
                            const stats = managerStats[m];
                            const avgCheck = stats.clients > 0 ? stats.revenue / stats.clients : 0;
                            const total = stats.clients + stats.refunds;
                            const conversion = total > 0 ? (stats.clients / total * 100) : 0;
                            return { manager: m, ...stats, avgCheck, conversion };
                        }).sort((a, b) => b.revenue - a.revenue);
                        
                        if (managers.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
                            return;
                        }
                        
                        tbody.innerHTML = managers.map((m, idx) => {
                            return '<tr style="background:' + (idx % 2 === 0 ? 'white' : '#f9fafb') + ';border-bottom:1px solid #e5e7eb">' +
                            '<td style="padding:10px 8px;font-weight:600">' + m.manager + '</td>' +
                            '<td style="padding:10px 8px;text-align:center;font-weight:700;color:#3b82f6">' + m.clients + '</td>' +
                            '<td style="padding:10px 8px;text-align:right;font-weight:700;color:#10b981">' + Math.round(m.revenue).toLocaleString('uk-UA') + ' –≥—Ä–Ω</td>' +
                            '<td style="padding:10px 8px;text-align:right;font-weight:700;color:#6366f1">' + Math.round(m.avgCheck).toLocaleString('uk-UA') + ' –≥—Ä–Ω</td>' +
                            '<td style="padding:10px 8px;text-align:center"><span style="padding:4px 8px;background:' + (m.conversion >= 80 ? '#d1fae5' : m.conversion >= 60 ? '#fef3c7' : '#fee2e2') + ';color:' + (m.conversion >= 80 ? '#065f46' : m.conversion >= 60 ? '#92400e' : '#991b1b') + ';border-radius:6px;font-weight:700">' + m.conversion.toFixed(0) + '%</span></td>' +
                            '</tr>';
                        }).join('');
                        }

                        // Initialize Analytics on tab switch
                        document.querySelectorAll('.tab-btn').forEach(btn => {
                        const oldListener = btn.onclick;
                        btn.addEventListener('click', () => {
                            const tabId = btn.getAttribute('data-tab');
                            
                            // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—ñ –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏
                            if (typeof syncPeriodSelection === 'function') {
                                setTimeout(syncPeriodSelection, 100);
                            }
                            
                            if (tabId === 'analyticsTab') {
                            updateAnalyticsPeriodFilter();
                            updateAnalyticsLocationFilter();
                            updateAnalytics();
                            } else if (tabId === 'clientsTab') {
                            // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤ CRM –æ–Ω–æ–≤–ª—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –ø–µ—Ä—ñ–æ–¥—ñ–≤
                            if (typeof updatePeriodSelect === 'function') {
                                updatePeriodSelect();
                            }
                            } else if (tabId === 'financeTab') {
                            // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤ –§—ñ–Ω–∞–Ω—Å–∏ –æ–Ω–æ–≤–ª—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –ø–µ—Ä—ñ–æ–¥—ñ–≤
                            updateAnalyticsPeriodFilter();
                            updateAnalyticsLocationFilter();
                            }
                        });
                        });



                        // Update CRM when period changes
                        document.getElementById('crmPeriod')?.addEventListener('change', () => {
                            updateLocationSelect();
                            updateShiftSelect();
                            syncPeriodSelection(); // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –∑ —ñ–Ω—à–∏–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏
                        });

                        // Update analytics when period filter changes
                        document.getElementById('analyticsPeriodFilter')?.addEventListener('change', () => {
                            updateAnalyticsLocationFilter();
                            updateAnalytics();
                            // syncPeriodSelection(); // –¢–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è —É—Å—É–Ω–µ–Ω–Ω—è –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è
                        });

                        document.getElementById('analyticsLocationFilter')?.addEventListener('change', updateAnalytics);

                        // Initialize system after all variables are ready
                        setTimeout(() => {
                        // Initialize plans system
                        allPlans = loadAllPlans();
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –≤—Å—ñ –ø–ª–∞–Ω–∏ –∑ CRM –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                        allPlans.forEach(plan => {
                            if (typeof syncPlanToCRM === 'function') {
                                syncPlanToCRM(plan);
                            }
                        });
                        
                        // Load active plan ID from localStorage
                        const savedActivePlanId = localStorage.getItem('activePlanId');
                        if (savedActivePlanId && allPlans.find(p => p.id === savedActivePlanId)) {
                            activePlanId = savedActivePlanId;
                        } else if (allPlans.length > 0) {
                            activePlanId = allPlans[0].id; // Default to first plan
                        }
                        
                        updateActivePlanSelector();
                        
                        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –ø–ª–∞–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                        if (activePlanId && allPlans.find(p => p.id === activePlanId)) {
                            console.log('üéØ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:', activePlanId);
                            loadPlanIntoEditor(activePlanId);
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –ø–µ—Ä—ñ–æ–¥—ñ–≤ –ø—ñ—Å–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
                        if (typeof updatePeriodSelectors === 'function') {
                            setTimeout(updatePeriodSelectors, 200);
                        }
                        
                        if (typeof buildTable === 'function') {
                            try {
                            buildTable();
                            } catch (e) {
                            console.log('Initial buildTable failed, will retry:', e);
                            setTimeout(buildTable, 500);
                            }
                        }
                        }, 100);

                        // ============ FINANCIAL ANALYTICS RENDER FUNCTIONS ============
                        
                        let financialIncomeChart = null;
                        let financialExpensesChart = null;
                        let financialTrendChart = null;
                        let profitabilityCostStructureChart = null;
                        let profitabilityTrendChart = null;

                        function renderFinancialIncomeChart(operations) {
                        const ctx = document.getElementById('financialIncomeChart');
                        if (!ctx || typeof Chart === 'undefined') {
                            console.log('Chart.js not loaded or canvas not found');
                            return;
                        }
                        
                        const incomeOps = operations.filter(op => (op.category || '').split('.')[0] === '–î–æ—Ö–æ–¥–∏');
                        const categories = {};
                        
                        incomeOps.forEach(op => {
                            const cat = op.category || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                            categories[cat] = (categories[cat] || 0) + Math.abs(parseFloat(op.amount) || 0);
                        });
                        
                        if (financialIncomeChart) financialIncomeChart.destroy();
                        
                        financialIncomeChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                            labels: Object.keys(categories),
                            datasets: [{
                                data: Object.values(categories),
                                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6']
                            }]
                            },
                            options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                            }
                        });
                        }

                        function renderFinancialExpensesChart(operations) {
                        const ctx = document.getElementById('financialExpensesChart');
                        if (!ctx || typeof Chart === 'undefined') {
                            console.log('Chart.js not loaded or canvas not found');
                            return;
                        }
                        
                        const expenseOps = operations.filter(op => (op.category || '').split('.')[0] !== '–î–æ—Ö–æ–¥–∏');
                        const categories = {};
                        
                        expenseOps.forEach(op => {
                            const cat = op.mainCategory || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                            categories[cat] = (categories[cat] || 0) + Math.abs(parseFloat(op.amount) || 0);
                        });
                        
                        if (financialExpensesChart) financialExpensesChart.destroy();
                        
                        financialExpensesChart = new Chart(ctx, {
                            type: 'pie',
                            data: {
                            labels: Object.keys(categories),
                            datasets: [{
                                data: Object.values(categories),
                                backgroundColor: ['#ef4444', '#f59e0b', '#f97316', '#dc2626']
                            }]
                            },
                            options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                            }
                        });
                        }

                        function renderFinancialOperationsTable(operations) {
                        const tbody = document.getElementById('financialOperationsBody');
                        if (!tbody) return;
                        
                        if (operations.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π</td></tr>';
                            return;
                        }
                        
                        // Sort by date (newest first)
                        const sortedOps = operations.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        tbody.innerHTML = sortedOps.map((op, idx) => {
                            const amount = parseFloat(op.amount) || 0;
                            const mainCategory = (op.category || '').split('.')[0];
                            const isIncome = mainCategory === '–î–æ—Ö–æ–¥–∏';
                            const amountColor = isIncome ? '#10b981' : '#ef4444';
                            const amountText = (isIncome ? '+' : '') + amount.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                            
                            return '<tr style="background:' + (idx % 2 === 0 ? 'white' : '#f9fafb') + ';border-bottom:1px solid #e5e7eb">' +
                            '<td style="padding:10px 8px">' + new Date(op.date).toLocaleDateString('uk-UA') + '</td>' +
                            '<td style="padding:10px 8px;font-weight:600">' + mainCategory + '</td>' +
                            '<td style="padding:10px 8px">' + (op.category || '').split('.')[1] + '</td>' +
                            '<td style="padding:10px 8px">' + (op.period || '') + '</td>' +
                            '<td style="padding:10px 8px">' + (op.location || '') + '</td>' +
                            '<td style="padding:10px 8px;text-align:right;font-weight:600;color:' + amountColor + '">' + amountText + '</td>' +
                            '<td style="padding:10px 8px">' + (op.comment || '') + '</td>' +
                            '</tr>';
                        }).join('');
                        }

                        function renderFinancialTrendChart(operations) {
                        const ctx = document.getElementById('financialTrendChart');
                        if (!ctx || typeof Chart === 'undefined') {
                            console.log('Chart.js not loaded or canvas not found');
                            return;
                        }
                        
                        const monthlyData = {};
                        
                        operations.forEach(op => {
                            const date = new Date(op.date);
                            const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                            
                            if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { income: 0, expenses: 0 };
                            }
                            
                            const amount = Math.abs(parseFloat(op.amount) || 0);
                            if (op.mainCategory === '–î–æ—Ö–æ–¥–∏') {
                            monthlyData[monthKey].income += amount;
                            } else {
                            monthlyData[monthKey].expenses += amount;
                            }
                        });
                        
                        const months = Object.keys(monthlyData).sort();
                        const incomeData = months.map(m => monthlyData[m].income);
                        const expensesData = months.map(m => monthlyData[m].expenses);
                        const profitData = months.map(m => monthlyData[m].income - monthlyData[m].expenses);
                        
                        if (financialTrendChart) financialTrendChart.destroy();
                        
                        financialTrendChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                            labels: months,
                            datasets: [{
                                label: '–î–æ—Ö–æ–¥–∏',
                                data: incomeData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: false
                            }, {
                                label: '–í–∏—Ç—Ä–∞—Ç–∏',
                                data: expensesData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: false
                            }, {
                                label: '–ü—Ä–∏–±—É—Ç–æ–∫',
                                data: profitData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true
                            }]
                            },
                            options: {
                            responsive: true,
                            scales: {
                                y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                    return value.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                                    }
                                }
                                }
                            }
                            }
                        });
                        }

                        function renderProfitabilityByPeriod(operations, totalRevenue, directExpenses, operationalExpenses, unexpectedExpenses) {
                        const tbody = document.getElementById('profitabilityPeriodBody');
                        if (!tbody) return;
                        
                        console.log('üñ•Ô∏è –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ñ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ –∑ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏...');
                        
                        // –ì—Ä—É–ø—É—î–º–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó —Ç—ñ–ª—å–∫–∏ –∑–∞ –ø–µ—Ä—ñ–æ–¥–æ–º
                        const groups = {};
                        
                        operations.forEach(op => {
                            const period = op.period || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø–µ—Ä—ñ–æ–¥';
                            
                            if (!groups[period]) {
                                groups[period] = {
                                    period: period,
                                    income: 0,
                                    directCosts: 0,
                                    operationalCosts: 0,
                                    unexpectedCosts: 0
                                };
                            }
                            
                            const amount = parseFloat(op.amount) || 0;
                            
                            if (amount > 0) {
                                // –ü–æ–∑–∏—Ç–∏–≤–Ω—ñ —Å—É–º–∏ = –¥–æ—Ö–æ–¥–∏
                                groups[period].income += amount;
                            } else {
                                // –ù–µ–≥–∞—Ç–∏–≤–Ω—ñ —Å—É–º–∏ = –≤–∏—Ç—Ä–∞—Ç–∏
                                const absAmount = Math.abs(amount);
                                const category = (op.category || '').split('.')[0];
                                
                                if (category === '–ü—Ä—è–º—ñ') {
                                    groups[period].directCosts += absAmount;
                                } else if (category === '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ') {
                                    groups[period].operationalCosts += absAmount;
                                } else if (category === '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ') {
                                    groups[period].unexpectedCosts += absAmount;
                                }
                            }
                        });
                        
                        console.log(`üñ•Ô∏è –ó–≥—Ä—É–ø–æ–≤–∞–Ω–æ –¥–∞–Ω—ñ –ø–æ ${Object.keys(groups).length} –ø–µ—Ä—ñ–æ–¥–∞–º`);
                        
                        const rows = Object.values(groups).map((g, idx) => {
                            const totalCosts = g.directCosts + g.operationalCosts + g.unexpectedCosts;
                            const profit = g.income - totalCosts;
                            const profitability = g.income > 0 ? ((profit / g.income) * 100) : 0;
                            const profitColor = profit >= 0 ? '#10b981' : '#ef4444';
                            
                            return `<tr style="background:${idx % 2 === 0 ? 'white' : '#f9fafb'};border-bottom:1px solid #e5e7eb">
                                <td style="padding:10px 8px;font-weight:600">${g.period}</td>
                                <td style="padding:10px 8px;text-align:right">${Math.round(g.income).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:10px 8px;text-align:right">${Math.round(g.directCosts).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:10px 8px;text-align:right">${Math.round(g.operationalCosts).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:10px 8px;text-align:right">${Math.round(g.unexpectedCosts).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:10px 8px;text-align:right;font-weight:600;color:${profitColor}">${Math.round(profit).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:10px 8px;text-align:center;font-weight:600;color:${profitColor}">${profitability.toFixed(1)}%</td>
                            </tr>`;
                        });
                        
                        if (rows.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</td></tr>';
                        } else {
                            tbody.innerHTML = rows.join('');
                        }
                        
                        console.log(`üñ•Ô∏è –¢–∞–±–ª–∏—Ü—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω–∞: ${rows.length} —Ä—è–¥–∫—ñ–≤`);
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–µ—Ç–∞–ª—å–Ω—É –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –≤–∏—Ç—Ä–∞—Ç
                        updateDetailedExpenseAnalysis(operations, Object.values(groups));
                        }
                        
                        function updateDetailedExpenseAnalysis(operations, groups) {
                        console.log('üîç –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –≤–∏—Ç—Ä–∞—Ç...');
                        
                        if (groups.length === 0) return;
                        
                        const totalRevenue = groups.reduce((sum, g) => sum + g.income, 0);
                        const totalDirectCosts = groups.reduce((sum, g) => sum + g.directCosts, 0);
                        const totalOperationalCosts = groups.reduce((sum, g) => sum + g.operationalCosts, 0);
                        const totalUnexpectedCosts = groups.reduce((sum, g) => sum + g.unexpectedCosts, 0);
                        const totalProfit = totalRevenue - totalDirectCosts - totalOperationalCosts - totalUnexpectedCosts;
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–≤–µ–¥–µ–Ω–Ω—è
                        const directPercent = totalRevenue > 0 ? ((totalDirectCosts / totalRevenue) * 100) : 0;
                        const operationalPercent = totalRevenue > 0 ? ((totalOperationalCosts / totalRevenue) * 100) : 0;
                        const unexpectedPercent = totalRevenue > 0 ? ((totalUnexpectedCosts / totalRevenue) * 100) : 0;
                        const profitPercent = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100) : 0;
                        
                        document.getElementById('detailedDirectTotal').textContent = directPercent.toFixed(1) + '%';
                        document.getElementById('detailedDirectAmount').textContent = Math.round(totalDirectCosts).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        
                        document.getElementById('detailedOperationalTotal').textContent = operationalPercent.toFixed(1) + '%';
                        document.getElementById('detailedOperationalAmount').textContent = Math.round(totalOperationalCosts).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        
                        document.getElementById('detailedUnexpectedTotal').textContent = unexpectedPercent.toFixed(1) + '%';
                        document.getElementById('detailedUnexpectedAmount').textContent = Math.round(totalUnexpectedCosts).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        
                        document.getElementById('detailedProfitTotal').textContent = profitPercent.toFixed(1) + '%';
                        document.getElementById('detailedProfitAmount').textContent = Math.round(totalProfit).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                        
                        // –ì—Ä—É–ø—É—î–º–æ –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤–∏—Ç—Ä–∞—Ç –∑–∞ –¥–µ—Ç–∞–ª—å–Ω–∏–º–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏
                        const expenseOperations = operations.filter(op => parseFloat(op.amount) < 0);
                        const categoryBreakdown = {};
                        
                        expenseOperations.forEach(op => {
                            const categoryParts = (op.category || '').split('.');
                            const mainCategory = categoryParts[0] || '–Ü–Ω—à—ñ';
                            const subCategory = categoryParts[1] || '–ó–∞–≥–∞–ª—å–Ω—ñ';
                            const detailCategory = categoryParts[2] || subCategory;
                            
                            const key = `${mainCategory}.${subCategory}.${detailCategory}`;
                            
                            if (!categoryBreakdown[key]) {
                                categoryBreakdown[key] = {
                                    mainCategory,
                                    subCategory,
                                    detailCategory,
                                    amount: 0,
                                    operations: []
                                };
                            }
                            
                            categoryBreakdown[key].amount += Math.abs(parseFloat(op.amount) || 0);
                            categoryBreakdown[key].operations.push(op);
                        });
                        
                        renderDetailedExpenseTable(categoryBreakdown, totalRevenue);
                        }
                        
                        function renderDetailedExpenseTable(categoryBreakdown, totalRevenue) {
                        const tbody = document.getElementById('expenseDetailsBody');
                        if (!tbody) return;
                        
                        const sortedCategories = Object.values(categoryBreakdown)
                            .sort((a, b) => b.amount - a.amount);
                        
                        if (sortedCategories.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="padding:40px;text-align:center;color:#94a3b8">–ù–µ–º–∞—î –¥–µ—Ç–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤–∏—Ç—Ä–∞—Ç–∏</td></tr>';
                            return;
                        }
                        
                        const rows = sortedCategories.map((category, idx) => {
                            const percent = totalRevenue > 0 ? ((category.amount / totalRevenue) * 100) : 0;
                            const status = percent > 15 ? 'üî¥ –í–∏—Å–æ–∫—ñ' : percent > 8 ? 'üü° –ü–æ–º—ñ—Ä–Ω—ñ' : 'üü¢ –ù–æ—Ä–º–∞–ª—å–Ω—ñ';
                            const rowColor = idx % 2 === 0 ? 'white' : '#f9fafb';
                            
                            return `<tr style="background:${rowColor};border-bottom:1px solid #e5e7eb">
                                <td style="padding:10px 8px;font-weight:600">${category.mainCategory}</td>
                                <td style="padding:10px 8px">${category.subCategory} ‚Üí ${category.detailCategory}</td>
                                <td style="padding:10px 8px;text-align:right;font-weight:600">${Math.round(category.amount).toLocaleString('uk-UA')} –≥—Ä–Ω</td>
                                <td style="padding:10px 8px;text-align:center;font-weight:600">${percent.toFixed(1)}%</td>
                                <td style="padding:10px 8px;text-align:center">${status}</td>
                            </tr>`;
                        });
                        
                        tbody.innerHTML = rows.join('');
                        console.log(`üîç –î–µ—Ç–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –≤–∏—Ç—Ä–∞—Ç: ${rows.length} –∫–∞—Ç–µ–≥–æ—Ä—ñ–π`);
                        }
                        
                        function toggleExpenseDetails() {
                        const table = document.getElementById('expenseDetailsTable');
                        const button = document.getElementById('expenseDetailsToggle');
                        
                        if (table.style.display === 'none') {
                            table.style.display = 'block';
                            button.textContent = 'üìä –°—Ö–æ–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—é';
                            button.style.background = '#ef4444';
                        } else {
                            table.style.display = 'none';
                            button.textContent = 'üìä –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—é';
                            button.style.background = '#6366f1';
                        }
                        }

                        function renderProfitabilityCostStructureChart(directExpenses, operationalExpenses, unexpectedExpenses, otherExpenses) {
                        const ctx = document.getElementById('profitabilityCostStructureChart');
                        if (!ctx) return;
                        
                        const costTypes = {
                            '–ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏': directExpenses || 0,
                            '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏': operationalExpenses || 0,
                            '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏': unexpectedExpenses || 0
                        };
                        
                        // –î–æ–¥–∞—î–º–æ —ñ–Ω—à—ñ –≤–∏—Ç—Ä–∞—Ç–∏, —è–∫—â–æ —î
                        if (otherExpenses && otherExpenses > 0) {
                            costTypes['–Ü–Ω—à—ñ –≤–∏—Ç—Ä–∞—Ç–∏'] = otherExpenses;
                        }
                        
                        if (profitabilityCostStructureChart) profitabilityCostStructureChart.destroy();
                        
                        profitabilityCostStructureChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                            labels: Object.keys(costTypes),
                            datasets: [{
                                data: Object.values(costTypes),
                                backgroundColor: ['#ef4444', '#f59e0b', '#f97316']
                            }]
                            },
                            options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                            }
                        });
                        }

                        function renderProfitabilityTrendChart(operations) {
                        const ctx = document.getElementById('profitabilityTrendChart');
                        if (!ctx) return;
                        
                        // Group by period
                        const periodData = {};
                        
                        operations.forEach(op => {
                            if (!op.period) return;
                            
                            if (!periodData[op.period]) {
                            periodData[op.period] = { income: 0, expenses: 0 };
                            }
                            
                            const amount = Math.abs(parseFloat(op.amount) || 0);
                            if (op.mainCategory === '–î–æ—Ö–æ–¥–∏') {
                            periodData[op.period].income += amount;
                            } else {
                            periodData[op.period].expenses += amount;
                            }
                        });
                        
                        const periods = Object.keys(periodData).sort();
                        const profitabilityData = periods.map(p => {
                            const data = periodData[p];
                            return data.income > 0 ? ((data.income - data.expenses) / data.income * 100) : 0;
                        });
                        
                        if (profitabilityTrendChart) profitabilityTrendChart.destroy();
                        
                        profitabilityTrendChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                            labels: periods,
                            datasets: [{
                                label: '–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å (%)',
                                data: profitabilityData,
                                backgroundColor: profitabilityData.map(p => p >= 0 ? '#10b981' : '#ef4444')
                            }]
                            },
                            options: {
                            responsive: true,
                            scales: {
                                y: {
                                ticks: {
                                    callback: function(value) {
                                    return value + '%';
                                    }
                                }
                                }
                            }
                            }
                        });
                        }

                        // P&L Chart Variables
                        let pnlRevenueChart = null;
                        let pnlWaterfallChart = null;
                        let pnlTrendChart = null;

                        function renderPnlRevenueChart(clients, basePrice) {
                        const ctx = document.getElementById('pnlRevenueChart');
                        if (!ctx || typeof Chart === 'undefined') return;
                        
                        const revenueBySource = {
                            '–û—Å–Ω–æ–≤–Ω–∞ —Ü—ñ–Ω–∞': 0,
                            '–¢—Ä–∞–Ω—Å—Ñ–µ—Ä': 0
                        };
                        
                        clients.forEach(c => {
                            const clientPrice = calculateClientPrice(basePrice, c.discount, c.transferCost);
                            const transferCost = parseFloat(c.transferCost) || 0;
                            revenueBySource['–û—Å–Ω–æ–≤–Ω–∞ —Ü—ñ–Ω–∞'] += clientPrice - transferCost;
                            revenueBySource['–¢—Ä–∞–Ω—Å—Ñ–µ—Ä'] += transferCost;
                        });
                        
                        if (pnlRevenueChart) pnlRevenueChart.destroy();
                        
                        pnlRevenueChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                            labels: Object.keys(revenueBySource),
                            datasets: [{
                                data: Object.values(revenueBySource),
                                backgroundColor: ['#3b82f6', '#10b981']
                            }]
                            },
                            options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                position: 'bottom'
                                }
                            }
                            }
                        });
                        }

                        function renderPnlWaterfallChart(revenue, direct, operating, other) {
                        const ctx = document.getElementById('pnlWaterfallChart');
                        if (!ctx || typeof Chart === 'undefined') return;
                        
                        if (pnlWaterfallChart) pnlWaterfallChart.destroy();
                        
                        pnlWaterfallChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                            labels: ['–î–æ—Ö–æ–¥–∏', '–ü—Ä—è–º—ñ –≤–∏—Ç—Ä–∞—Ç–∏', '–û–ø–µ—Ä. –≤–∏—Ç—Ä–∞—Ç–∏', '–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω—ñ', '–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫'],
                            datasets: [{
                                data: [revenue, -direct, -operating, -other, revenue - direct - operating - other],
                                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#f59e0b', '#6366f1']
                            }]
                            },
                            options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                display: false
                                }
                            },
                            scales: {
                                y: {
                                ticks: {
                                    callback: function(value) {
                                    return Math.abs(value).toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                                    }
                                }
                                }
                            }
                            }
                        });
                        }

                        function renderPnlTrendChart(clients, operations, basePrice) {
                        const ctx = document.getElementById('pnlTrendChart');
                        if (!ctx || typeof Chart === 'undefined') return;
                        
                        // Group by month for trend analysis
                        const monthlyData = {};
                        
                        clients.forEach(c => {
                            const month = c.period || '–ù–µ–≤—ñ–¥–æ–º–æ';
                            if (!monthlyData[month]) {
                            monthlyData[month] = { revenue: 0, expenses: 0 };
                            }
                            monthlyData[month].revenue += calculateClientPrice(basePrice, c.discount, c.transferCost);
                        });
                        
                        operations.forEach(op => {
                            const month = op.period || '–ù–µ–≤—ñ–¥–æ–º–æ';
                            if (!monthlyData[month]) {
                            monthlyData[month] = { revenue: 0, expenses: 0 };
                            }
                            const mainCategory = (op.category || '').split('.')[0];
                            if (mainCategory !== '–î–æ—Ö–æ–¥–∏') {
                            monthlyData[month].expenses += Math.abs(parseFloat(op.amount) || 0);
                            }
                        });
                        
                        const periods = Object.keys(monthlyData);
                        const revenueData = periods.map(p => monthlyData[p].revenue);
                        const expenseData = periods.map(p => monthlyData[p].expenses);
                        const profitData = periods.map(p => monthlyData[p].revenue - monthlyData[p].expenses);
                        
                        if (pnlTrendChart) pnlTrendChart.destroy();
                        
                        pnlTrendChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                            labels: periods,
                            datasets: [{
                                label: '–î–æ—Ö–æ–¥–∏',
                                data: revenueData,
                                borderColor: '#10b981',
                                backgroundColor: '#10b98120'
                            }, {
                                label: '–í–∏—Ç—Ä–∞—Ç–∏',
                                data: expenseData,
                                borderColor: '#ef4444',
                                backgroundColor: '#ef444420'
                            }, {
                                label: '–ü—Ä–∏–±—É—Ç–æ–∫',
                                data: profitData,
                                borderColor: '#6366f1',
                                backgroundColor: '#6366f120'
                            }]
                            },
                            options: {
                            responsive: true,
                            scales: {
                                y: {
                                ticks: {
                                    callback: function(value) {
                                    return value.toLocaleString('uk-UA') + ' –≥—Ä–Ω';
                                    }
                                }
                                }
                            }
                            }
                        });
                        }

                        // ==== Dashboard —Ñ—É–Ω–∫—Ü—ñ—ó ====
                        function updateDashboard() {
                            updateDashboardAnalytics();
                            updateDashboardActiveShifts();
                        }

                        function updateDashboardAnalytics() {
                            // –ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å
                            const totalBalance = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
                            document.getElementById('dashboardTotalBalance').textContent = totalBalance.toLocaleString('uk-UA') + ' ‚Ç¥';
                            
                            // –ê–∫—Ç–∏–≤–Ω—ñ –ø–ª–∞–Ω–∏ —ñ –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –¥—ñ—Ç–µ–π
                            let activePlansCount = 0;
                            let totalChildren = 0;
                            
                            // –û—Ç—Ä–∏–º—É—î–º–æ CRM –¥–∞–Ω—ñ –∑ localStorage
                            const crmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');
                            
                            console.log('–ê–Ω–∞–ª—ñ–∑—É—î–º–æ –ø–ª–∞–Ω–∏:', allPlans.length);
                            console.log('CRM –¥–∞–Ω—ñ - –≤—Å—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤:', crmData.clients ? crmData.clients.length : 0);
                            console.log('CRM —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:', crmData);
                            
                            allPlans.forEach(plan => {
                                console.log('–ü–ª–∞–Ω:', plan.name, '–°—Ç–∞—Ç—É—Å:', plan.status || '–∞–∫—Ç–∏–≤–Ω–∏–π', '–ü–µ—Ä—ñ–æ–¥—ñ–≤:', Object.keys(plan.periods || {}).length);
                                
                                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω—ñ –ø–ª–∞–Ω–∏ –ø—Ä–∏ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –∞–∫—Ç–∏–≤–Ω–∏—Ö
                                if (plan.status === 'archived') {
                                    console.log('‚è∏Ô∏è –ü–ª–∞–Ω', plan.name, '–∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏–π, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ');
                                    return;
                                }
                                
                                let planHasActiveShifts = false;
                                
                                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥—ñ—Ç–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ –ø–ª–∞–Ω—É
                                Object.values(plan.periods || {}).forEach(period => {
                                    Object.values(period.locations || {}).forEach(location => {
                                        Object.values(location.shifts || {}).forEach(shift => {
                                            const childrenCount = (shift.children || []).length;
                                            if (childrenCount > 0) {
                                                planHasActiveShifts = true;
                                                totalChildren += childrenCount;
                                                console.log('–ó–º—ñ–Ω–∞ –∑ –¥—ñ—Ç—å–º–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ –ø–ª–∞–Ω—É:', childrenCount);
                                            }
                                        });
                                    });
                                });
                                
                                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –≤ CRM –¥–ª—è —Ü—å–æ–≥–æ –ø–ª–∞–Ω—É
                                if (crmData.clients && crmData.clients.length > 0) {
                                    console.log('–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è –ø–ª–∞–Ω—É:', plan.name);
                                    console.log('–ü–µ—Ä—à—ñ 3 –∫–ª—ñ—î–Ω—Ç–∏ (—Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ):', JSON.stringify(crmData.clients.slice(0, 3), null, 2));
                                    console.log('–ü–æ–ª—è –ø–µ—Ä—à–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞:', Object.keys(crmData.clients[0] || {}));
                                    
                                    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞ –ø–æ–ª–µ–º period (—Å–∞–º–µ —Ç–∞–∫–µ –ø–æ–ª–µ —î –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ)
                                    let planClients = crmData.clients.filter(client => client.period === plan.name);
                                    console.log('‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è –ø–ª–∞–Ω—É', plan.name + ':', planClients.length);
                                    
                                    // –ü–æ–∫–∞–∂–µ–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å—ñ—Ö –ø–ª–∞–Ω–∞—Ö –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
                                    if (plan.name === '–ó–∏–º–∞ 2026') {
                                        const allPeriods = [...new Set(crmData.clients.map(c => c.period))];
                                        console.log('üìä –í—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏ –≤ CRM:', allPeriods);
                                        allPeriods.forEach(period => {
                                            const count = crmData.clients.filter(c => c.period === period).length;
                                            console.log(`  ${period}: ${count} –∫–ª—ñ—î–Ω—Ç—ñ–≤`);
                                        });
                                    }
                                    
                                    if (planClients.length > 0) {
                                        planHasActiveShifts = true;
                                        totalChildren += planClients.length;
                                        console.log('‚úÖ –ö–ª—ñ—î–Ω—Ç–∏ –∑ CRM –¥–ª—è –ø–ª–∞–Ω—É', plan.name + ':', planClients.length);
                                    }
                                }
                                
                                if (planHasActiveShifts) {
                                    activePlansCount++;
                                    console.log('–ü–ª–∞–Ω', plan.name, '–≤–≤–∞–∂–∞—î—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–∏–º');
                                }
                            });
                            
                            console.log('–ê–∫—Ç–∏–≤–Ω—ñ –ø–ª–∞–Ω–∏:', activePlansCount, '–í—Å—å–æ–≥–æ –¥—ñ—Ç–µ–π:', totalChildren);
                            
                            document.getElementById('dashboardActivePlans').textContent = activePlansCount;
                            document.getElementById('dashboardChildrenCount').textContent = totalChildren;
                            
                            // –ü—Ä–∏–±—É—Ç–æ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è
                            const currentMonth = new Date().getMonth();
                            const currentYear = new Date().getFullYear();
                            let monthlyProfit = 0;
                            
                            allPlans.forEach(plan => {
                                Object.values(plan.periods || {}).forEach(period => {
                                    Object.values(period.locations || {}).forEach(location => {
                                        Object.values(location.shifts || {}).forEach(shift => {
                                            (shift.children || []).forEach(child => {
                                                const childDate = new Date(child.createdAt || plan.startDate);
                                                if (childDate.getMonth() === currentMonth && childDate.getFullYear() === currentYear) {
                                                    monthlyProfit += (child.paid || 0);
                                                }
                                            });
                                        });
                                    });
                                });
                            });
                            
                            document.getElementById('dashboardMonthlyProfit').textContent = monthlyProfit.toLocaleString('uk-UA') + ' ‚Ç¥';
                        }

                        function updateDashboardActiveShifts() {
                            const container = document.getElementById('dashboardActiveShifts');
                            
                            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ CRM
                            const crmData = JSON.parse(localStorage.getItem('crmData') || '{"periods":[],"locations":{},"shifts":{},"clients":[],"fops":[],"refunds":[]}');
                            
                            // –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤ (–Ω–µ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏—Ö)
                            const activePlansNames = allPlans
                                .filter(plan => plan.status !== 'archived')
                                .map(plan => plan.name);
                            
                            // –ì—Ä—É–ø—É—î–º–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –ø–æ –∑–º—ñ–Ω–∞—Ö —Ç—ñ–ª—å–∫–∏ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤
                            const shiftGroups = {};
                            
                            crmData.clients.forEach(client => {
                                // –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∑–º—ñ–Ω–∏ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤
                                if (!activePlansNames.includes(client.period)) {
                                    return;
                                }
                                const key = `${client.period}_${client.location}_${client.shift}`;
                                if (!shiftGroups[key]) {
                                    shiftGroups[key] = {
                                        period: client.period,
                                        location: client.location,
                                        shift: client.shift,
                                        children: []
                                    };
                                }
                                shiftGroups[key].children.push(client);
                            });
                            
                            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –º–∞—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–º—ñ–Ω
                            const activeShifts = Object.values(shiftGroups).map(group => {
                                // –î–∏–Ω–∞–º—ñ—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —î–º–Ω—ñ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –¥—ñ—Ç–µ–π
                                const childrenCount = group.children.length;
                                let maxCapacity = Math.max(50, Math.ceil(childrenCount * 1.2)); // –ú—ñ–Ω—ñ–º—É–º 50, –∞–±–æ –Ω–∞ 20% –±—ñ–ª—å—à–µ –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
                                
                                return {
                                    planName: group.period,
                                    periodName: group.period,
                                    locationName: group.location,
                                    shiftName: group.shift,
                                    children: group.children,
                                    maxCapacity: maxCapacity
                                };
                            });

                            if (activeShifts.length === 0) {
                                container.innerHTML = `
                                    <div style="text-align:center;padding:40px;color:#64748b">
                                        <div style="font-size:48px;margin-bottom:16px;opacity:0.5">üèïÔ∏è</div>
                                        <div>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–º—ñ–Ω</div>
                                        <div style="font-size:13px;margin-top:8px">–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à–∏–π –ø–ª–∞–Ω, —â–æ–± –ø–æ—á–∞—Ç–∏</div>
                                    </div>
                                `;
                            } else {
                                container.innerHTML = activeShifts.map(shift => {
                                    const childrenCount = shift.children.length;
                                    const statusColor = childrenCount >= 100 ? '#ef4444' : childrenCount >= 50 ? '#f59e0b' : '#10b981';
                                    
                                    return `
                                        <div style="padding:16px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:12px;transition:all 0.2s ease" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#e5e7eb'">
                                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                                <div>
                                                    <div style="font-weight:600;color:#1e293b">${shift.planName}</div>
                                                    <div style="font-size:13px;color:#64748b;margin-top:2px">${shift.periodName} ‚Ä¢ ${shift.locationName} ‚Ä¢ ${shift.shiftName}</div>
                                                </div>
                                                <div style="background:${statusColor}20;color:${statusColor};padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600">
                                                    ${childrenCount} –¥—ñ—Ç–µ–π
                                                </div>
                                            </div>
                                            <div style="display:flex;justify-content:space-between;align-items:center">
                                                <div style="font-size:13px;color:#64748b">
                                                    ÔøΩ ${shift.children.filter(c => c.paymentStatus === '–û–ø–ª–∞—á–µ–Ω–æ').length} –æ–ø–ª–∞—á–µ–Ω–æ –∑ ${shift.children.length}
                                                </div>
                                                <button onclick="showTab('analyticsTab')" style="padding:4px 8px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:11px;cursor:pointer">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            }
                        }

                        // –û–Ω–æ–≤–ª—é—î–º–æ dashboard –ø—Ä–∏ –∑–º—ñ–Ω—ñ –¥–∞–Ω–∏—Ö
                        function refreshDashboard() {
                            updateDashboard();
                        }

                    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏
                    function closePlansModal() {
                        console.log('üîÑ –°–ø—Ä–æ–±–∞ –∑–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª–∫—É...');
                        
                        // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ –∑–∞ ID
                        let modal = document.getElementById('plansManagementModal');
                        console.log('üîç –ó–Ω–∞–π–¥–µ–Ω–∞ –º–æ–¥–∞–ª–∫–∞ –ø–æ ID:', modal);
                        
                        if (!modal) {
                            // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ –ø–æ ID, –ø—Ä–æ–±—É—î–º–æ –∑–∞ —Å—Ç–∏–ª—è–º–∏
                            modal = document.querySelector('div[style*="position:fixed"]');
                            console.log('üîç –ó–Ω–∞–π–¥–µ–Ω–∞ –º–æ–¥–∞–ª–∫–∞ –ø–æ —Å—Ç–∏–ª—è—Ö:', modal);
                        }
                        
                        if (!modal) {
                            // –û—Å—Ç–∞–Ω–Ω—ñ–π —Å–ø–æ—Å—ñ–± - –ø–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –≤—Å—ñ div
                            const allDivs = document.querySelectorAll('div');
                            for (let div of allDivs) {
                                if (div.style.position === 'fixed' || div.style.zIndex === '1000') {
                                    modal = div;
                                    console.log('üîç –ó–Ω–∞–π–¥–µ–Ω–∞ –º–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–±–æ—Ä–æ–º:', modal);
                                    break;
                                }
                            }
                        }
                        
                        if (modal) {
                            modal.remove();
                            console.log('‚úÖ –ú–æ–¥–∞–ª–∫–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–∞');
                        } else {
                            console.log('‚ùå –ú–æ–¥–∞–ª–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –∂–æ–¥–Ω–∏–º —Å–ø–æ—Å–æ–±–æ–º');
                        }
                    }                        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –º–æ–¥–∞–ª–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–ª–∞–Ω–∞–º–∏
                        function showPlansManagementModal() {
                            const activePlans = allPlans.filter(plan => plan.status !== 'archived');
                            const archivedPlans = allPlans.filter(plan => plan.status === 'archived');
                            
                        const modal = document.createElement('div');
                        modal.id = 'plansManagementModal';
                        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center';                            let modalContent = '<div style="background:white;padding:24px;border-radius:12px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto">';
                            modalContent += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
                            modalContent += '<h2 style="margin:0;color:#1e293b">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–ª–∞–Ω–∞–º–∏</h2>';
                            modalContent += '<button onclick="closePlansModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#64748b">√ó</button>';
                            modalContent += '</div>';
                            
                            modalContent += '<div style="margin-bottom:24px">';
                            modalContent += '<h3 style="margin:0 0 16px 0;color:#059669">–ê–∫—Ç–∏–≤–Ω—ñ –ø–ª–∞–Ω–∏ (' + activePlans.length + ')</h3>';
                            
                            if (activePlans.length > 0) {
                                activePlans.forEach(plan => {
                                    modalContent += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px">';
                                    modalContent += '<div>';
                                    modalContent += '<div style="font-weight:600">' + plan.name + '</div>';
                                    modalContent += '<div style="font-size:12px;color:#64748b">–°—Ç–≤–æ—Ä–µ–Ω–æ: ' + (plan.createdDate ? new Date(plan.createdDate).toLocaleDateString('uk-UA') : new Date(parseInt(plan.id)).toLocaleDateString('uk-UA')) + '</div>';
                                    modalContent += '</div>';
                                    modalContent += '<button onclick="archivePlan(' + "'" + plan.id + "'" + ')" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">';
                                    modalContent += '–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏</button>';
                                    modalContent += '</div>';
                                });
                            } else {
                                modalContent += '<div style="padding:20px;text-align:center;color:#64748b">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤</div>';
                            }
                            modalContent += '</div>';
                            
                            if (archivedPlans.length > 0) {
                                modalContent += '<div>';
                                modalContent += '<h3 style="margin:0 0 16px 0;color:#64748b">–ê—Ä—Ö—ñ–≤–æ–≤–∞–Ω—ñ –ø–ª–∞–Ω–∏ (' + archivedPlans.length + ')</h3>';
                                archivedPlans.forEach(plan => {
                                    modalContent += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;background:#f8fafc">';
                                    modalContent += '<div>';
                                    modalContent += '<div style="font-weight:600;color:#64748b">' + plan.name + '</div>';
                                    modalContent += '<div style="font-size:12px;color:#64748b">–ê—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ: ' + (plan.archivedDate ? new Date(plan.archivedDate).toLocaleDateString('uk-UA') : '–ù–µ–≤—ñ–¥–æ–º–æ') + '</div>';
                                    modalContent += '</div>';
                                    modalContent += '<button onclick="unarchivePlan(' + "'" + plan.id + "'" + ')" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">';
                                    modalContent += '–í—ñ–¥–Ω–æ–≤–∏—Ç–∏</button>';
                                    modalContent += '</div>';
                                });
                                modalContent += '</div>';
                            }
                            
                        modalContent += '</div>';
                        modal.innerHTML = modalContent;
                        
                        // –î–æ–¥–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–∞–∫—Ä–∏—Ç—Ç—è –∫–ª—ñ–∫–æ–º –ø–æ–∑–∞ –º–æ–¥–∞–ª–∫–æ—é
                        modal.addEventListener('click', function(e) {
                            if (e.target === modal) {
                                closePlansModal();
                            }
                        });
                        
                        document.body.appendChild(modal);
                    }                        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è –ø–ª–∞–Ω—É
                        function archivePlan(planId) {
                            const plan = allPlans.find(p => p.id === planId);
                            if (plan) {
                                // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è–º
                                const confirmMessage = "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ –ø–ª–∞–Ω \"" + plan.name + "\"?\n\n" +
                                    "–ê—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏–π –ø–ª–∞–Ω:\n" +
                                    "‚Ä¢ –ù–µ –±—É–¥–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏—Å—å —è–∫ –∞–∫—Ç–∏–≤–Ω–∏–π\n" +
                                    "‚Ä¢ –ù–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏–º–µ—Ç—å—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏—Ü—ñ\n" +
                                    "‚Ä¢ –ú–æ–∂–Ω–∞ –±—É–¥–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ\n\n" +
                                    "–¶–µ –¥—ñ—è –Ω–µ –≤–∏–¥–∞–ª—è—î –ø–ª–∞–Ω –Ω–∞–∑–∞–≤–∂–¥–∏!";
                                
                                if (!confirm(confirmMessage)) {
                                    return; // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–µ—Ä–µ–¥—É–º–∞–≤
                                }
                                
                                plan.status = 'archived';
                                plan.archivedDate = new Date().toISOString();
                                saveAllPlans();
                                refreshDashboard();
                                
                                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É —ñ –ø–æ–∫–∞–∑—É—î–º–æ –Ω–æ–≤—É
                                closePlansModal();
                                showPlansManagementModal();
                                
                                console.log('üì¶ –ü–ª–∞–Ω –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ:', plan.name);
                            }
                        }

                        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –∑ –∞—Ä—Ö—ñ–≤—É
                        function unarchivePlan(planId) {
                            const plan = allPlans.find(p => p.id === planId);
                            if (plan) {
                                delete plan.status;
                                delete plan.archivedDate;
                                saveAllPlans();
                                refreshDashboard();
                                
                                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É —ñ –ø–æ–∫–∞–∑—É—î–º–æ –Ω–æ–≤—É
                                closePlansModal();
                                showPlansManagementModal();
                                
                                console.log('üîÑ –ü–ª–∞–Ω –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ:', plan.name);
                            }
                        }

                        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ dashboard –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
                        document.addEventListener('DOMContentLoaded', function() {
                            updateDashboard();
                            updateRefundsBadge();
                            initAuthFromStorage();
                            applyRoleUI();
                        });

                        // Mobile menu toggle: collapse/expand left params column
                        function toggleMobileMenu() {
                            try {
                                const params = document.querySelector('.params-column');
                                const mainGrid = document.querySelector('.main-grid');
                                if (!params || !mainGrid) return;
                                const hidden = params.classList.toggle('collapsed');
                                if (hidden) {
                                    // ensure main grid expands
                                    mainGrid.classList.add('collapsed-columns');
                                } else {
                                    mainGrid.classList.remove('collapsed-columns');
                                }
                                // update button text
                                const btn = document.getElementById('mobileMenuToggle');
                                if (btn) btn.textContent = hidden ? '‚úï –ó–∞–∫—Ä–∏—Ç–∏' : '‚ò∞ –ú–µ–Ω—é';
                            } catch (e) { console.error(e); }
                        }

                    </script>
                    <script>
                    // ====== –ü—Ä–æ—Å—Ç–∏–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (—Ç–∏–º—á–∞—Å–æ–≤–æ) ======
                    const ROLE_PERMISSIONS = {
                        admin: { sales:true, clients:true, finance:true, analytics:true, settings:true },
                        manager: { sales:true, clients:true, finance:true, analytics:true, settings:false },
                        viewer: { sales:false, clients:true, finance:false, analytics:true, settings:false }
                    };

                    function getCurrentUser(){
                        const raw = localStorage.getItem('currentUser');
                        if(!raw) return null;
                        try { return JSON.parse(raw); } catch { return null; }
                    }
                    function setCurrentUser(u){
                        if(!u) localStorage.removeItem('currentUser'); else localStorage.setItem('currentUser', JSON.stringify(u));
                    }
                    function initAuthFromStorage(){
                        const user = getCurrentUser();
                        if(user){
                            const label = document.getElementById('currentUserLabel');
                            label.textContent = `üë§ ${user.name} (${user.role})`;
                            label.style.display = 'inline';
                            document.getElementById('loginBtn').style.display='none';
                            document.getElementById('logoutBtn').style.display='inline';
                        }
                    }
                    function applyRoleUI(){
                        const user = getCurrentUser();
                        const role = user?.role || 'viewer';
                        const perms = ROLE_PERMISSIONS[role];
                        const map = {
                            salesTab: 'sales',
                            clientsTab: 'clients',
                            financeTab: 'finance',
                            analyticsTab: 'analytics',
                            settingsTabBtn: 'settings'
                        };
                        Object.entries(map).forEach(([id, key]) => {
                            const btn = document.getElementById(id);
                            if(!btn) return;
                            if(perms[key]) {
                                if(id==='settingsTabBtn') btn.style.display='';
                                btn.disabled=false; btn.style.opacity='1';
                            } else {
                                if(id==='settingsTabBtn') btn.style.display='none';
                                if(id!=='clientsTab') { // CRM –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤—Å—ñ–º
                                    btn.disabled=true; btn.style.opacity='0.4';
                                }
                            }
                        });
                    }
                    function showLoginModal(){
                        if(document.getElementById('loginModal')) return;
                        const modal = document.createElement('div');
                        modal.id='loginModal';
                        modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center';
                        modal.innerHTML = `
                        <div style="background:white;padding:24px;border-radius:12px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.15)">
                            <h3 style="margin:0 0 12px 0">üîê –£–≤—ñ–π—Ç–∏</h3>
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <input id="loginEmail" type="email" placeholder="Email" style="padding:8px;border:1px solid #e2e8f0;border-radius:8px" />
                                <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding:8px;border:1px solid #e2e8f0;border-radius:8px" />
                                <button onclick="doLogin()" style="padding:10px 16px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer">–£–≤—ñ–π—Ç–∏</button>
                                <button onclick="closeLoginModal()" style="padding:8px 12px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:8px;font-weight:600;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                <div style="font-size:11px;color:#64748b">–¢–µ—Å—Ç–æ–≤—ñ: admin@example.com / password123</div>
                            </div>
                        </div>`;
                        modal.addEventListener('click', e=>{ if(e.target===modal) closeLoginModal(); });
                        document.body.appendChild(modal);
                    }
                    function closeLoginModal(){
                        const m=document.getElementById('loginModal'); if(m) m.remove();
                    }
                    async function doLogin(){
                        const email = (document.getElementById('loginEmail')).value.trim();
                        const password = (document.getElementById('loginPassword')).value;
                        if(!email || !password) { alert('–í–≤–µ–¥—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å'); return; }
                        try {
                            const res = await fetch('http://localhost:4000/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
                            if(!res.ok){ const err= await res.json(); alert(err.error||'–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É'); return; }
                            const data = await res.json();
                            setCurrentUser({ ...data.user, token: data.token });
                            closeLoginModal();
                            initAuthFromStorage();
                            applyRoleUI();
                        } catch(e){ console.error(e); alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó'); }
                    }
                    function logoutUser(){
                        setCurrentUser(null);
                        document.getElementById('currentUserLabel').style.display='none';
                        document.getElementById('loginBtn').style.display='inline';
                        document.getElementById('logoutBtn').style.display='none';
                        applyRoleUI();
                    }
                    </script>
                    </body>
                    </html>
